<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arth Book - Tally Prime Mode</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <style>
        /* Extra Tally Specific Styles */
        .bal-ind { font-size: 10px; color: #64748b; font-style: italic; margin-top: 2px; display: block; }
        .bal-ind.dr { color: var(--red); }
        .bal-ind.cr { color: var(--green); }

        /* Bank/Bill Details Popup */
        .details-popup {
            position: absolute; background: #fff; border: 1px solid var(--primary);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2); z-index: 500; padding: 10px;
            width: 300px; border-radius: 4px; display: none;
        }
        .details-popup h4 { margin: 0 0 10px 0; font-size: 12px; background: var(--primary); color: white; padding: 5px; margin: -10px -10px 10px -10px; }
        .det-row { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 12px; }
        .det-row input, .det-row select { width: 60%; padding: 4px; border: 1px solid #ccc; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="brand">ARTH</div>
        <a href="#" onclick="setMode('Contra')" class="side-btn" id="btnContra">
            <span class="btn-text">Contra</span> <span class="key-tag">F4</span>
        </a>
        <a href="#" onclick="setMode('Payment')" class="side-btn active" id="btnPayment">
            <span class="btn-text">Payment</span> <span class="key-tag">F5</span>
        </a>
        <a href="#" onclick="setMode('Receipt')" class="side-btn" id="btnReceipt">
            <span class="btn-text">Receipt</span> <span class="key-tag">F6</span>
        </a>
        <a href="#" onclick="setMode('Journal')" class="side-btn" id="btnJournal">
            <span class="btn-text">Journal</span> <span class="key-tag">F7</span>
        </a>
        <hr style="border-color:rgba(255,255,255,0.1); margin:5px 0;">
        <a href="sales_invoice.html" class="side-btn">
            <span class="btn-text">Sales</span> <span class="key-tag">F8</span>
        </a>
        <a href="purchase_invoice.html" class="side-btn">
            <span class="btn-text">Purchase</span> <span class="key-tag">F9</span>
        </a>
        <a href="#" onclick="openF10Modal()" class="side-btn" style="color:var(--accent);">
            <span class="btn-text">Other Vouchers</span> <span class="key-tag">F10</span>
        </a>
        <div style="margin-top:auto;">
            <a href="#" onclick="setMode('Credit Note')" class="side-btn" id="btnCreditNote" style="font-size:11px;">
                <span class="btn-text">Credit Note</span> <span class="key-tag">^F8</span>
            </a>
            <a href="#" onclick="setMode('Debit Note')" class="side-btn" id="btnDebitNote" style="font-size:11px;">
                <span class="btn-text">Debit Note</span> <span class="key-tag">^F9</span>
            </a>
        </div>
    </div>

    <div class="main-area">
        <div class="top-bar">
            <div class="v-mode-badge" id="lblMode">Payment</div>
            <div style="display:flex; gap:10px;">
                <input type="text" id="vNo" readonly style="width:120px; padding:8px; border:1px solid #ccc; background:#eee; font-weight:bold; font-size:13px;">
                <input type="text" id="vDate" placeholder="DDMMYY" maxlength="6" class="focusable" style="width:100px; padding:8px; border:1px solid #ccc; text-align:center; font-weight:bold;">
            </div>
        </div>

        <div class="grid-container" id="gridRows">
            </div>

        <div class="footer-bar">
            <div style="display:flex; align-items:center; gap:15px;">
                <div class="calc-trigger" onclick="toggleCalc()"><i class="fas fa-calculator"></i> Calc</div>
                <input type="text" id="narr" class="focusable" placeholder="Narration (Being...)" style="width:300px; padding:8px; border-radius:4px; border:none;">
            </div>
            <div style="text-align:right;">
                <div style="font-size:12px; opacity:0.7;">TOTAL</div>
                <div style="font-size:18px; font-weight:bold; font-family:'JetBrains Mono';" id="lblTotal">0.00</div>
                <div id="diffAlert" style="color:#ef4444; font-size:12px; display:none;">Diff: <span id="lblDiff">0.00</span></div>
            </div>
            <button onclick="saveVoucher()" style="background:var(--green); color:white; border:none; padding:10px 25px; font-weight:bold; border-radius:4px; margin-left:20px;">SAVE</button>
        </div>
    </div>

    <div id="bankPopup" class="details-popup">
        <h4>Bank Allocations</h4>
        <div class="det-row"><span>Trans Type:</span> <select><option>Cheque</option><option>e-Fund Transfer</option><option>DD</option></select></div>
        <div class="det-row"><span>Inst. No:</span> <input type="text" placeholder="Chq/Ref No"></div>
        <div class="det-row"><span>Inst. Date:</span> <input type="date"></div>
        <div style="text-align:right;"><button onclick="closeDetails('bankPopup')" style="font-size:10px;">Done</button></div>
    </div>

    <div id="billPopup" class="details-popup">
        <h4>Bill-wise Details</h4>
        <div class="det-row"><span>Ref Type:</span> <select><option>New Ref</option><option>Agst Ref</option><option>Advance</option><option>On Account</option></select></div>
        <div class="det-row"><span>Ref Name:</span> <input type="text" placeholder="Bill No"></div>
        <div class="det-row"><span>Due Date:</span> <input type="date"></div>
        <div class="det-row"><span>Amount:</span> <input type="number" id="billAmt"></div>
        <div style="text-align:right;"><button onclick="closeDetails('billPopup')" style="font-size:10px;">Done</button></div>
    </div>

    <div class="modal-overlay" id="f10Modal" onclick="closeF10Modal()">
        <div class="center-modal" onclick="event.stopPropagation()">
            <h3 style="margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:10px;">Select Voucher Type</h3>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; max-height:400px; overflow-y:auto;">
                <div>
                    <div style="font-weight:bold; color:#64748b; font-size:12px;">Accounting</div>
                    <div class="v-list-item" onclick="setMode('Contra')"><span>Contra</span> <span>F4</span></div>
                    <div class="v-list-item" onclick="setMode('Payment')"><span>Payment</span> <span>F5</span></div>
                    <div class="v-list-item" onclick="setMode('Receipt')"><span>Receipt</span> <span>F6</span></div>
                    <div class="v-list-item" onclick="setMode('Journal')"><span>Journal</span> <span>F7</span></div>
                    <div class="v-list-item" onclick="setMode('Credit Note')"><span>Credit Note</span> <span>^F8</span></div>
                    <div class="v-list-item" onclick="setMode('Debit Note')"><span>Debit Note</span> <span>^F9</span></div>
                </div>
                <div>
                    <div style="font-weight:bold; color:#64748b; font-size:12px;">Inventory</div>
                    <div class="v-list-item" onclick="location.href='sales_invoice.html'"><span>Sales</span> <span>F8</span></div>
                    <div class="v-list-item" onclick="location.href='purchase_invoice.html'"><span>Purchase</span> <span>F9</span></div>
                    <div class="v-list-item disabled"><span>Delivery Note</span> <span>Alt+F8</span></div>
                    <div class="v-list-item disabled"><span>Receipt Note</span> <span>Alt+F9</span></div>
                    <div class="v-list-item disabled"><span>Physical Stock</span> <span>^F10</span></div>
                    <div class="v-list-item disabled"><span>Stock Journal</span> <span>Alt+F7</span></div>
                </div>
                <div>
                    <div style="font-weight:bold; color:#64748b; font-size:12px;">Order Vouchers</div>
                    <div class="v-list-item disabled"><span>Purchase Order</span> <span>Ctrl+F9</span></div>
                    <div class="v-list-item disabled"><span>Sales Order</span> <span>Ctrl+F8</span></div>
                </div>
                <div>
                    <div style="font-weight:bold; color:#64748b; font-size:12px;">Payroll</div>
                    <div class="v-list-item disabled"><span>Payroll</span> <span>Ctrl+F4</span></div>
                    <div class="v-list-item disabled"><span>Attendance</span> <span>Ctrl+F5</span></div>
                </div>
            </div>
            <button onclick="closeF10Modal()" style="width:100%; margin-top:10px; padding:8px;">Close</button>
        </div>
    </div>

    <div class="calc-modal" id="calcModal">
        <div class="calc-header" id="calcHeader">Arth Calc <span onclick="toggleCalc()">‚úï</span></div>
        <div class="calc-body">
            <input type="text" class="calc-display" id="cDisp" readonly>
            <div class="calc-grid">
                <button class="c-btn" onclick="cIn('7')">7</button><button class="c-btn" onclick="cIn('8')">8</button><button class="c-btn" onclick="cIn('9')">9</button><button class="c-btn" onclick="cIn('/')">/</button>
                <button class="c-btn" onclick="cIn('4')">4</button><button class="c-btn" onclick="cIn('5')">5</button><button class="c-btn" onclick="cIn('6')">6</button><button class="c-btn" onclick="cIn('*')">*</button>
                <button class="c-btn" onclick="cIn('1')">1</button><button class="c-btn" onclick="cIn('2')">2</button><button class="c-btn" onclick="cIn('3')">3</button><button class="c-btn" onclick="cIn('-')">-</button>
                <button class="c-btn" onclick="cIn('0')">0</button><button class="c-btn" onclick="cIn('.')">.</button><button class="c-btn eq" onclick="cCalc()">Enter</button>
            </div>
        </div>
    </div>

    <datalist id="ledgerList"></datalist>

   <script src="db.js"></script>
<script>
    let currentMode = 'Payment';
    let allLedgers = [];
    let rowDataMeta = {}; // To store Bank/Bill details per row
    let currentRowIndex = -1; // To track which row opened the popup

    // Tally Colors
    const THEMES = {
        'Contra': '#f8fafc', 'Payment': '#fffbeb', 'Receipt': '#f0fdf4', 
        'Journal': '#eff6ff', 'Credit Note': '#fff1f2', 'Debit Note': '#ecfeff'
    };

    window.onload = async () => {
        try {
            await DB.init();
            allLedgers = await DB.getAll('ledgers');
            
            // Set Date
            const t = new Date();
            document.getElementById('vDate').value = `${String(t.getDate()).padStart(2,'0')}${String(t.getMonth()+1).padStart(2,'0')}${String(t.getFullYear()).slice(-2)}`;
            
            setMode('Payment');
            document.getElementById('vDate').focus();
        } catch(e) { console.error("DB Error", e); }
    };

    // --- 1. MODE SETTING ---
    async function setMode(mode) {
        currentMode = mode;
        document.querySelector('.main-area').style.background = THEMES[mode] || '#fff';
        document.getElementById('lblMode').innerText = mode;
        
        // Highlight Sidebar
        document.querySelectorAll('.side-btn').forEach(b => b.classList.remove('active'));
        if(mode === 'Credit Note') document.getElementById('btnCreditNote').classList.add('active');
        else if(mode === 'Debit Note') document.getElementById('btnDebitNote').classList.add('active');
        else if(document.getElementById(`btn${mode}`)) document.getElementById(`btn${mode}`).classList.add('active');

        // Generate Number
        const num = await DB.getNextVoucherNo(mode);
        const prefixMap = { 'Receipt':'RCPT', 'Payment':'PYMT', 'Contra':'CNTR', 'Journal':'JRNL', 'Credit Note':'CN', 'Debit Note':'DN' };
        document.getElementById('vNo').value = `${prefixMap[mode] || 'VCH'}-${num}`;

        // Reset Grid
        document.getElementById('gridRows').innerHTML = '';
        rowDataMeta = {}; // Clear temp metadata

        // Initial Rows
        if(mode === 'Payment') { addRow('Dr'); addRow('Cr'); }
        else if(mode === 'Receipt') { addRow('Cr'); addRow('Dr'); }
        else { addRow('Dr'); addRow('Cr'); }
        
        closeF10Modal();
    }

    // --- 2. ADD ROW (With Auto-Focus Fix) ---
    function addRow(type='Dr') {
        const index = document.querySelectorAll('.entry-row').length;
        const div = document.createElement('div');
        div.className = 'entry-row';
        div.dataset.index = index;
        div.innerHTML = `
            <div class="c-type">
                <select class="r-type focusable" onchange="handleTypeChange(this)">
                    <option value="Dr" ${type==='Dr'?'selected':''}>Dr</option>
                    <option value="Cr" ${type==='Cr'?'selected':''}>Cr</option>
                </select>
            </div>
            <div class="c-ledger">
                <input type="text" list="ledgerList" class="r-ledger focusable" placeholder="Select Ledger" 
                       onfocus="filterLedgers(this)" oninput="handleLedgerInput(this, ${index})" onblur="checkPopupTriggers(this, ${index})">
                <span class="bal-ind" id="bal-${index}"></span>
            </div>
            <div class="c-hist"><i class="fas fa-history" style="color:#cbd5e1;"></i></div>
            <div class="c-amt">
                <input type="number" class="amt-input focusable" placeholder="0.00" 
                       onfocus="handleAmtFocus(this)" oninput="calcTotals()">
            </div>
            <div class="c-del"><i class="fas fa-times" style="color:var(--red);" onclick="deleteRow(this)"></i></div>
        `;
        document.getElementById('gridRows').appendChild(div);
        
        // AUTO FOCUS: New row logic
        if(index > 1) { // Only auto focus if it's not the initial setup
            setTimeout(() => div.querySelector('.r-ledger').focus(), 50);
        }
    }

    function deleteRow(icon) {
        icon.closest('.entry-row').remove();
        calcTotals();
    }

    // --- 3. REAL BALANCE & FILTERING ---
    function filterLedgers(input) {
        // Tally-like filtering (Cash/Bank restriction)
        const isCashBank = (l) => [3,4].includes(l.group_id);
        let list = allLedgers;

        if (currentMode === 'Contra') list = allLedgers.filter(isCashBank);
        else if (currentMode === 'Payment') {
            const row = input.closest('.entry-row');
            const type = row.querySelector('.r-type').value;
            if(type === 'Cr') list = allLedgers.filter(isCashBank);
            else list = allLedgers.filter(l => !isCashBank(l));
        }
        else if (currentMode === 'Receipt') {
            const row = input.closest('.entry-row');
            const type = row.querySelector('.r-type').value;
            if(type === 'Dr') list = allLedgers.filter(isCashBank);
            else list = allLedgers.filter(l => !isCashBank(l));
        }

        const dl = document.getElementById('ledgerList');
        dl.innerHTML = list.map(l => `<option value="${l.name}">`).join('');
    }

    // üî• REAL TIME BALANCE LOGIC
    let debounceTimer;
    function handleLedgerInput(input, idx) {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(async () => {
            const name = input.value;
            const ledger = allLedgers.find(l => l.name === name);
            const balSpan = document.getElementById(`bal-${idx}`);
            
            if(ledger) {
                balSpan.innerText = "Fetching...";
                const bal = await DB.getLedgerBalance(ledger.id);
                const absBal = Math.abs(bal.net).toLocaleString('en-IN');
                const drCr = bal.net >= 0 ? 'Dr' : 'Cr';
                balSpan.innerText = `Cur Bal: ‚Çπ${absBal} ${drCr}`;
                balSpan.className = `bal-ind ${bal.net >= 0 ? 'dr' : 'cr'}`;
            } else {
                balSpan.innerText = "";
            }
        }, 300);
    }

    // --- 4. POPUP & META DATA HANDLING ---
    function checkPopupTriggers(input, idx) {
        const name = input.value;
        const ledger = allLedgers.find(l => l.name === name);
        if(!ledger) return;

        currentRowIndex = idx; // Lock current row for metadata

        // BANK DETAILS (Group 4)
        if(ledger.group_id === 4) {
            showPopup(input, 'bankPopup');
        }
        // BILL WISE (Group 5=Debtor, 7=Creditor)
        else if([5,7].includes(ledger.group_id)) {
            showPopup(input, 'billPopup');
            document.getElementById('billAmt').value = input.closest('.entry-row').querySelector('.amt-input').value || '';
        }
    }

    function showPopup(target, id) {
        const p = document.getElementById(id);
        const rect = target.getBoundingClientRect();
        p.style.top = (rect.bottom + 5) + 'px';
        p.style.left = rect.left + 'px';
        p.style.display = 'block';
        // Focus first input in popup
        p.querySelector('input, select').focus();
    }

    // Called when "Done" is clicked in Popup
    window.saveMeta = function(type) {
        if(currentRowIndex === -1) return;
        
        if(!rowDataMeta[currentRowIndex]) rowDataMeta[currentRowIndex] = {};

        if(type === 'bank') {
            // Harvest Bank Fields
            // In real code, grab IDs. For now assuming structure
            rowDataMeta[currentRowIndex].bank = {
                transType: document.querySelector('#bankPopup select').value,
                instNo: document.querySelector('#bankPopup input[type="text"]').value,
                instDate: document.querySelector('#bankPopup input[type="date"]').value
            };
            document.getElementById('bankPopup').style.display = 'none';
        } 
        else if (type === 'bill') {
            rowDataMeta[currentRowIndex].bill = {
                refType: document.querySelector('#billPopup select').value,
                refName: document.querySelector('#billPopup input[type="text"]').value,
                amount: document.querySelector('#billPopup input[type="number"]').value
            };
            document.getElementById('billPopup').style.display = 'none';
        }
        
        // Return focus to Amount field of that row
        const rows = document.querySelectorAll('.entry-row');
        if(rows[currentRowIndex]) {
            rows[currentRowIndex].querySelector('.amt-input').focus();
        }
    };

    // Replace your HTML close buttons to call saveMeta
    // <button onclick="saveMeta('bank')">Done</button>
    // <button onclick="saveMeta('bill')">Done</button>

    // --- 5. AUTO FILL AMOUNT & ENTER LOGIC ---
    function handleAmtFocus(input) {
        if(input.value === '') {
            calcTotals(); 
            const diff = parseFloat(document.getElementById('lblDiff').innerText);
            if(diff > 0) input.value = diff.toFixed(2);
        }
    }

    document.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            const focusable = Array.from(document.querySelectorAll('.focusable, input:not([type="hidden"]), select, button'));
            // Remove popup inputs from main cycle if popup is hidden
            const visibleFocusable = focusable.filter(el => el.offsetParent !== null);
            
            const idx = visibleFocusable.indexOf(document.activeElement);
            
            if (document.activeElement.classList.contains('amt-input')) {
                calcTotals();
                const diff = parseFloat(document.getElementById('lblDiff').innerText);
                const rows = document.querySelectorAll('.entry-row');
                const isLast = document.activeElement.closest('.entry-row') === rows[rows.length-1];

                if (isLast && diff > 0) {
                    // AUTO ROW ADD + FOCUS
                    const totDr = parseFloat(document.getElementById('lblTotal').dataset.dr || 0);
                    const totCr = parseFloat(document.getElementById('lblTotal').dataset.cr || 0);
                    const type = totDr < totCr ? 'Dr' : 'Cr';
                    addRow(type);
                    return; // addRow handles focus
                }
            }
            
            if (idx > -1 && idx < visibleFocusable.length - 1) visibleFocusable[idx + 1].focus();
        }
        
        // Shortcuts
        if(e.key === 'F4') setMode('Contra');
        if(e.key === 'F5') setMode('Payment');
        if(e.key === 'F6') setMode('Receipt');
        if(e.key === 'F7') setMode('Journal');
        if(e.ctrlKey && e.key === 'F8') { e.preventDefault(); setMode('Credit Note'); }
        if(e.ctrlKey && e.key === 'F9') { e.preventDefault(); setMode('Debit Note'); }
    });

    // --- 6. SAVE VALIDATION (BLOCKS ERROR) ---
    async function saveVoucher() {
        // 1. Calc Totals
        calcTotals();
        const diff = parseFloat(document.getElementById('lblDiff').innerText);
        
        // üõë BLOCKER 1: Difference Check
        if(diff > 0.05) {
            alert(`‚ùå Voucher is Unbalanced!\nDifference: ‚Çπ${diff}\nPlease correct before saving.`);
            return;
        }

        const narr = document.getElementById('narr').value;
        if(!narr) return alert("Please enter Narration");

        // Prepare Data
        const voucherData = {
            type: currentMode,
            voucher_no: document.getElementById('vNo').value,
            date: document.getElementById('vDate').value, // Use ISO in real app
            narration: narr,
            amount: parseFloat(document.getElementById('lblTotal').innerText)
        };

        const entries = [];
        const rows = document.querySelectorAll('.entry-row');
        for(let i=0; i<rows.length; i++) {
            const row = rows[i];
            const name = row.querySelector('.r-ledger').value;
            const ledger = allLedgers.find(l => l.name === name);
            if(!ledger) return alert(`Invalid Ledger at Row ${i+1}`);

            const amt = parseFloat(row.querySelector('.amt-input').value) || 0;
            const type = row.querySelector('.r-type').value;

            entries.push({
                ledger_id: ledger.id,
                debit: type === 'Dr' ? amt : 0,
                credit: type === 'Cr' ? amt : 0,
                meta: rowDataMeta[i] || null // Attach Bank/Bill details
            });
        }

        try {
            await DB.saveVoucherTransaction(voucherData, entries);
            alert("‚úÖ Voucher Saved Successfully!");
            location.reload();
        } catch(e) {
            alert("Save Failed: " + e.message);
        }
    }

    function calcTotals() {
        let dr=0, cr=0;
        document.querySelectorAll('.entry-row').forEach(r => {
            const type = r.querySelector('.r-type').value;
            const amt = parseFloat(r.querySelector('.amt-input').value) || 0;
            if(type === 'Dr') dr += amt; else cr += amt;
        });
        const diff = Math.abs(dr - cr);
        document.getElementById('lblTotal').innerText = Math.max(dr, cr).toFixed(2);
        document.getElementById('lblTotal').dataset.dr = dr;
        document.getElementById('lblTotal').dataset.cr = cr;
        document.getElementById('lblDiff').innerText = diff.toFixed(2);
        
        const alertBox = document.getElementById('diffAlert');
        if(diff > 0.05) {
            alertBox.style.display = 'block';
            alertBox.innerHTML = `‚ö†Ô∏è Difference: ‚Çπ${diff.toFixed(2)}`;
        } else {
            alertBox.style.display = 'none';
        }
    }
    
    // Helper to open F10
    function openF10Modal() { document.getElementById('f10Modal').style.display = 'block'; }
    function closeF10Modal() { document.getElementById('f10Modal').style.display = 'none'; }
</script>
</body>
</html>