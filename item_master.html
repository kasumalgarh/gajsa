<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Item Master - Arth Book</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
</head>
<style>
    /* ARTH BOOK ITEM MASTER STYLE */
    :root { --primary: #0d47a1; --bg: #f1f5f9; --text: #1e293b; --sidebar-width: 260px; }
    body { display: flex; height: 100vh; margin: 0; font-family: 'Inter', sans-serif; background: var(--bg); overflow: hidden; }

    /* SIDEBAR */
    .sidebar { width: var(--sidebar-width); background: var(--primary); color: white; display: flex; flex-direction: column; flex-shrink: 0; }
    .nav-links { padding: 10px; list-style: none; }
    .nav-link { display: flex; align-items: center; gap: 10px; padding: 12px; color: rgba(255,255,255,0.8); text-decoration: none; border-radius: 8px; margin-bottom: 5px; }
    .nav-link:hover, .nav-link.active { background: rgba(255,255,255,0.15); color: white; font-weight: bold; }

    /* MAIN */
    .main { flex: 1; display: flex; gap: 20px; padding: 20px; overflow: hidden; }
    
    /* LEFT LIST */
    .list-box { flex: 1; background: white; border-radius: 12px; display: flex; flex-direction: column; border: 1px solid #e2e8f0; }
    .search-bar { padding: 15px; border-bottom: 1px solid #e2e8f0; }
    .search-bar input { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; box-sizing: border-box; }
    .item-list { flex: 1; overflow-y: auto; padding: 0; }
    .item-row { display: flex; align-items: center; padding: 12px 15px; border-bottom: 1px solid #f1f5f9; cursor: pointer; transition: 0.2s; }
    .item-row:hover, .item-row.active { background: #e0f2fe; }
    .item-img { width: 40px; height: 40px; border-radius: 6px; background: #f1f5f9; object-fit: cover; margin-right: 12px; border: 1px solid #e2e8f0; }
    
    /* RIGHT FORM */
    .form-box { width: 400px; background: white; border-radius: 12px; display: flex; flex-direction: column; border: 1px solid #e2e8f0; overflow-y: auto; }
    .form-header { padding: 15px; border-bottom: 1px solid #e2e8f0; font-weight: bold; font-size: 18px; color: var(--primary); display: flex; justify-content: space-between; align-items: center; }
    .form-body { padding: 20px; display: flex; flex-direction: column; gap: 15px; }
    
    label { font-size: 12px; font-weight: 600; color: #64748b; margin-bottom: 4px; display: block; }
    input, select { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; box-sizing: border-box; font-size: 14px; }
    input:focus, select:focus { border-color: var(--primary); outline: none; }
    
    .row-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    .btn { padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 10px; }
    .btn-save { background: var(--primary); color: white; }
    .btn-new { background: #10b981; color: white; }
    
    /* IMAGE UPLOAD */
    .img-upload { width: 100px; height: 100px; border: 2px dashed #cbd5e1; border-radius: 8px; margin: 0 auto; display: flex; align-items: center; justify-content: center; cursor: pointer; overflow: hidden; position: relative; }
    .img-upload img { width: 100%; height: 100%; object-fit: cover; display: none; }
    .img-upload:hover { border-color: var(--primary); background: #f8fafc; }

    /* BARCODE */
    #barcodeCanvas { width: 100%; height: 60px; margin-top: 10px; display: none; }

    @media (max-width: 900px) { .sidebar { display: none; } .main { flex-direction: column; } .form-box { width: 100%; } }
</style>
<body>

<div class="sidebar">
    <div style="padding:20px; font-size:20px; font-weight:800; border-bottom:1px solid rgba(255,255,255,0.1);">Arth Book</div>
    <ul class="nav-links">
        <li><a href="index.html" class="nav-link"><i class="fas fa-home"></i> Dashboard</a></li>
        <li><a href="item_master.html" class="nav-link active"><i class="fas fa-boxes"></i> Inventory</a></li>
        <li><a href="reports.html" class="nav-link"><i class="fas fa-chart-line"></i> Reports</a></li>
    </ul>
</div>

<div class="main">
    <div class="list-box">
        <div class="search-bar">
            <input type="text" id="search" placeholder="üîç Search Item / SKU..." onkeyup="renderList()">
        </div>
        <div class="item-list" id="itemList">Loading...</div>
    </div>

    <div class="form-box">
        <div class="form-header">
            <span id="formTitle">New Item</span>
            <button onclick="newItem()" style="background:none; border:none; color:#64748b; cursor:pointer;"><i class="fas fa-plus-circle"></i> New</button>
        </div>
        <div class="form-body">
            <input type="hidden" id="itemId">
            
            <div class="img-upload" onclick="document.getElementById('fileInput').click()">
                <span id="uploadText" style="font-size:12px; color:#94a3b8; text-align:center;">Click to<br>Upload</span>
                <img id="previewImg">
                <input type="file" id="fileInput" hidden accept="image/*" onchange="handleImage(this)">
            </div>

            <div>
                <label>Item Name *</label>
                <input type="text" id="name" placeholder="e.g. Maggi Small">
            </div>

            <div class="row-2">
                <div>
                    <label>SKU / Barcode</label>
                    <input type="text" id="sku" placeholder="Scan or Type" oninput="genBarcode(this.value)">
                </div>
                <div>
                    <label>Unit</label>
                    <select id="unit">
                        <option value="Pcs">Pcs</option><option value="Kg">Kg</option><option value="Box">Box</option><option value="Ltr">Ltr</option><option value="Mtr">Mtr</option>
                    </select>
                </div>
            </div>

            <div class="row-2" style="background:#f0fdf4; padding:10px; border-radius:6px; border:1px solid #bbf7d0;">
                <div>
                    <label>HSN Code</label>
                    <input type="text" id="hsn" placeholder="e.g. 1902">
                </div>
                <div>
                    <label>GST Rate (%)</label>
                    <select id="gstRate">
                        <option value="0">0% (Exempt)</option>
                        <option value="5">5%</option>
                        <option value="12">12%</option>
                        <option value="18">18%</option>
                        <option value="28">28%</option>
                    </select>
                </div>
            </div>

            <div class="row-2">
                <div>
                    <label>Purchase Price (Ex. Tax)</label>
                    <input type="number" id="cost" placeholder="0.00">
                </div>
                <div>
                    <label>Sale Price (Inc. Tax)</label>
                    <input type="number" id="price" placeholder="0.00">
                </div>
            </div>

            <div class="row-2">
                <div>
                    <label>Current Stock</label>
                    <input type="number" id="stock" placeholder="0">
                </div>
                <div>
                    <label>Low Stock Alert</label>
                    <input type="number" id="minStock" value="5">
                </div>
            </div>

            <canvas id="barcodeCanvas"></canvas>

            <button class="btn btn-save" onclick="saveItem()">üíæ Save Item</button>
            <button class="btn btn-new" onclick="deleteItem()" style="background:#fee2e2; color:#ef4444; margin-top:5px; display:none;" id="btnDelete">üóëÔ∏è Delete</button>
        </div>
    </div>
</div>

<script src="db.js"></script>
<script>
    let items = [];
    let currentImgBase64 = null;

    window.onload = async () => {
        await DB.init();
        renderList();
    };

    async function renderList() {
        items = await DB.getAll('items');
        const q = document.getElementById('search').value.toLowerCase();
        const list = document.getElementById('itemList');
        list.innerHTML = '';

        const filtered = items.filter(i => i.name.toLowerCase().includes(q) || (i.sku && i.sku.includes(q)));
        
        if(filtered.length === 0) {
            list.innerHTML = '<div style="padding:20px; text-align:center; color:#94a3b8;">No items found</div>';
            return;
        }

        filtered.forEach(i => {
            const div = document.createElement('div');
            div.className = 'item-row';
            div.onclick = () => loadItem(i);
            div.innerHTML = `
                <img src="${i.image || 'https://via.placeholder.com/40'}" class="item-img">
                <div style="flex:1;">
                    <div style="font-weight:600;">${i.name}</div>
                    <div style="font-size:12px; color:#64748b;">Stock: ${i.current_stock} ${i.unit} | ‚Çπ${i.std_price}</div>
                </div>
                <div style="font-size:11px; font-weight:bold; color:${(i.current_stock<=i.reorder_level)?'red':'green'};">
                    ${(i.current_stock<=i.reorder_level)?'LOW':'OK'}
                </div>
            `;
            list.appendChild(div);
        });
    }

    function loadItem(i) {
        document.getElementById('itemId').value = i.id;
        document.getElementById('name').value = i.name;
        document.getElementById('sku').value = i.sku || '';
        document.getElementById('unit').value = i.unit || 'Pcs';
        document.getElementById('hsn').value = i.hsn || '';
        document.getElementById('gstRate').value = i.gst_rate || 0;
        document.getElementById('cost').value = i.std_cost || '';
        document.getElementById('price').value = i.std_price || '';
        document.getElementById('stock').value = i.current_stock || 0;
        document.getElementById('minStock').value = i.reorder_level || 5;
        
        currentImgBase64 = i.image;
        if(i.image) {
            document.getElementById('previewImg').src = i.image;
            document.getElementById('previewImg').style.display = 'block';
            document.getElementById('uploadText').style.display = 'none';
        } else {
            resetImg();
        }

        document.getElementById('formTitle').innerText = "Edit Item";
        document.getElementById('btnDelete').style.display = 'block';
        genBarcode(i.sku);
        
        // Highlight active
        document.querySelectorAll('.item-row').forEach(r => r.classList.remove('active'));
        event.currentTarget.classList.add('active');
    }

    function newItem() {
        document.querySelectorAll('input').forEach(i => i.value = '');
        document.getElementById('itemId').value = '';
        document.getElementById('unit').value = 'Pcs';
        document.getElementById('gstRate').value = 0;
        document.getElementById('stock').value = 0;
        document.getElementById('minStock').value = 5;
        resetImg();
        document.getElementById('formTitle').innerText = "New Item";
        document.getElementById('btnDelete').style.display = 'none';
        document.getElementById('barcodeCanvas').style.display = 'none';
    }

    async function saveItem() {
        const name = document.getElementById('name').value;
        if(!name) return alert("Item Name is required");

        const data = {
            name: name,
            sku: document.getElementById('sku').value,
            unit: document.getElementById('unit').value,
            hsn: document.getElementById('hsn').value,
            gst_rate: parseFloat(document.getElementById('gstRate').value) || 0,
            std_cost: parseFloat(document.getElementById('cost').value) || 0,
            std_price: parseFloat(document.getElementById('price').value) || 0,
            current_stock: parseFloat(document.getElementById('stock').value) || 0,
            reorder_level: parseFloat(document.getElementById('minStock').value) || 5,
            image: currentImgBase64
        };

        const id = document.getElementById('itemId').value;
        if(id) data.id = parseInt(id);

        await DB.saveItem(data);
        alert("‚úÖ Item Saved!");
        renderList();
        newItem();
    }

    async function deleteItem() {
        if(!confirm("Delete this item?")) return;
        const id = parseInt(document.getElementById('itemId').value);
        const tx = DB.db.transaction('items', 'readwrite');
        tx.objectStore('items').delete(id);
        tx.oncomplete = () => { renderList(); newItem(); };
    }

    // IMAGE LOGIC
    function handleImage(input) {
        const file = input.files[0];
        if(!file) return;
        if(file.size > 100000) return alert("Image too big! Max 100KB"); // Keep it small for IndexedDB
        
        const reader = new FileReader();
        reader.onload = (e) => {
            currentImgBase64 = e.target.result;
            document.getElementById('previewImg').src = currentImgBase64;
            document.getElementById('previewImg').style.display = 'block';
            document.getElementById('uploadText').style.display = 'none';
        };
        reader.readAsDataURL(file);
    }

    function resetImg() {
        currentImgBase64 = null;
        document.getElementById('previewImg').style.display = 'none';
        document.getElementById('uploadText').style.display = 'block';
    }

    // BARCODE LOGIC
    function genBarcode(val) {
        if(!val) { document.getElementById('barcodeCanvas').style.display='none'; return; }
        document.getElementById('barcodeCanvas').style.display='block';
        JsBarcode("#barcodeCanvas", val, { format: "CODE128", height: 40, displayValue: true });
    }
</script>
</body>
</html>