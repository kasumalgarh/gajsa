<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="icon" type="image/x-icon" href="favicon.ico">
    <title>Money Wise Pro - Item Master</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.0/dist/JsBarcode.all.min.js"></script>

    <style>
        :root {
            --sidebar-bg: #0f172a; --active-text: #f8fafc;
            --bg: #f8fafc; --text: #1e293b; --border: #e2e8f0; --muted: #64748b;
            --accent: #0ea5e9; --green: #10b981; --red: #ef4444; --orange: #f59e0b;
        }
        * { box-sizing: border-box; font-family: 'Inter', sans-serif; margin: 0; padding: 0; }
        body { display: flex; height: 100vh; background: var(--bg); color: var(--text); overflow: hidden; }

        /* SIDEBAR */
        .sidebar { width: 260px; background: var(--sidebar-bg); padding: 20px; display: flex; flex-direction: column; flex-shrink: 0; }
        .nav-link { padding: 12px 15px; margin-bottom: 5px; border-radius: 8px; color: #94a3b8; text-decoration: none; font-weight: 500; display: flex; align-items: center; gap: 12px; font-size: 14px; }
        .nav-link:hover, .nav-link.active { background: #1e293b; color: var(--active-text); }
        .nav-icon { font-size: 18px; }

        /* MAIN LAYOUT */
        .main { flex: 1; display: flex; padding: 20px; gap: 20px; overflow: hidden; }
        
        /* LEFT PANEL (LIST) */
        .list-panel { width: 340px; background: #fff; border-radius: 12px; border: 1px solid var(--border); display: flex; flex-direction: column; }
        .search-box { padding: 15px; border-bottom: 1px solid var(--border); background: #f8fafc; border-radius: 12px 12px 0 0; }
        .search-box input { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; outline: none; }
        
        .filter-tabs { display: flex; border-bottom: 1px solid var(--border); }
        .ftab { flex: 1; text-align: center; padding: 10px; font-size: 12px; font-weight: 600; cursor: pointer; background: #fff; }
        .ftab.active { background: #e0f2fe; color: var(--accent); border-bottom: 2px solid var(--accent); }

        .list-content { flex: 1; overflow-y: auto; }
        .list-item { padding: 12px 15px; border-bottom: 1px solid #f1f5f9; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: 0.2s; }
        .list-item:hover { background: #f0f9ff; }
        .list-item.low-stock-alert { border-left: 4px solid var(--red); background: #fef2f2; }
        
        .item-info strong { display: block; font-size: 14px; color: #0f172a; }
        .item-info span { font-size: 12px; color: var(--muted); }
        .stock-badge { font-size: 12px; font-weight: 700; text-align: right; }
        .val-badge { font-size: 11px; color: var(--muted); display: block; }

        .list-footer { padding: 10px 15px; border-top: 1px solid var(--border); background: #f1f5f9; font-size: 12px; color: var(--muted); display: flex; justify-content: space-between; border-radius: 0 0 12px 12px; }

        /* RIGHT PANEL (FORM) */
        .form-panel { flex: 1; background: #fff; border-radius: 12px; border: 1px solid var(--border); padding: 30px; display: flex; flex-direction: column; overflow-y: auto; }
        .form-header { font-size: 20px; font-weight: 700; margin-bottom: 20px; color: #0f172a; display: flex; justify-content: space-between; align-items: center; }
        
        .form-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
        .field { margin-bottom: 5px; }
        .full-width { grid-column: span 3; }
        .half-width { grid-column: span 2; }
        
        label { display: block; font-size: 12px; font-weight: 700; color: var(--muted); margin-bottom: 6px; text-transform: uppercase; }
        input, select { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 14px; outline: none; transition: 0.2s; }
        input:focus, select:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(14,165,233,0.1); }

        .btn { padding: 10px 20px; border-radius: 6px; border: none; font-weight: 600; cursor: pointer; }
        .btn-save { background: var(--accent); color: white; }
        .btn-new { background: #e2e8f0; color: var(--text); }
        .btn-del { background: #fee2e2; color: var(--red); float: right; }
        .btn-gen { background: var(--primary); color: white; font-size: 11px; padding: 5px 10px; border-radius: 4px; cursor: pointer; border: none; }

        #toast { position: fixed; top: 20px; right: 20px; background: var(--accent); color: white; padding: 12px 24px; border-radius: 6px; display: none; font-weight: 600; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        
        /* BARCODE PREVIEW */
        .barcode-area { grid-column: span 3; display: none; text-align: center; background: #f8fafc; padding: 10px; border-radius: 8px; border: 1px dashed #ccc; margin-top: 10px; }
        canvas { max-width: 100%; height: 60px; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div style="font-size: 20px; font-weight: 800; color: #fff; margin-bottom: 40px;">üöÄ Arth Book</div>
        <a href="index.html" class="nav-link"><span class="nav-icon">üìä</span> Dashboard</a>
        <a href="reports.html" class="nav-link"><span class="nav-icon">üìà</span> Reports</a>
        <a href="gst_filing.html" class="nav-link"><span class="nav-icon">üèõÔ∏è</span> GST Filing</a>
        <a href="sales_invoice.html" class="nav-link"><span class="nav-icon">üßæ</span> Sales Invoice</a>
        <a href="purchase_invoice.html" class="nav-link"><span class="nav-icon">üöö</span> Purchase Entry</a>
        <a href="vouchers.html" class="nav-link"><span class="nav-icon">üí∏</span> Vouchers (JV)</a>
        <a href="item_master.html" class="nav-link active"><span class="nav-icon">üì¶</span> Inventory</a>
        <a href="moneywise.html" class="nav-link"><span class="nav-icon">üë•</span> Parties / Ledgers</a>
        <a href="coa.html" class="nav-link"><span class="nav-icon">üóÇÔ∏è</span> Chart of Accounts</a>
        <a href="settings.html" class="nav-link"><span class="nav-icon">‚öôÔ∏è</span> Settings</a>
    </div>

    <div class="main">
        <div class="list-panel">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Search by Name or SKU..." onkeyup="renderList(this.value)">
            </div>
            <div class="filter-tabs">
                <div class="ftab active" onclick="filterList('all')">All Items</div>
                <div class="ftab" onclick="filterList('low')">‚ö†Ô∏è Low Stock</div>
            </div>
            <div class="list-content" id="itemList">
                </div>
            <div class="list-footer">
                <span id="totalCount">0 Items</span>
                <span id="totalValue">Value: ‚Çπ0.00</span>
            </div>
        </div>

        <div class="form-panel">
            <div class="form-header">
                <span>Product Master</span>
                <button class="btn btn-new" onclick="resetForm()">+ New Product</button>
            </div>
            <input type="hidden" id="itemId">

            <div class="form-grid">
                <div class="field half-width">
                    <label>Item Name *</label>
                    <input type="text" id="name" placeholder="Product Name" required>
                </div>
                <div class="field">
                    <label style="display:flex; justify-content:space-between;">
                        SKU / Barcode
                        <button class="btn-gen" onclick="generateSKU()">‚ö° Auto</button>
                    </label>
                    <input type="text" id="sku" placeholder="Scan or Click Auto" onchange="previewBarcode(this.value)">
                </div>

                <div id="barcodePreview" class="barcode-area">
                    <canvas id="barcodeCanvas"></canvas>
                    <div><button class="btn-gen" onclick="printBarcode()">üñ®Ô∏è Print Label</button></div>
                </div>

                <div class="field">
                    <label>Category</label>
                    <input type="text" id="category" placeholder="e.g. Electronics" list="catList">
                    <datalist id="catList"></datalist>
                </div>
                <div class="field">
                    <label>Unit</label>
                    <select id="unit">
                        <option value="Pcs">Pcs</option><option value="Kg">Kg</option>
                        <option value="Box">Box</option><option value="Mtr">Mtr</option>
                        <option value="Ltr">Ltr</option>
                    </select>
                </div>
                <div class="field">
                    <label>GST Rate</label>
                    <select id="gst">
                        <option value="0">0%</option><option value="5">5%</option>
                        <option value="12">12%</option><option value="18" selected>18%</option>
                        <option value="28">28%</option>
                    </select>
                </div>

                <div class="field">
                    <label>HSN Code</label>
                    <input type="text" id="hsn" placeholder="e.g. 8544">
                </div>
                <div class="field">
                    <label>Std Cost (Buy)</label>
                    <input type="number" id="stdCost" step="0.01" value="0">
                </div>
                <div class="field">
                    <label>Std Price (Sell)</label>
                    <input type="number" id="stdPrice" step="0.01" value="0">
                </div>

                <div class="field full-width" style="background:#f0f9ff; padding:15px; border-radius:8px; border:1px solid #bae6fd; margin-top:10px;">
                    <h4 style="margin-bottom:10px; color:#0284c7;">Opening Stock & Tracking</h4>
                    <div style="display:grid; grid-template-columns: repeat(4, 1fr); gap:15px;">
                        <div>
                            <label>Opening Qty</label>
                            <input type="number" id="opQty" value="0" onchange="toggleBatchFields()">
                        </div>
                        <div>
                            <label>Reorder Level</label>
                            <input type="number" id="reorder" value="5">
                        </div>
                        <div>
                            <label>Track Expiry?</label>
                            <select id="trackExpiry" onchange="toggleBatchFields()">
                                <option value="No">No</option>
                                <option value="Yes">Yes</option>
                            </select>
                        </div>
                        <div id="batchField" style="display:none;">
                            <label>Expiry Date</label>
                            <input type="date" id="expiryDate">
                        </div>
                    </div>
                </div>
            </div>

            <div style="margin-top:30px; display:flex; justify-content:space-between;">
                <button class="btn btn-save" onclick="saveItem()">Save Product (Alt+S)</button>
                <button class="btn btn-del" onclick="deleteItem()" id="delBtn" style="display:none;">Delete</button>
            </div>
        </div>
    </div>

    <div id="toast">Saved Successfully!</div>

    <script src="db.js"></script><script src="auth.js"></script>
    <script>
        let items = [];
        let filterMode = 'all';

        window.onload = async () => {
            await DB.init();
            renderList();
            
            // Populate Category Datalist
            const cats = new Set();
            (await DB.getItems()).forEach(i => { if(i.category) cats.add(i.category); });
            const dl = document.getElementById('catList');
            cats.forEach(c => { let op = document.createElement('option'); op.value = c; dl.appendChild(op); });
        };

        function toggleBatchFields() {
            const qty = parseFloat(document.getElementById('opQty').value) || 0;
            const track = document.getElementById('trackExpiry').value === 'Yes';
            
            if(track && qty > 0) {
                document.getElementById('batchField').style.display = 'block';
            } else {
                document.getElementById('batchField').style.display = 'none';
            }
        }

        function generateSKU() {
            const rnd = Math.floor(10000000 + Math.random() * 90000000); // 8 digit EAN-8 style
            document.getElementById('sku').value = rnd;
            previewBarcode(rnd);
        }

        function previewBarcode(val) {
            if(!val) {
                document.getElementById('barcodePreview').style.display = 'none';
                return;
            }
            document.getElementById('barcodePreview').style.display = 'block';
            try {
                JsBarcode("#barcodeCanvas", val, {
                    format: "CODE128",
                    lineColor: "#000",
                    width: 2,
                    height: 40,
                    displayValue: true
                });
            } catch(e) { console.log("Barcode Error", e); }
        }

        function printBarcode() {
            const canvas = document.getElementById('barcodeCanvas');
            const url = canvas.toDataURL();
            const w = window.open('','','width=400,height=300');
            w.document.write(`<img src="${url}" style="margin:20px;">`);
            w.print();
        }

        function filterList(mode) {
            filterMode = mode;
            document.querySelectorAll('.ftab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            renderList(document.getElementById('searchInput').value);
        }

        async function renderList(q = '') {
            items = await DB.getItems();
            const listDiv = document.getElementById('itemList');
            listDiv.innerHTML = '';
            
            let totalVal = 0;
            let count = 0;

            const filtered = items.filter(i => {
                const match = (i.name.toLowerCase().includes(q.toLowerCase()) || (i.sku && i.sku.toLowerCase().includes(q.toLowerCase())));
                if(!match) return false;
                if(filterMode === 'low') return (i.current_stock || 0) <= (i.reorder_level || 5);
                return true;
            });

            filtered.sort((a,b) => a.name.localeCompare(b.name)).forEach(i => {
                const stock = i.current_stock || 0;
                const val = stock * (i.std_cost || 0);
                totalVal += val;
                count++;

                const isLow = stock <= (i.reorder_level || 5);
                const isExp = i.track_expiry === 'Yes' ? '‚è≥' : '';
                
                const el = document.createElement('div');
                el.className = `list-item ${isLow ? 'low-stock-alert' : ''}`;
                el.onclick = () => loadItem(i);
                el.innerHTML = `
                    <div class="item-info">
                        <strong>${i.name} ${isExp}</strong>
                        <span>${i.sku || '-'} ‚Ä¢ ${i.category || 'General'}</span>
                    </div>
                    <div>
                        <div class="stock-badge" style="color:${isLow ? 'var(--red)' : 'var(--green)'}">${stock} ${i.unit}</div>
                        <span class="val-badge">‚Çπ${val.toFixed(0)}</span>
                    </div>
                `;
                listDiv.appendChild(el);
            });

            document.getElementById('totalCount').innerText = `${count} Items`;
            document.getElementById('totalValue').innerText = `Value: ‚Çπ${totalVal.toLocaleString('en-IN')}`;
        }

        function loadItem(i) {
            document.getElementById('itemId').value = i.id;
            document.getElementById('name').value = i.name;
            document.getElementById('sku').value = i.sku || '';
            document.getElementById('category').value = i.category || '';
            document.getElementById('unit').value = i.unit || 'Pcs';
            document.getElementById('gst').value = i.gst_rate || 18;
            document.getElementById('hsn').value = i.hsn || '';
            document.getElementById('stdCost').value = i.std_cost || 0;
            document.getElementById('stdPrice').value = i.std_price || 0;
            document.getElementById('opQty').value = i.op_qty || 0;
            document.getElementById('reorder').value = i.reorder_level || 5;
            document.getElementById('trackExpiry').value = i.track_expiry || 'No';
            
            // Set Expiry if exists
            if(i.expiry_date) document.getElementById('expiryDate').value = i.expiry_date;
            
            toggleBatchFields();
            if(i.sku) previewBarcode(i.sku);
            
            document.getElementById('delBtn').style.display = 'block';
        }

        function resetForm() {
            document.querySelectorAll('input').forEach(i => i.value = '');
            document.getElementById('gst').value = 18;
            document.getElementById('unit').value = 'Pcs';
            document.getElementById('stdCost').value = 0;
            document.getElementById('stdPrice').value = 0;
            document.getElementById('opQty').value = 0;
            document.getElementById('reorder').value = 5;
            document.getElementById('trackExpiry').value = 'No';
            document.getElementById('barcodePreview').style.display = 'none';
            toggleBatchFields();
            
            document.getElementById('delBtn').style.display = 'none';
            document.getElementById('name').focus();
        }

        async function saveItem() {
            const name = document.getElementById('name').value;
            if(!name) return alert("Name is required");
            
            // Auto Generate SKU if empty
            if(!document.getElementById('sku').value) {
                generateSKU();
            }

            const data = {
                name: name,
                sku: document.getElementById('sku').value,
                category: document.getElementById('category').value,
                unit: document.getElementById('unit').value,
                gst_rate: parseFloat(document.getElementById('gst').value),
                hsn: document.getElementById('hsn').value,
                std_cost: parseFloat(document.getElementById('stdCost').value)||0,
                std_price: parseFloat(document.getElementById('stdPrice').value)||0,
                op_qty: parseFloat(document.getElementById('opQty').value)||0,
                reorder_level: parseFloat(document.getElementById('reorder').value)||5,
                track_expiry: document.getElementById('trackExpiry').value,
                expiry_date: document.getElementById('expiryDate').value || null
            };
            
            // Update current stock based on Op Qty if New
            // Note: In real app, changing Op Qty later is tricky, but for simplicity:
            data.current_stock = data.op_qty; // Reset to Op Qty (User should use Purchase for adding more)

            const id = document.getElementById('itemId').value;
            if(id) data.id = parseInt(id);

            try {
                await DB.createItem(data); // db.js handles create/update
                showToast();
                resetForm();
                renderList();
            } catch(e) { alert("Error: " + e); }
        }

        async function deleteItem() {
            const id = document.getElementById('itemId').value;
            if(confirm("Delete this item?")) {
                await DB.deleteItem(parseInt(id));
                resetForm();
                renderList();
            }
        }

        function showToast() {
            const t = document.getElementById('toast');
            t.style.display = 'block';
            setTimeout(() => t.style.display='none', 2000);
        }

        // Shortcuts
        document.addEventListener('keydown', e => {
            if(e.altKey && e.key.toLowerCase() === 's') saveItem();
            if(e.altKey && e.key.toLowerCase() === 'n') resetForm();
        });
    </script>
</body>
</html>