<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Item Master - Money Wise</title>
    <style>
        /* --- PROFESSIONAL ERP THEME --- */
        :root {
            --bg-color: #f1f5f9;
            --header-bg: #0f172a;
            --accent-color: #0ea5e9;
            --focus-bg: #fef9c3; /* Tally Yellow */
            --focus-border: #f59e0b;
            --border-color: #cbd5e1;
            --text-color: #334155;
            --section-bg: #ffffff;
        }

        * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; background: var(--bg-color); overflow: hidden; }

        /* HEADER */
        .top-bar {
            background: var(--header-bg); color: white; padding: 0 15px; height: 45px;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 3px solid var(--accent-color);
        }
        .app-title { font-weight: bold; font-size: 14px; text-transform: uppercase; }
        .close-btn { color: #ef4444; cursor: pointer; font-size: 12px; font-weight: bold; }

        /* LAYOUT */
        .container { flex: 1; display: flex; height: calc(100vh - 75px); }

        /* LEFT LIST */
        .list-panel { width: 30%; background: white; border-right: 1px solid #94a3b8; display: flex; flex-direction: column; }
        .search-area { padding: 8px; background: #e2e8f0; border-bottom: 1px solid var(--border-color); }
        .search-box { width: 100%; padding: 8px; border: 1px solid #94a3b8; outline: none; }
        .item-list { flex: 1; overflow-y: auto; }
        .list-item {
            padding: 8px 12px; border-bottom: 1px solid #f1f5f9; cursor: pointer; font-size: 13px;
            display: flex; justify-content: space-between;
        }
        .list-item:hover { background-color: #e0f2fe; }
        .list-item span.stock { font-weight: bold; color: #166534; }

        /* RIGHT FORM */
        .form-panel { width: 70%; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; align-items: center; }
        .form-container {
            width: 100%; max-width: 900px; background: white; border: 1px solid var(--border-color);
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); padding: 15px; border-radius: 4px;
        }

        .section-header {
            font-size: 11px; font-weight: bold; color: var(--accent-color); text-transform: uppercase;
            border-bottom: 1px solid #e2e8f0; margin-bottom: 10px; margin-top: 15px; padding-bottom: 2px;
        }

        /* GRID */
        .row { display: flex; gap: 15px; margin-bottom: 10px; }
        .col { flex: 1; display: flex; flex-direction: column; }
        .col-small { flex: 0.5; display: flex; flex-direction: column; }

        label { font-size: 11px; font-weight: 700; color: #475569; margin-bottom: 3px; }
        input, select {
            padding: 5px 8px; border: 1px solid #94a3b8; font-size: 13px; outline: none; width: 100%;
            background: white; border-radius: 2px; height: 30px;
        }
        input:focus, select:focus { background-color: var(--focus-bg); border-color: var(--focus-border); }
        input[readonly] { background-color: #f1f5f9; color: #64748b; }

        /* FOOTER */
        .footer {
            height: 30px; background: var(--header-bg); color: white; display: flex; align-items: center;
            padding: 0 15px; font-size: 11px; gap: 15px; border-top: 1px solid #334155;
        }
        .key-badge { background: #334155; color: #38bdf8; padding: 2px 6px; border-radius: 3px; font-weight: bold; margin-right: 5px; }

        /* TOAST */
        #toast {
            position: fixed; top: 10px; right: 10px; background: #166534; color: white; padding: 10px 20px;
            border-radius: 4px; display: none; font-weight: bold; z-index: 999;
        }
    </style>
</head>
<body>

    <div class="top-bar">
        <div class="app-title">Stock Item Master</div>
        <div class="close-btn" onclick="window.location.href='index.html'">[ESC] Close</div>
    </div>

    <div class="container">
        <div class="list-panel">
            <div class="search-area">
                <input type="text" id="search" class="search-box" placeholder="Search Item..." onkeyup="renderItemList(this.value)">
            </div>
            <div class="item-list" id="itemList"></div>
        </div>

        <div class="form-panel">
            <div class="form-container">
                <input type="hidden" id="itemId">

                <div class="row">
                    <div class="col" style="flex: 2;">
                        <label>Item Name *</label>
                        <input type="text" id="name" placeholder="e.g. Samsung Galaxy S23">
                    </div>
                    <div class="col">
                        <label>Part No / SKU (Barcode)</label>
                        <input type="text" id="sku">
                    </div>
                </div>
                <div class="row">
                    <div class="col">
                        <label>Under Group</label>
                        <select id="group">
                            </select>
                    </div>
                    <div class="col">
                        <label>Unit *</label>
                        <select id="unit">
                            </select>
                    </div>
                </div>

                <div class="section-header">GST & HSN Details</div>
                <div class="row">
                    <div class="col">
                        <label>Taxability</label>
                        <select id="taxability" onchange="toggleTaxFields()">
                            <option value="Taxable">Taxable</option>
                            <option value="Exempt">Exempt</option>
                            <option value="Nil Rated">Nil Rated</option>
                        </select>
                    </div>
                    <div class="col">
                        <label>HSN / SAC Code</label>
                        <input type="text" id="hsn">
                    </div>
                    <div class="col-small">
                        <label>GST Rate (%)</label>
                        <input type="number" id="gstRate" placeholder="18">
                    </div>
                </div>

                <div class="section-header">Pricing & Reorder Limits</div>
                <div class="row">
                    <div class="col">
                        <label>Standard Cost (Purchase Rate)</label>
                        <input type="number" id="stdCost" placeholder="0.00">
                    </div>
                    <div class="col">
                        <label>Standard Selling Price</label>
                        <input type="number" id="stdPrice" placeholder="0.00">
                    </div>
                    <div class="col">
                        <label>MRP</label>
                        <input type="number" id="mrp" placeholder="0.00">
                    </div>
                </div>
                <div class="row">
                    <div class="col">
                        <label>Low Stock Warning Limit</label>
                        <input type="number" id="reorderLevel" placeholder="e.g. 10">
                    </div>
                </div>

                <div class="section-header">Opening Balance</div>
                <div class="row">
                    <div class="col">
                        <label>Opening Quantity</label>
                        <input type="number" id="opQty" value="0" oninput="calcOpValue()">
                    </div>
                    <div class="col">
                        <label>Rate (per Unit)</label>
                        <input type="number" id="opRate" value="0" oninput="calcOpValue()">
                    </div>
                    <div class="col">
                        <label>Value (Total)</label>
                        <input type="number" id="opValue" value="0" readonly>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <div class="footer">
        <div><span class="key-badge">Alt+S</span> Save</div>
        <div><span class="key-badge">Alt+N</span> New</div>
        <div><span class="key-badge">Enter</span> Next</div>
        <div><span class="key-badge">Esc</span> Close</div>
    </div>

    <div id="toast">Item Saved Successfully!</div>

    <script src="db.js"></script>
    <script>
        window.onload = async function() {
            try {
                await DB.init();
                await loadDropdowns();
                await renderItemList();
                document.getElementById('name').focus();
            } catch (e) {
                alert("Database Error: Ensure db.js (Version 3) is present.");
            }
        };

        // --- LOAD DATA FROM DB ---
        async function loadDropdowns() {
            // Load Units
            const units = await DB.getUnits();
            const unitSelect = document.getElementById('unit');
            unitSelect.innerHTML = '<option value="">-- Select Unit --</option>';
            units.forEach(u => {
                let opt = document.createElement('option');
                opt.value = u.name;
                opt.innerText = `${u.name} - ${u.formal_name}`;
                unitSelect.appendChild(opt);
            });

            // Load Stock Groups
            const groups = await DB.getStockGroups();
            const grpSelect = document.getElementById('group');
            grpSelect.innerHTML = '<option value="">-- Select Group --</option>';
            groups.forEach(g => {
                let opt = document.createElement('option');
                opt.value = g.name;
                opt.innerText = g.name;
                grpSelect.appendChild(opt);
            });
        }

        // --- RENDER LIST ---
        async function renderItemList(query = '') {
            const items = await DB.getItems();
            const listDiv = document.getElementById('itemList');
            listDiv.innerHTML = '';

            const filtered = items.filter(i => i.name.toLowerCase().includes(query.toLowerCase()));

            if(filtered.length === 0) {
                listDiv.innerHTML = '<div style="padding:10px;text-align:center;color:#ccc">No Items</div>';
                return;
            }

            filtered.forEach(i => {
                let div = document.createElement('div');
                div.className = 'list-item';
                div.innerHTML = `
                    <div>
                        <div style="font-weight:600">${i.name}</div>
                        <div style="font-size:11px;color:#64748b">SKU: ${i.sku || '-'}</div>
                    </div>
                    <div style="text-align:right">
                        <span class="stock">${i.op_qty} ${i.unit}</span><br>
                        <span style="font-size:11px">â‚¹${i.std_price}</span>
                    </div>
                `;
                div.onclick = () => loadItemForEdit(i);
                listDiv.appendChild(div);
            });
        }

        // --- LOGIC ---
        function calcOpValue() {
            const qty = parseFloat(document.getElementById('opQty').value) || 0;
            const rate = parseFloat(document.getElementById('opRate').value) || 0;
            document.getElementById('opValue').value = (qty * rate).toFixed(2);
        }

        function toggleTaxFields() {
            const type = document.getElementById('taxability').value;
            const rateField = document.getElementById('gstRate');
            if(type === 'Exempt' || type === 'Nil Rated') {
                rateField.value = 0;
                rateField.readOnly = true;
            } else {
                rateField.readOnly = false;
            }
        }

        // --- SAVE ---
        async function saveItem() {
            const id = document.getElementById('itemId').value;
            const name = document.getElementById('name').value.trim();
            const unit = document.getElementById('unit').value;

            if(!name || !unit) {
                showToast("Name and Unit are required!", true);
                return;
            }

            const data = {
                id: id ? parseInt(id) : undefined,
                name: name,
                sku: document.getElementById('sku').value,
                group: document.getElementById('group').value || 'General',
                unit: unit,
                
                // GST
                taxability: document.getElementById('taxability').value,
                hsn: document.getElementById('hsn').value,
                gst_rate: parseFloat(document.getElementById('gstRate').value) || 0,

                // Pricing
                std_cost: parseFloat(document.getElementById('stdCost').value) || 0,
                std_price: parseFloat(document.getElementById('stdPrice').value) || 0,
                mrp: parseFloat(document.getElementById('mrp').value) || 0,
                reorder_level: parseFloat(document.getElementById('reorderLevel').value) || 0,

                // Opening
                op_qty: parseFloat(document.getElementById('opQty').value) || 0,
                op_rate: parseFloat(document.getElementById('opRate').value) || 0,
                op_value: parseFloat(document.getElementById('opValue').value) || 0
            };

            try {
                await DB.createItem(data);
                showToast("Item Saved!");
                resetForm();
                renderItemList();
            } catch(e) {
                showToast("Error: Item Name/SKU already exists!", true);
            }
        }

        function loadItemForEdit(i) {
            document.getElementById('itemId').value = i.id;
            document.getElementById('name').value = i.name;
            document.getElementById('sku').value = i.sku || '';
            document.getElementById('group').value = i.group || 'General';
            document.getElementById('unit').value = i.unit;
            document.getElementById('taxability').value = i.taxability || 'Taxable';
            document.getElementById('hsn').value = i.hsn || '';
            document.getElementById('gstRate').value = i.gst_rate || 0;
            document.getElementById('stdCost').value = i.std_cost || '';
            document.getElementById('stdPrice').value = i.std_price || '';
            document.getElementById('mrp').value = i.mrp || '';
            document.getElementById('reorderLevel').value = i.reorder_level || '';
            document.getElementById('opQty').value = i.op_qty || 0;
            document.getElementById('opRate').value = i.op_rate || 0;
            document.getElementById('opValue').value = i.op_value || 0;
            
            toggleTaxFields();
        }

        function resetForm() {
            document.querySelectorAll('input').forEach(i => i.value = '');
            document.getElementById('itemId').value = '';
            document.getElementById('unit').selectedIndex = 0;
            document.getElementById('opQty').value = 0;
            document.getElementById('name').focus();
        }

        function showToast(msg, isError = false) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.style.backgroundColor = isError ? '#991b1b' : '#166534';
            t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 3000);
        }

        // --- SHORTCUTS ---
        document.addEventListener('keydown', (e) => {
            if (e.altKey && e.key.toLowerCase() === 's') { e.preventDefault(); saveItem(); }
            if (e.altKey && e.key.toLowerCase() === 'n') { e.preventDefault(); resetForm(); }
            if (e.key === 'Escape') { window.location.href = 'index.html'; }
            if (e.key === 'Enter') {
                e.preventDefault();
                const inputs = Array.from(document.querySelectorAll('input, select'));
                const index = inputs.indexOf(document.activeElement);
                if (index > -1 && index < inputs.length - 1) inputs[index + 1].focus();
            }
        });
    </script>
</body>
</html>