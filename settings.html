<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <title>Control Center - Arth Book</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css"> 

    <style>
        /* Local overrides for Settings Layout */
        body { display: flex; background: var(--bg-color); height: 100vh; overflow: hidden; }
        .main-setting { flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; }
        
        .setting-header { margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center; }
        .setting-header h1 { font-size: 24px; color: var(--primary-color); margin: 0; }

        .tabs { display: flex; gap: 20px; border-bottom: 2px solid var(--border-color); margin-bottom: 20px; }
        .tab { padding: 12px 20px; cursor: pointer; font-weight: 600; color: #64748b; border-bottom: 3px solid transparent; transition: 0.3s; }
        .tab:hover { color: var(--primary-color); }
        .tab.active { color: var(--primary-color); border-bottom-color: var(--accent-color); }

        .tab-content { display: none; animation: fadeIn 0.3s ease; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: var(--shadow-sm); margin-bottom: 20px; border: 1px solid var(--border-color); }
        .card h3 { margin-top: 0; color: var(--primary-color); border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 20px; }

        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .form-group label { display: block; font-size: 13px; font-weight: 700; color: #475569; margin-bottom: 8px; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 6px; font-family: 'Inter'; }
        
        /* Toggle Switch */
        .switch { position: relative; display: inline-block; width: 50px; height: 26px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #cbd5e1; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--success-color); }
        input:checked + .slider:before { transform: translateX(24px); }

        .status-badge { padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; }
        .status-ok { background: #dcfce7; color: #166534; }
        .status-fail { background: #fee2e2; color: #991b1b; }

        .btn-primary { background: var(--primary-color); color: white; padding: 12px 25px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; }
        .btn-danger { background: var(--danger-color); color: white; padding: 12px 25px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="brand-logo" style="text-align:center; padding:20px; color:white; font-weight:800; font-size:20px;">
            <i class="fas fa-cogs"></i> Settings
        </div>
        <a href="index.html" class="nav-link"><i class="fas fa-arrow-left"></i> Back to Dashboard</a>
        <a href="#" class="nav-link active"><i class="fas fa-sliders-h"></i> General</a>
        <div style="margin-top:auto; padding:20px; color:#64748b; font-size:12px; text-align:center;">
            Arth Book v2.5<br>Secure Build
        </div>
    </div>

    <div class="main-setting">
        <div class="setting-header">
            <h1>System Configuration</h1>
            <button class="btn-primary" onclick="saveSettings()">üíæ Save All Changes</button>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="showTab('company')">üè¢ Company Profile</div>
            <div class="tab" onclick="showTab('cloud')">‚òÅÔ∏è Cloud Backup</div>
            <div class="tab" onclick="showTab('gst')">üì° GST & API</div>
            <div class="tab" onclick="showTab('data')">üóÑÔ∏è Data Tools</div>
        </div>

        <div id="company" class="tab-content active">
            <div class="card">
                <h3>Bill Header Details</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Business Name</label>
                        <input type="text" id="compName" placeholder="e.g. Laxmi Traders">
                    </div>
                    <div class="form-group">
                        <label>GSTIN</label>
                        <input type="text" id="compGST" placeholder="15 Digit GSTIN">
                    </div>
                    <div class="form-group">
                        <label>Address</label>
                        <textarea id="compAddr" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Phone / Mobile</label>
                        <input type="text" id="compPhone">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="compEmail">
                    </div>
                </div>
            </div>
            <div class="card">
                <h3>Bank Details (For Bill Print)</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Bank Name</label>
                        <input type="text" id="bankName">
                    </div>
                    <div class="form-group">
                        <label>Account Number</label>
                        <input type="text" id="bankAcc">
                    </div>
                    <div class="form-group">
                        <label>IFSC Code</label>
                        <input type="text" id="bankIFSC">
                    </div>
                    <div class="form-group">
                        <label>UPI ID (For QR Code)</label>
                        <input type="text" id="upiId" placeholder="e.g. 9876543210@ybl">
                    </div>
                </div>
            </div>
        </div>

        <div id="cloud" class="tab-content">
            <div class="card" style="border-left: 5px solid var(--accent-color);">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <h3>Auto-Sync Engine</h3>
                        <p style="color:#64748b; font-size:13px; margin-top:-15px;">Automatically backup data to GitHub/Drive on every save.</p>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="autoBackup">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>

            <div class="card">
                <h3>GitHub Connection (Private Repo)</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>GitHub Personal Access Token</label>
                        <input type="password" id="ghToken" placeholder="ghp_xxxxxxxxxxxx">
                    </div>
                    <div class="form-group">
                        <label>Repository Path (username/repo)</label>
                        <input type="text" id="ghRepo" placeholder="kasumalgarh/arthbook-data">
                    </div>
                </div>
                <div style="margin-top:20px;">
                    <button class="btn-primary" onclick="testCloudConnection()">üîÑ Test Connection</button>
                    <span id="cloudStatus" class="status-badge status-fail" style="display:none; margin-left:10px;">Disconnected</span>
                </div>
            </div>
        </div>

        <div id="gst" class="tab-content">
            <div class="card">
                <h3>e-Invoicing Credentials (GSP)</h3>
                <p style="font-size:12px; color:#64748b; margin-bottom:20px;">Required for generating IRN and e-Way Bills directly.</p>
                <div class="form-grid">
                    <div class="form-group">
                        <label>API Environment</label>
                        <select id="apiEnv">
                            <option value="sandbox">Sandbox (Testing)</option>
                            <option value="production">Production (Live)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>GSP Client ID</label>
                        <input type="text" id="gspId">
                    </div>
                    <div class="form-group">
                        <label>GSP Client Secret</label>
                        <input type="password" id="gspSecret">
                    </div>
                    <div class="form-group">
                        <label>GST Portal Username</label>
                        <input type="text" id="gstUser">
                    </div>
                </div>
            </div>
        </div>

        <div id="data" class="tab-content">
            <div class="card">
                <h3>Export Data</h3>
                <div style="display:flex; gap:15px;">
                    <button class="btn-primary" style="background:#16a34a;" onclick="TallyExport.exportToTally('2025-01-01', '2026-12-31')">
                        <i class="fas fa-file-excel"></i> Export to Tally XML
                    </button>
                    <button class="btn-primary" onclick="DB.exportBackup()">
                        <i class="fas fa-download"></i> Download Full Backup (JSON)
                    </button>
                </div>
            </div>

            <div class="card" style="border-color: var(--danger-color);">
                <h3 style="color:var(--danger-color);">Danger Zone</h3>
                <p style="font-size:13px; color:#ef4444;">Once you delete data, there is no going back. Please be certain.</p>
                <button class="btn-danger" onclick="factoryReset()">
                    <i class="fas fa-trash"></i> Factory Reset (Wipe All Data)
                </button>
            </div>
        </div>
    </div>

    <script src="db.js"></script>
    <script src="auth.js"></script>
    <script src="tally_bridge.js"></script>
    <script>
        function showTab(id) {
            document.querySelectorAll('.tab-content').forEach(d => d.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            event.target.classList.add('active');
        }

        window.onload = async () => {
            await DB.init();
            const s = await DB.getSettings();
            
            // Populate Fields
            document.getElementById('compName').value = s.company_name || '';
            document.getElementById('compGST').value = s.gstin || '';
            document.getElementById('compAddr').value = s.address || '';
            document.getElementById('compPhone').value = s.phone || '';
            document.getElementById('compEmail').value = s.email || '';
            
            document.getElementById('bankName').value = s.bank_name || '';
            document.getElementById('bankAcc').value = s.bank_account || '';
            document.getElementById('bankIFSC').value = s.bank_ifsc || '';
            document.getElementById('upiId').value = s.upi_id || '';

            document.getElementById('autoBackup').checked = s.auto_backup_enabled || false;
            document.getElementById('ghToken').value = s.github_token || '';
            document.getElementById('ghRepo').value = s.github_repo || '';

            document.getElementById('apiEnv').value = s.api_env || 'sandbox';
            document.getElementById('gspId').value = s.gsp_id || '';
            document.getElementById('gspSecret').value = s.gsp_secret || '';
            document.getElementById('gstUser').value = s.gst_user || '';
        };

        async function saveSettings() {
            const settings = {
                company_name: document.getElementById('compName').value,
                gstin: document.getElementById('compGST').value,
                address: document.getElementById('compAddr').value,
                phone: document.getElementById('compPhone').value,
                email: document.getElementById('compEmail').value,
                
                bank_name: document.getElementById('bankName').value,
                bank_account: document.getElementById('bankAcc').value,
                bank_ifsc: document.getElementById('bankIFSC').value,
                upi_id: document.getElementById('upiId').value,

                auto_backup_enabled: document.getElementById('autoBackup').checked,
                github_token: document.getElementById('ghToken').value,
                github_repo: document.getElementById('ghRepo').value,

                api_env: document.getElementById('apiEnv').value,
                gsp_id: document.getElementById('gspId').value,
                gsp_secret: document.getElementById('gspSecret').value,
                gst_user: document.getElementById('gstUser').value
            };

            await DB.saveSettings(settings);
            alert("‚úÖ Settings Saved Successfully!");
            
            // Trigger a sync if enabled
            if(settings.auto_backup_enabled && settings.github_token) {
                testCloudConnection();
            }
        }

        async function testCloudConnection() {
            const token = document.getElementById('ghToken').value;
            const repo = document.getElementById('ghRepo').value;
            const status = document.getElementById('cloudStatus');
            
            status.style.display = 'inline-block';
            status.innerText = "Testing...";
            status.className = "status-badge";
            
            if(!token || !repo) {
                status.innerText = "Missing Info";
                status.classList.add('status-fail');
                return;
            }

            const ok = await DB.syncToGithub(token, repo, 'connection_test.txt', 'Arth Book Connection OK');
            if(ok) {
                status.innerText = "Connected ‚úÖ";
                status.classList.add('status-ok');
            } else {
                status.innerText = "Connection Failed ‚ùå";
                status.classList.add('status-fail');
            }
        }

        function factoryReset() {
            if(confirm("‚ö†Ô∏è CRITICAL WARNING: This will delete ALL data (Customers, Stock, Bills). Are you sure?")) {
                const req = indexedDB.deleteDatabase('ArthBook_DB');
                req.onsuccess = () => {
                    localStorage.clear();
                    sessionStorage.clear();
                    alert("System Reset Complete. Refreshing...");
                    window.location.href = "login.html";
                };
            }
        }
    </script>
</body>
</html>