<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <title>Control Center - Arth Book</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<style>
    /* ARTH BOOK - SETTINGS ROYAL STYLE */
    :root {
        --primary: #0d47a1; --primary-dark: #002171; --accent: #ffca28;
        --bg: #f1f5f9; --surface: #ffffff; --text-main: #1e293b; --text-sub: #64748b;
        --border: #e2e8f0; --success: #16a34a; --danger: #dc2626; --sidebar-width: 260px;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', sans-serif; outline: none; }
    body { display: flex; height: 100vh; background: var(--bg); color: var(--text-main); overflow: hidden; }

    /* SIDEBAR */
    .sidebar { width: var(--sidebar-width); background: var(--primary) !important; color: white; display: flex; flex-direction: column; flex-shrink: 0; height: 100vh; overflow-y: auto; z-index: 2000; box-shadow: 4px 0 10px rgba(0,0,0,0.1); }
    .brand-logo { padding: 25px 20px; font-size: 22px; font-weight: 800; border-bottom: 1px solid rgba(255,255,255,0.1); color: white !important; }
    .nav-links { padding: 10px; list-style: none; } .nav-links li { margin-bottom: 5px; }
    .sidebar a { display: flex !important; align-items: center; gap: 12px; padding: 12px 15px; color: rgba(255,255,255,0.85) !important; text-decoration: none !important; border-radius: 8px; font-weight: 500; font-size: 14px; transition: 0.2s; }
    .sidebar a:hover { background: rgba(255,255,255,0.15) !important; color: #fff !important; padding-left: 20px; }
    .sidebar a.active { background: var(--accent) !important; color: var(--primary-dark) !important; font-weight: 800; }

    /* MAIN */
    .main-setting { flex: 1; display: flex; flex-direction: column; overflow-y: auto; background: var(--bg); }
    .setting-header { background: var(--surface); padding: 20px 30px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; position: sticky; top: 0; z-index: 100; }
    .setting-header h1 { font-size: 1.5rem; font-weight: 800; color: var(--primary); }

    /* TABS */
    .tabs { display: flex; background: #fff; padding: 0 30px; border-bottom: 1px solid var(--border); gap: 20px; overflow-x: auto; white-space: nowrap; }
    .tab { padding: 18px 5px; cursor: pointer; font-size: 14px; font-weight: 600; color: var(--text-sub); border-bottom: 3px solid transparent; transition: 0.2s; }
    .tab.active { color: var(--primary); border-bottom-color: var(--primary); }
    .tab-content { display: none; padding: 30px; max-width: 1000px; margin: 0 auto; width: 100%; }
    .tab-content.active { display: block; }

    /* CARDS */
    .card { background: #fff; border-radius: 16px; padding: 25px; margin-bottom: 25px; border: 1px solid var(--border); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
    .card h3 { font-size: 1rem; font-weight: 700; color: var(--primary); margin-bottom: 20px; border-left: 4px solid var(--accent); padding-left: 12px; }
    .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
    .form-group { display: flex; flex-direction: column; gap: 8px; }
    .form-group label { font-size: 12px; font-weight: 700; color: var(--text-sub); text-transform: uppercase; }
    input, select, textarea { padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px; background: #f8fafc; transition: 0.2s; width: 100%; }
    
    /* IMAGES & BUTTONS */
    .img-preview-box { width: 120px; height: 120px; border: 2px dashed var(--border); border-radius: 12px; margin-top: 10px; position: relative; display: flex; align-items: center; justify-content: center; overflow: hidden; }
    .img-preview-box img { width: 100%; height: 100%; object-fit: contain; }
    .remove-img { position: absolute; top: 5px; right: 5px; background: var(--danger); color: white; border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; display: none; }
    .btn-primary { padding: 12px 24px; border: none; border-radius: 8px; background: var(--primary); color: white; font-weight: 700; cursor: pointer; transition: 0.2s; font-size: 14px; }
    .btn-danger { background: #fee2e2; color: var(--danger); border: 1px solid #fecaca; padding: 12px 24px; border-radius: 8px; font-weight: 700; cursor: pointer; }
    
    /* TOGGLE */
    .switch { position: relative; display: inline-block; width: 50px; height: 26px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #cbd5e1; transition: .4s; border-radius: 34px; }
    .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: var(--success); }
    input:checked + .slider:before { transform: translateX(24px); }
    .status-badge { padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
    .status-ok { background: #dcfce7; color: #166534; }
    .status-fail { background: #fee2e2; color: #991b1b; }

    /* MOBILE */
    .menu-btn { display: none; font-size: 1.5rem; color: white; background: var(--primary); border: none; cursor: pointer; position: fixed; top: 15px; right: 15px; z-index: 3000; width: 45px; height: 45px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
    .overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2500; }
    @media (max-width: 900px) {
        .menu-btn { display: flex; align-items: center; justify-content: center; }
        .sidebar { position: fixed; left: -100%; transition: 0.3s; }
        .sidebar.active { left: 0; }
        .overlay.active { display: block; }
        .setting-header { flex-direction: column; align-items: stretch; text-align: center; padding-top: 70px; }
        .form-grid { grid-template-columns: 1fr; }
    }
</style>
<body>
    <button class="menu-btn" onclick="toggleMenu()">‚ò∞</button>
    <div class="overlay" onclick="toggleMenu()"></div>

    <div class="sidebar" id="sidebar">
        <div class="brand-logo"><i class="fas fa-cube"></i> Arth Book</div>
        <ul class="nav-links">
            <li><a href="index.html"><i class="fas fa-home"></i> Dashboard</a></li>
            <li style="margin:15px 0 5px 15px; font-size:11px; opacity:0.5; text-transform:uppercase;">Entry</li>
            <li><a href="sales_invoice.html"><i class="fas fa-file-invoice"></i> Sales</a></li>
            <li><a href="purchase_invoice.html"><i class="fas fa-truck"></i> Purchase</a></li>
            <li><a href="vouchers.html"><i class="fas fa-receipt"></i> Day Book</a></li>
            <li style="margin:15px 0 5px 15px; font-size:11px; opacity:0.5; text-transform:uppercase;">Masters</li>
            <li><a href="item_master.html"><i class="fas fa-boxes"></i> Inventory</a></li>
            <li><a href="ArthBook.html"><i class="fas fa-users"></i> Parties</a></li>
            <li><a href="coa.html"><i class="fas fa-sitemap"></i> Accounts</a></li>
            <li style="margin:15px 0 5px 15px; font-size:11px; opacity:0.5; text-transform:uppercase;">Reports</li>
            <li><a href="reports.html"><i class="fas fa-chart-line"></i> Reports</a></li>
            <li><a href="gst_filing.html"><i class="fas fa-university"></i> GST Returns</a></li>
            <li><a href="settings.html" class="active"><i class="fas fa-cog"></i> Settings</a></li>
        </ul>
    </div>

    <div class="main-setting">
        <div class="setting-header">
            <h1>System Configuration</h1>
            <button class="btn-primary" onclick="saveSettings()">üíæ Save All Changes</button>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="showTab('company')">üè¢ Company Profile</div>
            <div class="tab" onclick="showTab('invoice')">üñ®Ô∏è Invoice Settings</div>
            <div class="tab" onclick="showTab('cloud')">‚òÅÔ∏è Cloud Backup</div>
            <div class="tab" onclick="showTab('gst')">üì° GST & API</div>
            <div class="tab" onclick="showTab('data')">üóÑÔ∏è Data Tools</div>
        </div>

        <div id="company" class="tab-content active">
            <div class="card">
                <h3>Business Details</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Business Name</label>
                        <input type="text" id="compName" placeholder="e.g. Laxmi Traders">
                    </div>
                    <div class="form-group">
                        <label>State (Required for GST) *</label>
                        <select id="compState">
                            <option value="">Select State</option>
                            <option value="Andhra Pradesh">Andhra Pradesh</option><option value="Arunachal Pradesh">Arunachal Pradesh</option><option value="Assam">Assam</option><option value="Bihar">Bihar</option><option value="Chhattisgarh">Chhattisgarh</option><option value="Goa">Goa</option><option value="Gujarat">Gujarat</option><option value="Haryana">Haryana</option><option value="Himachal Pradesh">Himachal Pradesh</option><option value="Jharkhand">Jharkhand</option><option value="Karnataka">Karnataka</option><option value="Kerala">Kerala</option><option value="Madhya Pradesh">Madhya Pradesh</option><option value="Maharashtra">Maharashtra</option><option value="Manipur">Manipur</option><option value="Meghalaya">Meghalaya</option><option value="Mizoram">Mizoram</option><option value="Nagaland">Nagaland</option><option value="Odisha">Odisha</option><option value="Punjab">Punjab</option><option value="Rajasthan">Rajasthan</option><option value="Sikkim">Sikkim</option><option value="Tamil Nadu">Tamil Nadu</option><option value="Telangana">Telangana</option><option value="Tripura">Tripura</option><option value="Uttar Pradesh">Uttar Pradesh</option><option value="Uttarakhand">Uttarakhand</option><option value="West Bengal">West Bengal</option><option value="Delhi">Delhi</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>GSTIN</label>
                        <input type="text" id="compGST" placeholder="15 Digit GSTIN">
                    </div>
                    <div class="form-group">
                        <label>Address</label>
                        <textarea id="compAddr" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Phone / Mobile</label>
                        <input type="text" id="compPhone">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="compEmail">
                    </div>
                </div>
            </div>
            <div class="card">
                <h3>Bank Details (For Bill Print)</h3>
                <div class="form-grid">
                    <div class="form-group"><label>Bank Name</label><input type="text" id="bankName"></div>
                    <div class="form-group"><label>Account Number</label><input type="text" id="bankAcc"></div>
                    <div class="form-group"><label>IFSC Code</label><input type="text" id="bankIFSC"></div>
                    <div class="form-group"><label>UPI ID</label><input type="text" id="upiId"></div>
                </div>
            </div>
        </div>

        <div id="invoice" class="tab-content">
            <div class="card">
                <h3>Branding</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Company Logo</label>
                        <input type="file" id="logoInput" accept="image/*" onchange="handleImage(this, 'logo')">
                        <div class="img-preview-box" id="logoBox">
                            <span style="color:#94a3b8; font-size:12px;">No Logo</span>
                            <img id="logoPreview" style="display:none;">
                            <button class="remove-img" onclick="clearImage('logo')" id="btnRmLogo">√ó</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Signature</label>
                        <input type="file" id="signInput" accept="image/*" onchange="handleImage(this, 'sign')">
                        <div class="img-preview-box" id="signBox">
                            <span style="color:#94a3b8; font-size:12px;">No Signature</span>
                            <img id="signPreview" style="display:none;">
                            <button class="remove-img" onclick="clearImage('sign')" id="btnRmSign">√ó</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card">
                <h3>Bill Content</h3>
                <div class="form-group">
                    <label>Terms & Conditions</label>
                    <textarea id="terms" rows="6"></textarea>
                </div>
            </div>
        </div>

        <div id="cloud" class="tab-content">
            <div class="card" style="border-left: 5px solid #4285F4;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div><h3>Google Drive Sync</h3><p style="color:#64748b; font-size:13px; margin-top:-15px;">Auto backup enabled.</p></div>
                    <label class="switch"><input type="checkbox" id="autoBackup"><span class="slider"></span></label>
                </div>
            </div>
            <div class="card">
                <h3>Google Drive Connection</h3>
                <div style="display:flex; gap:15px; align-items:center; flex-wrap:wrap;">
                    <button class="btn-primary" style="background:white; color:#444; border:1px solid #ddd;" onclick="handleAuthClick()"><i class="fab fa-google"></i> Link Account</button>
                    <button class="btn-primary" style="background:#16a34a;" onclick="runManualDriveBackup()"><i class="fas fa-cloud-upload-alt"></i> Backup Now</button>
                    <span id="driveStatus" class="status-badge status-fail">Not Linked</span>
                </div>
                <div id="lastBackupInfo" style="margin-top:20px; font-size:12px; color:#64748b;">Last Sync: <span id="lastSyncTime">Never</span></div>
            </div>
        </div>

        <div id="gst" class="tab-content">
            <div class="card">
                <h3>e-Invoicing (API)</h3>
                <div class="form-grid">
                    <div class="form-group"><label>Environment</label><select id="apiEnv"><option value="sandbox">Sandbox</option><option value="production">Live</option></select></div>
                    <div class="form-group"><label>GSP Client ID</label><input type="text" id="gspId"></div>
                    <div class="form-group"><label>GSP Secret</label><input type="password" id="gspSecret"></div>
                    <div class="form-group"><label>Portal Username</label><input type="text" id="gstUser"></div>
                </div>
            </div>
        </div>

        <div id="data" class="tab-content">
            <div class="card">
                <h3>Export Data</h3>
                <div style="display:flex; gap:15px;">
                    <button class="btn-primary" style="background:#16a34a;" onclick="TallyExport.exportToTally('2025-01-01', '2026-12-31')"><i class="fas fa-file-excel"></i> Export Tally XML</button>
                    <button class="btn-primary" onclick="DB.exportBackup()"><i class="fas fa-download"></i> Full Backup (JSON)</button>
                </div>
            </div>
            <div class="card" style="border-color: var(--danger);">
                <h3 style="color:var(--danger);">Danger Zone</h3>
                <button class="btn-danger" onclick="factoryReset()"><i class="fas fa-trash"></i> Factory Reset</button>
            </div>
        </div>
    </div>

    <script src="db.js"></script>
    <script src="auth.js"></script>
    <script src="tally_bridge.js"></script>
    
    <script>
        const CLIENT_ID = '32983669609-i8c1qe1iqvtitq7nqmm9i186djsiqehm.apps.googleusercontent.com';
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';

        let tokenClient, accessToken = null;
        let logoBase64 = null, signBase64 = null;

        function showTab(id) {
            document.querySelectorAll('.tab-content').forEach(d => d.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            event.currentTarget.classList.add('active');
        }

        window.onload = async () => {
            await DB.init();
            let s = await DB.getSettings();
            if(Array.isArray(s) && s.length > 0) s = s[0];
            if(!s) s = {};

            // 1. Company
            document.getElementById('compName').value = s.company_name || '';
            document.getElementById('compGST').value = s.gstin || '';
            document.getElementById('compState').value = s.state || ''; // NEW: Load State
            document.getElementById('compAddr').value = s.address || '';
            document.getElementById('compPhone').value = s.phone || '';
            document.getElementById('compEmail').value = s.email || '';
            
            document.getElementById('bankName').value = s.bank_name || '';
            document.getElementById('bankAcc').value = s.bank_account || '';
            document.getElementById('bankIFSC').value = s.bank_ifsc || '';
            document.getElementById('upiId').value = s.upi_id || '';

            // 2. Invoice
            logoBase64 = s.logo || null;
            signBase64 = s.signature || null;
            document.getElementById('terms').value = s.terms || "1. Goods once sold will not be taken back.\n2. Interest @18% p.a. will be charged if not paid by due date.";

            if(logoBase64) showImg('logo', logoBase64);
            if(signBase64) showImg('sign', signBase64);

            // 3. System
            document.getElementById('autoBackup').checked = s.auto_backup_enabled || false;
            document.getElementById('lastSyncTime').innerText = s.last_sync || 'Never';
            document.getElementById('apiEnv').value = s.api_env || 'sandbox';
            document.getElementById('gspId').value = s.gsp_id || '';
            document.getElementById('gspSecret').value = s.gsp_secret || '';
            document.getElementById('gstUser').value = s.gst_user || '';

            initGoogleAuth();
        };

        function handleImage(input, type) {
            const file = input.files[0];
            if(!file) return;
            if(file.size > 512000) { alert("‚ö†Ô∏è Image too large (Max 500KB)"); input.value=""; return; }
            const reader = new FileReader();
            reader.onload = function(e) {
                const base64 = e.target.result;
                if(type === 'logo') { logoBase64 = base64; showImg('logo', base64); }
                else { signBase64 = base64; showImg('sign', base64); }
            };
            reader.readAsDataURL(file);
        }

        function showImg(type, src) {
            document.getElementById(type + 'Preview').src = src;
            document.getElementById(type + 'Preview').style.display = 'block';
            document.getElementById('btnRm' + (type==='logo'?'Logo':'Sign')).style.display = 'block';
            document.querySelector('#' + type + 'Box span').style.display = 'none';
        }

        function clearImage(type) {
            if(type === 'logo') {
                logoBase64 = null; document.getElementById('logoInput').value = '';
                document.getElementById('logoPreview').style.display = 'none';
                document.querySelector('#logoBox span').style.display = 'block';
                document.getElementById('btnRmLogo').style.display = 'none';
            } else {
                signBase64 = null; document.getElementById('signInput').value = '';
                document.getElementById('signPreview').style.display = 'none';
                document.querySelector('#signBox span').style.display = 'block';
                document.getElementById('btnRmSign').style.display = 'none';
            }
        }

        async function saveSettings() {
            const state = document.getElementById('compState').value;
            if(!state) return alert("‚ö†Ô∏è Please select Company State for GST.");

            const settings = {
                company_name: document.getElementById('compName').value,
                gstin: document.getElementById('compGST').value,
                state: state, // NEW: Saving State
                address: document.getElementById('compAddr').value,
                phone: document.getElementById('compPhone').value,
                email: document.getElementById('compEmail').value,
                bank_name: document.getElementById('bankName').value,
                bank_account: document.getElementById('bankAcc').value,
                bank_ifsc: document.getElementById('bankIFSC').value,
                upi_id: document.getElementById('upiId').value,
                logo: logoBase64,
                signature: signBase64,
                terms: document.getElementById('terms').value,
                auto_backup_enabled: document.getElementById('autoBackup').checked,
                last_sync: document.getElementById('lastSyncTime').innerText,
                api_env: document.getElementById('apiEnv').value,
                gsp_id: document.getElementById('gspId').value,
                gsp_secret: document.getElementById('gspSecret').value,
                gst_user: document.getElementById('gstUser').value
            };

            await DB.saveSettings(settings);
            alert("‚úÖ Settings Saved Successfully!");
        }

        function initGoogleAuth() {
            try {
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID, scope: SCOPES,
                    callback: (r) => { if (r.access_token) { accessToken = r.access_token; document.getElementById('driveStatus').innerText = "Linked ‚úÖ"; document.getElementById('driveStatus').className = "status-badge status-ok"; alert("Google Drive Linked!"); } }
                });
            } catch (e) {}
        }
        function handleAuthClick() { if (tokenClient) tokenClient.requestAccessToken(); else alert("Internet check karein."); }
        async function runManualDriveBackup() {
            if (!accessToken) return handleAuthClick();
            try { await DB.backupToGoogleDrive(accessToken); alert("Backup Uploaded!"); } catch(e){ alert("Backup Failed"); }
        }
        function factoryReset() {
            if(confirm("‚ö†Ô∏è CRITICAL: Wipe ALL data?")) {
                indexedDB.deleteDatabase('ArthBook_DB').onsuccess = () => { location.href="login.html"; };
            }
        }
        function toggleMenu() {
            document.getElementById('sidebar').classList.toggle('active');
            document.querySelector('.overlay').classList.toggle('active');
        }
    </script>
</body>
</html>