<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="icon" type="image/x-icon" href="favicon.ico">
    <title>Settings - Arth Book</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- 1. GLOBAL VARIABLES & RESET --- */
        :root {
            --primary-bg: #0f172a;   /* Dark Sidebar */
            --active-bg: #1e293b;    /* Hover State */
            --accent: #2563eb;       /* Blue Buttons */
            --bg-body: #f1f5f9;      /* Light Grey BG */
            --text-main: #1e293b;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --white: #ffffff;
            --green: #10b981;
            --red: #ef4444;
            --orange: #f59e0b;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', sans-serif; }
        body { display: flex; height: 100vh; background-color: var(--bg-body); color: var(--text-main); overflow: hidden; }

        /* --- 2. SIDEBAR (Fixed Design) --- */
        .sidebar {
            width: 260px;
            background-color: var(--primary-bg);
            color: #94a3b8;
            display: flex;
            flex-direction: column;
            padding: 20px;
            flex-shrink: 0; /* Prevent shrinking */
        }
        .brand {
            font-size: 20px; font-weight: 800; color: var(--white); margin-bottom: 40px;
            padding: 0 10px; display: flex; align-items: center; gap: 10px;
        }
        .nav-link {
            display: flex; align-items: center; gap: 12px;
            padding: 12px 15px;
            color: inherit; text-decoration: none;
            border-radius: 8px; margin-bottom: 5px;
            font-size: 14px; font-weight: 500;
            transition: 0.2s;
        }
        .nav-link:hover, .nav-link.active { background-color: var(--active-bg); color: var(--white); }
        .nav-link i { width: 20px; text-align: center; }

        /* --- 3. MAIN AREA --- */
        .main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }

        /* Tabs Header */
        .tabs-header {
            background: var(--white);
            padding: 15px 30px;
            border-bottom: 1px solid var(--border);
            display: flex; gap: 20px; overflow-x: auto;
        }
        .tab-btn {
            border: none; background: none;
            padding: 10px 5px;
            font-size: 14px; font-weight: 600; color: var(--text-muted);
            cursor: pointer; position: relative; white-space: nowrap;
        }
        .tab-btn.active { color: var(--accent); }
        .tab-btn.active::after {
            content: ''; position: absolute; bottom: -16px; left: 0; width: 100%; height: 3px; background: var(--accent); border-radius: 3px 3px 0 0;
        }

        /* Content Scroll Area */
        .content-area { flex: 1; overflow-y: auto; padding: 30px; }

        /* --- 4. CARDS & FORMS --- */
        .card {
            background: var(--white);
            border-radius: 12px;
            border: 1px solid var(--border);
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        }
        .card h3 { font-size: 16px; font-weight: 700; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid var(--border); color: var(--text-main); }

        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 15px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-size: 13px; font-weight: 600; color: var(--text-muted); margin-bottom: 6px; }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%; padding: 10px 12px;
            border: 1px solid var(--border); border-radius: 6px;
            font-size: 14px; outline: none; transition: 0.2s; background: #fff;
        }
        .form-group input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }

        /* --- 5. BUTTONS --- */
        .btn {
            padding: 10px 20px; border-radius: 6px; border: none; font-weight: 600; font-size: 14px; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; transition: 0.2s;
        }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-primary { background: var(--accent); color: white; }
        .btn-success { background: var(--green); color: white; }
        .btn-danger { background: var(--red); color: white; }
        .btn-warn { background: var(--orange); color: white; }

        /* --- 6. TABLE & TOGGLE --- */
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th { text-align: left; padding: 12px; background: #f8fafc; border-bottom: 2px solid var(--border); color: var(--text-muted); font-size: 13px; }
        td { padding: 12px; border-bottom: 1px solid var(--border); }
        
        /* Toggle Switch */
        .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #cbd5e1; transition: .4s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--accent); }
        input:checked + .slider:before { transform: translateX(20px); }

        /* Tabs Logic */
        .tab-content { display: none; animation: fadeIn 0.3s ease; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity:0; transform:translateY(5px); } to { opacity:1; transform:translateY(0); } }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="brand"><i class="fas fa-book"></i> Arth Book</div>
        <a href="index.html" class="nav-link"><i class="fas fa-chart-pie"></i> Dashboard</a>
        <a href="sales_invoice.html" class="nav-link"><i class="fas fa-cash-register"></i> Sales POS</a>
        <a href="purchase_invoice.html" class="nav-link"><i class="fas fa-truck"></i> Purchase</a>
        <a href="vouchers.html" class="nav-link"><i class="fas fa-receipt"></i> Vouchers</a>
        <a href="item_master.html" class="nav-link"><i class="fas fa-boxes"></i> Inventory</a>
        <a href="reports.html" class="nav-link"><i class="fas fa-chart-line"></i> Reports</a>
        <a href="settings.html" class="nav-link active"><i class="fas fa-cogs"></i> Settings</a>
    </div>

    <div class="main">
        <div class="tabs-header">
            <button class="tab-btn active" onclick="showTab('company')"><i class="fas fa-building"></i> Company</button>
            <button class="tab-btn" onclick="showTab('config')"><i class="fas fa-sliders-h"></i> Config</button>
            <button class="tab-btn" onclick="showTab('users')"><i class="fas fa-users"></i> Users</button>
            <button class="tab-btn" onclick="showTab('tools')"><i class="fas fa-plug"></i> Integration</button>
            <button class="tab-btn" onclick="showTab('logs')"><i class="fas fa-history"></i> Logs</button>
            <button class="tab-btn" onclick="showTab('backup')"><i class="fas fa-database"></i> Backup</button>
        </div>

        <div class="content-area">
            
            <div id="company" class="tab-content active">
                <div class="card">
                    <h3>Business Profile (Prints on Bill)</h3>
                    <div class="form-grid">
                        <div class="form-group"><label>Company Name</label><input type="text" id="compName" placeholder="e.g. My Super Store"></div>
                        <div class="form-group"><label>GSTIN / Tax ID</label><input type="text" id="compGST" placeholder="e.g. 27ABCDE1234F1Z5"></div>
                        <div class="form-group"><label>Address</label><input type="text" id="compAddr" placeholder="Full Address"></div>
                        <div class="form-group"><label>Phone</label><input type="text" id="compPhone" placeholder="Mobile No"></div>
                    </div>
                    <div class="form-group">
                        <label>Terms & Conditions</label>
                        <textarea id="compTerms" rows="2" placeholder="e.g. Goods once sold will not be taken back."></textarea>
                    </div>
                    <button class="btn btn-primary" onclick="saveCompany()"><i class="fas fa-save"></i> Save Profile</button>
                </div>
            </div>

            <div id="config" class="tab-content">
                <div class="card">
                    <h3>System Preferences</h3>
                    <div class="form-group" style="max-width: 300px;">
                        <label>Printer Format</label>
                        <select id="printFormat">
                            <option value="A4">A4 Standard (Laser)</option>
                            <option value="THERMAL">Thermal Roll (POS)</option>
                        </select>
                    </div>
                    
                    <h3 style="margin-top:30px;">üõ°Ô∏è Iron Dome Security</h3>
                    <div style="background:#f8fafc; padding:15px; border-radius:8px; display:flex; justify-content:space-between; align-items:center; border:1px solid var(--border);">
                        <div>
                            <strong>üëª Ghost Mode</strong>
                            <div style="font-size:13px; color:var(--text-muted);">Encrypts local data & hides financial values on dashboard.</div>
                        </div>
                        <label class="switch"><input type="checkbox" id="ghostSwitch" onchange="toggleGhost()"><span class="slider"></span></label>
                    </div>
                    <br>
                    <button class="btn btn-primary" onclick="saveConfig()"><i class="fas fa-check"></i> Update Config</button>
                </div>
            </div>

            <div id="users" class="tab-content">
                <div class="card">
                    <h3>Create New User</h3>
                    <div class="form-grid">
                        <div class="form-group"><label>Username</label><input type="text" id="uUser"></div>
                        <div class="form-group"><label>Password</label><input type="password" id="uPass"></div>
                        <div class="form-group"><label>Role</label>
                            <select id="uRole">
                                <option value="operator">Operator</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn btn-success" onclick="createUser()"><i class="fas fa-user-plus"></i> Add Secure User</button>
                </div>
                
                <div class="card">
                    <h3>Active Users</h3>
                    <table id="userTable"><thead><tr><th>User</th><th>Role</th><th>Action</th></tr></thead><tbody></tbody></table>
                </div>
            </div>

            <div id="tools" class="tab-content">
                <div class="card">
                    <h3>üîå Data Integration</h3>
                    <p style="color:var(--text-muted); margin-bottom:15px;">Export your data for external accounting software.</p>
                    <div style="display:flex; gap:10px;">
                        <button class="btn btn-warn" onclick="exportTally()"><i class="fas fa-file-code"></i> Export Tally XML</button>
                        <button class="btn btn-success" onclick="alert('Use Reports tab for Excel!')"><i class="fas fa-file-excel"></i> Export Excel</button>
                    </div>
                </div>
            </div>

            <div id="logs" class="tab-content">
                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                        <h3>üïµÔ∏è Audit Trail</h3>
                        <button class="btn btn-primary" style="padding:5px 10px; font-size:12px;" onclick="renderLogs()"><i class="fas fa-sync"></i> Refresh</button>
                    </div>
                    <div style="max-height:400px; overflow-y:auto; border:1px solid var(--border); border-radius:6px;">
                        <table id="logTable">
                            <thead><tr><th>Time</th><th>User</th><th>Action</th><th>Details</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="backup" class="tab-content">
                <div class="card">
                    <h3>üîÑ Auto-Backup System</h3>
                    <div style="display:flex; align-items:center; margin-bottom:20px; background:#eff6ff; padding:15px; border-radius:8px; border:1px solid #bfdbfe;">
                        <div style="flex:1;">
                            <strong style="color:#1d4ed8;">Auto-Download Backup</strong><br>
                            <small style="color:#3b82f6;">Automatically downloads backup every 60 minutes.</small>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="autoBackupToggle" onchange="toggleAutoBackup()">
                            <span class="slider"></span>
                        </label>
                    </div>

                    <div class="form-grid">
                        <div style="border:1px dashed var(--border); padding:20px; text-align:center; border-radius:8px;">
                            <h4 style="margin-bottom:10px;">Manual Backup</h4>
                            <button class="btn btn-primary" onclick="exportBackup()"><i class="fas fa-download"></i> Download JSON</button>
                        </div>
                        <div style="border:1px dashed var(--border); padding:20px; text-align:center; border-radius:8px;">
                            <h4 style="margin-bottom:10px;">Restore Data</h4>
                            <input type="file" id="restoreFile" onchange="handleRestore(this)" style="display:none;">
                            <button class="btn btn-warn" onclick="document.getElementById('restoreFile').click()"><i class="fas fa-upload"></i> Upload & Restore</button>
                        </div>
                    </div>
                </div>
                
                <div class="card" style="border-left:5px solid var(--red);">
                    <h3 style="color:var(--red);">‚ö†Ô∏è Danger Zone</h3>
                    <p style="margin-bottom:15px; font-size:13px;">This will permanently delete all data.</p>
                    <button class="btn btn-danger" onclick="hardReset()"><i class="fas fa-trash"></i> Factory Reset</button>
                </div>
            </div>

        </div>
    </div>

    <script src="security_utils.js"></script>
    <script src="db.js"></script>
    <script>
        // INIT
        window.onload = async () => {
            await DB.init();
            
            // Admin Check
            const u = JSON.parse(sessionStorage.getItem('user_session'));
            if(u && u.role !== 'admin') {
                document.querySelector('.content-area').innerHTML = '<div class="card"><h3>‚õî Access Denied: Admin Only</h3></div>';
                return;
            }

            loadSettings();
            renderUsers();
            renderLogs();
            
            const pref = localStorage.getItem('autoBackup');
            document.getElementById('autoBackupToggle').checked = pref === 'true';
            if(pref === 'true') startAutoBackupTimer();
        };

        function showTab(id) {
            document.querySelectorAll('.tab-content').forEach(d => d.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            event.target.classList.add('active');
        }

        // --- SETTINGS LOGIC ---
        async function loadSettings() {
            const s = await DB.getSettings();
            if(s) {
                document.getElementById('compName').value = s.name || '';
                document.getElementById('compGST').value = s.gstin || '';
                document.getElementById('compAddr').value = s.address || '';
                document.getElementById('compPhone').value = s.phone || '';
                document.getElementById('compTerms').value = s.terms || '';
            }
            const c = await DB.getOne('settings', 'config');
            if(c) {
                document.getElementById('printFormat').value = c.print_format || 'A4';
                document.getElementById('ghostSwitch').checked = c.ghost_mode || false;
            }
        }
        async function saveCompany() {
            await DB.saveSettings({
                name: document.getElementById('compName').value,
                gstin: document.getElementById('compGST').value,
                address: document.getElementById('compAddr').value,
                phone: document.getElementById('compPhone').value,
                terms: document.getElementById('compTerms').value
            });
            alert("‚úÖ Profile Saved!");
        }
        async function saveConfig() {
            const tx = DB.db.transaction('settings', 'readwrite');
            tx.objectStore('settings').put({
                id: 'config',
                print_format: document.getElementById('printFormat').value,
                ghost_mode: document.getElementById('ghostSwitch').checked
            });
            alert("‚úÖ Preferences Updated!");
        }
        function toggleGhost() {
            if(document.getElementById('ghostSwitch').checked) alert("üëª Ghost Mode Enabled: Data encrypted.");
        }

        // --- USERS ---
        async function renderUsers() {
            const users = await DB.getAll('users');
            const tbody = document.getElementById('userTable').querySelector('tbody');
            tbody.innerHTML = '';
            users.forEach(u => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${u.username}</td><td><span style="background:#e0f2fe; color:#0369a1; padding:2px 6px; border-radius:4px; font-size:12px;">${u.role}</span></td>
                <td>${u.username !== 'admin' ? `<button class="btn btn-danger" style="padding:4px 8px; font-size:12px;" onclick="delUser('${u.username}')"><i class="fas fa-trash"></i></button>` : ''}</td>`;
                tbody.appendChild(tr);
            });
        }
        async function createUser() {
            const u = document.getElementById('uUser').value;
            const p = document.getElementById('uPass').value;
            if(!u || !p) return alert("Fill all fields");
            
            const hash = await Security.hashPassword(p); 
            try {
                const tx = DB.db.transaction('users', 'readwrite');
                tx.objectStore('users').add({
                    username: u, password: hash, role: document.getElementById('uRole').value, name: u
                });
                tx.oncomplete = () => { alert("User Added!"); renderUsers(); };
            } catch(e) { alert("User already exists!"); }
        }
        async function delUser(username) {
            if(confirm("Delete User?")) {
                const tx = DB.db.transaction('users', 'readwrite');
                tx.objectStore('users').delete(username);
                tx.oncomplete = () => renderUsers();
            }
        }

        // --- BACKUP ---
        let backupInterval;
        function toggleAutoBackup() {
            const isOn = document.getElementById('autoBackupToggle').checked;
            localStorage.setItem('autoBackup', isOn);
            if(isOn) { alert("‚úÖ Auto-Backup Started (Hourly)"); startAutoBackupTimer(); }
            else { clearInterval(backupInterval); }
        }
        function startAutoBackupTimer() {
            clearInterval(backupInterval);
            backupInterval = setInterval(() => exportBackup(true), 3600000); 
        }
        async function exportBackup(silent = false) {
            const stores = ['vouchers', 'items', 'ledgers', 'acct_entries', 'groups', 'settings', 'users', 'logs'];
            const data = {};
            for(let s of stores) data[s] = await DB.getAll(s);
            const blob = new Blob([JSON.stringify(data)], {type: "application/json"});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `ArthBook_Backup_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
            if(!silent) alert("Backup Downloaded!");
        }
        function handleRestore(input) {
            const reader = new FileReader();
            reader.onload = async (e) => {
                if(!confirm("‚ö†Ô∏è Restore Data? This will overwrite existing data.")) return;
                try {
                    const data = JSON.parse(e.target.result);
                    const tx = DB.db.transaction(Object.keys(data), 'readwrite');
                    for(let k in data) if(data[k]) data[k].forEach(i => tx.objectStore(k).put(i));
                    alert("‚úÖ Restore Complete! Reloading..."); location.reload();
                } catch(err) { alert("Invalid File"); }
            };
            reader.readAsText(input.files[0]);
        }

        // --- LOGS ---
        async function renderLogs() {
            const logs = await DB.getAll('logs');
            logs.sort((a,b) => b.timestamp - a.timestamp);
            const tbody = document.getElementById('logTable').querySelector('tbody');
            tbody.innerHTML = '';
            logs.slice(0, 50).forEach(l => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td style="color:var(--text-muted); font-size:12px;">${new Date(l.timestamp).toLocaleString()}</td><td><b>${l.user}</b></td><td>${l.action}</td><td>${l.description}</td>`;
                tbody.appendChild(tr);
            });
        }

        // --- TALLY ---
        async function exportTally() {
            const vouchers = await DB.getAll('vouchers');
            let xml = '<ENVELOPE><HEADER><TALLYREQUEST>Import Data</TALLYREQUEST></HEADER><BODY><IMPORTDATA><REQUESTDESC><REPORTNAME>Vouchers</REPORTNAME></REQUESTDESC><REQUESTDATA>';
            vouchers.forEach(v => {
                xml += `<TALLYMESSAGE><VOUCHER><DATE>${v.date.replace(/-/g,'')}</DATE><NARRATION>${v.narration||''}</NARRATION><VOUCHERTYPENAME>${v.type}</VOUCHERTYPENAME><VOUCHERNUMBER>${v.voucher_no}</VOUCHERNUMBER></VOUCHER></TALLYMESSAGE>`;
            });
            xml += '</REQUESTDATA></IMPORTDATA></BODY></ENVELOPE>';
            const blob = new Blob([xml], {type: "text/xml"});
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = "TallyExport.xml";
            a.click();
        }

        function hardReset() {
            if(confirm("üî• FACTORY RESET? ALL DATA WILL BE DELETED!")) {
                indexedDB.deleteDatabase("ArthBook_DB"); 
                alert("System Reset."); location.reload();
            }
        }
    </script>
</body>
</html>