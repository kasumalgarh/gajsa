<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <title>Control Center - Arth Book</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="https://accounts.google.com/gsi/client" async defer></script>


</head>
<body>

   <div class="sidebar" id="sidebar">
        <div class="brand-logo" style="padding: 20px; font-size: 20px; font-weight: 800; color: white; display: flex; align-items: center; gap: 10px;">
            <i class="fas fa-cube"></i> Arth Book
        </div>
        <ul class="nav-links" style="list-style: none; padding: 0 10px;">
            <li><a href="index.html"><i class="fas fa-home"></i> Dashboard</a></li>
            <li><a href="sales_invoice.html"><i class="fas fa-file-invoice"></i> Sales (POS)</a></li>
            <li><a href="purchase_invoice.html"><i class="fas fa-truck"></i> Purchase</a></li>
            <li><a href="vouchers.html"><i class="fas fa-receipt"></i> Day Book</a></li>
            
            <li style="margin-top:15px; margin-bottom:5px; font-size:11px; color:#64748b; font-weight:bold; padding-left:15px; text-transform:uppercase;">Masters</li>
            <li><a href="item_master.html"><i class="fas fa-boxes"></i> Inventory</a></li>
            <li><a href="ArthBook.html"><i class="fas fa-users"></i> Parties</a></li>
            <li><a href="coa.html"><i class="fas fa-sitemap"></i> Accounts</a></li>
            
            <li style="margin-top:15px; margin-bottom:5px; font-size:11px; color:#64748b; font-weight:bold; padding-left:15px; text-transform:uppercase;">Reports & Tax</li>
            <li><a href="reports.html"><i class="fas fa-chart-line"></i> Reports</a></li>
            <li><a href="gst_filing.html"><i class="fas fa-university"></i> GST Returns</a></li>
            <li><a href="taxation.html"><i class="fas fa-calculator"></i> Tax / ITR</a></li>
            
            <hr style="border:0; border-top:1px solid rgba(255,255,255,0.1); margin:15px 5px;">
            <li><a href="settings.html" class="active"><i class="fas fa-cog"></i> Settings</a></li>
            <li><a href="help.html"><i class="fas fa-question-circle"></i> Help</a></li>
        </ul>
        
        <div style="padding: 20px; font-size: 11px; color: #64748b; text-align: center; margin-top:auto;">
            Arth Book v4.2<br>Authorized User
        </div>
    </div>

    <div class="main-setting">
        <div class="setting-header">
            <h1>System Configuration</h1>
            <button class="btn-primary" onclick="saveSettings()">üíæ Save All Changes</button>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="showTab('company')">üè¢ Company Profile</div>
            <div class="tab" onclick="showTab('invoice')">üñ®Ô∏è Invoice Settings</div>
            <div class="tab" onclick="showTab('cloud')">‚òÅÔ∏è Cloud Backup</div>
            <div class="tab" onclick="showTab('gst')">üì° GST & API</div>
            <div class="tab" onclick="showTab('data')">üóÑÔ∏è Data Tools</div>
        </div>

        <div id="company" class="tab-content active">
            <div class="card">
                <h3>Business Details</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Business Name</label>
                        <input type="text" id="compName" placeholder="e.g. Laxmi Traders">
                    </div>
                    <div class="form-group">
                        <label>GSTIN</label>
                        <input type="text" id="compGST" placeholder="15 Digit GSTIN">
                    </div>
                    <div class="form-group">
                        <label>Address</label>
                        <textarea id="compAddr" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Phone / Mobile</label>
                        <input type="text" id="compPhone">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="compEmail">
                    </div>
                </div>
            </div>
            <div class="card">
                <h3>Bank Details (For Bill Print)</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Bank Name</label>
                        <input type="text" id="bankName">
                    </div>
                    <div class="form-group">
                        <label>Account Number</label>
                        <input type="text" id="bankAcc">
                    </div>
                    <div class="form-group">
                        <label>IFSC Code</label>
                        <input type="text" id="bankIFSC">
                    </div>
                    <div class="form-group">
                        <label>UPI ID (For QR Code)</label>
                        <input type="text" id="upiId" placeholder="e.g. 9876543210@ybl">
                    </div>
                </div>
            </div>
        </div>

        <div id="invoice" class="tab-content">
            <div class="card">
                <h3>Branding</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Company Logo (Max 500KB)</label>
                        <input type="file" id="logoInput" accept="image/*" onchange="handleImage(this, 'logo')">
                        <div class="img-preview-box" id="logoBox">
                            <span style="color:#94a3b8; font-size:12px;">No Logo</span>
                            <img id="logoPreview" style="display:none;">
                            <button class="remove-img" onclick="clearImage('logo')" id="btnRmLogo">√ó</button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Authorized Signature (Max 500KB)</label>
                        <input type="file" id="signInput" accept="image/*" onchange="handleImage(this, 'sign')">
                        <div class="img-preview-box" id="signBox">
                            <span style="color:#94a3b8; font-size:12px;">No Signature</span>
                            <img id="signPreview" style="display:none;">
                            <button class="remove-img" onclick="clearImage('sign')" id="btnRmSign">√ó</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>Bill Content</h3>
                <div class="form-group">
                    <label>Terms & Conditions (Printed on Invoice)</label>
                    <textarea id="terms" rows="6" placeholder="1. Goods once sold will not be taken back..."></textarea>
                </div>
            </div>
        </div>

        <div id="cloud" class="tab-content">
            <div class="card" style="border-left: 5px solid #4285F4;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <h3>Google Drive Auto-Sync</h3>
                        <p style="color:#64748b; font-size:13px; margin-top:-15px;">Your data is securely backed up to your personal Google Drive account.</p>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="autoBackup">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>

            <div class="card">
                <h3>Google Drive Connection</h3>
                <div style="display:flex; gap:15px; align-items:center; flex-wrap:wrap;">
                    <button class="btn-primary btn-google" onclick="handleAuthClick()">
                        <i class="fab fa-google"></i> Link Google Account
                    </button>
                    <button class="btn-primary" style="background:#16a34a;" onclick="runManualDriveBackup()">
                        <i class="fas fa-cloud-upload-alt"></i> Backup Now to Drive
                    </button>
                    <span id="driveStatus" class="status-badge status-fail">Not Linked</span>
                </div>
                
                <div id="lastBackupInfo" style="margin-top:20px; font-size:12px; color:#64748b;">
                    Last Cloud Sync: <span id="lastSyncTime">Never</span>
                </div>
            </div>
        </div>

        <div id="gst" class="tab-content">
            <div class="card">
                <h3>e-Invoicing Credentials (GSP)</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>API Environment</label>
                        <select id="apiEnv">
                            <option value="sandbox">Sandbox (Testing)</option>
                            <option value="production">Production (Live)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>GSP Client ID</label>
                        <input type="text" id="gspId">
                    </div>
                    <div class="form-group">
                        <label>GSP Client Secret</label>
                        <input type="password" id="gspSecret">
                    </div>
                    <div class="form-group">
                        <label>GST Portal Username</label>
                        <input type="text" id="gstUser">
                    </div>
                </div>
            </div>
        </div>

        <div id="data" class="tab-content">
            <div class="card">
                <h3>Export Data</h3>
                <div style="display:flex; gap:15px; flex-wrap:wrap;">
                    <button class="btn-primary" style="background:#16a34a;" onclick="TallyExport.exportToTally('2025-01-01', '2026-12-31')">
                        <i class="fas fa-file-excel"></i> Export to Tally XML
                    </button>
                    <button class="btn-primary" onclick="DB.exportBackup()">
                        <i class="fas fa-download"></i> Download Full Backup (JSON)
                    </button>
                </div>
            </div>

            <div class="card" style="border-color: var(--danger-color);">
                <h3 style="color:var(--danger-color);">Danger Zone</h3>
                <button class="btn-danger" onclick="factoryReset()">
                    <i class="fas fa-trash"></i> Factory Reset (Wipe All Data)
                </button>
            </div>
        </div>
    </div>

    <script src="db.js"></script>
    <script src="auth.js"></script>
    <script src="tally_bridge.js"></script>
    
    <script>
        const CLIENT_ID = '32983669609-i8c1qe1iqvtitq7nqmm9i186djsiqehm.apps.googleusercontent.com';
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';

        let tokenClient;
        let accessToken = null;
        let logoBase64 = null;
        let signBase64 = null;

        function showTab(id) {
            document.querySelectorAll('.tab-content').forEach(d => d.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            event.currentTarget.classList.add('active');
        }

        window.onload = async () => {
            await DB.init();
            let s = await DB.getSettings();
            
            if(Array.isArray(s) && s.length > 0) s = s[0];
            if(!s) s = {};

            // 1. Company Profile
            document.getElementById('compName').value = s.company_name || '';
            document.getElementById('compGST').value = s.gstin || '';
            document.getElementById('compAddr').value = s.address || '';
            document.getElementById('compPhone').value = s.phone || '';
            document.getElementById('compEmail').value = s.email || '';
            
            document.getElementById('bankName').value = s.bank_name || '';
            document.getElementById('bankAcc').value = s.bank_account || '';
            document.getElementById('bankIFSC').value = s.bank_ifsc || '';
            document.getElementById('upiId').value = s.upi_id || '';

            // 2. Invoice Settings
            logoBase64 = s.logo || null;
            signBase64 = s.signature || null;
            document.getElementById('terms').value = s.terms || "1. Goods once sold will not be taken back.\n2. Interest @18% p.a. will be charged if not paid by due date.\n3. Subject to local jurisdiction.";

            if(logoBase64) showImg('logo', logoBase64);
            if(signBase64) showImg('sign', signBase64);

            // 3. System
            document.getElementById('autoBackup').checked = s.auto_backup_enabled || false;
            document.getElementById('lastSyncTime').innerText = s.last_sync || 'Never';
            document.getElementById('apiEnv').value = s.api_env || 'sandbox';
            document.getElementById('gspId').value = s.gsp_id || '';
            document.getElementById('gspSecret').value = s.gsp_secret || '';
            document.getElementById('gstUser').value = s.gst_user || '';

            initGoogleAuth();
        };

        // --- UPDATED IMAGE HANDLER (Limit: 500KB) ---
        function handleImage(input, type) {
            const file = input.files[0];
            if(!file) return;
            
            if(file.size > 512000) { // Limit increased to 500KB (512,000 bytes)
                alert("‚ö†Ô∏è Image is too large! Please use a smaller image (under 500KB).");
                input.value = "";
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const base64 = e.target.result;
                if(type === 'logo') {
                    logoBase64 = base64;
                    showImg('logo', base64);
                } else {
                    signBase64 = base64;
                    showImg('sign', base64);
                }
            };
            reader.readAsDataURL(file);
        }

        function showImg(type, src) {
            document.getElementById(type + 'Preview').src = src;
            document.getElementById(type + 'Preview').style.display = 'block';
            document.getElementById('btnRm' + (type.charAt(0).toUpperCase() + type.slice(1))).style.display = 'block';
            document.querySelector('#' + type + 'Box span').style.display = 'none';
        }

        function clearImage(type) {
            if(type === 'logo') {
                logoBase64 = null;
                document.getElementById('logoInput').value = '';
                document.getElementById('logoPreview').style.display = 'none';
                document.querySelector('#logoBox span').style.display = 'block';
                document.getElementById('btnRmLogo').style.display = 'none';
            } else {
                signBase64 = null;
                document.getElementById('signInput').value = '';
                document.getElementById('signPreview').style.display = 'none';
                document.querySelector('#signBox span').style.display = 'block';
                document.getElementById('btnRmSign').style.display = 'none';
            }
        }

        async function saveSettings() {
            const settings = {
                company_name: document.getElementById('compName').value,
                gstin: document.getElementById('compGST').value,
                address: document.getElementById('compAddr').value,
                phone: document.getElementById('compPhone').value,
                email: document.getElementById('compEmail').value,
                bank_name: document.getElementById('bankName').value,
                bank_account: document.getElementById('bankAcc').value,
                bank_ifsc: document.getElementById('bankIFSC').value,
                upi_id: document.getElementById('upiId').value,

                logo: logoBase64,
                signature: signBase64,
                terms: document.getElementById('terms').value,

                auto_backup_enabled: document.getElementById('autoBackup').checked,
                last_sync: document.getElementById('lastSyncTime').innerText,
                api_env: document.getElementById('apiEnv').value,
                gsp_id: document.getElementById('gspId').value,
                gsp_secret: document.getElementById('gspSecret').value,
                gst_user: document.getElementById('gstUser').value
            };

            await DB.saveSettings(settings);
            alert("‚úÖ Settings Saved Successfully!");
        }

        function initGoogleAuth() {
            try {
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID, scope: SCOPES,
                    callback: (tokenResponse) => {
                        if (tokenResponse && tokenResponse.access_token) {
                            accessToken = tokenResponse.access_token;
                            document.getElementById('driveStatus').innerText = "Linked ‚úÖ";
                            document.getElementById('driveStatus').className = "status-badge status-ok";
                            alert("‚úÖ Google Drive successfully linked!");
                        }
                    },
                });
            } catch (e) { console.error("Google Auth Init Failed:", e); }
        }

        function handleAuthClick() {
            if (tokenClient) tokenClient.requestAccessToken();
            else alert("Google Library not loaded. Check internet.");
        }

        async function runManualDriveBackup() {
            if (!accessToken) return handleAuthClick();
            const btn = event.currentTarget;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
            btn.disabled = true;
            try {
                await DB.backupToGoogleDrive(accessToken);
                const now = new Date().toLocaleString();
                document.getElementById('lastSyncTime').innerText = now;
                const s = await DB.getSettings();
                s.last_sync = now;
                await DB.saveSettings(s);
                alert("‚úÖ Backup saved to Google Drive!");
            } catch (e) { alert("‚ùå Backup Failed."); } 
            finally { btn.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> Backup Now to Drive'; btn.disabled = false; }
        }

        function factoryReset() {
            if(confirm("‚ö†Ô∏è CRITICAL: This will wipe ALL data. Confirm?")) {
                const req = indexedDB.deleteDatabase('ArthBook_DB');
                req.onsuccess = () => {
                    localStorage.clear(); sessionStorage.clear();
                    alert("Reset Complete. Reloading...");
                    window.location.href = "login.html";
                };
            }
        }
    </script>
</body>
</html>