<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Reporting - Arth Book</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --sidebar-bg: #0f172a; --bg: #f8fafc; --text: #1e293b; --border: #cbd5e1;
            --accent: #2563eb; --red: #ef4444; --green: #10b981; --orange: #f59e0b;
        }
        * { box-sizing: border-box; font-family: 'Inter', sans-serif; margin: 0; padding: 0; }
        body { display: flex; height: 100vh; background: var(--bg); color: var(--text); overflow: hidden; }

        /* SIDEBAR */
        .sidebar { width: 260px; background: var(--sidebar-bg); padding: 20px; display: flex; flex-direction: column; flex-shrink: 0; }
        .nav-link { padding: 12px 15px; margin-bottom: 5px; border-radius: 8px; color: #94a3b8; text-decoration: none; font-weight: 500; display: block; font-size: 14px; }
        .nav-link:hover, .nav-link.active { background: #1e293b; color: #f8fafc; }

        /* MAIN LAYOUT */
        .main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        
        /* FILTERS BAR */
        .top-bar { background: white; padding: 15px 25px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 15px; flex-wrap: wrap; }
        select, input { padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px; font-size: 14px; outline:none; }
        
        .btn { padding: 8px 20px; border-radius: 6px; border: none; font-weight: 600; cursor: pointer; color: white; transition:0.2s; }
        .btn-go { background: var(--accent); }
        .btn-print { background: #475569; margin-left: auto; }
        .btn-excel { background: var(--green); }

        /* REPORT CONTENT */
        .content-area { flex: 1; overflow-y: auto; padding: 25px; }
        .report-paper { background: white; min-height: 297mm; padding: 20mm; margin: 0 auto; max-width: 210mm; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; }
        
        h2 { text-align: center; text-transform: uppercase; color: var(--accent); margin-bottom: 5px; }
        .sub-head { text-align: center; font-size: 13px; color: #64748b; margin-bottom: 25px; }

        /* TABLES */
        table { width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 10px; }
        th { background: #f1f5f9; padding: 8px; text-align: left; border-bottom: 2px solid var(--border); }
        td { padding: 8px; border-bottom: 1px solid #eee; }
        .amt { text-align: right; font-family: monospace; font-weight: 600; font-size: 13px; }
        .bold-row { font-weight: 700; background: #f8fafc; border-top: 2px solid var(--border); }
        
        /* AI HEALTH CARD STYLES */
        .health-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .h-card { border: 1px solid #eee; padding: 15px; border-radius: 8px; }
        .ai-box { background: #f0f9ff; border: 1px solid #bae6fd; padding: 15px; border-radius: 8px; margin-bottom: 20px; }

        /* ALERTS */
        .exp-soon { color: var(--orange); font-weight: 700; }
        .exp-expired { color: var(--red); font-weight: 700; }

        @media print {
            .sidebar, .top-bar { display: none !important; }
            .content-area { padding: 0; }
            .report-paper { box-shadow: none; border: none; margin: 0; width: 100%; max-width: 100%; }
            .no-print { display: none; }
        }
    </style>
</head>
<body>

    <div class="sidebar">
        <div style="font-size: 20px; font-weight: 800; color: #fff; margin-bottom: 40px; padding: 0 10px;">Arth Book</div>
        <a href="index.html" class="nav-link">üìä Dashboard</a>
        <a href="reports.html" class="nav-link active">üìà Reports</a>
        <a href="gst_filing.html" class="nav-link">üèõÔ∏è GST Filing</a>
        <a href="sales_invoice.html" class="nav-link">üßæ Sales Invoice</a>
        <a href="purchase_invoice.html" class="nav-link">üöö Purchase Entry</a>
        <a href="vouchers.html" class="nav-link">üí∏ Vouchers (JV)</a>
        <a href="item_master.html" class="nav-link">üì¶ Inventory</a>
        <a href="ArthBook.html" class="nav-link">üë• Parties</a>
        <a href="coa.html" class="nav-link">üóÇÔ∏è Accounts</a>
        <a href="settings.html" class="nav-link">‚öôÔ∏è Settings</a>
    </div>

    <div class="main">
        <div class="top-bar">
            <select id="reportType" onchange="toggleFilters()">
                <option value="Health">üè• Business Health (AI)</option>
                <option value="BalanceSheet">‚öñÔ∏è Balance Sheet</option>
                <option value="PL">üìâ Profit & Loss</option>
                <option value="TrialBalance">üìë Trial Balance</option>
                <option value="DayBook">üìÖ Day Book</option>
                <option value="Ledger">üë§ Party Ledger</option>
                <option value="Stock">üì¶ Stock Summary</option>
                <option value="Expiry">‚ö†Ô∏è Expiry Report</option>
                <option value="LowStock">üìâ Low Stock Alert</option>
            </select>

            <div id="partyFilter" style="display:none;">
                <input type="text" id="partyInput" list="partyList" placeholder="Select Party..." onchange="resolvePartyId()">
                <datalist id="partyList"></datalist>
                <input type="hidden" id="finalPartyId">
            </div>

            <input type="date" id="fromDate">
            <input type="date" id="toDate">
            
            <button class="btn btn-go" onclick="generateReport()">Show</button>
            <button class="btn btn-excel" onclick="exportExcel()">üìä Excel</button>
            <button class="btn btn-print" onclick="window.print()">üñ®Ô∏è Print</button>
        </div>

        <div class="content-area">
            <div class="report-paper" id="reportContent">
                <div style="text-align:center; padding:100px; color:#cbd5e1;">
                    <h3>Ready for Analysis</h3>
                    <p>Select "Business Health" for AI Insights</p>
                </div>
            </div>
        </div>
    </div>

    <script src="security_utils.js"></script>
    <script src="db.js"></script>
    <script src="ai_engine.js"></script>

    <script>
        // --- GLOBAL VARIABLES ---
        let ledgers=[], items=[], groups=[], acctEntries=[], vouchers=[], batches=[];
        let ledgerMap = {};
        
        // Group Mapping (Assets, Liabilities, Income, Expenses)
        const GROUP_TYPES = {
            'Capital Account': 'Liabilities',
            'Loans (Liability)': 'Liabilities',
            'Current Liabilities': 'Liabilities',
            'Sundry Creditors': 'Liabilities',
            'Duties & Taxes': 'Liabilities',
            'Fixed Assets': 'Assets',
            'Current Assets': 'Assets',
            'Cash-in-Hand': 'Assets',
            'Bank Accounts': 'Assets',
            'Sundry Debtors': 'Assets',
            'Sales Accounts': 'Income',
            'Direct Incomes': 'Income',
            'Indirect Incomes': 'Income',
            'Purchase Accounts': 'Expenses',
            'Direct Expenses': 'Expenses',
            'Indirect Expenses': 'Expenses'
        };

        window.onload = async () => {
            await DB.init();
            // Load ALL Data for Analysis
            [ledgers, items, groups, acctEntries, vouchers, batches] = await Promise.all([
                DB.getLedgers(), DB.getItems(), DB.getGroups(), DB.getAll('acct_entries'), DB.getAll('vouchers'), DB.getAll('batches')
            ]);
            
            const d = new Date();
            document.getElementById('toDate').valueAsDate = d;
            document.getElementById('fromDate').valueAsDate = new Date(d.getFullYear(), d.getMonth(), 1);
            
            populateParties();
        };

        function populateParties() {
            const list = document.getElementById('partyList');
            ledgers.sort((a,b)=>a.name.localeCompare(b.name)).forEach(l => {
                ledgerMap[l.name] = l.id;
                let opt = document.createElement('option');
                opt.value = l.name;
                list.appendChild(opt);
            });
        }
        function resolvePartyId() {
            const val = document.getElementById('partyInput').value;
            document.getElementById('finalPartyId').value = ledgerMap[val] || '';
        }
        function toggleFilters() {
            const type = document.getElementById('reportType').value;
            document.getElementById('partyFilter').style.display = (type === 'Ledger') ? 'block' : 'none';
        }

        async function generateReport() {
            const type = document.getElementById('reportType').value;
            const container = document.getElementById('reportContent');
            container.innerHTML = '<div style="text-align:center; padding:50px;">Processing...</div>';

            setTimeout(async () => {
                if(type === 'Health') await renderHealth(container);
                else if(type === 'BalanceSheet') calculateBalanceSheet(container);
                else if(type === 'PL') calculatePL(container);
                else if(type === 'TrialBalance') calculateTrialBalance(container);
                else if(type === 'DayBook') renderDayBook(container);
                else if(type === 'Stock') renderStock(container);
                else if(type === 'Ledger') renderLedgerReport(container);
                else if(type === 'Expiry') renderExpiry(container);
                else if(type === 'LowStock') renderLowStock(container);
            }, 100);
        }

        // --- ACCOUNTING ENGINE ---
        function getLedgerBalance(ledgerId) {
            const l = ledgers.find(x => x.id === ledgerId);
            if(!l) return 0;
            let bal = l.opening_balance || 0;
            acctEntries.filter(e => e.ledger_id === ledgerId).forEach(e => {
                bal += (e.debit - e.credit);
            });
            return bal; 
        }

        function getGroupTotals() {
            const reportData = { Liabilities: {}, Assets: {}, Income: {}, Expenses: {} };
            ledgers.forEach(l => {
                const bal = getLedgerBalance(l.id);
                if(bal === 0) return;
                const grp = groups.find(g => g.id === l.group_id);
                const grpName = grp ? grp.name : 'Unknown';
                const rootType = GROUP_TYPES[grpName] || 'Liabilities';
                if(!reportData[rootType][grpName]) reportData[rootType][grpName] = 0;
                
                if(rootType === 'Liabilities' || rootType === 'Income') reportData[rootType][grpName] += (bal * -1); 
                else reportData[rootType][grpName] += bal;
            });
            return reportData;
        }

        // --- REPORT GENERATORS ---

        async function renderHealth(c) {
            const totalStockVal = items.reduce((s, i) => s + ((i.current_stock||0)*(i.std_cost||0)), 0);
            const prediction = await AI.predictCashFlow(); // Using AI Engine
            const forecast = prediction.prediction || 0;

            c.innerHTML = `
                <h2>Business Health Report</h2>
                <p class="sub-head">AI Powered Analysis ‚Ä¢ ${new Date().toLocaleDateString()}</p>
                
                <div class="ai-box">
                    <h3 style="color:#2563eb; margin-bottom:5px;">ü§ñ AI Oracle Prediction</h3>
                    <p style="font-size:14px; color:#555;">Based on your last 90 days of sales data, the system predicts:</p>
                    <div style="font-size:24px; font-weight:bold; margin-top:10px;">
                        Next Month Revenue: ‚Çπ${parseFloat(forecast).toLocaleString('en-IN')}
                    </div>
                    <small style="color:#666;">Daily Avg Sales: ‚Çπ${prediction.daily_avg}</small>
                </div>

                <div class="health-grid">
                    <div class="h-card">
                        <h4>Stock Valuation (Cost)</h4>
                        <div class="amt" style="font-size:20px;">‚Çπ${totalStockVal.toLocaleString('en-IN')}</div>
                    </div>
                    <div class="h-card">
                        <h4>Trend Analysis</h4>
                         <canvas id="healthChart" height="150"></canvas>
                    </div>
                </div>
            `;

            new Chart(document.getElementById('healthChart'), {
                type: 'bar',
                data: {
                    labels: ['Past 30 Days', 'Next 30 Days'],
                    datasets: [{
                        label: 'Revenue',
                        data: [parseFloat(prediction.daily_avg)*30, forecast],
                        backgroundColor: ['#cbd5e1', '#2563eb']
                    }]
                },
                options: { plugins: { legend: { display: false } } }
            });
        }

        function calculatePL(c) {
            const data = getGroupTotals();
            let totalInc = 0, totalExp = 0;
            Object.values(data.Income).forEach(v => totalInc += v);
            Object.values(data.Expenses).forEach(v => totalExp += v);
            let closingStock = items.reduce((s, i) => s + ((i.current_stock||0)*(i.std_cost||0)), 0);
            const netProfit = (totalInc + closingStock) - totalExp;

            let html = `<h2>Profit & Loss A/c</h2><p class="sub-head">As on ${new Date().toLocaleDateString()}</p>
            <div style="display:flex; gap:2px;">
                <div style="flex:1; border:1px solid #ccc;">
                    <div style="background:#f1f5f9; padding:5px; font-weight:bold; text-align:center; border-bottom:1px solid #ccc;">Expenses (Dr)</div>
                    <table class="no-border">`;
            for(let g in data.Expenses) html += `<tr><td>${g}</td><td class="amt">${data.Expenses[g].toFixed(2)}</td></tr>`;
            if(netProfit > 0) html += `<tr style="font-weight:bold; color:green;"><td>Net Profit</td><td class="amt">${netProfit.toFixed(2)}</td></tr>`;
            html += `</table></div>
                <div style="flex:1; border:1px solid #ccc;">
                    <div style="background:#f1f5f9; padding:5px; font-weight:bold; text-align:center; border-bottom:1px solid #ccc;">Income (Cr)</div>
                    <table class="no-border">`;
            for(let g in data.Income) html += `<tr><td>${g}</td><td class="amt">${data.Income[g].toFixed(2)}</td></tr>`;
            html += `<tr><td>Closing Stock</td><td class="amt">${closingStock.toFixed(2)}</td></tr>`;
            if(netProfit < 0) html += `<tr style="font-weight:bold; color:red;"><td>Net Loss</td><td class="amt">${Math.abs(netProfit).toFixed(2)}</td></tr>`;
            html += `</table></div></div>`;
            c.innerHTML = html;
        }

        function calculateBalanceSheet(c) {
            const data = getGroupTotals();
            let totalLiab = 0, totalAsset = 0;
            
            // Calc Profit for Capital
            let inc=0, exp=0;
            Object.values(data.Income).forEach(v => inc += v);
            Object.values(data.Expenses).forEach(v => exp += v);
            let closingStock = items.reduce((s, i) => s + ((i.current_stock||0)*(i.std_cost||0)), 0);
            const netProfit = (inc + closingStock) - exp;

            let liabRows = "";
            for(let g in data.Liabilities) { totalLiab += data.Liabilities[g]; liabRows += `<tr><td>${g}</td><td class="amt">${data.Liabilities[g].toFixed(2)}</td></tr>`; }
            totalLiab += netProfit;
            liabRows += `<tr style="font-weight:bold;"><td>Profit & Loss A/c</td><td class="amt">${netProfit.toFixed(2)}</td></tr>`;

            let assetRows = "";
            for(let g in data.Assets) { totalAsset += data.Assets[g]; assetRows += `<tr><td>${g}</td><td class="amt">${data.Assets[g].toFixed(2)}</td></tr>`; }
            totalAsset += closingStock;
            assetRows += `<tr><td>Closing Stock</td><td class="amt">${closingStock.toFixed(2)}</td></tr>`;

            c.innerHTML = `<h2>Balance Sheet</h2><p class="sub-head">As on Today</p>
            <div style="display:flex; gap:2px;">
                <div style="flex:1; border:1px solid #ccc;">
                    <div style="background:#f1f5f9; padding:5px; font-weight:bold; text-align:center;">Liabilities</div>
                    <table>${liabRows}</table>
                </div>
                <div style="flex:1; border:1px solid #ccc;">
                    <div style="background:#f1f5f9; padding:5px; font-weight:bold; text-align:center;">Assets</div>
                    <table>${assetRows}</table>
                </div>
            </div>
            <div style="display:flex; gap:2px; margin-top:5px;">
                <div style="flex:1; background:#eee; padding:10px; font-weight:bold; text-align:right;">Total: ‚Çπ${totalLiab.toFixed(2)}</div>
                <div style="flex:1; background:#eee; padding:10px; font-weight:bold; text-align:right;">Total: ‚Çπ${totalAsset.toFixed(2)}</div>
            </div>`;
        }

        function calculateTrialBalance(c) {
            let html = `<h2>Trial Balance</h2><table><thead><tr><th>Ledger Name</th><th class="amt">Debit</th><th class="amt">Credit</th></tr></thead><tbody>`;
            let totDr = 0, totCr = 0;
            ledgers.sort((a,b)=>a.name.localeCompare(b.name)).forEach(l => {
                const bal = getLedgerBalance(l.id);
                if(Math.abs(bal) < 0.01) return;
                const dr = bal > 0 ? bal : 0;
                const cr = bal < 0 ? Math.abs(bal) : 0;
                totDr += dr; totCr += cr;
                html += `<tr><td>${l.name}</td><td class="amt">${dr ? dr.toFixed(2) : ''}</td><td class="amt">${cr ? cr.toFixed(2) : ''}</td></tr>`;
            });
            html += `<tr class="bold-row"><td>Grand Total</td><td class="amt">${totDr.toFixed(2)}</td><td class="amt">${totCr.toFixed(2)}</td></tr></tbody></table>`;
            c.innerHTML = html;
        }

        function renderDayBook(c) {
            const f = document.getElementById('fromDate').value;
            const t = document.getElementById('toDate').value;
            const filtered = vouchers.filter(v => v.date >= f && v.date <= t);
            let html = `<h2>Day Book</h2><p class="sub-head">${f} to ${t}</p><table><thead><tr><th>Date</th><th>Type</th><th>No</th><th>Narration</th><th class="amt">Amount</th></tr></thead><tbody>`;
            filtered.forEach(v => html += `<tr><td>${v.date}</td><td>${v.type}</td><td>${v.voucher_no}</td><td>${v.narration}</td><td class="amt">${v.amount.toFixed(2)}</td></tr>`);
            c.innerHTML = html + "</tbody></table>";
        }

        function renderStock(c) {
            let html = `<h2>Stock Summary</h2><table><thead><tr><th>Item</th><th>Category</th><th class="amt">Qty</th><th class="amt">Value</th></tr></thead><tbody>`;
            let totVal = 0;
            items.forEach(i => {
                const val = (i.current_stock||0) * (i.std_cost||0);
                totVal += val;
                html += `<tr><td>${i.name}</td><td>${i.category||'-'}</td><td class="amt">${i.current_stock||0}</td><td class="amt">${val.toFixed(2)}</td></tr>`;
            });
            html += `<tr class="bold-row"><td colspan="3">Total Stock Value</td><td class="amt">${totVal.toFixed(2)}</td></tr></tbody></table>`;
            c.innerHTML = html;
        }

        function renderLedgerReport(c) {
            const name = document.getElementById('partyInput').value;
            const pid = ledgers.find(l=>l.name === name)?.id;
            if(!pid) return c.innerHTML = "<h3 style='color:red; text-align:center;'>Party not found</h3>";
            
            const from = document.getElementById('fromDate').value;
            const to = document.getElementById('toDate').value;
            let bal = ledgers.find(x=>x.id==pid).opening_balance || 0;
            
            // Calculate Opening for Range
            acctEntries.filter(e => e.ledger_id == pid).forEach(e => {
                const v = vouchers.find(vx => vx.id == e.voucher_id);
                if(v && v.date < from) bal += (e.debit - e.credit);
            });

            let html = `<h2>${name}</h2><p class="sub-head">${from} to ${to}</p><table><thead><tr><th>Date</th><th>Vch</th><th>Narration</th><th class="amt">Dr</th><th class="amt">Cr</th><th class="amt">Balance</th></tr></thead><tbody>`;
            html += `<tr><td>-</td><td>-</td><td><b>Opening Balance</b></td><td></td><td></td><td class="amt">${bal.toFixed(2)}</td></tr>`;

            const ents = acctEntries.filter(e => e.ledger_id == pid);
            ents.forEach(e => {
                const v = vouchers.find(x=>x.id==e.voucher_id);
                if(v && v.date >= from && v.date <= to) {
                    bal += (e.debit - e.credit);
                    html += `<tr><td>${v.date}</td><td>${v.voucher_no}</td><td>${v.narration||v.type}</td><td class="amt">${e.debit||''}</td><td class="amt">${e.credit||''}</td><td class="amt">${bal.toFixed(2)}</td></tr>`;
                }
            });
            c.innerHTML = html + "</tbody></table>";
        }

        function renderExpiry(c) {
            const today = new Date();
            let html = `<h2>Expiry Report</h2><table><thead><tr><th>Item</th><th>Batch</th><th>Expiry</th><th>Qty</th></tr></thead><tbody>`;
            batches.forEach(b => {
                if(!b.expiry_date) return;
                html += `<tr><td>Item-${b.item_id}</td><td>${b.batch_no}</td><td>${b.expiry_date}</td><td class="amt">${b.qty}</td></tr>`;
            });
            c.innerHTML = html + `</tbody></table>`;
        }

        function renderLowStock(c) {
            let html = `<h2>Low Stock Alert</h2><table><thead><tr><th>Item</th><th>Current</th><th>Reorder</th></tr></thead><tbody>`;
            items.filter(i => (i.current_stock||0) <= (i.reorder_level||0)).forEach(i => {
                html += `<tr><td>${i.name}</td><td class="amt" style="color:red">${i.current_stock}</td><td class="amt">${i.reorder_level}</td></tr>`;
            });
            c.innerHTML = html + `</tbody></table>`;
        }

        function exportExcel() {
            const table = document.querySelector('table');
            if(!table) return alert("No report generated!");
            let csv = [];
            const rows = table.querySelectorAll("tr");
            for (let i = 0; i < rows.length; i++) {
                let row = [], cols = rows[i].querySelectorAll("td, th");
                for (let j = 0; j < cols.length; j++) row.push(cols[j].innerText);
                csv.push(row.join(","));
            }
            const blob = new Blob([csv.join("\n")], { type: "text/csv" });
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = "Report.csv";
            a.click();
        }
    </script>
</body>
</html>