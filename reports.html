<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <title>Advanced Reporting - Arth Book</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


</head>
<style>
    /* ==========================================================================
   ARTH BOOK - ADVANCED REPORTING MASTER STYLE
   ========================================================================== */

:root {
    --primary: #0d47a1;
    --primary-dark: #002171;
    --accent: #ffca28;
    --bg: #f1f5f9;
    --surface: #ffffff;
    --text-main: #1e293b;
    --text-sub: #64748b;
    --border: #e2e8f0;
    --green: #10b981;
    --red: #ef4444;
    --sidebar-width: 260px;
}

/* --- RESET --- */
* { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', sans-serif; outline: none; }
body { display: flex; height: 100vh; background: var(--bg); color: var(--text-main); overflow: hidden; }

/* --- SIDEBAR (Standard Fix) --- */
.sidebar {
    width: var(--sidebar-width); background: var(--primary);
    color: white; display: flex; flex-direction: column; flex-shrink: 0; height: 100vh;
    overflow-y: auto; z-index: 2000; box-shadow: 4px 0 10px rgba(0,0,0,0.1);
    transition: 0.2s;
}
.brand-logo { padding: 20px; font-size: 20px; font-weight: 800; border-bottom: 1px solid rgba(255,255,255,0.1); }
.nav-links { padding: 10px; list-style: none; }
.nav-links li { margin-bottom: 5px; }
.sidebar a {
    display: flex; align-items: center; gap: 12px; padding: 12px 15px;
    color: rgba(255,255,255,0.8); text-decoration: none; border-radius: 8px; font-weight: 500; font-size: 14px;
}
.sidebar a:hover { background: rgba(255,255,255,0.1); color: #fff; }
.sidebar a.active { background: var(--accent); color: var(--primary-dark); font-weight: 800; }

/* --- MAIN CONTENT AREA --- */
.main { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }

/* Top Bar / Filter Bar */
.top-bar {
    background: var(--surface); padding: 12px 20px; 
    border-bottom: 1px solid var(--border);
    display: flex; align-items: center; gap: 12px; flex-wrap: wrap;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05); z-index: 100;
}

.top-bar select, .top-bar input {
    padding: 8px 12px; border: 1px solid var(--border);
    border-radius: 6px; font-size: 13px; background: #f8fafc;
}
.top-bar select:focus, .top-bar input:focus { border-color: var(--primary); background: #fff; }

/* --- BUTTONS --- */
.btn {
    padding: 8px 16px; border: none; border-radius: 6px;
    font-weight: 600; font-size: 13px; cursor: pointer;
    display: inline-flex; align-items: center; gap: 6px; transition: 0.2s;
}
.btn-go { background: var(--primary); color: white; }
.btn-excel { background: #166534; color: white; }
.btn-print { background: var(--text-main); color: white; }
.btn:hover { opacity: 0.9; transform: translateY(-1px); }

/* --- REPORT DISPLAY (PAPER LOOK) --- */
.content-area { flex: 1; overflow-y: auto; padding: 30px; display: flex; justify-content: center; background: #cbd5e1; }

.report-paper {
    background: white; width: 100%; max-width: 900px; min-height: 100%;
    padding: 50px; box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    border-radius: 4px; color: #000;
}

.report-paper h2 { text-align: center; margin-bottom: 5px; font-weight: 800; text-transform: uppercase; color: var(--primary); }
.sub-head { text-align: center; font-size: 12px; color: var(--text-sub); margin-bottom: 30px; border-bottom: 2px solid var(--primary); padding-bottom: 10px; }

/* Tables in Report */
table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 13px; }
th { background: #f1f5f9; padding: 12px; text-align: left; border: 1px solid #e2e8f0; font-weight: 700; }
td { padding: 10px 12px; border: 1px solid #e2e8f0; }
.amt { text-align: right; font-family: 'JetBrains Mono', monospace; font-weight: 600; }
.bold-row { background: #f8fafc; font-weight: 800; }

/* AI Card */
.ai-box {
    background: linear-gradient(135deg, #1e3a8a, #3b82f6);
    color: white; padding: 25px; border-radius: 12px; margin-bottom: 30px;
    text-align: center; box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3);
}

.health-grid { display: grid; grid-template-columns: 1fr 2fr; gap: 20px; margin-top: 20px; }
.h-card { background: #fff; border: 1px solid var(--border); padding: 15px; border-radius: 8px; }

/* --- MOBILE RESPONSIVE --- */
.menu-btn { 
    display: none; position: fixed; right: 15px; top: 10px; z-index: 3000;
    background: var(--primary); color: white; border: none; width: 40px; height: 40px; border-radius: 6px; font-size: 20px;
}
.overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1500; }

@media (max-width: 900px) {
    .sidebar { position: fixed; left: -100%; }
    .sidebar.active { left: 0; }
    .menu-btn { display: block; }
    .overlay.active { display: block; }

    .top-bar { padding: 50px 15px 15px; gap: 8px; } /* Space for menu btn */
    .top-bar > * { flex: 1 1 45%; } /* Two columns on mobile */
    .btn { justify-content: center; }

    .content-area { padding: 10px; background: #fff; }
    .report-paper { padding: 20px; box-shadow: none; border: 1px solid var(--border); }
    
    .health-grid { grid-template-columns: 1fr; }
    
    /* Make tables scrollable on mobile */
    .report-paper { overflow-x: auto; }
    table { min-width: 500px; }
}

/* --- PRINT RULES --- */
@media print {
    .sidebar, .top-bar, .menu-btn, .overlay { display: none !important; }
    body, .main, .content-area { height: auto; overflow: visible; background: white; padding: 0; }
    .report-paper { width: 100%; max-width: 100%; box-shadow: none; padding: 0; margin: 0; }
    table { page-break-inside: auto; }
    tr { page-break-inside: avoid; page-break-after: auto; }
}
</style>
<body>

    <button class="menu-btn" onclick="toggleMenu()">‚ò∞</button>
    <div class="overlay" onclick="toggleMenu()"></div>

    <div class="sidebar" id="sidebar">
        <div class="brand-logo" style="padding: 20px; font-size: 20px; font-weight: 800; color: white; display: flex; align-items: center; gap: 10px;">
            <i class="fas fa-cube"></i> Arth Book
        </div>
        <ul class="nav-links" style="list-style: none; padding: 0 10px;">
            <li><a href="index.html" class="nav-link"><i class="fas fa-home"></i> Dashboard</a></li>
            <li><a href="sales_invoice.html" class="nav-link"><i class="fas fa-file-invoice"></i> Sales (POS)</a></li>
            <li><a href="purchase_invoice.html" class="nav-link"><i class="fas fa-truck"></i> Purchase</a></li>
            <li><a href="vouchers.html" class="nav-link"><i class="fas fa-receipt"></i> Day Book</a></li>
            
            <li style="margin-top:15px; margin-bottom:5px; font-size:11px; color:#64748b; font-weight:bold; padding-left:15px; text-transform:uppercase;">Masters</li>
            <li><a href="item_master.html" class="nav-link"><i class="fas fa-boxes"></i> Inventory</a></li>
            <li><a href="ArthBook.html" class="nav-link"><i class="fas fa-users"></i> Parties</a></li>
            <li><a href="coa.html" class="nav-link"><i class="fas fa-sitemap"></i> Accounts</a></li>
            
            <li style="margin-top:15px; margin-bottom:5px; font-size:11px; color:#64748b; font-weight:bold; padding-left:15px; text-transform:uppercase;">Reports & Tax</li>
            <li><a href="reports.html" class="nav-link active"><i class="fas fa-chart-line"></i> Reports</a></li>
            <li><a href="gst_filing.html" class="nav-link"><i class="fas fa-university"></i> GST Returns</a></li>
            <li><a href="taxation.html" class="nav-link"><i class="fas fa-calculator"></i> Tax / ITR</a></li>
            
            <hr style="border:0; border-top:1px solid rgba(255,255,255,0.1); margin:15px 5px;">
            <li><a href="settings.html" class="nav-link"><i class="fas fa-cog"></i> Settings</a></li>
            <li><a href="help.html" class="nav-link"><i class="fas fa-question-circle"></i> Help</a></li>
        </ul>
        
        <div style="padding: 20px; font-size: 11px; color: #64748b; text-align: center; margin-top:auto;">
            Arth Book v4.1<br>Authorized User
        </div>
    </div>

    <div class="main">
        <div class="top-bar">
            <select id="reportType" onchange="toggleFilters()">
                <optgroup label="Business Overview">
                    <option value="Health">üè• Business Health (AI)</option>
                    <option value="PL">üìâ Profit & Loss</option>
                    <option value="BalanceSheet">‚öñÔ∏è Balance Sheet</option>
                </optgroup>
                <optgroup label="Accounting">
                    <option value="TrialBalance">üìë Trial Balance</option>
                    <option value="DayBook">üìÖ Day Book</option>
                    <option value="Ledger">üë§ Party Ledger</option>
                    <option value="Receivables">üí∞ Outstanding Receivables (Udhari)</option>
                    <option value="Payables">üí∏ Outstanding Payables (Dena)</option>
                    <option value="GSTReport">üèõÔ∏è GST Tax Report</option>
                </optgroup>
                <optgroup label="Inventory">
                    <option value="Stock">üì¶ Stock Summary</option>
                    <option value="LowStock">‚ö†Ô∏è Low Stock</option>
                    <option value="Expiry">üóìÔ∏è Expiry Report</option>
                </optgroup>
            </select>

            <div id="partyFilter" style="display:none; width:300px;">
                <input type="text" id="partyInput" list="partyList" placeholder="Search & Select Party..." style="width:100%;">
                <datalist id="partyList"></datalist>
                <input type="hidden" id="selectedPartyId">
            </div>

            <input type="date" id="fromDate">
            <input type="date" id="toDate">

            <button class="btn btn-go" onclick="generateReport()">üîÑ Generate</button>
            <button class="btn btn-excel" onclick="exportToExcel()">üìä Export</button>
            <button class="btn btn-print" onclick="window.print()">üñ®Ô∏è Print</button>
        </div>

        <div class="content-area">
            <div class="report-paper" id="reportContent">
                <div style="text-align:center; padding:120px 40px; color:#cbd5e1;">
                    <h2>Select Report Type</h2>
                    <p style="margin-top:15px;">Choose from dropdown & click Generate</p>
                    <p style="margin-top:10px; font-size:14px;">Includes AI Health, GST & Outstanding Reports</p>
                </div>
            </div>
        </div>
    </div>

    <script src="db.js"></script>
    <script src="ai_engine.js" onerror="console.warn('AI Engine not loaded')"></script>

    <script>
        let ledgers = [], items = [], groups = [], acctEntries = [], vouchers = [], batches = [];
        let ledgerMap = {}, itemMap = {};

        // Helper: Dynamic Group ID Lookup
        const getGroupIdByName = (name) => groups.find(g => g.name === name)?.id;

        // AI Safety
        if (!window.AI) {
            window.AI = {
                predictNextMonth: async () => ({ forecast: 0, dailyAvg: 0, currentMonth: 0 })
            };
        }

        window.onload = async () => {
            await DB.init();
            [ledgers, items, groups, acctEntries, vouchers, batches] = await Promise.all([
                DB.getAll('ledgers'), DB.getAll('items'), DB.getAll('groups'),
                DB.getAll('acct_entries'), DB.getAll('vouchers'), DB.getAll('batches') || []
            ]);
            ledgers.forEach(l => ledgerMap[l.id] = l.name);
            items.forEach(i => itemMap[i.id] = i.name);

            const today = new Date();
            document.getElementById('toDate').valueAsDate = today;
            document.getElementById('fromDate').valueAsDate = new Date(today.getFullYear(), today.getMonth(), 1);
            populatePartyDatalist();
        };

        function toggleMenu() {
            document.getElementById('sidebar').classList.toggle('active');
            document.querySelector('.overlay').classList.toggle('active');
        }

        function populatePartyDatalist() {
            const datalist = document.getElementById('partyList');
            datalist.innerHTML = ledgers.map(l => `<option value="${l.name}" data-id="${l.id}">`).join('');
        }

        function toggleFilters() {
            const type = document.getElementById('reportType').value;
            document.getElementById('partyFilter').style.display = (type === 'Ledger') ? 'block' : 'none';
        }

        function getSelectedPartyId() {
            const val = document.getElementById('partyInput').value;
            return ledgers.find(l => l.name === val)?.id;
        }

        async function generateReport() {
            const type = document.getElementById('reportType').value;
            const container = document.getElementById('reportContent');
            container.innerHTML = '<div style="text-align:center; padding:80px;"><h3>Generating Report...</h3></div>';

            setTimeout(async () => {
                try {
                    if(type === 'Health') await renderBusinessHealth(container);
                    else if(type === 'PL') renderProfitLoss(container);
                    else if(type === 'BalanceSheet') renderBalanceSheet(container);
                    else if(type === 'TrialBalance') renderTrialBalance(container);
                    else if(type === 'DayBook') renderDayBook(container);
                    else if(type === 'Ledger') renderPartyLedger(container);
                    else if(type === 'Receivables') renderOutstanding(container, getGroupIdByName('Sundry Debtors'), "Receivables (Udhari)");
                    else if(type === 'Payables') renderOutstanding(container, getGroupIdByName('Sundry Creditors'), "Payables (Dena Hai)");
                    else if(type === 'GSTReport') renderGSTReport(container);
                    else if(type === 'Stock') renderStockSummary(container);
                    else if(type === 'LowStock') renderLowStock(container);
                    else if(type === 'Expiry') renderExpiryReport(container);
                } catch (e) {
                    container.innerHTML = `<h3 style="color:red; text-align:center;">Error: ${e.message}</h3>`;
                }
            }, 200);
        }

        // --- ACCOUNTING LOGIC ---
        function calculateLedgerBalance(ledgerId, upToDate = null) {
            const ledger = ledgers.find(l => l.id === ledgerId);
            if(!ledger) return 0;
            let balance = parseFloat(ledger.opening_balance) || 0;
            acctEntries.filter(e => e.ledger_id === ledgerId).forEach(e => {
                const v = vouchers.find(v => v.id === e.voucher_id);
                if(!upToDate || (v && v.date <= upToDate)) {
                    balance += (parseFloat(e.debit) || 0) - (parseFloat(e.credit) || 0);
                }
            });
            return balance;
        }

        function getGroupBalances() {
            const balances = { Assets: 0, Liabilities: 0, Income: 0, Expenses: 0 };
            ledgers.forEach(l => {
                const bal = calculateLedgerBalance(l.id);
                const group = groups.find(g => g.id === l.group_id);
                const root = group ? GROUP_TYPES[group.name] || 'Liabilities' : 'Liabilities';
                if(root === 'Assets' || root === 'Expenses') balances[root] += bal;
                else balances[root] += (bal * -1); 
            });
            return balances;
        }

        const GROUP_TYPES = {
            'Capital Account': 'Liabilities', 'Loans (Liability)': 'Liabilities',
            'Current Liabilities': 'Liabilities', 'Sundry Creditors': 'Liabilities',
            'Duties & Taxes': 'Liabilities', 'Fixed Assets': 'Assets',
            'Current Assets': 'Assets', 'Cash-in-Hand': 'Assets',
            'Bank Accounts': 'Assets', 'Sundry Debtors': 'Assets',
            'Stock-in-Hand': 'Assets', 'Sales Accounts': 'Income',
            'Direct Income': 'Income', 'Indirect Income': 'Income',
            'Purchase Accounts': 'Expenses', 'Direct Expenses': 'Expenses',
            'Indirect Expenses': 'Expenses'
        };

        // --- RENDER FUNCTIONS ---
        async function renderBusinessHealth(container) {
            const stockValue = items.reduce((sum, i) => sum + ((i.current_stock || 0) * (i.std_cost || 0)), 0);
            const prediction = await window.AI.predictNextMonth();
            container.innerHTML = `
                <h2>Business Health Overview</h2>
                <p class="sub-head">AI-Powered Insights ‚Ä¢ ${new Date().toLocaleDateString('en-IN')}</p>
                <div class="ai-box">
                    <h3 style="color:var(--accent); margin-bottom:10px;">ü§ñ AI Prediction</h3>
                    <div style="font-size:28px; font-weight:800; margin:15px 0;">‚Çπ${(prediction.forecast || 0).toLocaleString('en-IN')}</div>
                    <p>Projected Revenue Next Month<br><small>Daily Avg: ‚Çπ${(prediction.dailyAvg || 0).toLocaleString('en-IN')}</small></p>
                </div>
                <div class="health-grid">
                    <div class="h-card"><h4>Stock Value</h4><div class="amt" style="font-size:24px; color:var(--green);">‚Çπ${stockValue.toLocaleString('en-IN')}</div></div>
                    <div class="h-card"><canvas id="trendChart" height="180"></canvas></div>
                </div>`;
            new Chart(document.getElementById('trendChart'), {
                type: 'line',
                data: { labels: ['Current', 'Next (AI)'], datasets: [{ data: [prediction.currentMonth, prediction.forecast], borderColor: '#2563eb', fill: true }] }
            });
        }

        function renderProfitLoss(container) {
            const balances = getGroupBalances();
            const closingStock = items.reduce((s, i) => s + ((i.current_stock || 0) * (i.std_cost || 0)), 0);
            const netProfit = (balances.Income - balances.Expenses) + closingStock; 
            container.innerHTML = `
                <h2>Profit & Loss Statement</h2>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px;">
                    <table><thead><tr><th>Expenses</th><th class="amt">Amount</th></tr></thead><tbody>
                        <tr><td>Purchases & Expenses</td><td class="amt">${balances.Expenses.toLocaleString('en-IN')}</td></tr>
                        ${netProfit > 0 ? `<tr class="bold-row"><td>Net Profit</td><td class="amt" style="color:var(--green);">${netProfit.toLocaleString('en-IN')}</td></tr>` : ''}
                    </tbody></table>
                    <table><thead><tr><th>Income</th><th class="amt">Amount</th></tr></thead><tbody>
                        <tr><td>Sales & Income</td><td class="amt">${balances.Income.toLocaleString('en-IN')}</td></tr>
                        <tr><td>Closing Stock</td><td class="amt">${closingStock.toLocaleString('en-IN')}</td></tr>
                        ${netProfit < 0 ? `<tr class="bold-row"><td>Net Loss</td><td class="amt" style="color:var(--red);">${Math.abs(netProfit).toLocaleString('en-IN')}</td></tr>` : ''}
                    </tbody></table>
                </div>`;
        }

        function renderBalanceSheet(container) {
            const balances = getGroupBalances();
            const closingStock = items.reduce((s, i) => s + ((i.current_stock || 0) * (i.std_cost || 0)), 0);
            const netProfit = (balances.Income - balances.Expenses) + closingStock; 
            const totalLiab = balances.Liabilities + netProfit;
            const totalAssets = balances.Assets + closingStock;
            container.innerHTML = `
                <h2>Balance Sheet</h2>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px;">
                    <table><thead><tr><th>Liabilities</th><th class="amt">Amount</th></tr></thead><tbody>
                        <tr><td>Capital & Liabilities</td><td class="amt">${balances.Liabilities.toLocaleString('en-IN')}</td></tr>
                        <tr><td>Net Profit</td><td class="amt">${netProfit.toLocaleString('en-IN')}</td></tr>
                        <tr class="bold-row"><td>Total</td><td class="amt">${totalLiab.toLocaleString('en-IN')}</td></tr>
                    </tbody></table>
                    <table><thead><tr><th>Assets</th><th class="amt">Amount</th></tr></thead><tbody>
                        <tr><td>Fixed & Current Assets</td><td class="amt">${balances.Assets.toLocaleString('en-IN')}</td></tr>
                        <tr><td>Closing Stock</td><td class="amt">${closingStock.toLocaleString('en-IN')}</td></tr>
                        <tr class="bold-row"><td>Total</td><td class="amt">${totalAssets.toLocaleString('en-IN')}</td></tr>
                    </tbody></table>
                </div>`;
        }

        function renderTrialBalance(container) {
            let html = `<h2>Trial Balance</h2><table><thead><tr><th>Ledger</th><th class="amt">Debit</th><th class="amt">Credit</th></tr></thead><tbody>`;
            let totalDr = 0, totalCr = 0;
            ledgers.forEach(l => {
                const bal = calculateLedgerBalance(l.id);
                if(Math.abs(bal) < 0.01) return;
                const dr = bal > 0 ? bal : 0; const cr = bal < 0 ? Math.abs(bal) : 0;
                totalDr += dr; totalCr += cr;
                html += `<tr><td>${l.name}</td><td class="amt">${dr ? dr.toLocaleString('en-IN') : ''}</td><td class="amt">${cr ? cr.toLocaleString('en-IN') : ''}</td></tr>`;
            });
            container.innerHTML = html + `<tr class="bold-row"><td>Total</td><td class="amt">${totalDr.toLocaleString('en-IN')}</td><td class="amt">${totalCr.toLocaleString('en-IN')}</td></tr></tbody></table>`;
        }

        function renderOutstanding(container, groupId, title) {
            if(!groupId) return container.innerHTML = `<h3 style="color:red; text-align:center;">Group '${title}' not found in Database.</h3>`;
            let html = `<h2>Outstanding ${title}</h2><table><thead><tr><th>Party Name</th><th class="amt">Amount</th></tr></thead><tbody>`;
            let total = 0;
            ledgers.filter(l => l.group_id == groupId).forEach(l => {
                const bal = calculateLedgerBalance(l.id);
                const pending = (title.includes("Receivables")) ? bal : (bal * -1);
                if(pending > 0.01) {
                    total += pending;
                    html += `<tr><td>${l.name}</td><td class="amt">‚Çπ${pending.toLocaleString('en-IN')}</td></tr>`;
                }
            });
            container.innerHTML = html + `<tr class="bold-row"><td>Total</td><td class="amt">‚Çπ${total.toLocaleString('en-IN')}</td></tr></tbody></table>`;
        }

        function renderGSTReport(container) {
            const gid = getGroupIdByName('Duties & Taxes');
            const taxLedgers = ledgers.filter(l => l.group_id == gid);
            let inputTax = 0, outputTax = 0, html = `<h2>GST Tax Report</h2><table><thead><tr><th>Tax Ledger</th><th class="amt">Input (Dr)</th><th class="amt">Output (Cr)</th></tr></thead><tbody>`;
            taxLedgers.forEach(l => {
                const bal = calculateLedgerBalance(l.id);
                let dr = bal > 0 ? bal : 0, cr = bal < 0 ? Math.abs(bal) : 0;
                if(l.name.toLowerCase().includes('input')) inputTax += dr;
                if(l.name.toLowerCase().includes('output')) outputTax += cr;
                html += `<tr><td>${l.name}</td><td class="amt">${dr.toFixed(2)}</td><td class="amt">${cr.toFixed(2)}</td></tr>`;
            });
            const net = outputTax - inputTax;
            container.innerHTML = html + `<tr class="bold-row"><td>Total</td><td class="amt">‚Çπ${inputTax.toFixed(2)}</td><td class="amt">‚Çπ${outputTax.toFixed(2)}</td></tr></tbody></table>
            <div style="margin-top:20px; padding:15px; background:${net>0?'#fee2e2':'#dcfce7'}; border-radius:8px; text-align:center;">
                <h3>${net>0?'Payable':'Refund'}: ‚Çπ${Math.abs(net).toFixed(2)}</h3></div>`;
        }

        function renderDayBook(container) {
            const from = document.getElementById('fromDate').value, to = document.getElementById('toDate').value;
            const filtered = vouchers.filter(v => v.date >= from && v.date <= to).sort((a,b) => a.date.localeCompare(b.date));
            let html = `<h2>Day Book</h2><table><thead><tr><th>Date</th><th>Voucher</th><th>Type</th><th class="amt">Amount</th></tr></thead><tbody>`;
            filtered.forEach(v => { html += `<tr><td>${v.date}</td><td>${v.voucher_no}</td><td>${v.type}</td><td class="amt">‚Çπ${(v.amount || 0).toLocaleString('en-IN')}</td></tr>`; });
            container.innerHTML = html + '</tbody></table>';
        }

        function renderPartyLedger(container) {
            const pid = getSelectedPartyId();
            if(!pid) return container.innerHTML = '<h3 style="color:red; text-align:center;">Select a Party</h3>';
            const from = document.getElementById('fromDate').value, to = document.getElementById('toDate').value;
            let bal = calculateLedgerBalance(pid, from), html = `<h2>Ledger: ${ledgerMap[pid]}</h2><table><thead><tr><th>Date</th><th>Voucher</th><th class="amt">Debit</th><th class="amt">Credit</th><th class="amt">Balance</th></tr></thead><tbody>`;
            html += `<tr><td colspan="4">Opening Balance</td><td class="amt">‚Çπ${bal.toLocaleString('en-IN')}</td></tr>`;
            acctEntries.filter(e => e.ledger_id == pid).map(e => ({e, v: vouchers.find(v => v.id == e.voucher_id)})).filter(x => x.v && x.v.date >= from && x.v.date <= to).forEach(x => {
                const dr = parseFloat(x.e.debit)||0, cr = parseFloat(x.e.credit)||0; bal += dr - cr;
                html += `<tr><td>${x.v.date}</td><td>${x.v.voucher_no}</td><td class="amt">${dr||''}</td><td class="amt">${cr||''}</td><td class="amt">‚Çπ${bal.toLocaleString('en-IN')}</td></tr>`;
            });
            container.innerHTML = html + '</tbody></table>';
        }

        function renderStockSummary(container) {
            let total = 0, html = `<h2>Stock Summary</h2><table><thead><tr><th>Item</th><th>Stock</th><th class="amt">Value</th></tr></thead><tbody>`;
            items.forEach(i => { const val = (i.current_stock||0)*(i.std_cost||0); total += val; html += `<tr><td>${i.name}</td><td>${i.current_stock}</td><td class="amt">‚Çπ${val.toLocaleString('en-IN')}</td></tr>`; });
            container.innerHTML = html + `<tr class="bold-row"><td>Total Value</td><td></td><td class="amt">‚Çπ${total.toLocaleString('en-IN')}</td></tr></tbody></table>`;
        }

        function renderLowStock(container) {
            const low = items.filter(i => (i.current_stock||0) <= (i.reorder_level||5));
            let html = `<h2>Low Stock Alert</h2><table><thead><tr><th>Item</th><th>Current</th><th>Min</th></tr></thead><tbody>`;
            low.forEach(i => { html += `<tr><td>${i.name}</td><td style="color:red;">${i.current_stock}</td><td>${i.reorder_level}</td></tr>`; });
            container.innerHTML = html + '</tbody></table>';
        }

        function renderExpiryReport(container) {
            const today = new Date().toISOString().slice(0,10);
            let html = `<h2>Expiry Report</h2><table><thead><tr><th>Item</th><th>Batch</th><th>Expiry</th></tr></thead><tbody>`;
            batches.forEach(b => { 
                const color = b.expiry_date < today ? 'red' : 'orange';
                html += `<tr><td>${itemMap[b.item_id]}</td><td>${b.batch_no}</td><td style="color:${color}">${b.expiry_date}</td></tr>`; 
            });
            container.innerHTML = html + '</tbody></table>';
        }

        function exportToExcel() {
            const table = document.querySelector('#reportContent table');
            if(!table) return alert('No Data');
            let csv = Array.from(table.querySelectorAll('tr')).map(tr => Array.from(tr.querySelectorAll('th,td')).map(td => `"${td.innerText}"`).join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'Report.csv'; a.click();
        }
    </script>
</body>
</html>