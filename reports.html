<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Reports - Money Wise Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --sidebar-bg: #0f172a; --sidebar-text: #94a3b8; --active-text: #f8fafc;
            --bg: #f1f5f9; --text: #1e293b; --border: #cbd5e1;
            --accent: #2563eb; 
        }
        * { box-sizing: border-box; font-family: 'Inter', sans-serif; margin: 0; padding: 0; }
        body { display: flex; height: 100vh; background: var(--bg); color: var(--text); overflow: hidden; }

        .sidebar { width: 260px; background: var(--sidebar-bg); padding: 20px; display: flex; flex-direction: column; flex-shrink: 0; }
        .brand { font-size: 20px; font-weight: 800; color: #fff; margin-bottom: 40px; display: flex; align-items: center; gap: 10px; }
        .nav-link { padding: 12px 15px; margin-bottom: 5px; border-radius: 8px; color: var(--sidebar-text); text-decoration: none; font-weight: 500; display: flex; align-items: center; gap: 12px; transition: 0.2s; font-size: 14px; }
        .nav-link:hover, .nav-link.active { background: #1e293b; color: var(--active-text); }
        .nav-icon { font-size: 18px; }

        .main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .top-header { background: white; padding: 15px 25px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        
        .filters { background: white; padding: 15px 25px; display: flex; gap: 15px; align-items: center; border-bottom: 1px solid var(--border); flex-wrap: wrap; }
        select, input { padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px; font-size: 14px; }
        .btn-go { background: var(--accent); color: white; border: none; padding: 8px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; }
        .btn-print { background: #475569; color: white; border: none; padding: 8px 20px; border-radius: 6px; cursor: pointer; margin-left: auto; }

        .content-area { flex: 1; overflow-y: auto; padding: 25px; }
        .report-card { background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); overflow: hidden; border: 1px solid var(--border); min-height: 400px; padding: 20px; }
        
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { background: #f8fafc; padding: 10px 12px; text-align: left; font-weight: 700; color: #475569; border-bottom: 2px solid var(--border); }
        td { padding: 8px 12px; border-bottom: 1px solid #e2e8f0; color: #334155; }
        .amount { text-align: right; font-family: 'Courier New', monospace; font-weight: 600; }
        
        .bold-row { background: #f1f5f9; font-weight: 700; border-top: 2px solid #cbd5e1; }
        
        /* Balance Sheet Split View */
        .bs-container { display: flex; width: 100%; gap: 20px; }
        .bs-side { flex: 1; border: 1px solid var(--border); border-radius: 6px; overflow: hidden; }
        .bs-header { background: #e2e8f0; padding: 10px; font-weight: 800; text-align: center; text-transform: uppercase; font-size: 14px; }

        @media print {
            .sidebar, .filters, .btn-print { display: none !important; }
            .content-area { padding: 0; }
            .report-card { border: none; box-shadow: none; }
        }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="brand">üöÄ MoneyWise Pro</div>
        <a href="index.html" class="nav-link"><span class="nav-icon">üìä</span> Dashboard</a>
        <a href="reports.html" class="nav-link active"><span class="nav-icon">üìà</span> Reports</a>
        <a href="gst_filing.html" class="nav-link"><span class="nav-icon">üèõÔ∏è</span> GST Filing</a>
        <a href="sales_invoice.html" class="nav-link"><span class="nav-icon">üßæ</span> Sales Invoice</a>
        <a href="purchase_invoice.html" class="nav-link"><span class="nav-icon">üöö</span> Purchase Entry</a>
        <a href="vouchers.html" class="nav-link"><span class="nav-icon">üí∏</span> Vouchers (JV)</a>
        <a href="item_master.html" class="nav-link"><span class="nav-icon">üì¶</span> Inventory</a>
        <a href="moneywise.html" class="nav-link"><span class="nav-icon">üë•</span> Parties / Ledgers</a>
        <a href="coa.html" class="nav-link"><span class="nav-icon">üóÇÔ∏è</span> Chart of Accounts</a>
        <a href="settings.html" class="nav-link"><span class="nav-icon">‚öôÔ∏è</span> Settings</a>
    </div>

    <div class="main">
        <div class="top-header">
            <h2 style="font-size:18px;">Financial Reports</h2>
            <div style="font-size:12px; color:#64748b;">Auto-Generated</div>
        </div>

        <div class="filters">
            <select id="reportType" onchange="toggleFilters()">
                <option value="BalanceSheet">‚öñÔ∏è Balance Sheet</option>
                <option value="PL">üìâ Profit & Loss A/c</option>
                <option value="TrialBalance">üìë Trial Balance</option>
                <option value="DayBook">üìÖ Day Book</option>
                <option value="Ledger">üë§ Ledger Statement</option>
                <option value="Stock">üì¶ Stock Summary</option>
            </select>

            <div id="partyFilter" style="display:none;">
                <input type="text" id="partyInput" list="partyList" placeholder="Select Party..." onchange="resolvePartyId()">
                <datalist id="partyList"></datalist>
                <input type="hidden" id="finalPartyId">
            </div>

            <span style="font-size:13px; font-weight:600;">From:</span>
            <input type="date" id="fromDate">
            <span style="font-size:13px; font-weight:600;">To:</span>
            <input type="date" id="toDate">
            
            <button class="btn-go" onclick="generateReport()">Show Report</button>
            <button class="btn-print" onclick="window.print()">Print Report</button>
        </div>

        <div class="content-area">
            <div class="report-card" id="reportContainer">
                <div style="text-align:center; padding:50px; color:#94a3b8;">Select a report type and click 'Show Report'</div>
            </div>
        </div>
    </div>

    <script src="db.js"></script>
    <script src="auth.js"></script>
    <script>
        let ledgers = [], items = [], groups = [], acctEntries = [], vouchers = [];
        let ledgerMap = {};

        window.onload = async () => {
            await DB.init();
            // Load Data
            [ledgers, items, groups, acctEntries, vouchers] = await Promise.all([
                DB.getLedgers(), DB.getItems(), DB.getGroups(), DB.getAll('acct_entries'), DB.getAll('vouchers')
            ]);
            
            // Set Default Dates (Current FY or Month)
            const d = new Date();
            document.getElementById('toDate').valueAsDate = d;
            document.getElementById('fromDate').valueAsDate = new Date(d.getFullYear(), d.getMonth(), 1); // 1st of current month
            
            populateParties();
            generateReport(); // Load default
        };

        function populateParties() {
            const list = document.getElementById('partyList');
            ledgers.sort((a,b)=>a.name.localeCompare(b.name)).forEach(l => {
                const g = groups.find(grp => grp.id == l.group_id)?.name || '';
                ledgerMap[`${l.name} [${g}]`] = l.id;
                let opt = document.createElement('option');
                opt.value = `${l.name} [${g}]`;
                list.appendChild(opt);
            });
        }
        function resolvePartyId() {
            const val = document.getElementById('partyInput').value;
            document.getElementById('finalPartyId').value = ledgerMap[val] || '';
        }
        function toggleFilters() {
            const type = document.getElementById('reportType').value;
            document.getElementById('partyFilter').style.display = (type === 'Ledger') ? 'block' : 'none';
        }

        async function generateReport() {
            const type = document.getElementById('reportType').value;
            const from = document.getElementById('fromDate').value;
            const to = document.getElementById('toDate').value;
            const pid = document.getElementById('finalPartyId').value;
            
            const container = document.getElementById('reportContainer');
            container.innerHTML = '<div style="text-align:center; padding:20px;">Calculating...</div>';

            if(type === 'BalanceSheet') await renderBalanceSheet(container);
            else if(type === 'PL') await renderPL(container);
            else if(type === 'TrialBalance') await renderTB(container);
            else if(type === 'DayBook') await renderDayBook(container, from, to);
            else if(type === 'Stock') await renderStock(container);
            else if(type === 'Ledger') await renderLedger(container, pid, from, to);
        }

        // --- 1. BALANCE SHEET ---
        async function renderBalanceSheet(container) {
            let liabilities = [], assets = [];
            let totalLiab = 0, totalAsset = 0;

            // Closing Stock
            let closingStock = 0;
            items.forEach(i => closingStock += (i.current_stock * i.std_cost));

            // Net Profit Calc
            let income=0, expense=0;
            // Iterate Ledger Balances
            const balances = {};
            acctEntries.forEach(e => {
                balances[e.ledger_id] = (balances[e.ledger_id] || 0) + (e.debit - e.credit);
            });

            ledgers.forEach(l => {
                const g = groups.find(x => x.id == l.group_id);
                const net = (l.opening_balance || 0) + (balances[l.id] || 0);
                if(net === 0) return;

                if(g.nature === 'Income') income += Math.abs(net); // Cr is negative in calc, so Abs
                else if(g.nature === 'Expense') expense += net; // Dr is positive
                else if(g.nature === 'Asset') {
                    assets.push({name: l.name, amt: net});
                    totalAsset += net;
                } else if(g.nature === 'Liability') {
                    liabilities.push({name: l.name, amt: Math.abs(net)});
                    totalLiab += Math.abs(net);
                }
            });

            // Adjust Profit
            // Trading: Sales + Closing Stock - Purchase - Direct Exp
            // For simplicity here: Income + Closing Stock - Expense
            const netProfit = (income + closingStock) - expense;
            if(netProfit !== 0) {
                liabilities.push({name: "Net Profit / (Loss)", amt: netProfit});
                totalLiab += netProfit;
            }
            assets.push({name: "Closing Stock", amt: closingStock});
            totalAsset += closingStock;

            let lHtml = liabilities.map(x=>`<tr><td>${x.name}</td><td class="amount">‚Çπ${x.amt.toFixed(2)}</td></tr>`).join('');
            let aHtml = assets.map(x=>`<tr><td>${x.name}</td><td class="amount">‚Çπ${x.amt.toFixed(2)}</td></tr>`).join('');

            container.innerHTML = `
                <h3 style="text-align:center; margin-bottom:20px;">Balance Sheet</h3>
                <div class="bs-container">
                    <div class="bs-side">
                        <div class="bs-header">Liabilities</div>
                        <table>${lHtml}<tr class="bold-row"><td>Total</td><td class="amount">‚Çπ${totalLiab.toFixed(2)}</td></tr></table>
                    </div>
                    <div class="bs-side">
                        <div class="bs-header">Assets</div>
                        <table>${aHtml}<tr class="bold-row"><td>Total</td><td class="amount">‚Çπ${totalAsset.toFixed(2)}</td></tr></table>
                    </div>
                </div>`;
        }

        // --- 2. PROFIT & LOSS ---
        async function renderPL(container) {
            // Simplified for brevity
            let sales=0, purchase=0, expenses=0, otherInc=0;
            let closingStock = 0; items.forEach(i => closingStock += (i.current_stock * i.std_cost));

            // Calc Balances
            const balances = {};
            acctEntries.forEach(e => { balances[e.ledger_id] = (balances[e.ledger_id] || 0) + (e.debit - e.credit); });

            ledgers.forEach(l => {
                const g = groups.find(x => x.id == l.group_id);
                const net = (balances[l.id] || 0); // Exclude Op Bal for P&L usually
                if(net === 0) return;

                if(g.name === 'Sales Accounts') sales += Math.abs(net);
                else if(g.name === 'Purchase Accounts') purchase += net;
                else if(g.nature === 'Expense') expenses += net;
                else if(g.nature === 'Income') otherInc += Math.abs(net);
            });

            const gp = (sales + closingStock) - purchase;
            const np = (gp + otherInc) - expenses;

            container.innerHTML = `
                <h3 style="text-align:center;">Profit & Loss Account</h3>
                <table style="max-width:800px; margin:auto; border:1px solid #ddd;">
                    <tr><td>Sales</td><td class="amount">‚Çπ${sales.toFixed(2)}</td></tr>
                    <tr><td>Purchase</td><td class="amount">(‚Çπ${purchase.toFixed(2)})</td></tr>
                    <tr><td>Closing Stock</td><td class="amount">‚Çπ${closingStock.toFixed(2)}</td></tr>
                    <tr class="bold-row"><td>Gross Profit</td><td class="amount">‚Çπ${gp.toFixed(2)}</td></tr>
                    <tr><td colspan="2" style="height:10px;"></td></tr>
                    <tr><td>Indirect Income</td><td class="amount">‚Çπ${otherInc.toFixed(2)}</td></tr>
                    <tr><td>Indirect Expenses</td><td class="amount">(‚Çπ${expenses.toFixed(2)})</td></tr>
                    <tr class="bold-row"><td>Net Profit</td><td class="amount">‚Çπ${np.toFixed(2)}</td></tr>
                </table>`;
        }

        // --- 3. TRIAL BALANCE ---
        async function renderTB(container) {
            let html = `<table><thead><tr><th>Account</th><th>Dr</th><th>Cr</th></tr></thead><tbody>`;
            let tDr=0, tCr=0;
            
            // Calculate balances
            const balances = {};
            acctEntries.forEach(e => { balances[e.ledger_id] = (balances[e.ledger_id] || 0) + (e.debit - e.credit); });

            ledgers.forEach(l => {
                const bal = (l.opening_balance || 0) + (balances[l.id] || 0);
                if(bal === 0) return;
                const dr = bal > 0 ? bal : 0;
                const cr = bal < 0 ? Math.abs(bal) : 0;
                tDr += dr; tCr += cr;
                html += `<tr><td>${l.name}</td><td class="amount">${dr?dr.toFixed(2):''}</td><td class="amount">${cr?cr.toFixed(2):''}</td></tr>`;
            });
            html += `<tr class="bold-row"><td>Total</td><td class="amount">${tDr.toFixed(2)}</td><td class="amount">${tCr.toFixed(2)}</td></tr></tbody></table>`;
            container.innerHTML = html;
        }

        // --- 4. DAY BOOK ---
        async function renderDayBook(container, from, to) {
            const filtered = vouchers.filter(v => v.date >= from && v.date <= to).sort((a,b) => new Date(a.date) - new Date(b.date));
            let html = `<table><thead><tr><th>Date</th><th>Vch No</th><th>Type</th><th>Narration</th><th class="amount">Amount</th></tr></thead><tbody>`;
            let total = 0;
            filtered.forEach(v => {
                total += v.amount;
                html += `<tr><td>${v.date}</td><td>${v.voucher_no}</td><td>${v.type}</td><td>${v.narration}</td><td class="amount">${v.amount.toFixed(2)}</td></tr>`;
            });
            html += `<tr class="bold-row"><td colspan="4">Total</td><td class="amount">${total.toFixed(2)}</td></tr></tbody></table>`;
            container.innerHTML = filtered.length ? html : '<div style="padding:20px; text-align:center">No entries found</div>';
        }

        // --- 5. LEDGER STATEMENT ---
        async function renderLedger(container, pid, from, to) {
            if(!pid) return container.innerHTML = '<div style="padding:20px; text-align:center">Select a Party first</div>';
            
            const l = ledgers.find(x => x.id == pid);
            let bal = l.opening_balance || 0;
            
            // Calculate Opening Balance before 'From Date'
            acctEntries.filter(e => e.ledger_id == pid).forEach(e => {
                const v = vouchers.find(vx => vx.id == e.voucher_id);
                if(v && v.date < from) bal += (e.debit - e.credit);
            });

            let html = `<h3>${l.name}</h3><p>From: ${from} To: ${to}</p>
            <table><thead><tr><th>Date</th><th>Vch No</th><th>Particulars</th><th class="amount">Debit</th><th class="amount">Credit</th><th class="amount">Balance</th></tr></thead><tbody>
            <tr style="background:#fff7ed"><td>-</td><td>-</td><td><b>Opening Balance</b></td><td></td><td></td><td class="amount">${bal.toFixed(2)}</td></tr>`;

            // Filter entries within range
            const relevantEntries = acctEntries.filter(e => e.ledger_id == pid);
            // Sort by voucher date
            const sortedEntries = [];
            relevantEntries.forEach(e => {
                const v = vouchers.find(vx => vx.id == e.voucher_id);
                if(v && v.date >= from && v.date <= to) sortedEntries.push({e, v});
            });
            sortedEntries.sort((a,b) => new Date(a.v.date) - new Date(b.v.date));

            sortedEntries.forEach(item => {
                const {e, v} = item;
                bal += (e.debit - e.credit);
                html += `<tr>
                    <td>${v.date}</td>
                    <td>${v.voucher_no}</td>
                    <td>${v.type} (${v.narration})</td>
                    <td class="amount">${e.debit ? e.debit.toFixed(2) : ''}</td>
                    <td class="amount">${e.credit ? e.credit.toFixed(2) : ''}</td>
                    <td class="amount" style="color:${bal<0?'red':'green'}">${Math.abs(bal).toFixed(2)} ${bal>=0?'Dr':'Cr'}</td>
                </tr>`;
            });
            
            html += `<tr class="bold-row"><td colspan="5">Closing Balance</td><td class="amount">${Math.abs(bal).toFixed(2)} ${bal>=0?'Dr':'Cr'}</td></tr></tbody></table>`;
            container.innerHTML = html;
        }

        // --- 6. STOCK ---
        async function renderStock(container) {
            let html = `<table><thead><tr><th>Item Name</th><th class="amount">Qty</th><th>Unit</th><th class="amount">Avg Cost</th><th class="amount">Value</th></tr></thead><tbody>`;
            let totalVal = 0;
            items.forEach(i => {
                const val = i.current_stock * i.std_cost;
                totalVal += val;
                html += `<tr><td>${i.name}</td><td class="amount">${i.current_stock}</td><td>${i.unit}</td><td class="amount">${i.std_cost.toFixed(2)}</td><td class="amount">${val.toFixed(2)}</td></tr>`;
            });
            html += `<tr class="bold-row"><td colspan="4">Total Inventory Value</td><td class="amount">${totalVal.toFixed(2)}</td></tr></tbody></table>`;
            container.innerHTML = html;
        }
    </script>
</body>
</html>