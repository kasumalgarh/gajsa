<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Money Wise Pro - Reports</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --sidebar-bg: #0f172a; --sidebar-text: #94a3b8; --active-text: #f8fafc;
            --bg: #f1f5f9; --card-bg: #ffffff; --text: #334155; --border: #cbd5e1;
            --accent: #2563eb; 
        }
        * { box-sizing: border-box; font-family: 'Inter', sans-serif; margin: 0; padding: 0; }
        body { display: flex; height: 100vh; background: var(--bg); color: var(--text); overflow: hidden; }

        .sidebar { width: 260px; background: var(--sidebar-bg); padding: 20px; display: flex; flex-direction: column; flex-shrink: 0; }
        .brand { font-size: 20px; font-weight: 800; color: #fff; margin-bottom: 40px; display: flex; align-items: center; gap: 10px; }
        .nav-link { padding: 12px 15px; margin-bottom: 5px; border-radius: 8px; color: var(--sidebar-text); text-decoration: none; font-weight: 500; display: flex; align-items: center; gap: 12px; transition: 0.2s; font-size: 14px; }
        .nav-link:hover, .nav-link.active { background: #1e293b; color: var(--active-text); }
        .nav-icon { font-size: 18px; }

        .main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .top-header { background: white; padding: 15px 25px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .report-title { font-size: 18px; font-weight: 700; color: #0f172a; }

        .filters { background: white; padding: 15px 25px; display: flex; gap: 15px; align-items: center; border-bottom: 1px solid var(--border); flex-wrap: wrap; }
        select, input { padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px; outline: none; font-size: 14px; }
        .btn-go { background: var(--accent); color: white; border: none; padding: 8px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; }
        .btn-print { background: #475569; color: white; border: none; padding: 8px 20px; border-radius: 6px; cursor: pointer; margin-left: auto; }

        .content-area { flex: 1; overflow-y: auto; padding: 25px; }
        .report-card { background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); overflow: hidden; border: 1px solid var(--border); }
        
        table { width: 100%; border-collapse: collapse; font-size: 12px; }
        th { background: #f8fafc; padding: 10px 12px; text-align: left; font-weight: 700; color: #475569; border-bottom: 2px solid var(--border); }
        td { padding: 8px 12px; border-bottom: 1px solid var(--border); color: #334155; }
        tr:last-child td { border-bottom: none; }
        .amount { text-align: right; font-family: 'Courier New', monospace; font-weight: 600; }
        
        .dr { color: #16a34a; } /* Green */
        .cr { color: #dc2626; } /* Red */
        .bold-row { background: #f8fafc; font-weight: 700; }
        
        /* Specific coloring for Cash/Bank Book */
        .cash-col { background-color: #f0fdf4; }
        .bank-col { background-color: #eff6ff; }

        @media print {
            .sidebar, .filters, .btn-print { display: none !important; }
            .main { width: 100%; height: auto; }
            .content-area { padding: 0; overflow: visible; }
            .report-card { border: none; box-shadow: none; }
        }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="brand">üöÄ MoneyWise Pro</div>
        <a href="index.html" class="nav-link"><span class="nav-icon">üìä</span> Dashboard</a>
        <a href="#" class="nav-link active"><span class="nav-icon">üìà</span> Reports</a>
        <a href="sales_invoice.html" class="nav-link"><span class="nav-icon">üßæ</span> Sales Invoice</a>
        <a href="purchase_invoice.html" class="nav-link"><span class="nav-icon">üöö</span> Purchase Entry</a>
        <a href="vouchers.html" class="nav-link"><span class="nav-icon">üí∏</span> Vouchers</a>
        <a href="item_master.html" class="nav-link"><span class="nav-icon">üì¶</span> Inventory</a>
        <a href="moneywise.html" class="nav-link"><span class="nav-icon">üë•</span> Parties / Ledgers</a>
        <a href="coa.html" class="nav-link"><span class="nav-icon">üóÇÔ∏è</span> Chart of Accounts</a>
        <a href="settings.html" class="nav-link"><span class="nav-icon">‚öôÔ∏è</span> Settings</a>
    </div>

    <div class="main">
        <div class="top-header">
            <div class="report-title">Reports & Analysis</div>
            <div style="font-size:12px; color:#64748b;" id="dateDisplay"></div>
        </div>

        <div class="filters">
            <select id="reportType" onchange="toggleFilters()">
                <option value="CashBankBook">üí∞ Cash & Bank Book</option>
                <option value="DayBook">üìÖ Day Book (Roznamcha)</option>
                <option value="Ledger">üë§ Party Statement (Khata)</option>
                <option value="TrialBalance">‚öñÔ∏è Trial Balance</option>
                <option value="MonthlySummary">üìä Business Summary</option>
                <option value="Stock">üì¶ Stock Summary</option>
                <option value="PL">üìâ Profit & Loss</option>
            </select>

            <div id="partyFilter" style="display:none;">
                <input type="text" id="partyInput" list="partyList" placeholder="üîç Search Ledger..." style="width: 200px;" onchange="resolvePartyId()">
                <datalist id="partyList"></datalist>
                <input type="hidden" id="finalPartyId">
            </div>

            <input type="date" id="fromDate">
            <input type="date" id="toDate">
            <button class="btn-go" onclick="generateReport()">Show</button>
            <button class="btn-print" onclick="window.print()">Print</button>
        </div>

        <div class="content-area">
            <div class="report-card">
                <table id="reportTable">
                    <thead></thead>
                    <tbody></tbody>
                </table>
            </div>
            <div id="emptyState" style="text-align:center; padding:50px; color:#94a3b8; display:none;">No records found.</div>
        </div>
    </div>

    <script src="db.js"></script>
    <script>
        let ledgers = [];
        let items = [];
        let groups = [];
        let ledgerMap = {};

        window.onload = async () => {
            await DB.init();
            ledgers = await DB.getLedgers();
            items = await DB.getItems();
            groups = await DB.getGroups();
            
            const d = new Date();
            document.getElementById('toDate').valueAsDate = d;
            document.getElementById('fromDate').valueAsDate = new Date(d.getFullYear(), d.getMonth(), 1);
            
            populateParties();
            generateReport(); 
        };

        function populateParties() {
            const list = document.getElementById('partyList');
            list.innerHTML = '';
            ledgerMap = {};
            ledgers.sort((a,b) => a.name.localeCompare(b.name));
            ledgers.forEach(l => {
                const g = groups.find(grp => grp.id == l.group_id)?.name || 'Unknown';
                const displayName = `${l.name} [${g}]`;
                ledgerMap[displayName] = l.id;
                let opt = document.createElement('option');
                opt.value = displayName;
                list.appendChild(opt);
            });
        }

        function resolvePartyId() {
            const val = document.getElementById('partyInput').value;
            const id = ledgerMap[val];
            document.getElementById('finalPartyId').value = id || '';
        }

        function toggleFilters() {
            const type = document.getElementById('reportType').value;
            document.getElementById('partyFilter').style.display = (type === 'Ledger') ? 'block' : 'none';
        }

        async function generateReport() {
            const type = document.getElementById('reportType').value;
            const from = document.getElementById('fromDate').value;
            const to = document.getElementById('toDate').value;
            const partyId = document.getElementById('finalPartyId').value;

            const table = document.getElementById('reportTable');
            const thead = table.querySelector('thead');
            const tbody = table.querySelector('tbody');
            tbody.innerHTML = '';
            document.getElementById('emptyState').style.display = 'none';

            if (type === 'CashBankBook') await renderCashBankBook(thead, tbody, from, to);
            else if (type === 'DayBook') await renderDayBook(thead, tbody, from, to);
            else if (type === 'Ledger') await renderLedger(thead, tbody, partyId, from, to);
            else if (type === 'TrialBalance') await renderTrialBalance(thead, tbody, from, to);
            else if (type === 'MonthlySummary') await renderMonthlySummary(thead, tbody);
            else if (type === 'Stock') await renderStock(thead, tbody);
            else if (type === 'PL') await renderPL(thead, tbody);
        }

        // --- 1. CASH & BANK BOOK (NEW) ---
        async function renderCashBankBook(thead, tbody, from, to) {
            thead.innerHTML = `
                <tr>
                    <th rowspan="2">Date</th>
                    <th rowspan="2">Voucher</th>
                    <th rowspan="2">Particulars</th>
                    <th colspan="2" style="text-align:center; background:#f0fdf4;">CASH</th>
                    <th colspan="2" style="text-align:center; background:#eff6ff;">BANK</th>
                </tr>
                <tr>
                    <th class="amount cash-col">In (Dr)</th>
                    <th class="amount cash-col">Out (Cr)</th>
                    <th class="amount bank-col">In (Dr)</th>
                    <th class="amount bank-col">Out (Cr)</th>
                </tr>`;

            const acctEntries = await DB.getAll('acct_entries');
            const vouchers = await DB.getAll('vouchers');

            // Identify Cash and Bank Ledgers
            const cashIds = ledgers.filter(l => {
                const g = groups.find(grp => grp.id == l.group_id);
                return g && g.name.includes("Cash");
            }).map(l => l.id);

            const bankIds = ledgers.filter(l => {
                const g = groups.find(grp => grp.id == l.group_id);
                return g && g.name.includes("Bank");
            }).map(l => l.id);

            // Filter Entries
            const filtered = acctEntries.filter(e => {
                const isCashOrBank = cashIds.includes(e.ledger_id) || bankIds.includes(e.ledger_id);
                if (!isCashOrBank) return false;
                
                const v = vouchers.find(vx => vx.id == e.voucher_id);
                return v && v.date >= from && v.date <= to;
            });

            if (filtered.length === 0) return showEmpty();

            // Enrich and Sort
            const rows = filtered.map(e => {
                const v = vouchers.find(vx => vx.id == e.voucher_id);
                return { ...e, date: v.date, vNo: v.voucher_no, narr: v.narration || '' };
            }).sort((a,b) => a.date.localeCompare(b.date));

            let totCIn=0, totCOut=0, totBIn=0, totBOut=0;

            rows.forEach(r => {
                const isCash = cashIds.includes(r.ledger_id);
                const cashIn = isCash ? r.debit : 0;
                const cashOut = isCash ? r.credit : 0;
                const bankIn = !isCash ? r.debit : 0;
                const bankOut = !isCash ? r.credit : 0;

                totCIn += cashIn; totCOut += cashOut;
                totBIn += bankIn; totBOut += bankOut;

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${r.date}</td>
                    <td>${r.vNo}</td>
                    <td><small>${r.narr}</small></td>
                    <td class="amount cash-col">${cashIn ? cashIn.toFixed(2) : '-'}</td>
                    <td class="amount cash-col">${cashOut ? cashOut.toFixed(2) : '-'}</td>
                    <td class="amount bank-col">${bankIn ? bankIn.toFixed(2) : '-'}</td>
                    <td class="amount bank-col">${bankOut ? bankOut.toFixed(2) : '-'}</td>
                `;
                tbody.appendChild(tr);
            });

            tbody.innerHTML += `
                <tr class="bold-row">
                    <td colspan="3">Total Period</td>
                    <td class="amount">${totCIn.toFixed(2)}</td>
                    <td class="amount">${totCOut.toFixed(2)}</td>
                    <td class="amount">${totBIn.toFixed(2)}</td>
                    <td class="amount">${totBOut.toFixed(2)}</td>
                </tr>`;
        }

        // --- 2. DAY BOOK ---
        async function renderDayBook(thead, tbody, from, to) {
            thead.innerHTML = `<tr><th>Date</th><th>Voucher No</th><th>Particulars</th><th>Type</th><th class="amount">Amount</th></tr>`;
            const vouchers = await DB.getAll('vouchers');
            const filtered = vouchers.filter(v => v.date >= from && v.date <= to).sort((a,b) => a.date.localeCompare(b.date));
            if(filtered.length === 0) return showEmpty();

            filtered.forEach(v => {
                const party = ledgers.find(l => l.id == v.party_id)?.name || 'Unknown';
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${v.date}</td>
                    <td>${v.voucher_no}</td>
                    <td>${party} <br><small style="color:#64748b">${v.narration || ''}</small></td>
                    <td>${v.type}</td>
                    <td class="amount">‚Çπ${v.amount.toFixed(2)}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // --- 3. LEDGER STATEMENT ---
        async function renderLedger(thead, tbody, partyId, from, to) {
            if(!partyId) return alert("Select a Party first");
            const party = ledgers.find(l => l.id == partyId);
            thead.innerHTML = `<tr><th>Date</th><th>Voucher</th><th>Narration</th><th class="amount">Debit</th><th class="amount">Credit</th></tr>`;
            
            let runningBal = party.opening_balance || 0;
            tbody.innerHTML += `<tr style="background:#fffbeb"><td colspan="3"><strong>Op. Balance</strong></td><td class="amount dr">${runningBal>=0?runningBal.toFixed(2):''}</td><td class="amount cr">${runningBal<0?Math.abs(runningBal).toFixed(2):''}</td></tr>`;

            const acctEntries = await DB.getAll('acct_entries');
            const vouchers = await DB.getAll('vouchers');
            const enriched = acctEntries.filter(e => e.ledger_id == partyId).map(e => {
                const v = vouchers.find(vx => vx.id == e.voucher_id);
                return { ...e, date: v?.date, vNo: v?.voucher_no, narr: v?.narration };
            }).filter(e => e.date >= from && e.date <= to).sort((a,b) => a.date.localeCompare(b.date));

            let tDr=0, tCr=0;
            enriched.forEach(e => {
                tDr += e.debit; tCr += e.credit;
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${e.date}</td><td>${e.vNo}</td><td>${e.narr||'-'}</td><td class="amount">${e.debit||'-'}</td><td class="amount">${e.credit||'-'}</td>`;
                tbody.appendChild(tr);
            });
            tbody.innerHTML += `<tr class="bold-row"><td colspan="3">Total</td><td class="amount">${tDr.toFixed(2)}</td><td class="amount">${tCr.toFixed(2)}</td></tr>`;
        }

        // --- 4. TRIAL BALANCE ---
        async function renderTrialBalance(thead, tbody, from, to) {
            thead.innerHTML = `<tr><th>Account Name</th><th>Group</th><th class="amount">Total Debit</th><th class="amount">Total Credit</th><th class="amount">Closing Balance</th></tr>`;
            const acctEntries = await DB.getAll('acct_entries');
            const vouchers = await DB.getAll('vouchers');
            
            for (const l of ledgers) {
                const g = groups.find(grp => grp.id == l.group_id)?.name || 'Unknown';
                const lEntries = acctEntries.filter(e => e.ledger_id == l.id && vouchers.find(v=>v.id==e.voucher_id)?.date >= from); // simplified date check
                
                if (lEntries.length === 0 && (l.opening_balance||0)===0) continue;
                
                let dr=0, cr=0;
                lEntries.forEach(e => { dr+=e.debit; cr+=e.credit; });
                let net = (l.opening_balance||0) + (dr - cr);
                
                const tr = document.createElement('tr');
                tr.innerHTML = `<td><strong>${l.name}</strong></td><td><small>${g}</small></td><td class="amount">${dr||'-'}</td><td class="amount">${cr||'-'}</td><td class="amount" style="color:${net>=0?'green':'red'}">${Math.abs(net).toFixed(2)} ${net>=0?'Dr':'Cr'}</td>`;
                tbody.appendChild(tr);
            }
        }

        // --- 5. MONTHLY SUMMARY ---
        async function renderMonthlySummary(thead, tbody) {
            thead.innerHTML = `<tr><th>Month</th><th class="amount">Sales</th><th class="amount">Purchase</th><th class="amount">Rcpt</th><th class="amount">Pmt</th></tr>`;
            const vouchers = await DB.getAll('vouchers');
            const sum = {};
            vouchers.forEach(v => {
                const k = v.date.substring(0,7);
                if(!sum[k]) sum[k] = {s:0, p:0, r:0, pay:0};
                if(v.type==='Sales') sum[k].s += v.amount;
                if(v.type==='Purchase') sum[k].p += v.amount;
                if(v.type==='Receipt') sum[k].r += v.amount;
                if(v.type==='Payment') sum[k].pay += v.amount;
            });
            Object.keys(sum).sort().forEach(m => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${m}</td><td class="amount dr">${sum[m].s}</td><td class="amount cr">${sum[m].p}</td><td class="amount dr">${sum[m].r}</td><td class="amount cr">${sum[m].pay}</td>`;
                tbody.appendChild(tr);
            });
        }

        // --- 6. STOCK & PL ---
        async function renderStock(thead, tbody) {
            thead.innerHTML = `<tr><th>Item</th><th>Qty</th><th class="amount">Value</th></tr>`;
            items.forEach(i => {
                tbody.innerHTML += `<tr><td>${i.name}</td><td>${i.current_stock}</td><td class="amount">${(i.current_stock*i.std_cost).toFixed(2)}</td></tr>`;
            });
        }

        async function renderPL(thead, tbody) {
            thead.innerHTML = `<tr><th>Particulars</th><th class="amount">Amount</th></tr>`;
            let s=0, p=0;
            const vouchers = await DB.getAll('vouchers');
            vouchers.forEach(v => { if(v.type==='Sales')s+=v.amount; if(v.type==='Purchase')p+=v.amount; });
            tbody.innerHTML = `<tr><td>Sales</td><td class="amount">${s}</td></tr><tr><td>Purchase</td><td class="amount">${p}</td></tr><tr class="bold-row"><td>Gross Profit</td><td class="amount">${s-p}</td></tr>`;
        }

        function showEmpty() { document.getElementById('emptyState').style.display = 'block'; }
    </script>
</body>
</html>