<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Reporting - Arth Book</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --sidebar-bg: #0f172a; --bg: #f8fafc; --text: #1e293b; --border: #cbd5e1;
            --accent: #2563eb; --red: #ef4444; --green: #10b981; --orange: #f59e0b;
            --shadow: 0 4px 12px rgba(0,0,0,0.08);
            --transition: all 0.3s ease;
        }
        * { box-sizing: border-box; font-family: 'Inter', sans-serif; margin: 0; padding: 0; }
        body { display: flex; height: 100vh; background: var(--bg); color: var(--text); overflow: hidden; }

        /* SIDEBAR */
        .sidebar { 
            width: 260px; background: var(--sidebar-bg); padding: 20px; display: flex; 
            flex-direction: column; flex-shrink: 0; height: 100vh; overflow-y: auto; 
            transition: var(--transition); z-index: 100;
        }
        .brand { font-size: 20px; font-weight: 800; color: white; margin-bottom: 40px; display: flex; align-items: center; gap: 10px; }
        .nav-link { display: flex; align-items: center; gap: 12px; padding: 14px 18px; color: #94a3b8; text-decoration: none; border-radius: 10px; margin-bottom: 6px; font-weight: 500; transition: var(--transition); }
        .nav-link:hover, .nav-link.active { background: #1e293b; color: white; }

        /* MOBILE */
        .menu-btn { display: none; position: fixed; top: 15px; left: 15px; z-index: 1100; background: none; border: none; font-size: 1.6rem; color: var(--text); cursor: pointer; }
        .overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 900; }

        /* MAIN */
        .main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .top-bar { background: white; padding: 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 15px; flex-wrap: wrap; box-shadow: var(--shadow); }
        select, input[type="date"], input[type="text"] { padding: 10px 14px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px; outline: none; }
        .btn { padding: 10px 20px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; color: white; transition: var(--transition); display: inline-flex; align-items: center; gap: 8px; }
        .btn:hover { opacity: 0.9; transform: translateY(-2px); }
        .btn-go { background: var(--accent); }
        .btn-excel { background: var(--green); }
        .btn-print { background: #475569; }

        .content-area { flex: 1; overflow-y: auto; padding: 30px; }
        .report-paper { background: white; padding: 30px; margin: 0 auto; max-width: 210mm; border-radius: 12px; box-shadow: var(--shadow); border: 1px solid var(--border); }

        h2 { text-align: center; font-size: 22px; font-weight: 700; color: var(--accent); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; }
        .sub-head { text-align: center; font-size: 14px; color: #64748b; margin-bottom: 30px; }

        /* TABLES */
        table { width: 100%; border-collapse: collapse; font-size: 13px; margin-top: 15px; }
        th { background: #f1f5f9; padding: 12px; text-align: left; font-weight: 600; color: #475569; border-bottom: 2px solid var(--border); }
        td { padding: 10px 12px; border-bottom: 1px solid var(--border); }
        .amt { text-align: right; font-weight: 600; font-family: monospace; }
        .bold-row { font-weight: 700; background: #f8fafc; border-top: 2px solid var(--border); border-bottom: 2px solid var(--border); }

        /* HEALTH REPORT */
        .health-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px; margin: 30px 0; }
        .h-card { background: #f0f9ff; border: 1px solid #bae6fd; padding: 20px; border-radius: 12px; }
        .ai-box { background: linear-gradient(135deg, #dbeafe, #bfdbfe); border: 1px solid var(--accent); padding: 20px; border-radius: 12px; margin-bottom: 30px; }

        /* ALERTS */
        .exp-soon { color: var(--orange); font-weight: 700; }
        .exp-expired { color: var(--red); font-weight: 700; }

        @media print {
            .sidebar, .top-bar, .menu-btn, .overlay { display: none !important; }
            .content-area { padding: 0; }
            .report-paper { box-shadow: none; border: none; margin: 0; width: 100%; max-width: 100%; padding: 20px; }
            body { background: white; }
        }

        @media (max-width: 900px) {
            .menu-btn { display: block; }
            .sidebar { position: fixed; left: -100%; top: 0; height: 100%; z-index: 1000; box-shadow: var(--shadow); }
            .sidebar.active { left: 0; }
            .overlay.active { display: block; }
            .top-bar { padding: 15px; flex-direction: column; align-items: stretch; }
            .top-bar > div, .top-bar > button { width: 100%; margin-bottom: 10px; }
            .content-area { padding: 20px 15px; }
            .health-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <button class="menu-btn" onclick="toggleMenu()">‚ò∞</button>
    <div class="overlay" onclick="toggleMenu()"></div>

    <div class="sidebar" id="mySidebar">
        <div class="brand"><i class="fas fa-book"></i> Arth Book</div>
        <a href="index.html" class="nav-link"><i class="fas fa-chart-pie"></i> Dashboard</a>
        <a href="reports.html" class="nav-link active"><i class="fas fa-chart-line"></i> Reports</a>
        <a href="gst_filing.html" class="nav-link"><i class="fas fa-university"></i> GST Filing</a>
        <a href="sales_invoice.html" class="nav-link"><i class="fas fa-file-invoice"></i> Sales</a>
        <a href="purchase_invoice.html" class="nav-link"><i class="fas fa-truck"></i> Purchase</a>
        <a href="vouchers.html" class="nav-link"><i class="fas fa-receipt"></i> Vouchers</a>
        <a href="item_master.html" class="nav-link"><i class="fas fa-boxes"></i> Inventory</a>
        <a href="ArthBook.html" class="nav-link"><i class="fas fa-users"></i> Parties</a>
        <a href="coa.html" class="nav-link"><i class="fas fa-balance-scale"></i> Accounts</a>
        <a href="settings.html" class="nav-link"><i class="fas fa-cogs"></i> Settings</a>
    </div>

    <div class="main">
        <div class="top-bar">
            <select id="reportType" onchange="toggleFilters()">
                <option value="Health">üè• Business Health (AI)</option>
                <option value="PL">üìâ Profit & Loss</option>
                <option value="BalanceSheet">‚öñÔ∏è Balance Sheet</option>
                <option value="TrialBalance">üìë Trial Balance</option>
                <option value="DayBook">üìÖ Day Book</option>
                <option value="Ledger">üë§ Party Ledger</option>
                <option value="Stock">üì¶ Stock Summary</option>
                <option value="LowStock">‚ö†Ô∏è Low Stock</option>
                <option value="Expiry">üóìÔ∏è Expiry Report</option>
            </select>

            <div id="partyFilter" style="display:none; width:100%;">
                <input type="text" id="partyInput" list="partyList" placeholder="Search & Select Party..." style="width:100%;">
                <datalist id="partyList"></datalist>
                <input type="hidden" id="selectedPartyId">
            </div>

            <input type="date" id="fromDate">
            <input type="date" id="toDate">

            <button class="btn btn-go" onclick="generateReport()">üîÑ Generate Report</button>
            <button class="btn btn-excel" onclick="exportToExcel()">üìä Export Excel</button>
            <button class="btn btn-print" onclick="window.print()">üñ®Ô∏è Print</button>
        </div>

        <div class="content-area">
            <div class="report-paper" id="reportContent">
                <div style="text-align:center; padding:120px 40px; color:#cbd5e1;">
                    <h2>Select Report Type</h2>
                    <p style="margin-top:15px;">Choose from dropdown & click Generate</p>
                    <p style="margin-top:10px; font-size:14px;">Tip: Business Health uses AI for predictions</p>
                </div>
            </div>
        </div>
    </div>

    <script src="db.js"></script>
    <script src="ai_engine.js"></script>
    <script>
        let ledgers = [], items = [], groups = [], acctEntries = [], vouchers = [], batches = [];
        let ledgerMap = {}, itemMap = {};

        window.onload = async () => {
            await DB.init();

            [ledgers, items, groups, acctEntries, vouchers, batches] = await Promise.all([
                DB.getLedgers(),
                DB.getAll('items'),
                DB.getAll('groups'),
                DB.getAll('acct_entries'),
                DB.getAll('vouchers'),
                DB.getAll('batches') || []
            ]);

            // Maps for quick lookup
            ledgers.forEach(l => ledgerMap[l.id] = l.name);
            items.forEach(i => itemMap[i.id] = i.name);

            // Default dates: Current month
            const today = new Date();
            document.getElementById('toDate').valueAsDate = today;
            document.getElementById('fromDate').valueAsDate = new Date(today.getFullYear(), today.getMonth(), 1);

            populatePartyDatalist();
        };

        function toggleMenu() {
            document.getElementById('mySidebar').classList.toggle('active');
            document.querySelector('.overlay').classList.toggle('active');
        }

        function populatePartyDatalist() {
            const datalist = document.getElementById('partyList');
            datalist.innerHTML = '';
            ledgers.sort((a,b) => a.name.localeCompare(b.name)).forEach(l => {
                const opt = document.createElement('option');
                opt.value = l.name;
                opt.dataset.id = l.id;
                datalist.appendChild(opt);
            });
        }

        function toggleFilters() {
            const type = document.getElementById('reportType').value;
            document.getElementById('partyFilter').style.display = (type === 'Ledger') ? 'block' : 'none';
        }

        function getSelectedPartyId() {
            const input = document.getElementById('partyInput').value.trim();
            const option = Array.from(document.querySelectorAll('#partyList option'))
                .find(opt => opt.value === input);
            return option ? option.dataset.id : null;
        }

        async function generateReport() {
            const type = document.getElementById('reportType').value;
            const container = document.getElementById('reportContent');
            container.innerHTML = '<div style="text-align:center; padding:80px; color:#94a3b8;"><h3>Generating Report...</h3></div>';

            setTimeout(async () => {
                if(type === 'Health') await renderBusinessHealth(container);
                else if(type === 'PL') renderProfitLoss(container);
                else if(type === 'BalanceSheet') renderBalanceSheet(container);
                else if(type === 'TrialBalance') renderTrialBalance(container);
                else if(type === 'DayBook') renderDayBook(container);
                else if(type === 'Ledger') renderPartyLedger(container);
                else if(type === 'Stock') renderStockSummary(container);
                else if(type === 'LowStock') renderLowStock(container);
                else if(type === 'Expiry') renderExpiryReport(container);
            }, 200);
        }

        // --- CORE ACCOUNTING HELPERS ---
        function calculateLedgerBalance(ledgerId, upToDate = null) {
            const ledger = ledgers.find(l => l.id === ledgerId);
            if(!ledger) return 0;
            let balance = ledger.opening_balance || 0;

            acctEntries
                .filter(e => e.ledger_id === ledgerId)
                .forEach(e => {
                    const v = vouchers.find(v => v.id === e.voucher_id);
                    if(!upToDate || (v && v.date <= upToDate)) {
                        balance += (e.debit || 0) - (e.credit || 0);
                    }
                });
            return balance;
        }

        function getGroupBalances() {
            const balances = { Assets: 0, Liabilities: 0, Income: 0, Expenses: 0 };
            ledgers.forEach(l => {
                const bal = calculateLedgerBalance(l.id);
                const group = groups.find(g => g.id === l.group_id);
                const root = group ? GROUP_TYPES[group.name] || 'Liabilities' : 'Liabilities';
                if(root === 'Assets' || root === 'Expenses') balances[root] += bal;
                else balances[root] += Math.abs(bal) * -1; // Credit side positive
            });
            return balances;
        }

        const GROUP_TYPES = {
            'Capital Account': 'Liabilities',
            'Loans (Liability)': 'Liabilities',
            'Current Liabilities': 'Liabilities',
            'Sundry Creditors': 'Liabilities',
            'Duties & Taxes': 'Liabilities',
            'Fixed Assets': 'Assets',
            'Current Assets': 'Assets',
            'Cash-in-Hand': 'Assets',
            'Bank Accounts': 'Assets',
            'Sundry Debtors': 'Assets',
            'Stock-in-Hand': 'Assets',
            'Sales Accounts': 'Income',
            'Direct Income': 'Income',
            'Indirect Income': 'Income',
            'Purchase Accounts': 'Expenses',
            'Direct Expenses': 'Expenses',
            'Indirect Expenses': 'Expenses'
        };

        // --- REPORT RENDERERS ---
        async function renderBusinessHealth(container) {
            const stockValue = items.reduce((sum, i) => sum + ((i.current_stock || 0) * (i.std_cost || 0)), 0);
            const prediction = await AI.predictNextMonth() || { forecast: 0, dailyAvg: 0 };

            container.innerHTML = `
                <h2>Business Health Overview</h2>
                <p class="sub-head">AI-Powered Insights ‚Ä¢ ${new Date().toLocaleDateString('en-IN')}</p>

                <div class="ai-box">
                    <h3 style="color:var(--accent); margin-bottom:10px;">ü§ñ AI Prediction</h3>
                    <p>Based on recent sales trends:</p>
                    <div style="font-size:28px; font-weight:800; margin:15px 0;">‚Çπ${parseFloat(prediction.forecast || 0).toLocaleString('en-IN')}</div>
                    <p>Projected Revenue Next Month<br><small>Daily Avg: ‚Çπ${parseFloat(prediction.dailyAvg || 0).toLocaleString('en-IN')}</small></p>
                </div>

                <div class="health-grid">
                    <div class="h-card">
                        <h4>Current Stock Value</h4>
                        <div class="amt" style="font-size:24px; color:var(--green);">‚Çπ${stockValue.toLocaleString('en-IN')}</div>
                    </div>
                    <div class="h-card">
                        <h4>Sales Trend</h4>
                        <canvas id="trendChart" height="180"></canvas>
                    </div>
                </div>
            `;

            new Chart(document.getElementById('trendChart'), {
                type: 'line',
                data: {
                    labels: ['Current Month', 'Next Month (AI)'],
                    datasets: [{
                        label: 'Revenue',
                        data: [prediction.currentMonth || 0, prediction.forecast || 0],
                        borderColor: var(--accent),
                        backgroundColor: 'rgba(37,99,235,0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: { responsive: true, plugins: { legend: { display: false } } }
            });
        }

        function renderProfitLoss(container) {
            const balances = getGroupBalances();
            const closingStock = items.reduce((s, i) => s + ((i.current_stock || 0) * (i.std_cost || 0)), 0);
            const grossProfit = balances.Income - balances.Expenses;
            const netProfit = grossProfit + closingStock;

            container.innerHTML = `
                <h2>Profit & Loss Statement</h2>
                <p class="sub-head">For the Period</p>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px;">
                    <div>
                        <table>
                            <thead><tr><th>Expenses</th><th class="amt">Amount</th></tr></thead>
                            <tbody>
                                <tr><td>Purchases & Direct Expenses</td><td class="amt">${balances.Expenses.toLocaleString('en-IN')}</td></tr>
                                ${netProfit < 0 ? `<tr class="bold-row"><td>Net Loss</td><td class="amt" style="color:var(--red);">${Math.abs(netProfit).toLocaleString('en-IN')}</td></tr>` : ''}
                            </tbody>
                        </table>
                    </div>
                    <div>
                        <table>
                            <thead><tr><th>Income</th><th class="amt">Amount</th></tr></thead>
                            <tbody>
                                <tr><td>Sales & Income</td><td class="amt">${balances.Income.toLocaleString('en-IN')}</td></tr>
                                <tr><td>Closing Stock</td><td class="amt">${closingStock.toLocaleString('en-IN')}</td></tr>
                                ${netProfit > 0 ? `<tr class="bold-row"><td>Net Profit</td><td class="amt" style="color:var(--green);">${netProfit.toLocaleString('en-IN')}</td></tr>` : ''}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function renderBalanceSheet(container) {
            const balances = getGroupBalances();
            const closingStock = items.reduce((s, i) => s + ((i.current_stock || 0) * (i.std_cost || 0)), 0);
            const netProfit = balances.Income - balances.Expenses + closingStock;

            container.innerHTML = `
                <h2>Balance Sheet</h2>
                <p class="sub-head">As on ${new Date().toLocaleDateString('en-IN')}</p>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px;">
                    <div>
                        <table>
                            <thead><tr><th>Liabilities</th><th class="amt">Amount</th></tr></thead>
                            <tbody>
                                <tr><td>Capital + Profit</td><td class="amt">${(balances.Liabilities + netProfit).toLocaleString('en-IN')}</td></tr>
                                <tr><td>Current Liabilities</td><td class="amt">${balances.Liabilities.toLocaleString('en-IN')}</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                        <table>
                            <thead><tr><th>Assets</th><th class="amt">Amount</th></tr></thead>
                            <tbody>
                                <tr><td>Fixed & Current Assets</td><td class="amt">${balances.Assets.toLocaleString('en-IN')}</td></tr>
                                <tr><td>Closing Stock</td><td class="amt">${closingStock.toLocaleString('en-IN')}</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function renderTrialBalance(container) {
            let html = `<h2>Trial Balance</h2><table><thead><tr><th>Ledger</th><th class="amt">Debit</th><th class="amt">Credit</th></tr></thead><tbody>`;
            let totalDr = 0, totalCr = 0;
            ledgers.forEach(l => {
                const bal = calculateLedgerBalance(l.id);
                if(Math.abs(bal) < 0.01) return;
                const dr = bal > 0 ? bal : 0;
                const cr = bal < 0 ? Math.abs(bal) : 0;
                totalDr += dr; totalCr += cr;
                html += `<tr><td>${l.name}</td><td class="amt">${dr ? dr.toLocaleString('en-IN') : ''}</td><td class="amt">${cr ? cr.toLocaleString('en-IN') : ''}</td></tr>`;
            });
            html += `<tr class="bold-row"><td>Total</td><td class="amt">${totalDr.toLocaleString('en-IN')}</td><td class="amt">${totalCr.toLocaleString('en-IN')}</td></tr></tbody></table>`;
            container.innerHTML = html;
        }

        function renderDayBook(container) {
            const from = document.getElementById('fromDate').value;
            const to = document.getElementById('toDate').value;
            const filtered = vouchers.filter(v => v.date >= from && v.date <= to).sort((a,b) => a.date.localeCompare(b.date));

            let html = `<h2>Day Book</h2><p class="sub-head">${from} to ${to}</p><table><thead><tr><th>Date</th><th>Voucher</th><th>Type</th><th>Narration</th><th class="amt">Amount</th></tr></thead><tbody>`;
            filtered.forEach(v => {
                html += `<tr><td>${v.date}</td><td>${v.voucher_no}</td><td>${v.type}</td><td>${v.narration || '-'}</td><td class="amt">‚Çπ${(v.amount || 0).toLocaleString('en-IN')}</td></tr>`;
            });
            container.innerHTML = html + '</tbody></table>';
        }

        function renderPartyLedger(container) {
            const partyId = getSelectedPartyId();
            if(!partyId) return container.innerHTML = '<h3 style="text-align:center; color:var(--red);">Please select a valid party</h3>';

            const partyName = ledgers.find(l => l.id == partyId)?.name || 'Unknown';
            const from = document.getElementById('fromDate').value;
            const to = document.getElementById('toDate').value;

            let openingBal = calculateLedgerBalance(partyId, from);
            let runningBal = openingBal;

            const relevantEntries = acctEntries
                .filter(e => e.ledger_id == partyId)
                .map(e => ({ entry: e, voucher: vouchers.find(v => v.id === e.voucher_id) }))
                .filter(x => x.voucher && x.voucher.date >= from && x.voucher.date <= to)
                .sort((a,b) => a.voucher.date.localeCompare(b.voucher.date));

            let html = `<h2>Ledger Statement - ${partyName}</h2><p class="sub-head">${from} to ${to}</p>
            <table><thead><tr><th>Date</th><th>Voucher</th><th>Particulars</th><th class="amt">Debit</th><th class="amt">Credit</th><th class="amt">Balance</th></tr></thead><tbody>
            <tr><td colspan="3"><strong>Opening Balance</strong></td><td class="amt"></td><td class="amt"></td><td class="amt"><strong>‚Çπ${openingBal.toLocaleString('en-IN')}</strong></td></tr>`;

            relevantEntries.forEach(x => {
                const dr = x.entry.debit || 0;
                const cr = x.entry.credit || 0;
                runningBal += dr - cr;
                html += `<tr><td>${x.voucher.date}</td><td>${x.voucher.voucher_no}</td><td>${x.voucher.narration || x.voucher.type}</td>
                <td class="amt">${dr ? '‚Çπ' + dr.toLocaleString('en-IN') : ''}</td>
                <td class="amt">${cr ? '‚Çπ' + cr.toLocaleString('en-IN') : ''}</td>
                <td class="amt"><strong>‚Çπ${runningBal.toLocaleString('en-IN')}</strong></td></tr>`;
            });

            html += `<tr class="bold-row"><td colspan="5">Closing Balance</td><td class="amt"><strong>‚Çπ${runningBal.toLocaleString('en-IN')}</strong></td></tr></tbody></table>`;
            container.innerHTML = html;
        }

        function renderStockSummary(container) {
            const totalValue = items.reduce((sum, i) => sum + ((i.current_stock || 0) * (i.std_cost || 0)), 0);

            let html = `<h2>Stock Summary</h2><table><thead><tr><th>Item</th><th>Current Stock</th><th>Rate</th><th class="amt">Value</th></tr></thead><tbody>`;
            items.forEach(i => {
                const value = (i.current_stock || 0) * (i.std_cost || 0);
                html += `<tr><td>${i.name}</td><td class="amt">${i.current_stock || 0} ${i.unit || ''}</td><td class="amt">‚Çπ${(i.std_cost || 0).toFixed(2)}</td><td class="amt">‚Çπ${value.toLocaleString('en-IN')}</td></tr>`;
            });
            html += `<tr class="bold-row"><td colspan="3">Total Stock Value</td><td class="amt">‚Çπ${totalValue.toLocaleString('en-IN')}</td></tr></tbody></table>`;
            container.innerHTML = html;
        }

        function renderLowStock(container) {
            const lowItems = items.filter(i => (i.current_stock || 0) <= (i.reorder_level || 5));

            let html = `<h2>Low Stock Alert</h2>`;
            if(lowItems.length === 0) html += '<p style="text-align:center; color:var(--green); padding:50px;">‚ú® All items above reorder level!</p>';
            else {
                html += `<table><thead><tr><th>Item</th><th>Current Stock</th><th>Reorder Level</th></tr></thead><tbody>`;
                lowItems.forEach(i => {
                    html += `<tr><td>${i.name}</td><td class="amt" style="color:var(--red);">${i.current_stock || 0}</td><td class="amt">${i.reorder_level || 0}</td></tr>`;
                });
                html += '</tbody></table>';
            }
            container.innerHTML = html;
        }

        function renderExpiryReport(container) {
            const today = new Date().toISOString().slice(0,10);
            const soon = new Date(Date.now() + 30*24*60*60*1000).toISOString().slice(0,10);

            let html = `<h2>Batch Expiry Report</h2><table><thead><tr><th>Item</th><th>Batch</th><th>Expiry Date</th><th>Qty</th><th>Status</th></tr></thead><tbody>`;
            batches.forEach(b => {
                if(!b.expiry_date) return;
                const itemName = itemMap[b.item_id] || `Item ${b.item_id}`;
                const status = b.expiry_date < today ? 'Expired' : (b.expiry_date <= soon ? 'Expiring Soon' : 'OK');
                const color = b.expiry_date < today ? 'var(--red)' : (b.expiry_date <= soon ? 'var(--orange)' : 'var(--green)');
                html += `<tr><td>${itemName}</td><td>${b.batch_no || '-'}</td><td>${b.expiry_date}</td><td class="amt">${b.qty || 0}</td><td style="color:${color}; font-weight:700;">${status}</td></tr>`;
            });
            container.innerHTML = html + '</tbody></table>';
        }

        function exportToExcel() {
            const table = document.querySelector('#reportContent table');
            if(!table) return alert('Generate a report first!');

            let csv = [];
            table.querySelectorAll('tr').forEach(row => {
                const cells = row.querySelectorAll('th, td');
                csv.push(Array.from(cells).map(cell => `"${cell.innerText.trim().replace(/"/g, '""')}"`).join(','));
            });

            const blob = new Blob([csv.join('\n')], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ArthBook_Report_${new Date().toISOString().slice(0,10)}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>