<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="icon" type="image/x-icon" href="favicon.ico">
    <title>Sales POS - Arth Book</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #1e293b; --accent: #2563eb; --border: #cbd5e1; --bg: #f1f5f9; --green: #10b981; --red: #ef4444; }
        * { box-sizing: border-box; font-family: 'Inter', sans-serif; margin: 0; padding: 0; }
        body { background: var(--bg); padding: 15px; color: var(--primary); height: 100vh; display:flex; flex-direction:column; overflow:hidden; }

        /* TOP BAR */
        .toolbar { flex-shrink:0; background:white; padding:10px 20px; display:flex; justify-content:space-between; align-items:center; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.05); margin-bottom:15px; }
        .search-grp { display:flex; gap:10px; flex:1; max-width:600px; position: relative; }
        .search-grp i { position: absolute; left: 10px; top: 12px; color: #999; }
        input, select, textarea { padding:10px; border:1px solid var(--border); border-radius:6px; outline:none; font-family: inherit; }
        .btn { padding:10px 20px; background:var(--accent); color:white; border:none; border-radius:6px; cursor:pointer; font-weight:600; transition: 0.2s; }
        .btn:hover { opacity: 0.9; }
        
        /* POS GRID */
        .pos-layout { display:flex; gap:15px; flex:1; overflow:hidden; }
        
        /* LEFT: VIRTUAL SCROLL LIST */
        .item-list-area { flex:2; background:white; border-radius:12px; border:1px solid var(--border); display:flex; flex-direction:column; overflow:hidden; position:relative; }
        .list-header { padding: 10px 15px; background: #f8fafc; border-bottom: 1px solid var(--border); font-size: 13px; font-weight: 600; color: #64748b; display: flex; justify-content: space-between; }
        
        .vs-viewport { flex:1; overflow-y:auto; position:relative; padding:10px; }
        .vs-spacer { position:absolute; top:0; left:0; right:0; z-index:-1; } 
        
        /* PRODUCT CARD */
        .product-card {
            position: absolute; left:10px; right:10px; height: 70px; 
            border: 1px solid #eee; border-radius: 8px; padding: 10px 15px;
            background: white; cursor: pointer; display: flex; justify-content: space-between; align-items: center;
            transition: background 0.1s;
        }
        .product-card:hover { background: #f0f7ff; border-color: var(--accent); transform: translateX(2px); }
        .low-stock { border-left: 4px solid var(--red); background: #fef2f2; }

        /* RIGHT: BILLING CART */
        .cart-area { flex:1.2; background:white; border-radius:12px; border:1px solid var(--border); display:flex; flex-direction:column; min-width:350px; }
        
        /* Party Section */
        .party-panel { padding: 15px; border-bottom: 1px solid var(--border); background: #f8fafc; }
        .party-row { display: flex; gap: 10px; margin-bottom: 10px; }
        .credit-warn { font-size: 11px; color: var(--red); font-weight: bold; display: none; margin-top: 5px; }

        /* Cart Items */
        .cart-items { flex:1; overflow-y:auto; background: #fff; }
        .cart-header-row { display: flex; padding: 8px 15px; background: #eee; font-size: 12px; font-weight: 700; color: #555; }
        .cart-item { display:flex; align-items: center; padding:10px 15px; border-bottom:1px solid #f1f5f9; font-size:13px; }
        .cart-item:hover { background: #f9f9f9; }
        
        /* Cart Footer */
        .cart-footer { padding:20px; background:#f1f5f9; border-top:1px solid var(--border); border-radius:0 0 12px 12px; }
        .summary-row { display:flex; justify-content:space-between; margin-bottom:5px; font-size: 13px; color: #555; }
        .grand-total { font-size:24px; font-weight:800; color:var(--primary); text-align:right; margin:10px 0; border-top: 2px solid #ddd; padding-top: 5px; }
        
        @media (max-width: 900px) { .pos-layout { flex-direction:column; } .cart-area { height:50vh; } }
    </style>
</head>
<body>

    <div class="toolbar">
        <button class="btn" style="background:#64748b;" onclick="location.href='index.html'">üè† Home</button>
        <div class="search-grp">
            <input type="text" id="searchBar" placeholder="‚ö° Scan Barcode or Type Name..." style="flex:1; padding-left: 15px;" oninput="handleSearch(this.value)">
        </div>
        <div style="font-weight:bold; background:#e0f2fe; color: var(--accent); padding:8px 15px; border-radius:6px;" id="invoiceNo">INV-...</div>
    </div>

    <div class="pos-layout">
        <div class="item-list-area">
            <div class="list-header">
                <span>Select Items (<span id="itemCount">0</span> Loaded)</span>
                <span>Values incl. GST</span>
            </div>
            <div id="loading" style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); color:#999; display:none;">Loading Inventory...</div>
            
            <div class="vs-viewport" id="viewport" onscroll="renderVirtualItems()">
                <div class="vs-spacer" id="spacer"></div>
                <div id="content"></div> 
            </div>
        </div>

        <div class="cart-area">
            <div class="party-panel">
                <div class="party-row">
                    <select id="customerSelect" style="flex:2;" onchange="loadPartyDetails()">
                        <option value="">Select Customer</option>
                    </select>
                    <input type="date" id="billDate" style="flex:1;">
                </div>
                <div id="partyInfo" style="display:none;">
                    <div class="party-row">
                        <input id="partyMobile" placeholder="Phone" style="flex:1;" readonly>
                        <input id="partyGST" placeholder="GSTIN" style="flex:1;" readonly>
                    </div>
                    <div id="creditMsg" class="credit-warn">‚ö†Ô∏è Credit Limit Exceeded! Balance: ‚Çπ<span id="currBal">0</span></div>
                </div>
            </div>

            <div class="cart-header-row">
                <span style="flex:2;">Item</span>
                <span style="flex:1; text-align:center;">Qty</span>
                <span style="flex:1; text-align:right;">Total</span>
                <span style="width:20px;"></span>
            </div>

            <div class="cart-items" id="cartBody">
                <div style="text-align:center; padding:40px; color:#ccc;">
                    üõí Cart is Empty<br><small>Scan items to add</small>
                </div>
            </div>

            <div class="cart-footer">
                <div class="summary-row"><span>Subtotal</span> <span id="subTotal">0.00</span></div>
                <div class="summary-row"><span>Tax (GST)</span> <span id="taxTotal">0.00</span></div>
                <div class="grand-total">‚Çπ <span id="grandTotal">0.00</span></div>
                
                <div style="display:flex; gap: 10px;">
                    <button class="btn" style="flex:1; background:#475569;" onclick="cart=[]; renderCart();">Clear</button>
                    <button class="btn" style="flex:2; background:var(--green);" onclick="processSale()">‚úÖ PRINT (Ctrl+Enter)</button>
                </div>
            </div>
        </div>
    </div>

    <script src="security_utils.js"></script>
    <script src="db.js"></script>
    <script>
        // --- VIRTUAL SCROLL CONFIG ---
        const ITEM_HEIGHT = 80; 
        let allItems = [], visibleItems = [], cart = [], ledgers = [];
        let searchTimer;

        window.onload = async () => {
            document.getElementById('loading').style.display = 'block';
            await DB.init();
            
            // Load Data
            [allItems, ledgers] = await Promise.all([
                DB.getAll('items'),
                DB.getLedgers()
            ]);
            
            visibleItems = allItems;
            document.getElementById('itemCount').innerText = allItems.length;
            document.getElementById('loading').style.display = 'none';
            document.getElementById('billDate').valueAsDate = new Date();
            
            loadCustomers();
            generateInvNo();
            
            // Init Virtual Scroll
            document.getElementById('spacer').style.height = `${visibleItems.length * ITEM_HEIGHT}px`;
            renderVirtualItems();
            document.getElementById('searchBar').focus();
        };

        // --- 1. VIRTUAL SCROLL ENGINE ---
        function renderVirtualItems() {
            const viewport = document.getElementById('viewport');
            const scrollTop = viewport.scrollTop;
            const viewportHeight = viewport.clientHeight;
            
            const startIndex = Math.floor(scrollTop / ITEM_HEIGHT);
            const endIndex = Math.min(visibleItems.length - 1, Math.ceil((scrollTop + viewportHeight) / ITEM_HEIGHT) + 2);

            const content = document.getElementById('content');
            content.innerHTML = '';

            for (let i = startIndex; i <= endIndex; i++) {
                const item = visibleItems[i];
                if (!item) continue;

                const isLow = (item.current_stock || 0) <= (item.reorder_level || 5);
                const el = document.createElement('div');
                el.className = `product-card ${isLow ? 'low-stock' : ''}`;
                el.style.top = `${i * ITEM_HEIGHT}px`; 
                el.onclick = () => addToCart(item);
                
                el.innerHTML = `
                    <div style="flex:1;">
                        <div style="font-weight:600; font-size:14px;">${item.name}</div>
                        <div style="font-size:11px; color:#666;">
                            SKU: ${item.sku||'-'} 
                            <span style="margin-left:5px; background:#eee; padding:2px 4px; border-radius:4px;">${item.category||'Gen'}</span>
                        </div>
                    </div>
                    <div style="text-align:right;">
                        <div style="font-weight:bold; color:var(--accent);">‚Çπ${item.std_price || 0}</div>
                        <div style="font-size:10px; font-weight:bold; color:${isLow?'var(--red)':'var(--green)'}">
                            ${isLow ? 'Low: ' : 'Qty: '}${item.current_stock||0}
                        </div>
                    </div>
                `;
                content.appendChild(el);
            }
        }

        // --- 2. PARTY LOGIC (Combined) ---
        function loadCustomers() {
            const sel = document.getElementById('customerSelect');
            ledgers.sort((a,b)=>a.name.localeCompare(b.name)).forEach(l => {
                sel.innerHTML += `<option value="${l.id}">${l.name}</option>`;
            });
        }

        function loadPartyDetails() {
            const pid = document.getElementById('customerSelect').value;
            const infoDiv = document.getElementById('partyInfo');
            
            if(!pid) { infoDiv.style.display = 'none'; return; }
            
            infoDiv.style.display = 'block';
            const p = ledgers.find(l => l.id == pid);
            
            document.getElementById('partyMobile').value = p.phone || '';
            document.getElementById('partyGST').value = p.gstin || '';
            
            // Credit Check
            if(p.credit_limit > 0) {
                const bal = Math.abs(p.opening_balance || 0); // Need real calculation in prod
                document.getElementById('currBal').innerText = bal;
                document.getElementById('creditMsg').style.display = bal > p.credit_limit ? 'block' : 'none';
            } else {
                document.getElementById('creditMsg').style.display = 'none';
            }
        }

        // --- 3. SEARCH & SCAN ---
        function handleSearch(query) {
            clearTimeout(searchTimer);
            const q = query.trim().toLowerCase();
            
            // Instant Barcode
            const exact = allItems.find(i => i.sku && i.sku.toLowerCase() === q);
            if(exact) {
                addToCart(exact);
                document.getElementById('searchBar').value = '';
                return;
            }

            // Fuzzy Filter
            searchTimer = setTimeout(() => {
                visibleItems = allItems.filter(i => i.name.toLowerCase().includes(q) || (i.sku && i.sku.toLowerCase().includes(q)));
                document.getElementById('spacer').style.height = `${visibleItems.length * ITEM_HEIGHT}px`;
                document.getElementById('viewport').scrollTop = 0;
                renderVirtualItems();
            }, 200);
        }

        // --- 4. CART ENGINE ---
        function addToCart(item) {
            const existing = cart.find(c => c.id === item.id);
            if(existing) existing.qty++;
            else cart.push({ ...item, qty: 1 });
            renderCart();
        }

        function renderCart() {
            const div = document.getElementById('cartBody');
            div.innerHTML = '';
            let sub = 0, tax = 0;

            if(cart.length === 0) {
                div.innerHTML = '<div style="text-align:center; padding:40px; color:#ccc;">üõí Cart Empty</div>';
                document.getElementById('grandTotal').innerText = '0.00';
                document.getElementById('subTotal').innerText = '0.00';
                document.getElementById('taxTotal').innerText = '0.00';
                return;
            }

            cart.forEach((c, idx) => {
                const rate = c.std_price || 0;
                const baseTotal = c.qty * rate;
                const gstAmt = baseTotal * ((c.gst_rate||18)/100);
                
                sub += baseTotal;
                tax += gstAmt;

                div.innerHTML += `
                    <div class="cart-item">
                        <div style="flex:2;">
                            <div style="font-weight:600;">${c.name}</div>
                            <small style="color:#666;">‚Çπ${rate} + ${c.gst_rate||0}% GST</small>
                        </div>
                        <div style="flex:1; display:flex; justify-content:center; gap:5px;">
                            <button class="btn" style="padding:2px 6px; background:#ddd; color:black;" onclick="updateQty(${idx}, -1)">-</button>
                            <span style="font-weight:bold; width:20px; text-align:center;">${c.qty}</span>
                            <button class="btn" style="padding:2px 6px; background:#ddd; color:black;" onclick="updateQty(${idx}, 1)">+</button>
                        </div>
                        <div style="flex:1; text-align:right; font-weight:bold;">‚Çπ${(baseTotal+gstAmt).toFixed(2)}</div>
                        <div style="width:20px; text-align:right; cursor:pointer; color:red;" onclick="updateQty(${idx}, -999)">√ó</div>
                    </div>`;
            });

            document.getElementById('subTotal').innerText = sub.toFixed(2);
            document.getElementById('taxTotal').innerText = tax.toFixed(2);
            document.getElementById('grandTotal').innerText = (sub + tax).toFixed(2);
        }

        function updateQty(idx, change) {
            cart[idx].qty += change;
            if(cart[idx].qty <= 0) cart.splice(idx, 1);
            renderCart();
        }

        async function processSale() {
            if(cart.length === 0) return alert("Cart is empty!");
            const pid = document.getElementById('customerSelect').value;
            if(!pid) {
                if(!confirm("No Customer Selected. Save as Cash Sale?")) return;
            }

            // Check Stock & Credit
            const lowStock = cart.filter(c => c.current_stock < c.qty);
            if(lowStock.length > 0) {
                if(!confirm(`‚ö†Ô∏è ${lowStock.length} items have low stock. Proceed?`)) return;
            }
            if(document.getElementById('creditMsg').style.display === 'block') {
                if(!confirm("‚ö†Ô∏è Customer Credit Limit Exceeded. Proceed?")) return;
            }

            const grand = parseFloat(document.getElementById('grandTotal').innerText);
            const saleData = {
                voucher_no: document.getElementById('invoiceNo').innerText,
                date: document.getElementById('billDate').value,
                type: 'Sales',
                party_id: parseInt(pid) || null,
                amount: grand,
                narration: "POS Invoice"
            };

            const entries = cart.map(c => ({ item_id: c.id, qty: c.qty, rate: c.std_price, amount: c.qty*c.std_price }));
            const acct = [
                { ledger_id: saleData.party_id || 1, debit: grand, credit: 0 },
                { ledger_id: 2, debit: 0, credit: grand } // Sales A/c
            ];

            try {
                await DB.saveVoucher(saleData, entries, acct);
                alert("‚úÖ Bill Saved Successfully!");
                location.reload();
            } catch(e) { alert(e); }
        }

        async function generateInvNo() {
            const all = await DB.getAll('vouchers');
            const count = all.filter(v=>v.type==='Sales').length + 1;
            document.getElementById('invoiceNo').innerText = `INV-${new Date().getFullYear()}-${count}`;
        }
        
        document.addEventListener('keydown', e => { if(e.ctrlKey && e.key === 'Enter') processSale(); });
    </script>
</body>
</html>