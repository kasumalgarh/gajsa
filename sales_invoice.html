<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Entry - Arth Book</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<style>
/* ==========================================================================
   ARTH BOOK MASTER CSS v8.0 (MOBILE SALES FIX)
   ========================================================================== */

:root {
    --primary: #0d47a1;       /* Royal Navy */
    --primary-dark: #002171;
    --accent: #ffca28;        /* Gold */
    --bg: #f1f5f9;
    --surface: #ffffff;
    --text-main: #1e293b;
    --text-sub: #64748b;
    --border: #e2e8f0;
    --success: #10b981;
    --danger: #ef4444;
    --sidebar-width: 260px;
    --shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
    --transition: all 0.2s ease-in-out;
}

/* --- RESET --- */
* { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', sans-serif; outline: none; }
body { display: flex; height: 100vh; background: var(--bg); color: var(--text-main); overflow: hidden; }
a { text-decoration: none; }
ul { list-style: none; }

/* --- SIDEBAR --- */
.sidebar {
    width: var(--sidebar-width);
    background: var(--primary) !important;
    color: white;
    display: flex; flex-direction: column; flex-shrink: 0; height: 100vh;
    overflow-y: auto; z-index: 2000;
    box-shadow: 4px 0 10px rgba(0,0,0,0.1);
    transition: var(--transition);
}

.sidebar .brand-logo {
    padding: 20px; font-size: 20px; font-weight: 800; color: white !important;
    display: flex; align-items: center; gap: 10px;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    margin-bottom: 10px;
}

/* Links */
.nav-links { padding: 0 10px; }
.nav-links li { margin-bottom: 5px; }

.sidebar a, .nav-links a, .nav-link {
    display: flex !important; align-items: center; gap: 12px;
    padding: 12px 15px; margin-bottom: 5px;
    color: rgba(255,255,255,0.85) !important;
    text-decoration: none !important;
    border-radius: 8px; font-weight: 500; font-size: 14px;
    transition: var(--transition);
    background: transparent; cursor: pointer;
}

.sidebar a:hover, .nav-link:hover {
    background: rgba(255,255,255,0.15) !important;
    color: #ffffff !important;
    padding-left: 20px;
}

.sidebar a.active, .nav-link.active {
    background: var(--accent) !important;
    color: var(--primary-dark) !important;
    font-weight: 800;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
}

/* --- MAIN LAYOUT --- */
.main, .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; width: 100%; }

.header, .header-card {
    background: var(--surface); padding: 15px;
    border-bottom: 1px solid var(--border);
    display: flex; align-items: center; justify-content: space-between; 
    flex-wrap: wrap; gap: 15px; flex-shrink: 0;
    min-height: 60px;
}

.header-card { border-radius: 0 0 12px 12px; margin: 10px; border: 1px solid var(--border); }

/* --- SALES & PURCHASE ENTRY (Desktop) --- */
.entry-bar {
    background: #fff; padding: 15px; margin: 0 10px;
    border: 1px solid var(--border); border-bottom: none;
    border-radius: 12px 12px 0 0;
    display: grid; grid-template-columns: 3fr 1fr 1fr 1fr 100px; 
    gap: 15px; align-items: end;
}

.table-area {
    flex: 1; overflow-y: auto; background: white; margin: 0 10px;
    border: 1px solid var(--border); border-top: 1px solid #e2e8f0;
    border-radius: 0 0 12px 12px; 
}

.footer-bar {
    background: var(--surface); padding: 15px 20px;
    border-top: 1px solid var(--border);
    display: flex; justify-content: space-between; align-items: center;
    box-shadow: 0 -4px 15px rgba(0,0,0,0.05); z-index: 50;
}

/* --- INPUTS & BUTTONS --- */
input, select, textarea {
    width: 100%; padding: 10px 12px; border: 1px solid var(--border);
    border-radius: 8px; font-size: 14px; outline: none; background: #fff;
    transition: 0.2s;
}
input:focus, select:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(13, 71, 161, 0.1); }

.btn {
    padding: 10px 20px; border-radius: 8px; border: none;
    font-weight: 600; cursor: pointer; transition: 0.2s; font-size: 14px;
    display: inline-flex; align-items: center; justify-content: center; gap: 8px;
}
.btn:active { transform: scale(0.98); }

.btn-primary, .btn-save { background: var(--primary); color: white; }
.btn-success { background: var(--success); color: white; }
.btn-danger { background: #fee2e2; color: var(--danger); }

/* --- MODALS & PAYMENT OPTIONS (Fixed) --- */
.modal-overlay { 
    position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2500; 
    display: none; align-items: center; justify-content: center; backdrop-filter: blur(2px); 
}
.modal { 
    background: white; width: 500px; max-width: 90%; 
    padding: 25px; border-radius: 16px; 
    box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); 
    animation: slideUp 0.2s ease-out; 
    display: flex; flex-direction: column;
}

/* Payment Grid (Desktop Default) */
.pay-options { 
    display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin: 20px 0; 
}
.p-opt {
    padding: 15px; border: 2px solid var(--border); border-radius: 10px;
    text-align: center; cursor: pointer; background: #f9f9f9; transition: 0.2s;
}
.p-opt:hover { border-color: var(--primary); }
.p-opt.selected { 
    border-color: var(--accent); background: #fffbeb; 
    color: var(--primary-dark); font-weight: bold; 
}

@keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

/* --- UTILITIES --- */
table { width: 100%; border-collapse: collapse; font-size: 13px; }
th { background: #f8fafc; padding: 12px; text-align: left; border-bottom: 2px solid var(--border); position: sticky; top: 0; }
td { padding: 10px 12px; border-bottom: 1px solid #f1f5f9; }

.menu-btn { display: none; font-size: 1.5rem; color: var(--primary); background: none; border: none; cursor: pointer; margin-right: 15px; }
.overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1500; }

/* ===========================
   MOBILE RESPONSIVENESS (THE FIX)
   =========================== */
@media (max-width: 1024px) {
    /* Sidebar */
    .sidebar { position: fixed; left: -100%; top: 0; height: 100%; width: 280px; }
    .sidebar.active { left: 0; }
    .menu-btn { display: block; }
    .overlay.active { display: block; }
    
    /* Layout */
    .header, .header-card { flex-direction: column; align-items: stretch; gap: 10px; margin: 0; border-radius: 0; }
    .main-content { padding: 0; }
    
    /* Sales Entry - Stack Inputs */
    .entry-bar {
        grid-template-columns: 1fr !important; /* Stack vertically */
        gap: 10px; margin: 0; border-radius: 0; border-left: none; border-right: none;
    }
    .entry-bar .btn { width: 100%; height: 45px; margin-top: 5px; }
    
    /* Footer - Stack Totals */
    .footer-bar { flex-direction: column; gap: 15px; align-items: stretch; height: auto; }
    .footer-bar > div { flex-direction: column; align-items: flex-start; width: 100%; gap: 5px; }
    .footer-bar .btn { width: 100%; height: 45px; margin-top: 10px; }
    
    /* Table Scroll */
    .table-area { margin: 0; border-radius: 0; border-left: none; border-right: none; }
    table { min-width: 600px; } /* Force Horizontal Scroll */
    
    /* MODAL MOBILE FIX */
    .modal {
        width: 95% !important;
        max-height: 85vh;
        overflow-y: auto;
        padding: 20px !important;
    }
    
    /* Payment Options Stack */
    .pay-options {
        grid-template-columns: 1fr !important; /* Stack 1 column */
        gap: 10px;
    }
    .p-opt {
        display: flex; align-items: center; justify-content: center; gap: 10px;
        padding: 12px;
    }
    .p-opt i { margin-bottom: 0 !important; font-size: 18px !important; }
}

/* Toast */
#toast { position: fixed; bottom: 80px; right: 20px; background: var(--success); color: white; padding: 12px 24px; border-radius: 50px; display: none; z-index: 3000; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }

/* Print */
@media print {
    .sidebar, .menu-btn, .header-card, .entry-bar, .footer-bar, .btn, .modal-overlay, #toast { display: none !important; }
    .main-content, .table-area { padding: 0; border: none; height: auto; overflow: visible; }
}
/* --- MOBILE MODAL FINAL FIX --- */
@media (max-width: 600px) {
    /* Modal Size & Padding */
    .modal {
        width: 95% !important;
        max-width: 95% !important;
        padding: 20px !important;
        max-height: 90vh;
        overflow-y: auto;
    }

    /* Payment Options Stack (List View) */
    .pay-options {
        display: flex !important;
        flex-direction: column !important;
        gap: 10px !important;
    }

    .p-opt {
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        gap: 15px !important;
        padding: 15px !important;
        font-size: 16px !important;
    }

    .p-opt i {
        margin-bottom: 0 !important;
        font-size: 20px !important;
    }

    /* Buttons Stack */
    .modal .btn-action {
        width: 100% !important;
        margin-bottom: 10px !important;
        height: 45px !important;
        font-size: 16px !important;
    }
    
    /* Make buttons container stack */
    .modal > div:last-child {
        flex-direction: column !important;
        gap: 5px !important;
    }
}   /* --- MENU BUTTON RIGHT SIDE FIX --- */
@media (max-width: 1024px) {
    /* Header और Cards को रिलेटिव बनाएं ताकि बटन उनके अंदर सेट हो सके */
    .header, .header-card, .top-bar {
        position: relative;
        padding-right: 60px !important; /* बटन के लिए जगह छोड़ी */
    }

    /* बटन को उठाकर Right Side में चिपका दिया */
    .menu-btn {
        position: absolute !important;
        right: 15px !important;
        top: 15px !important;
        left: auto !important;
        margin: 0 !important;
        z-index: 100;
        font-size: 1.8rem; /* थोड़ा बड़ा किया ताकि उंगली से क्लिक हो सके */
    }
}
</style>
<body>

    <button class="menu-btn" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
    <div class="overlay" onclick="toggleSidebar()"></div>

    <div class="sidebar" id="sidebar">
        <div class="brand-logo">
            <i class="fas fa-cube"></i> Arth Book
        </div>
        
        <ul class="nav-links">
            <li><a href="index.html"><i class="fas fa-home"></i> Dashboard</a></li>
            
            <li style="margin-top:15px; margin-bottom:5px; font-size:11px; color:rgba(255,255,255,0.5); font-weight:bold; padding-left:15px; text-transform:uppercase;">Entry</li>
            <li><a href="sales_invoice.html" class="active"><i class="fas fa-file-invoice"></i> Sales (POS)</a></li>
            <li><a href="purchase_invoice.html"><i class="fas fa-truck"></i> Purchase</a></li>
            <li><a href="vouchers.html"><i class="fas fa-receipt"></i> Day Book</a></li>
            
            <li style="margin-top:15px; margin-bottom:5px; font-size:11px; color:rgba(255,255,255,0.5); font-weight:bold; padding-left:15px; text-transform:uppercase;">Masters</li>
            <li><a href="item_master.html"><i class="fas fa-boxes"></i> Inventory</a></li>
            <li><a href="ArthBook.html"><i class="fas fa-users"></i> Parties</a></li>
            <li><a href="coa.html"><i class="fas fa-sitemap"></i> Accounts</a></li>
            
            <li style="margin-top:15px; margin-bottom:5px; font-size:11px; color:rgba(255,255,255,0.5); font-weight:bold; padding-left:15px; text-transform:uppercase;">Reports & Tax</li>
            <li><a href="reports.html"><i class="fas fa-chart-line"></i> Reports</a></li>
            <li><a href="gst_filing.html"><i class="fas fa-university"></i> GST Returns</a></li>
            <li><a href="taxation.html"><i class="fas fa-calculator"></i> Tax / ITR</a></li>
            
            <hr style="border:0; border-top:1px solid rgba(255,255,255,0.1); margin:15px 5px;">
            <li><a href="settings.html"><i class="fas fa-cog"></i> Settings</a></li>
        </ul>
        
        <div style="padding: 20px; font-size: 11px; color: rgba(255,255,255,0.5); text-align: center; margin-top:auto;">
            Arth Book v5.0<br>POS Edition
        </div>
    </div>

    <div class="main">
        
       <div class="header-card">
    <div style="flex:2; min-width: 250px;">
        <label class="h-label" style="font-size:12px; font-weight:700; color:var(--text-sub); display:block; margin-bottom:5px;">Customer / Party</label>
        <div style="display:flex; gap:5px;">
            <select id="custSelect" style="flex:1; width:100%;">
                <option value="">Walk-in Customer (Cash)</option>
            </select>
            <button class="btn btn-save" style="padding:0 12px;" onclick="openCustModal()" title="New Customer">
                <i class="fas fa-plus"></i>
            </button>
        </div>
    </div>
    
    <div style="flex:1; min-width: 150px;">
        <label class="h-label" style="font-size:12px; font-weight:700; color:var(--text-sub); display:block; margin-bottom:5px;">Invoice Date</label>
        <input type="date" id="billDate" style="width:100%;">
    </div>
    
    <div style="flex:0.5; min-width: 100px; text-align:right;">
        <label class="h-label" style="font-size:12px; font-weight:700; color:var(--text-sub); display:block; margin-bottom:5px;">Inv. No</label>
        <div id="invNo" style="background:var(--bg); padding:10px; border-radius:8px; font-weight:800; color:var(--primary); border:1px solid var(--border); text-align:center;">
            ...
        </div>
    </div>
</div>

        <div class="entry-bar">
            <div class="e-grp" style="position:relative;">
                <label style="font-size:11px; font-weight:700; color:var(--text-sub);">Item Name (F2)</label>
                <input type="text" id="itemSearch" list="itemList" placeholder="Search Item..." oninput="onItemSelect()" onkeydown="handleEnter(event, 'qtyInput')">
                <datalist id="itemList"></datalist>
                <span id="stockInd" style="position:absolute; right:10px; top:-20px; font-size:11px; font-weight:bold; display:none;"></span>
                <input type="hidden" id="selItemId">
                <input type="hidden" id="selItemGst">
            </div>
            
            <div class="e-grp">
                <label style="font-size:11px; font-weight:700; color:var(--text-sub);">Qty</label>
                <input type="number" id="qtyInput" value="1" min="1" oninput="calcLine()" onkeydown="handleEnter(event, 'rateInput')">
            </div>
            
            <div class="e-grp">
                <label style="font-size:11px; font-weight:700; color:var(--text-sub);">Rate</label>
                <input type="number" id="rateInput" placeholder="0.00" oninput="calcLine()" onkeydown="handleEnter(event, 'addBtn')">
            </div>
            
            <div class="e-grp">
                <label style="font-size:11px; font-weight:700; color:var(--text-sub);">Amount</label>
                <input type="number" id="amtDisplay" placeholder="0.00" readonly style="background:#f8fafc;">
            </div>
            
            <button class="btn btn-primary" id="addBtn" onclick="addItemRow()" style="height:42px; margin-bottom:1px;">
                <i class="fas fa-plus"></i> ADD
            </button>
        </div>

        <div class="table-area">
            <table style="width:100%; border-collapse:collapse;">
                <thead>
                    <tr>
                        <th width="50">#</th>
                        <th>Item Name</th>
                        <th width="100" style="text-align:center;">Qty</th>
                        <th width="120" style="text-align:center;">Rate</th>
                        <th width="150" style="text-align:right;">Total</th>
                        <th width="50"></th>
                    </tr>
                </thead>
                <tbody id="cartTableBody">
                    <tr><td colspan="6" style="text-align:center; padding:40px; color:#94a3b8;">Start adding items...</td></tr>
                </tbody>
            </table>
        </div>

        <div class="footer-bar" style="position:relative; height:auto; padding:20px; margin-top:auto; background:white; border-top:1px solid var(--border);">
            <div style="display:flex; justify-content:space-between; align-items:center; width:100%;">
                <div style="font-size:13px; color:var(--text-sub);">
                    Items: <strong id="lblCount" style="color:var(--text-main);">0</strong> | 
                    Total Qty: <strong id="lblQty" style="color:var(--text-main);">0</strong>
                </div>
                
                <div style="text-align:right; display:flex; gap:30px; align-items:center;">
                    <div>
                        <div style="font-size:12px; color:var(--text-sub);">Total Tax: <span id="lblTax">0.00</span></div>
                        <div style="font-size:24px; font-weight:800; color:var(--primary); font-family:'JetBrains Mono';">₹ <span id="lblGrand">0.00</span></div>
                    </div>
                    
                    <button class="btn btn-success" onclick="openPaymentModal()" style="padding:12px 30px; font-size:16px;">
                        Checkout <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>
        </div>

    </div>

    <div class="modal-overlay" id="payModal">
        <div class="modal">
            <div class="modal-header">
                <h3 style="margin:0; color:var(--primary);">Confirm Payment</h3>
                <button onclick="closeModal()" style="background:none; border:none; font-size:20px; cursor:pointer;">&times;</button>
            </div>
            
            <div class="modal-body" style="text-align:center;">
                <div style="font-size:14px; color:var(--text-sub); margin-bottom:5px;">Payable Amount</div>
                <div style="font-size:36px; font-weight:800; color:var(--primary); margin-bottom:25px;" id="modalTotal">₹0</div>

                <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:15px; margin-bottom:25px;">
                    <div class="p-opt selected" onclick="setMode('Cash', this)" style="padding:15px; border:2px solid var(--border); border-radius:10px; cursor:pointer; background:#f9f9f9;">
                        <i class="fas fa-money-bill-wave" style="display:block; font-size:20px; margin-bottom:5px;"></i> Cash
                    </div>
                    <div class="p-opt" onclick="setMode('Online', this)" style="padding:15px; border:2px solid var(--border); border-radius:10px; cursor:pointer; background:#f9f9f9;">
                        <i class="fas fa-qrcode" style="display:block; font-size:20px; margin-bottom:5px;"></i> UPI
                    </div>
                    <div class="p-opt" onclick="setMode('Udhar', this)" style="padding:15px; border:2px solid var(--border); border-radius:10px; cursor:pointer; background:#f9f9f9;">
                        <i class="fas fa-book" style="display:block; font-size:20px; margin-bottom:5px;"></i> Credit
                    </div>
                </div>

                <div style="display:flex; gap:10px;">
                    <button class="btn btn-print" style="flex:1;" onclick="saveBill(false)">Save Only</button>
                    <button class="btn btn-success" style="flex:1;" onclick="saveBill(true)">Print & Save</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-overlay" id="custModal">
    <div class="modal" style="width:350px;">
        <div class="modal-header" style="display:flex; justify-content:space-between; margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:10px;">
            <h3 style="margin:0; color:var(--primary);">New Customer</h3>
            <button onclick="closeCustModal()" style="border:none; background:none; font-size:20px; cursor:pointer;">&times;</button>
        </div>
        
        <div class="form-group" style="margin-bottom:10px;">
            <label style="font-weight:bold; font-size:12px;">Customer Name *</label>
            <input type="text" id="newCustName" placeholder="Enter Name" style="width:100%; padding:10px; margin-top:5px;">
        </div>
        
        <div class="form-group" style="margin-bottom:10px;">
            <label style="font-weight:bold; font-size:12px;">Mobile Number</label>
            <input type="text" id="newCustPhone" placeholder="Mobile No" style="width:100%; padding:10px; margin-top:5px;">
        </div>
        
        <div class="form-group" style="margin-bottom:20px;">
            <label style="font-weight:bold; font-size:12px;">Address (Optional)</label>
            <input type="text" id="newCustAddr" placeholder="City / Area" style="width:100%; padding:10px; margin-top:5px;">
        </div>
        
        <button class="btn btn-save" onclick="saveNewCustomer()" style="width:100%">Save & Select</button>
    </div>
</div>

    <div id="printArea"></div>
    <div id="toast"></div>

    <script src="db.js"></script>
    <script>
        // --- SIDEBAR LOGIC ---
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
            document.querySelector('.overlay').classList.toggle('active');
        }

        // --- GLOBAL VARIABLES ---
        let items=[], ledgers=[], cart=[], settings={}, groups=[];
        let selectedMode = 'Cash';

        window.onload = async () => {
            try {
                if (typeof DB === 'undefined') { console.error("DB.js is missing"); return; }
                
                await DB.init();
                [items, ledgers, settings, groups] = await Promise.all([
                    DB.getAll('items'), DB.getAll('ledgers'), DB.getAll('settings'), DB.getAll('groups')
                ]);
                
                if(Array.isArray(settings) && settings.length > 0) settings = settings[0];

                updateItemDatalist(items);
                loadCustomers();
                generateInvNo();
                document.getElementById('billDate').valueAsDate = new Date();
                
            } catch(e) { console.error(e); showToast("⚠️ Database Error"); }
        };

        // --- ENTRY FUNCTIONS ---
        function updateItemDatalist(list) {
            const dl = document.getElementById('itemList');
            dl.innerHTML = list.map(i => `<option value="${i.name}">Price: ${i.std_price} | Stock: ${i.current_stock}</option>`).join('');
        }

        function onItemSelect() {
            const val = document.getElementById('itemSearch').value;
            const item = items.find(i => i.name === val || i.sku === val);
            if(item) {
                document.getElementById('selItemId').value = item.id;
                document.getElementById('selItemGst').value = item.gst_rate || 0;
                document.getElementById('rateInput').value = item.std_price || 0;
                document.getElementById('itemSearch').value = item.name; 
                
                const stock = item.current_stock || 0;
                const ind = document.getElementById('stockInd');
                ind.innerText = `Stock: ${stock} ${item.unit||''}`;
                ind.style.display = 'block';
                ind.style.color = stock < (item.reorder_level||5) ? 'var(--danger)' : 'var(--success)';
                
                calcLine();
                document.getElementById('qtyInput').focus();
            }
        }

        function calcLine() {
            const qty = parseFloat(document.getElementById('qtyInput').value) || 0;
            const rate = parseFloat(document.getElementById('rateInput').value) || 0;
            document.getElementById('amtDisplay').value = (qty * rate).toFixed(2);
        }

     function addItemRow() {
            const idStr = document.getElementById('selItemId').value; // String Value
            const name = document.getElementById('itemSearch').value;
            const qty = parseFloat(document.getElementById('qtyInput').value);
            const rate = parseFloat(document.getElementById('rateInput').value);
            const gst = parseFloat(document.getElementById('selItemGst').value) || 0;

            if(!idStr || !name) return showToast("⚠️ Select an item");
            if(qty <= 0) return showToast("⚠️ Invalid Quantity");

            // --- FIX: Convert ID to Number (parseInt) ---
            const id = parseInt(idStr); 

            const item = items.find(i => i.id === id);
            const itemHsn = item ? item.hsn : '';
            const itemUnit = item ? item.unit : '';

            if(qty > (item.current_stock || 0)) {
                return showToast(`⚠️ Low Stock! Only ${item.current_stock} left.`);
            }

            const existing = cart.find(c => c.id === id);
            if(existing) {
                existing.qty += qty;
            } else {
                cart.push({ id: id, name: name, qty: qty, rate: rate, gst: gst, hsn: itemHsn, unit: itemUnit });
            }

            // Reset Fields
            document.getElementById('itemSearch').value = '';
            document.getElementById('selItemId').value = '';
            document.getElementById('qtyInput').value = 1;
            document.getElementById('rateInput').value = '';
            document.getElementById('amtDisplay').value = '';
            document.getElementById('stockInd').style.display = 'none';
            document.getElementById('itemSearch').focus();
            
            renderCartTable();
        }

        function handleEnter(e, nextId) {
            if(e.key === 'Enter') {
                e.preventDefault();
                if(nextId === 'addBtn') addItemRow();
                else document.getElementById(nextId).focus();
            }
        }

        function renderCartTable() {
            const tbody = document.getElementById('cartTableBody');
            if(cart.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:30px; color:#94a3b8;">Start adding items...</td></tr>';
                updateTotals(0,0,0,0);
                return;
            }
            
            let sub = 0, tax = 0, totalQty = 0;
            tbody.innerHTML = '';
            
            cart.forEach((c, idx) => {
                const base = c.qty * c.rate;
                const taxAmt = base * (c.gst/100);
                sub += base;
                tax += taxAmt;
                totalQty += c.qty;
                
                tbody.innerHTML += `
                    <tr style="border-bottom:1px solid #f1f5f9;">
                        <td style="padding:10px; color:#64748b;">${idx+1}</td>
                        <td style="padding:10px; font-weight:600;">${c.name} <span style="font-size:10px; color:#94a3b8;">(${c.gst}%)</span></td>
                        <td style="padding:10px; text-align:center;">
                            <input type="number" style="width:60px; padding:5px; text-align:center; border:1px solid #e2e8f0; border-radius:4px;" 
                                   value="${c.qty}" onchange="editCart(${idx}, 'qty', this.value)">
                        </td>
                        <td style="padding:10px; text-align:center;">
                            <input type="number" style="width:80px; padding:5px; text-align:center; border:1px solid #e2e8f0; border-radius:4px;" 
                                   value="${c.rate}" onchange="editCart(${idx}, 'rate', this.value)">
                        </td>
                        <td style="padding:10px; text-align:right; font-weight:700;">₹${(base+taxAmt).toFixed(2)}</td>
                        <td style="padding:10px; text-align:center;">
                            <i class="fas fa-trash" style="color:var(--danger); cursor:pointer;" onclick="remItem(${idx})"></i>
                        </td>
                    </tr>
                `;
            });
            updateTotals(sub, tax, cart.length, totalQty);
        }

        function editCart(idx, field, val) {
            const v = parseFloat(val) || 0;
            if(v <= 0 && field === 'qty') return remItem(idx);
            
            if(field === 'qty') {
                 const item = items.find(i => i.id == cart[idx].id);
                 if(v > (item.current_stock||0)) {
                     showToast("⚠️ Stock Limit Exceeded");
                     cart[idx].qty = item.current_stock;
                 } else { cart[idx].qty = v; }
            } else { cart[idx].rate = v; }
            
            renderCartTable();
        }

        function remItem(idx) {
            cart.splice(idx, 1);
            renderCartTable();
        }

        function updateTotals(sub, tax, count, qty) {
            const grand = Math.round(sub + tax);
            document.getElementById('lblTax').innerText = tax.toFixed(2);
            document.getElementById('lblGrand').innerText = grand.toFixed(2);
            document.getElementById('modalTotal').innerText = "₹" + grand.toLocaleString('en-IN');
            document.getElementById('lblCount').innerText = count;
            document.getElementById('lblQty').innerText = qty;
        }

        function loadCustomers() {
            const sel = document.getElementById('custSelect');
            sel.innerHTML = '<option value="">Walk-in Customer (Cash)</option>';
            const targetGroups = ['Sundry Debtors', 'Sundry Creditors'];
            const allowedGids = groups.filter(g => targetGroups.includes(g.name)).map(g => g.id);
            const parties = ledgers.filter(l => allowedGids.includes(l.group_id));
            parties.sort((a,b) => a.name.localeCompare(b.name));
            parties.forEach(l => { sel.innerHTML += `<option value="${l.id}">${l.name}</option>`; });
        }

        async function generateInvNo() {
            try { 
                const n = await DB.getNextVoucherNo('Sales'); 
                document.getElementById('invNo').innerText = `INV-${n}`; 
            } catch(e) {}
        }
        
        function showToast(msg) {
            const t = document.getElementById('toast'); t.innerText = msg; t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 3000);
        }

        function openPaymentModal() {
            if(cart.length === 0) return showToast("Add items first!");
            document.getElementById('payModal').style.display = 'flex';
        }
        function closeModal() { document.getElementById('payModal').style.display = 'none'; }
        
        function setMode(m, el) {
            selectedMode = m;
            document.querySelectorAll('.p-opt').forEach(e => {
                e.classList.remove('selected');
                e.style.borderColor = 'var(--border)';
                e.style.backgroundColor = '#f9f9f9';
            });
            el.classList.add('selected');
            el.style.borderColor = 'var(--accent)';
            el.style.backgroundColor = '#fffbeb';
        }

        // --- SAVE & PRINT LOGIC ---
        async function saveBill(shouldPrint) {
            const pid = document.getElementById('custSelect').value;
            const invNo = document.getElementById('invNo').innerText;
            const date = document.getElementById('billDate').value;
            const grand = parseFloat(document.getElementById('lblGrand').innerText.replace(',',''));

            if (selectedMode === 'Udhar' && (!pid || pid === "0" || pid === "")) {
                alert("❌ Select a Party for Credit Sale.");
                return;
            }

            const voucher = {
                voucher_no: invNo,
                date: date,
                type: 'Sales',
                party_id: parseInt(pid) || 0,
                amount: grand,
                payment_mode: selectedMode,
                narration: `POS Sale - ${selectedMode}`
            };

            const entries = [];
            
            // 1. Party Debit
            let debitLedgerId = 0;
            if (selectedMode === 'Cash') {
                const cashL = ledgers.find(l => l.name === 'Cash' || l.group_name === 'Cash-in-Hand');
                if(cashL) debitLedgerId = cashL.id;
            } else if (selectedMode === 'Udhar') {
                debitLedgerId = parseInt(pid);
            } else {
                const bankL = ledgers.find(l => l.name === 'Bank Account' || l.group_name === 'Bank Accounts');
                if(bankL) debitLedgerId = bankL.id;
            }
            if (debitLedgerId) entries.push({ ledger_id: debitLedgerId, debit: grand, credit: 0 });

            // 2. Sales Credit & Item Data
            let salesL = ledgers.find(l => l.name === 'Local Sales');
            if (!salesL) salesL = ledgers.find(l => l.group_id === 9); 
            const salesId = salesL ? salesL.id : 0;

            let totalTax = 0;

            cart.forEach(c => {
                const taxable = c.qty * c.rate;
                const taxAmt = taxable * (c.gst / 100);
                totalTax += taxAmt;

                entries.push({
                    ledger_id: salesId,
                    debit: 0,
                    credit: taxable,
                    meta_data: { item_id: c.id, qty: c.qty, rate: c.rate } 
                });
            });

            // 3. Tax Credit
            if(totalTax > 0) {
                let taxL = ledgers.find(l => l.name === 'Output GST');
                if(!taxL) taxL = ledgers.find(l => l.group_name === 'Duties & Taxes');
                const taxId = taxL ? taxL.id : 0;
                if(taxId) entries.push({ ledger_id: taxId, debit: 0, credit: totalTax });
            }

            try {
                await DB.saveVoucherTransaction(voucher, entries);
                if (shouldPrint) printReceipt(voucher, cart, grand);
                else {
                    showToast("✅ Sale Saved!");
                    setTimeout(() => location.reload(), 1000);
                }
            } catch (e) { alert("Failed: " + e.message); }
        }

        // --- PRINT RECEIPT (Standardized) ---
        function printReceipt(v, items, total) {
            const companyName = (settings && settings.company_name) ? settings.company_name : "Arth Book User";
            const companyAddr = (settings && settings.address) ? settings.address : "India";
            const companyGST = (settings && settings.gst_user) ? settings.gst_user : "Unregistered";
            const companyPhone = (settings && settings.phone) ? settings.phone : "";
            
            let buyerName = "Cash / Walk-in";
            let buyerGST = "N/A";
            const pid = document.getElementById('custSelect').value;
            if(pid) {
                const party = ledgers.find(l => l.id == pid);
                if(party) { buyerName = party.name; buyerGST = party.gstin || "Unregistered"; }
            }

            const amountInWords = numToWords(Math.round(total));
            let rows = '';
            items.forEach((i, idx) => {
                const base = i.qty * i.rate;
                rows += `
                    <tr>
                        <td style="border:1px solid #000; padding:5px; text-align:center;">${idx+1}</td>
                        <td style="border:1px solid #000; padding:5px;">${i.name}</td>
                        <td style="border:1px solid #000; padding:5px; text-align:center;">${i.qty}</td>
                        <td style="border:1px solid #000; padding:5px; text-align:right;">${i.rate.toFixed(2)}</td>
                        <td style="border:1px solid #000; padding:5px; text-align:right;">${base.toFixed(2)}</td>
                    </tr>`;
            });

            const content = `
                <div style="width:210mm; padding:20px; font-family:Arial; margin:auto; background:white;">
                    <div style="border:1px solid #000;">
                        <div style="text-align:center; background:#eee; padding:5px; border-bottom:1px solid #000;">
                            <h3 style="margin:0;">TAX INVOICE</h3>
                        </div>
                        <div style="padding:10px; display:flex; justify-content:space-between; border-bottom:1px solid #000;">
                            <div>
                                <h4 style="margin:0;">${companyName}</h4>
                                <div style="font-size:12px;">${companyAddr}<br>GST: ${companyGST}<br>Ph: ${companyPhone}</div>
                            </div>
                            <div style="text-align:right;">
                                <div>Inv: <b>${v.voucher_no}</b></div>
                                <div>Date: ${v.date}</div>
                            </div>
                        </div>
                        <div style="padding:5px; border-bottom:1px solid #000; font-size:12px;">
                            <b>Bill To:</b> ${buyerName} (GST: ${buyerGST})
                        </div>
                        <table style="width:100%; border-collapse:collapse; font-size:12px;">
                            <tr style="background:#eee;">
                                <th style="border:1px solid #000; padding:5px;">#</th>
                                <th style="border:1px solid #000; padding:5px;">Item</th>
                                <th style="border:1px solid #000; padding:5px;">Qty</th>
                                <th style="border:1px solid #000; padding:5px;">Rate</th>
                                <th style="border:1px solid #000; padding:5px;">Total</th>
                            </tr>
                            ${rows}
                            <tr>
                                <td colspan="4" style="border:1px solid #000; text-align:right; font-weight:bold; padding:5px;">Grand Total</td>
                                <td style="border:1px solid #000; text-align:right; font-weight:bold; padding:5px;">₹${total.toFixed(2)}</td>
                            </tr>
                        </table>
                        <div style="padding:10px; font-size:12px;">
                            Amount (in words): <b>${amountInWords} Only</b>
                        </div>
                    </div>
                </div>`;

            document.getElementById('printArea').innerHTML = content;
            setTimeout(() => { window.print(); setTimeout(() => location.reload(), 500); }, 500);
        }

        function numToWords(n) {
            if (n === 0) return "Zero";
            const units = ["", "One", "Two", "Three", "Four", "Five", "Six", "Seven", "Eight", "Nine"];
            const tens = ["", "", "Twenty", "Thirty", "Forty", "Fifty", "Sixty", "Seventy", "Eighty", "Ninety"];
            // Simplified logic for demo
            return n + ""; 
        }

        // Shortcuts
        document.addEventListener('keydown', e => {
            if(e.key === 'F2') { e.preventDefault(); document.getElementById('itemSearch').focus(); }
            if(e.ctrlKey && e.key === 'Enter') openPaymentModal();
        });
        // --- QUICK CUSTOMER FUNCTIONS (Direct Add) ---

    function openCustModal() {
        document.getElementById('custModal').style.display = 'flex';
        document.getElementById('newCustName').focus();
    }

    function closeCustModal() {
        document.getElementById('custModal').style.display = 'none';
        document.getElementById('newCustName').value = '';
        document.getElementById('newCustPhone').value = '';
        document.getElementById('newCustAddr').value = '';
    }

    async function saveNewCustomer() {
        const name = document.getElementById('newCustName').value.trim();
        if(!name) return alert("Customer Name is required");

        // 1. 'Sundry Debtors' ग्रुप ढूंढें (Customers के लिए)
        // ध्यान दें: 'groups' वेरिएबल window.onload से लोड होना चाहिए
        const debtGroup = groups.find(g => g.name === 'Sundry Debtors');
        if(!debtGroup) return alert("Error: 'Sundry Debtors' group missing in Masters!");

        // 2. डेटा तैयार करें
        const newLedger = {
            name: name,
            group_id: debtGroup.id,
            phone: document.getElementById('newCustPhone').value.trim(),
            address: document.getElementById('newCustAddr').value.trim(),
            opening_balance: 0,
            op_date: new Date().toISOString().slice(0,10),
            reg_type: 'Unregistered'
        };

        // 3. डेटाबेस में सेव करें
        try {
            const tx = DB.db.transaction('ledgers', 'readwrite');
            const store = tx.objectStore('ledgers');
            const request = store.add(newLedger);

            request.onsuccess = async (e) => {
                const newId = e.target.result;
                
                // लिस्ट रिफ्रेश करें
                ledgers = await DB.getAll('ledgers');
                
                // ड्रापडाउन को अपडेट करें (यहाँ ID 'custSelect' ही यूज करें)
                const sel = document.getElementById('custSelect'); 
                sel.innerHTML = '<option value="">Walk-in Customer (Cash)</option>';
                
                // वही फिल्टर लॉजिक जो लोड करते समय यूज होता है
                const targetNames = ['Sundry Debtors', 'Cash-in-Hand', 'Bank Accounts'];
                const allowedGroupIds = groups.filter(g => targetNames.includes(g.name)).map(g => g.id);
                const validParties = ledgers.filter(l => allowedGroupIds.includes(l.group_id));
                
                validParties.sort((a,b) => a.name.localeCompare(b.name));
                validParties.forEach(l => {
                    const isSelected = (l.id === newId) ? 'selected' : '';
                    sel.innerHTML += `<option value="${l.id}" ${isSelected}>${l.name}</option>`;
                });

                alert("✅ Customer Added Successfully!");
                closeCustModal();
            };
        } catch(err) {
            alert("Error creating customer: " + err.message);
        }
    }   
    </script>
</body>
</html>