<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Entry - Arth Book</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- ARTH BOOK PLATINUM THEME --- */
        :root { 
            --primary: #0d47a1; 
            --primary-dark: #002171;
            --accent: #ffca28; 
            --bg: #f1f5f9; 
            --surface: #ffffff;
            --border: #e2e8f0; 
            --text-main: #1e293b;
            --green: #10b981; 
            --red: #ef4444; 
            --sidebar-width: 260px;
        }

        * { box-sizing: border-box; font-family: 'Inter', sans-serif; margin: 0; padding: 0; }
        body { background: var(--bg); color: var(--text-main); height: 100vh; display:flex; overflow:hidden; }

        /* --- SIDEBAR --- */
        .sidebar { 
            width: var(--sidebar-width); background: var(--primary); color: #e2e8f0; 
            display: flex; flex-direction: column; flex-shrink: 0; height: 100vh; 
            transition: all 0.3s ease-in-out; z-index: 1000; box-shadow: 4px 0 10px rgba(0,0,0,0.1);
        }
        .brand-logo { 
            padding: 20px; font-size: 20px; font-weight: 800; color: white; 
            display: flex; align-items: center; gap: 10px; border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .nav-links { list-style: none; padding: 15px 10px; flex: 1; overflow-y: auto; }
        .nav-link { 
            display: flex; align-items: center; gap: 12px; padding: 12px 15px; 
            color: rgba(255,255,255,0.7); text-decoration: none; border-radius: 8px; 
            font-weight: 500; margin-bottom: 5px; transition: 0.2s; font-size: 14px;
        }
        .nav-link:hover { background: rgba(255,255,255,0.1); color: white; padding-left: 20px; }
        .nav-link.active { background: var(--accent); color: var(--primary-dark); font-weight: 800; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        
        /* --- MAIN CONTENT --- */
        .main-content { flex: 1; display: flex; flex-direction: column; height: 100vh; overflow: hidden; padding: 15px; position: relative; }

        /* HEADER CARD */
        .header-card {
            background: var(--surface); padding: 15px; border-radius: 12px; border: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); flex-wrap: wrap; gap: 10px;
        }
        .h-group { display: flex; flex-direction: column; gap: 5px; flex: 1; min-width: 200px; }
        .h-label { font-size: 12px; color: #64748b; font-weight: 700; text-transform: uppercase; }
        .h-input { padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-weight: 600; font-size: 14px; outline: none; }
        .h-input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(13, 71, 161, 0.1); }
        .inv-badge { background: #e0f2fe; color: var(--primary); padding: 5px 12px; border-radius: 20px; font-weight: 800; font-size: 14px; }

        /* ENTRY BAR */
        .entry-bar {
            background: #fff; padding: 10px; border-radius: 12px 12px 0 0; border: 1px solid var(--border); border-bottom: none;
            display: grid; grid-template-columns: 3fr 1fr 1fr 1fr 100px; gap: 10px; align-items: end;
        }
        .e-grp { display: flex; flex-direction: column; gap: 4px; position: relative; }
        .e-label { font-size: 11px; color: #64748b; font-weight: 600; }
        .e-input { padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-weight: 600; width: 100%; outline: none; }
        .e-input:focus { border-color: var(--accent); }
        .btn-add { background: var(--primary); color: white; border: none; padding: 10px; border-radius: 6px; cursor: pointer; font-weight: 700; height: 38px; }
        .btn-add:hover { background: var(--primary-dark); }
        .stock-tag { position: absolute; right: 5px; top: 0; font-size: 10px; color: var(--green); font-weight: bold; background: #ecfdf5; padding: 2px 6px; border-radius: 4px; display: none; }

        /* TABLE AREA */
        .table-area { flex: 1; overflow-y: auto; background: white; border: 1px solid var(--border); border-radius: 0 0 12px 12px; border-top: 1px solid #e2e8f0; }
        table { width: 100%; border-collapse: collapse; }
        th { position: sticky; top: 0; background: #f8fafc; padding: 12px; text-align: left; font-size: 12px; font-weight: 700; color: #475569; border-bottom: 2px solid var(--border); z-index: 10; }
        td { padding: 10px 12px; border-bottom: 1px solid #f1f5f9; font-size: 13px; color: var(--text-main); vertical-align: middle; }
        tr:hover { background: #f8fafc; }
        .td-input { width: 80px; padding: 5px; border: 1px solid transparent; background: transparent; text-align: center; font-weight: 600; }
        .td-input:focus { border-color: var(--accent); background: white; border-radius: 4px; }
        .td-amt { font-family: 'Courier New', monospace; font-weight: 700; }

        /* FOOTER */
        .footer-card {
            background: white; padding: 15px 20px; border-radius: 12px; border: 1px solid var(--border);
            margin-top: 15px; display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 -4px 15px rgba(0,0,0,0.03);
        }
        .total-box { text-align: right; line-height: 1.4; }
        .lbl-grand { font-size: 28px; font-weight: 800; color: var(--primary); }
        
        .btn-action { padding: 12px 25px; border-radius: 8px; border: none; font-weight: 700; cursor: pointer; color: white; display: flex; align-items: center; gap: 8px; font-size: 16px; }
        /* FIXED: Green Print Button */
        .btn-save { background-color: #10b981 !important; color: white !important; box-shadow: 0 4px 10px rgba(16, 185, 129, 0.4); border: 1px solid #059669; }
        .btn-save:hover { background-color: #047857 !important; transform: translateY(-2px); }

        /* MODAL */
        .modal-overlay { position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.6); display:none; justify-content:center; align-items:center; z-index:2000; backdrop-filter: blur(4px); }
        .modal { background:white; width:95%; max-width:450px; padding:30px; border-radius:20px; box-shadow:0 25px 50px -12px rgba(0,0,0,0.25); animation: slideIn 0.2s ease-out; }
        .pay-options { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin: 25px 0; }
        .p-opt { padding: 15px; border: 2px solid var(--border); border-radius: 12px; text-align: center; cursor: pointer; font-weight: 600; color: var(--text-main); transition: 0.2s; background: #f8fafc; }
        .p-opt:hover { border-color: var(--primary); transform: translateY(-2px); }
        .p-opt.selected { border-color: var(--accent); background: #fffbeb; color: var(--primary-dark); box-shadow: 0 4px 6px rgba(0,0,0,0.05); }

        #toast { position: fixed; bottom: 20px; right: 20px; background: var(--green); color: white; padding: 12px 24px; border-radius: 8px; font-weight: 600; box-shadow: 0 4px 12px rgba(0,0,0,0.2); display: none; z-index: 3000; }
        .menu-btn { display: none; font-size: 20px; color: var(--primary); cursor: pointer; margin-right: 15px; }

        @media (max-width: 1024px) {
            .sidebar { position: fixed; left: -100%; width: 280px; height: 100vh; }
            .sidebar.active { left: 0; }
            .menu-btn { display: block; }
            .entry-bar { grid-template-columns: 1fr 1fr; }
            .e-grp:first-child { grid-column: 1 / -1; }
            .btn-add { grid-column: 1 / -1; }
        }

        /* --- PRINT CSS: Hides Browser Headers & URL --- */
        @media print {
            @page { margin: 0; size: A4; }
            body { margin: 0; }
            body * { visibility: hidden; }
            #printArea, #printArea * { visibility: visible; }
            #printArea { position: absolute; left: 0; top: 0; width: 100%; }
        }
    </style>
</head>
<body>

   <div class="sidebar" id="sidebar">
        <div class="brand-logo">
            <i class="fas fa-cube"></i> Arth Book
        </div>
        <ul class="nav-links">
            <li><a href="index.html" class="nav-link"><i class="fas fa-home"></i> Dashboard</a></li>
            <li><a href="sales_invoice.html" class="nav-link active"><i class="fas fa-file-invoice"></i> Sales (Table)</a></li>
            <li><a href="purchase_invoice.html" class="nav-link"><i class="fas fa-truck"></i> Purchase</a></li>
            <li><a href="vouchers.html" class="nav-link"><i class="fas fa-receipt"></i> Day Book</a></li>
            <li style="margin-top:15px; margin-bottom:5px; font-size:11px; color:#64748b; font-weight:bold; padding-left:15px; text-transform:uppercase;">Masters</li>
            <li><a href="item_master.html" class="nav-link"><i class="fas fa-boxes"></i> Inventory</a></li>
            <li><a href="ArthBook.html" class="nav-link"><i class="fas fa-users"></i> Parties</a></li>
            <hr style="border:0; border-top:1px solid rgba(255,255,255,0.1); margin:15px 5px;">
            <li><a href="settings.html" class="nav-link"><i class="fas fa-cog"></i> Settings</a></li>
        </ul>
        <div style="padding: 20px; font-size: 11px; color: #64748b; text-align: center; margin-top:auto;">
            Arth Book v4.2<br>Table Edition
        </div>
    </div>

    <div class="main-content">
        <div class="header-card">
            <div style="display:flex; align-items:center;">
                <i class="fas fa-bars menu-btn" onclick="document.getElementById('sidebar').classList.toggle('active')"></i>
                <div class="h-group">
                    <span class="h-label">Customer / Party</span>
                    <select id="custSelect" class="h-input">
                        <option value="">Walk-in Customer (Cash)</option>
                    </select>
                </div>
            </div>
            <div class="h-group" style="max-width: 150px;">
                <span class="h-label">Invoice Date</span>
                <input type="date" id="billDate" class="h-input">
            </div>
            <div class="h-group" style="max-width: 120px; text-align:right;">
                <span class="h-label">Inv. No</span>
                <div id="invNo" class="inv-badge">LOADING</div>
            </div>
        </div>

        <div class="entry-bar">
            <div class="e-grp">
                <span class="e-label">Item Name (F2)</span>
                <input type="text" id="itemSearch" class="e-input" list="itemList" placeholder="Search or Scan Barcode..." oninput="onItemSelect()" onkeydown="handleEnter(event, 'qtyInput')">
                <datalist id="itemList"></datalist>
                <span id="stockInd" class="stock-tag">Stock: 0</span>
                <input type="hidden" id="selItemId">
                <input type="hidden" id="selItemGst">
            </div>
            <div class="e-grp">
                <span class="e-label">Qty</span>
                <input type="number" id="qtyInput" class="e-input" value="1" min="1" oninput="calcLine()" onkeydown="handleEnter(event, 'rateInput')">
            </div>
            <div class="e-grp">
                <span class="e-label">Rate</span>
                <input type="number" id="rateInput" class="e-input" placeholder="0.00" oninput="calcLine()" onkeydown="handleEnter(event, 'addBtn')">
            </div>
            <div class="e-grp">
                <span class="e-label">Amount</span>
                <input type="number" id="amtDisplay" class="e-input" placeholder="0.00" readonly style="background:#f8fafc;">
            </div>
            <button class="btn-add" id="addBtn" onclick="addItemRow()">
                <i class="fas fa-plus"></i> ADD
            </button>
        </div>

        <div class="table-area">
            <table>
                <thead>
                    <tr>
                        <th width="50">#</th>
                        <th>Item Name</th>
                        <th width="100" style="text-align:center;">Qty</th>
                        <th width="120" style="text-align:center;">Rate</th>
                        <th width="150" style="text-align:right;">Total</th>
                        <th width="50"></th>
                    </tr>
                </thead>
                <tbody id="cartTableBody">
                    <tr><td colspan="6" style="text-align:center; padding:30px; color:#94a3b8;">Items will appear here...</td></tr>
                </tbody>
            </table>
        </div>

        <div class="footer-card">
            <div style="font-size:12px; color:#64748b;">
                Items: <span id="lblCount">0</span> | Qty: <span id="lblQty">0</span>
            </div>
            <div style="display:flex; gap:30px; align-items:center;">
                <div class="total-box">
                    <div style="font-size:12px; color:#64748b;">Tax (GST): <span id="lblTax">0.00</span></div>
                    <div class="lbl-grand">₹ <span id="lblGrand">0.00</span></div>
                </div>
                <button class="btn-action btn-save" onclick="openPaymentModal()">
                    Checkout <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="payModal">
        <div class="modal">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2 style="margin:0; color:var(--primary);">Confirm Payment</h2>
                <button onclick="closeModal()" style="background:none; border:none; font-size:24px; cursor:pointer; color:#94a3b8;">&times;</button>
            </div>
            
            <div style="text-align:center; margin-bottom:20px; padding: 20px; background: #f8fafc; border-radius: 12px; border:1px solid var(--border);">
                <div style="font-size:14px; color:#64748b; margin-bottom: 5px;">Total Payable Amount</div>
                <div style="font-size:40px; font-weight:800; color:var(--primary); line-height:1;" id="modalTotal">₹0</div>
            </div>

            <label style="font-size:12px; font-weight:bold; color:#64748b; text-transform:uppercase;">Payment Mode</label>
            <div class="pay-options">
                <div class="p-opt selected" onclick="setMode('Cash', this)">
                    <i class="fas fa-money-bill-wave" style="display:block; font-size:20px; margin-bottom:5px;"></i> Cash
                </div>
                <div class="p-opt" onclick="setMode('Online', this)">
                    <i class="fas fa-qrcode" style="display:block; font-size:20px; margin-bottom:5px;"></i> UPI/Card
                </div>
                <div class="p-opt" onclick="setMode('Udhar', this)">
                    <i class="fas fa-book" style="display:block; font-size:20px; margin-bottom:5px;"></i> Credit
                </div>
            </div>

            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn-action" style="background:#64748b; color:white; flex:1; justify-content:center;" onclick="saveBill(false)">
                    <i class="fas fa-save"></i> Save Only
                </button>
                <button class="btn-action" style="background:#10b981; color:white; flex:1; justify-content:center;" onclick="saveBill(true)">
                    <i class="fas fa-print"></i> Print & Save
                </button>
            </div>
        </div>
    </div>

    <div id="printArea"></div>
    <div id="toast"></div>

    <script src="db.js"></script>
    <script>
        let items=[], ledgers=[], cart=[], settings={}, groups=[];
        let selectedMode = 'Cash';

        window.onload = async () => {
            try {
                await DB.init();
                [items, ledgers, settings, groups] = await Promise.all([
                    DB.getAll('items'), DB.getAll('ledgers'), DB.getAll('settings'), DB.getAll('groups')
                ]);
                
                if(Array.isArray(settings) && settings.length > 0) settings = settings[0];

                updateItemDatalist(items);
                loadCustomers();
                generateInvNo();
                document.getElementById('billDate').valueAsDate = new Date();
                
            } catch(e) { console.error(e); showToast("⚠️ Database connection failed."); }
        };

        // --- ENTRY LOGIC ---
        function updateItemDatalist(list) {
            const dl = document.getElementById('itemList');
            dl.innerHTML = list.map(i => `<option value="${i.name}">Price: ${i.std_price} | Stock: ${i.current_stock}</option>`).join('');
        }

        function onItemSelect() {
            const val = document.getElementById('itemSearch').value;
            const item = items.find(i => i.name === val || i.sku === val);
            if(item) {
                document.getElementById('selItemId').value = item.id;
                document.getElementById('selItemGst').value = item.gst_rate || 0;
                document.getElementById('rateInput').value = item.std_price || 0;
                document.getElementById('itemSearch').value = item.name; 
                const stock = item.current_stock || 0;
                const ind = document.getElementById('stockInd');
                ind.innerText = `Stock: ${stock} ${item.unit||''}`;
                ind.style.display = 'block';
                ind.style.color = stock < (item.reorder_level||5) ? 'red' : 'var(--green)';
                calcLine();
                document.getElementById('qtyInput').focus();
            }
        }

        function calcLine() {
            const qty = parseFloat(document.getElementById('qtyInput').value) || 0;
            const rate = parseFloat(document.getElementById('rateInput').value) || 0;
            document.getElementById('amtDisplay').value = (qty * rate).toFixed(2);
        }

        function addItemRow() {
            const id = document.getElementById('selItemId').value;
            const name = document.getElementById('itemSearch').value;
            const qty = parseFloat(document.getElementById('qtyInput').value);
            const rate = parseFloat(document.getElementById('rateInput').value);
            const gst = parseFloat(document.getElementById('selItemGst').value) || 0;

            if(!id || !name) return showToast("⚠️ Select an item first");
            if(qty <= 0) return showToast("⚠️ Invalid Quantity");

            const item = items.find(i => i.id == id);
            const itemHsn = item ? item.hsn : '';
            const itemUnit = item ? item.unit : '';

            if(qty > (item.current_stock || 0)) {
                return showToast(`⚠️ Low Stock! Only ${item.current_stock} available.`);
            }

            const existing = cart.find(c => c.id == id);
            if(existing) {
                existing.qty += qty;
            } else {
                cart.push({ id: id, name: name, qty: qty, rate: rate, gst: gst, hsn: itemHsn, unit: itemUnit });
            }

            document.getElementById('itemSearch').value = '';
            document.getElementById('selItemId').value = '';
            document.getElementById('qtyInput').value = 1;
            document.getElementById('rateInput').value = '';
            document.getElementById('amtDisplay').value = '';
            document.getElementById('stockInd').style.display = 'none';
            document.getElementById('itemSearch').focus();
            renderCartTable();
        }

        function handleEnter(e, nextId) {
            if(e.key === 'Enter') {
                e.preventDefault();
                if(nextId === 'addBtn') addItemRow();
                else document.getElementById(nextId).focus();
            }
        }

        function renderCartTable() {
            const tbody = document.getElementById('cartTableBody');
            if(cart.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:30px; color:#94a3b8;">Items will appear here...</td></tr>';
                updateTotals(0,0,0,0);
                return;
            }
            let sub = 0, tax = 0, totalQty = 0;
            tbody.innerHTML = '';
            cart.forEach((c, idx) => {
                const base = c.qty * c.rate;
                const taxAmt = base * (c.gst/100);
                sub += base;
                tax += taxAmt;
                totalQty += c.qty;
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="color:#64748b;">${idx+1}</td>
                    <td style="font-weight:600;">${c.name} <span style="font-size:10px; color:#94a3b8;">(${c.gst}% GST)</span></td>
                    <td style="text-align:center;">
                        <input type="number" class="td-input" value="${c.qty}" onchange="editCart(${idx}, 'qty', this.value)">
                    </td>
                    <td style="text-align:center;">
                        <input type="number" class="td-input" value="${c.rate}" onchange="editCart(${idx}, 'rate', this.value)">
                    </td>
                    <td style="text-align:right;" class="td-amt">₹${(base+taxAmt).toFixed(2)}</td>
                    <td style="text-align:center;">
                        <i class="fas fa-trash" style="color:#ef4444; cursor:pointer;" onclick="remItem(${idx})"></i>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            updateTotals(sub, tax, cart.length, totalQty);
        }

        function editCart(idx, field, val) {
            const v = parseFloat(val) || 0;
            if(v <= 0 && field === 'qty') return remItem(idx);
            if(field === 'qty') {
                 const item = items.find(i => i.id == cart[idx].id);
                 if(v > (item.current_stock||0)) {
                     showToast("⚠️ Stock Limit Exceeded");
                     cart[idx].qty = item.current_stock;
                 } else { cart[idx].qty = v; }
            } else { cart[idx].rate = v; }
            renderCartTable();
        }

        function remItem(idx) {
            cart.splice(idx, 1);
            renderCartTable();
        }

        function updateTotals(sub, tax, count, qty) {
            const grand = Math.round(sub + tax);
            document.getElementById('lblTax').innerText = tax.toFixed(2);
            document.getElementById('lblGrand').innerText = grand.toFixed(2);
            document.getElementById('modalTotal').innerText = "₹" + grand.toLocaleString('en-IN');
            document.getElementById('lblCount').innerText = count;
            document.getElementById('lblQty').innerText = qty;
        }

        function loadCustomers() {
            const sel = document.getElementById('custSelect');
            sel.innerHTML = '<option value="">Walk-in Customer (Cash)</option>';
            const targetGroups = ['Sundry Debtors', 'Sundry Creditors'];
            const allowedGids = groups.filter(g => targetGroups.includes(g.name)).map(g => g.id);
            const parties = ledgers.filter(l => allowedGids.includes(l.group_id));
            parties.sort((a,b) => a.name.localeCompare(b.name));
            parties.forEach(l => { sel.innerHTML += `<option value="${l.id}">${l.name}</option>`; });
        }

        async function generateInvNo() {
            try { const n = await DB.getNextVoucherNo('Sales'); document.getElementById('invNo').innerText = `INV-${n}`; } catch(e) {}
        }
        
        function showToast(msg) {
            const t = document.getElementById('toast'); t.innerText = msg; t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 3000);
        }

        function openPaymentModal() {
            if(cart.length === 0) return showToast("Add items first!");
            document.getElementById('payModal').style.display = 'flex';
        }
        function closeModal() { document.getElementById('payModal').style.display = 'none'; }
        
        function setMode(m, el) {
            selectedMode = m;
            document.querySelectorAll('.p-opt').forEach(e => e.classList.remove('selected'));
            el.classList.add('selected');
        }

        // --- 4. SAVE & PRINT ---
        // --- UPDATED SAVE FUNCTION (Fixes Missing Tax & Items) ---
async function saveBill(shouldPrint) {
    const pid = document.getElementById('custSelect').value;
    const invNo = document.getElementById('invNo').innerText;
    const date = document.getElementById('billDate').value;
    const grand = parseFloat(document.getElementById('lblGrand').innerText.replace(',',''));

    if (selectedMode === 'Udhar' && (!pid || pid === "0" || pid === "")) {
        alert("❌ Error: Select a Party for Credit Sale.");
        return;
    }

    const voucher = {
        voucher_no: invNo,
        date: date,
        type: 'Sales',
        party_id: parseInt(pid) || 0,
        amount: grand,
        payment_mode: selectedMode,
        narration: `POS Sale - ${selectedMode}`
    };

    const entries = [];
    
    // 1. Party Debit (Grand Total)
    let debitLedgerId = 0;
    if (selectedMode === 'Cash') {
        const cashL = ledgers.find(l => l.name === 'Cash' || l.group_name === 'Cash-in-Hand');
        if(cashL) debitLedgerId = cashL.id;
    } else if (selectedMode === 'Udhar') {
        debitLedgerId = parseInt(pid);
    } else {
        const bankL = ledgers.find(l => l.name === 'Bank Account' || l.group_name === 'Bank Accounts');
        if(bankL) debitLedgerId = bankL.id;
    }
    if (debitLedgerId) entries.push({ ledger_id: debitLedgerId, debit: grand, credit: 0 });

    // 2. Sales Credit (Taxable Amount Only)
    let salesL = ledgers.find(l => l.name === 'Local Sales');
    if (!salesL) salesL = ledgers.find(l => l.group_id === 9); // Fallback to Sales Group
    const salesId = salesL ? salesL.id : 0;

    let totalTax = 0;

    cart.forEach(c => {
        const taxable = c.qty * c.rate;
        const taxAmt = taxable * (c.gst / 100);
        totalTax += taxAmt;

        entries.push({
            ledger_id: salesId,
            debit: 0,
            credit: taxable,
            meta_data: { item_id: c.id, qty: c.qty, rate: c.rate } // यह Item Name प्रिंट के लिए जरूरी है
        });
    });

    // 3. Tax Credit (Duties & Taxes)
    if(totalTax > 0) {
        let taxL = ledgers.find(l => l.name === 'Output GST');
        if(!taxL) taxL = ledgers.find(l => l.group_name === 'Duties & Taxes');
        const taxId = taxL ? taxL.id : 0;
        
        // अगर Tax लेजर नहीं मिला तो भी एंट्री करो (ताकि टोटल मैच हो)
        if(taxId) entries.push({ ledger_id: taxId, debit: 0, credit: totalTax });
    }

    try {
        await DB.saveVoucherTransaction(voucher, entries);
        if (shouldPrint) printReceipt(voucher, cart, grand);
        else {
            showToast("✅ Sale Saved Correctly!");
            setTimeout(() => location.reload(), 1000);
        }
    } catch (e) { alert("Transaction Failed: " + e.message); }
}

        // --- UPDATED PRINT FUNCTION ---
    // --- GST A4 INVOICE PRINT (Updated with Logo, Bank & Sign) ---
// --- FINAL GST INVOICE PRINT (Full Grid Lines) ---
function printReceipt(v, items, total) {
    const companyName = (settings && settings.company_name) ? settings.company_name : "Arth Book User";
    const companyAddr = (settings && settings.address) ? settings.address : "India";
    const companyGST = (settings && settings.gst_user) ? settings.gst_user : "Unregistered";
    const companyPhone = (settings && settings.phone) ? settings.phone : "";
    
    // बैंक डीटेल्स
    const bankName = (settings && settings.bank_name) ? settings.bank_name : "";
    const bankAcc = (settings && settings.bank_account) ? settings.bank_account : "";
    const bankIFSC = (settings && settings.bank_ifsc) ? settings.bank_ifsc : "";
    const upiId = (settings && settings.upi_id) ? settings.upi_id : "";

    let buyerName = "Cash / Walk-in";
    let buyerGST = "N/A";
    let buyerAddr = "";
    
    const pid = document.getElementById('custSelect').value;
    if(pid) {
        const party = ledgers.find(l => l.id == pid);
        if(party) {
            buyerName = party.name;
            buyerGST = party.gstin || "Unregistered";
            buyerAddr = party.address || "";
        }
    }

    const amountInWords = numToWords(Math.round(total));

    let rows = '';
    let totalTaxable = 0;
    let totalCGST = 0;
    let totalSGST = 0;

    items.forEach((i, idx) => {
        const rate = parseFloat(i.rate);
        const qty = parseFloat(i.qty);
        const gstPercent = parseFloat(i.gst) || 0;
        
        const baseAmt = rate * qty; 
        const taxAmt = baseAmt * (gstPercent / 100);
        
        const halfTaxRate = gstPercent / 2;
        const halfTaxAmt = taxAmt / 2;

        totalTaxable += baseAmt;
        totalCGST += halfTaxAmt;
        totalSGST += halfTaxAmt;

        // BORDERS FIXED: border: 1px solid #000 everywhere
        rows += `
            <tr>
                <td style="text-align:center; padding:5px; border:1px solid #000;">${idx + 1}</td>
                <td style="padding:5px; border:1px solid #000;">${i.name}</td>
                <td style="text-align:center; padding:5px; border:1px solid #000;">${i.hsn || '-'}</td>
                <td style="text-align:center; padding:5px; border:1px solid #000;">${qty} ${i.unit || ''}</td>
                <td style="text-align:right; padding:5px; border:1px solid #000;">${rate.toFixed(2)}</td>
                <td style="text-align:right; padding:5px; border:1px solid #000;">${baseAmt.toFixed(2)}</td>
                <td style="text-align:right; padding:5px; border:1px solid #000;">${halfTaxRate}%<br><small>${halfTaxAmt.toFixed(2)}</small></td>
                <td style="text-align:right; padding:5px; border:1px solid #000;">${halfTaxRate}%<br><small>${halfTaxAmt.toFixed(2)}</small></td>
                <td style="text-align:right; padding:5px; border:1px solid #000;">${(baseAmt + taxAmt).toFixed(2)}</td>
            </tr>
        `;
    });

    const exactTotal = totalTaxable + totalCGST + totalSGST;
    const grandTotal = Math.round(exactTotal);
    const roundOffAmt = grandTotal - exactTotal;

    const content = `
        <div style="width: 210mm; padding: 20px; font-family: 'Arial', sans-serif; color: #000; background: white; margin: auto;">
            
            <div style="border: 1px solid #000;">
                
                <div style="text-align: center; border-bottom: 1px solid #000; padding: 8px; background: #eee;">
                    <h2 style="margin: 0; text-transform: uppercase; font-size: 18px;">TAX INVOICE</h2>
                </div>

                <div style="display: flex; border-bottom: 1px solid #000;">
                    <div style="flex: 1; padding: 10px; border-right: 1px solid #000;">
                        <img src="logo.png" style="max-height: 50px; margin-bottom: 5px; display:block;" onerror="this.style.display='none'">
                        
                        <h3 style="margin: 0 0 5px 0; font-size: 16px;">${companyName}</h3>
                        <div style="font-size: 12px; line-height: 1.4;">
                            ${companyAddr}<br>
                            <strong>GSTIN:</strong> ${companyGST}<br>
                            <strong>Contact:</strong> ${companyPhone}
                        </div>
                    </div>
                    
                    <div style="flex: 1; padding: 10px;">
                        <div style="display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 10px;">
                            <span><strong>Inv No:</strong> ${v.voucher_no}</span>
                            <span><strong>Date:</strong> ${v.date}</span>
                        </div>
                        <div style="font-size: 12px; line-height: 1.4; border-top: 1px solid #ccc; padding-top: 5px;">
                            <strong>Bill To:</strong><br>
                            <span style="font-weight:bold; font-size: 14px;">${buyerName}</span><br>
                            <span>${buyerAddr}</span><br>
                            <span><strong>GSTIN:</strong> ${buyerGST}</span>
                        </div>
                    </div>
                </div>

                <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                    <thead>
                        <tr style="background: #f0f0f0;">
                            <th style="border: 1px solid #000; padding: 6px; width: 5%;">#</th>
                            <th style="border: 1px solid #000; padding: 6px; width: 30%;">Item Description</th>
                            <th style="border: 1px solid #000; padding: 6px;">HSN</th>
                            <th style="border: 1px solid #000; padding: 6px;">Qty</th>
                            <th style="border: 1px solid #000; padding: 6px;">Rate</th>
                            <th style="border: 1px solid #000; padding: 6px;">Taxable</th>
                            <th style="border: 1px solid #000; padding: 6px;">CGST</th>
                            <th style="border: 1px solid #000; padding: 6px;">SGST</th>
                            <th style="border: 1px solid #000; padding: 6px;">Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${rows}
                        <tr style="height: 50px;">
                            <td style="border:1px solid #000;"></td>
                            <td style="border:1px solid #000;"></td>
                            <td style="border:1px solid #000;"></td>
                            <td style="border:1px solid #000;"></td>
                            <td style="border:1px solid #000;"></td>
                            <td style="border:1px solid #000;"></td>
                            <td style="border:1px solid #000;"></td>
                            <td style="border:1px solid #000;"></td>
                            <td style="border:1px solid #000;"></td>
                        </tr>
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="5" style="border: 1px solid #000; text-align: right; padding: 6px; font-weight: bold;">Sub Total</td>
                            <td style="border: 1px solid #000; text-align: right; padding: 6px;">${totalTaxable.toFixed(2)}</td>
                            <td style="border: 1px solid #000; text-align: right; padding: 6px;">${totalCGST.toFixed(2)}</td>
                            <td style="border: 1px solid #000; text-align: right; padding: 6px;">${totalSGST.toFixed(2)}</td>
                            <td style="border: 1px solid #000; text-align: right; padding: 6px; font-weight: bold;">${exactTotal.toFixed(2)}</td>
                        </tr>
                        <tr>
                            <td colspan="8" style="border: 1px solid #000; text-align: right; padding: 6px;">Round Off</td>
                            <td style="border: 1px solid #000; text-align: right; padding: 6px;">${roundOffAmt > 0 ? '+' : ''}${roundOffAmt.toFixed(2)}</td>
                        </tr>
                        <tr style="background:#eee;">
                            <td colspan="8" style="border: 1px solid #000; text-align: right; padding: 6px; font-weight: 800; font-size:14px;">GRAND TOTAL</td>
                            <td style="border: 1px solid #000; text-align: right; padding: 6px; font-weight: 800; font-size:14px;">₹${grandTotal.toFixed(2)}</td>
                        </tr>
                    </tfoot>
                </table>

                <div style="display: flex; border-top: 1px solid #000;">
                    <div style="flex: 1.8; padding: 10px; border-right: 1px solid #000;">
                        <div style="font-size: 12px;"><strong>Amount in Words:</strong></div>
                        <div style="font-style: italic; margin-top: 5px; font-weight:600;">${amountInWords} Only</div>
                        
                        <div style="margin-top: 15px; font-size: 11px; border: 1px solid #000; padding: 8px;">
                            <strong>Bank Details:</strong><br>
                            Bank: ${bankName}<br>
                            A/c: <b>${bankAcc}</b> &nbsp;|&nbsp; IFSC: ${bankIFSC}<br>
                            UPI: ${upiId}
                        </div>

                        <div style="margin-top: 10px; font-size: 10px;">
                            <strong>Terms & Conditions:</strong><br>
                            1. Goods once sold will not be taken back.<br>
                            2. Subject to local jurisdiction.<br>
                            3. E. & O.E.
                        </div>
                    </div>
                    
                    <div style="flex: 1.2; padding: 10px; text-align: center; display: flex; flex-direction: column; justify-content: space-between;">
                        <div style="margin-top: 10px;">
                            <div style="font-size: 12px; margin-bottom:40px;">For ${companyName}</div>
                            
                            <img src="sign.png" style="height: 40px; margin: 0 auto; display:block;" onerror="this.style.display='none'">
                            
                            <div style="font-size: 12px; font-weight:bold; border-top:1px solid #000; padding-top:5px; margin-top:5px;">Authorized Signatory</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div style="text-align:center; font-size:10px; margin-top:5px;">This is a Computer Generated Invoice</div>
        </div>
    `;

    document.getElementById('printArea').innerHTML = content;
    setTimeout(() => { window.print(); setTimeout(() => location.reload(), 500); }, 500);
}

        function numToWords(n) {
            if (n === 0) return "Zero";
            const units = ["", "One", "Two", "Three", "Four", "Five", "Six", "Seven", "Eight", "Nine"];
            const teens = ["Ten", "Eleven", "Twelve", "Thirteen", "Fourteen", "Fifteen", "Sixteen", "Seventeen", "Eighteen", "Nineteen"];
            const tens = ["", "", "Twenty", "Thirty", "Forty", "Fifty", "Sixty", "Seventy", "Eighty", "Ninety"];
            function convert(num) {
                if (num < 10) return units[num];
                if (num < 20) return teens[num - 10];
                if (num < 100) return tens[Math.floor(num / 10)] + (num % 10 ? " " + units[num % 10] : "");
                if (num < 1000) return units[Math.floor(num / 100)] + " Hundred" + (num % 100 ? " and " + convert(num % 100) : "");
                if (num < 100000) return convert(Math.floor(num / 1000)) + " Thousand" + (num % 1000 ? " " + convert(num % 1000) : "");
                if (num < 10000000) return convert(Math.floor(num / 100000)) + " Lakh" + (num % 100000 ? " " + convert(num % 100000) : "");
                return convert(Math.floor(num / 10000000)) + " Crore" + (num % 10000000 ? " " + convert(num % 10000000) : "");
            }
            return convert(n);
        }

        document.addEventListener('keydown', e => {
            if(e.key === 'F2') { e.preventDefault(); document.getElementById('itemSearch').focus(); }
            if(e.ctrlKey && e.key === 'Enter') openPaymentModal();
        });
    </script>
</body>
</html>