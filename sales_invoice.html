<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales & Billing - Money Wise Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #1e293b; --accent: #2563eb; --border: #cbd5e1; --bg: #f1f5f9; --green: #10b981; --red: #ef4444; }
        * { box-sizing: border-box; font-family: 'Inter', sans-serif; margin: 0; padding: 0; }
        body { background: var(--bg); padding: 20px; color: var(--primary); }

        /* TOOLBAR */
        .toolbar { max-width: 210mm; margin: 0 auto 20px; display: flex; justify-content: space-between; align-items: center; }
        .btn { padding: 10px 20px; border-radius: 6px; border: none; font-weight: 600; cursor: pointer; color: white; display: flex; align-items: center; gap: 8px; }
        .btn-save { background: var(--green); }
        .btn-print { background: var(--primary); }
        .btn-wa { background: #25D366; }
        .mode-switch select { padding: 8px; border-radius: 6px; border: 1px solid var(--border); font-weight: 600; }

        /* INVOICE BOX */
        .invoice-box { background: white; width: 210mm; min-height: 297mm; margin: 0 auto; padding: 15mm; box-shadow: 0 5px 15px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; display: flex; flex-direction: column; }
        
        /* HEADER */
        .header { display: flex; justify-content: space-between; border-bottom: 2px solid var(--primary); padding-bottom: 10px; margin-bottom: 20px; }
        .company-info h1 { font-size: 24px; text-transform: uppercase; color: var(--accent); margin-bottom: 5px; }
        .invoice-title h2 { font-size: 20px; text-transform: uppercase; color: #94a3b8; text-align: right; }
        .meta-grid { display: grid; grid-template-columns: auto auto; gap: 5px 15px; margin-top: 10px; text-align: right; font-size: 13px; }
        .meta-val input { text-align: right; font-weight: 700; width: 120px; border: 1px solid #eee; padding: 2px; }

        /* PARTY & SCAN */
        .top-row { display: flex; gap: 20px; margin-bottom: 15px; }
        .party-box { flex: 2; background: #f8fafc; padding: 15px; border-radius: 6px; border: 1px solid var(--border); }
        .scan-box { flex: 1; display: flex; flex-direction: column; gap: 10px; }
        .scan-input { width: 100%; padding: 12px; border: 2px solid var(--accent); border-radius: 6px; font-size: 14px; outline: none; }
        
        /* TABLE */
        .item-table { width: 100%; border-collapse: collapse; font-size: 12px; margin-bottom: 20px; }
        .item-table th { background: var(--primary); color: white; padding: 8px; text-align: left; }
        .item-table td { border-bottom: 1px solid var(--border); padding: 8px; vertical-align: middle; }
        .item-table input { width: 100%; border: none; outline: none; background: transparent; font-size: 12px; }
        .text-right { text-align: right; }

        /* FOOTER */
        .footer-section { display: flex; gap: 20px; margin-top: auto; border-top: 2px solid var(--primary); padding-top: 10px; }
        .footer-left { flex: 2; font-size: 12px; }
        .footer-right { flex: 1; font-size: 13px; }
        .total-row { display: flex; justify-content: space-between; padding: 5px 0; }
        .grand-total { font-size: 18px; font-weight: 800; border-top: 2px solid var(--primary); padding-top: 5px; margin-top: 5px; }

        /* CREDIT LIMIT WARNING */
        #creditWarning { color: var(--red); font-size: 12px; font-weight: 700; margin-top: 5px; display: none; }

        /* PRINT MEDIA */
        @media print {
            body { background: white; padding: 0; }
            .toolbar, .scan-box, .no-print { display: none !important; }
            .invoice-box { box-shadow: none; border: none; margin: 0; width: 100%; height: auto; padding: 0; }
            input { border: none !important; }
            
            /* Thermal Mode Support (Dynamic Class) */
            .thermal-mode .invoice-box { width: 78mm; padding: 5px; min-height: auto; }
            .thermal-mode .header { flex-direction: column; text-align: center; }
            .thermal-mode .invoice-title h2 { text-align: center; font-size: 16px; }
            .thermal-mode .top-row { flex-direction: column; }
            .thermal-mode .footer-section { flex-direction: column; }
        }
    </style>
</head>
<body id="bodyTag">

    <div class="toolbar">
        <button class="btn" style="background:#64748b;" onclick="location.href='index.html'">‚Üê Home</button>
        
        <div class="mode-switch">
            <select id="docType" onchange="changeMode()">
                <option value="Sales">Tax Invoice</option>
                <option value="Quotation">Estimate / Quotation</option>
                <option value="Challan">Delivery Challan</option>
                <option value="Return">Credit Note (Return)</option>
            </select>
        </div>

        <div style="display:flex; gap:10px;">
            <button class="btn btn-wa" onclick="shareWA()">üì± WhatsApp</button>
            <button class="btn btn-print" onclick="printBill()">üñ®Ô∏è Print</button>
            <button class="btn btn-save" onclick="saveBill()">üíæ Save (Alt+S)</button>
        </div>
    </div>

    <div class="invoice-box">
        <div class="header">
            <div class="company-info">
                <h1 id="cmpName">COMPANY</h1>
                <p id="cmpAddr">Address...</p>
                <p>GSTIN: <span id="cmpGST">-</span> | Phone: <span id="cmpPhone">-</span></p>
            </div>
            <div class="invoice-title">
                <h2 id="titleText">Tax Invoice</h2>
                <div class="meta-grid">
                    <span>No:</span> <input type="text" id="invNo">
                    <span>Date:</span> <input type="date" id="invDate">
                </div>
            </div>
        </div>

        <div class="top-row">
            <div class="party-box">
                <div style="font-weight:700; color:#64748b; margin-bottom:5px;">Bill To:</div>
                <select id="partySelect" onchange="loadParty()" style="width:100%; padding:5px; margin-bottom:5px;">
                    <option value="">Select Customer</option>
                </select>
                <div id="creditWarning">‚ö†Ô∏è Credit Limit Exceeded! (Curr: ‚Çπ<span id="currBal">0</span> / Lim: ‚Çπ<span id="limitBal">0</span>)</div>
                <textarea id="partyAddr" rows="2" style="width:100%; border:none; background:transparent; resize:none;" placeholder="Address..."></textarea>
                <input id="partyGst" placeholder="GSTIN" style="width:100%;">
            </div>
            <div class="scan-box">
                <input type="text" id="barcodeScan" class="scan-input" placeholder="üîç Scan Barcode / Search Item" onkeyup="handleScan(event)" autofocus>
                <div style="font-size:11px; color:#64748b;">Tip: Use Scanner or Type SKU</div>
            </div>
        </div>

        <table class="item-table">
            <thead>
                <tr>
                    <th width="5%">#</th>
                    <th width="40%">Item Description</th>
                    <th width="10%">Batch</th>
                    <th width="10%" class="text-right">Qty</th>
                    <th width="10%" class="text-right">Rate</th>
                    <th width="10%" class="text-right">Tax%</th>
                    <th width="15%" class="text-right">Total</th>
                    <th width="5%" class="no-print"></th>
                </tr>
            </thead>
            <tbody id="itemRows"></tbody>
        </table>

        <div class="footer-section">
            <div class="footer-left">
                <div>Amount in Words: <i id="amtWords">Zero Only</i></div>
                <div style="margin-top:10px; font-size:11px; color:#64748b;">
                    Terms: <span id="termsText">-</span>
                </div>
                <div style="margin-top:10px; border:1px solid #eee; padding:5px;">
                    <b>Bank Details:</b> <span id="bankDet">-</span>
                </div>
            </div>
            <div class="footer-right">
                <div class="total-row"><span>Sub Total</span><span id="subTotal">0.00</span></div>
                <div class="total-row"><span>CGST</span><span id="cgstVal">0.00</span></div>
                <div class="total-row"><span>SGST</span><span id="sgstVal">0.00</span></div>
                <div class="total-row"><span>Round Off</span><span id="roundOff">0.00</span></div>
                <div class="total-row grand-total"><span>Grand Total</span><span id="grandTotal">‚Çπ 0.00</span></div>
            </div>
        </div>
    </div>

    <script src="db.js"></script><script src="auth.js"></script>
    <script>
        let items = [], ledgers = [], settings = {};
        let currentParty = null;

        window.onload = async () => {
            await DB.init();
            settings = (await DB.getSettings()) || {};
            items = await DB.getItems();
            ledgers = await DB.getLedgers();
            
            // Load Settings
            document.getElementById('cmpName').innerText = settings.name || "MY COMPANY";
            document.getElementById('cmpAddr').innerText = settings.address || "";
            document.getElementById('cmpGST').innerText = settings.gstin || "";
            document.getElementById('cmpPhone').innerText = settings.phone || "";
            document.getElementById('termsText').innerText = settings.terms || "";
            
            // Check URL Mode
            const urlParams = new URLSearchParams(window.location.search);
            const mode = urlParams.get('mode');
            if(mode) {
                document.getElementById('docType').value = mode.charAt(0).toUpperCase() + mode.slice(1);
                changeMode();
            }

            loadParties();
            document.getElementById('invDate').valueAsDate = new Date();
            generateInvNo();
        };

        function changeMode() {
            const type = document.getElementById('docType').value;
            let title = "Tax Invoice";
            if(type === 'Quotation') title = "Estimate / Quotation";
            if(type === 'Challan') title = "Delivery Challan";
            if(type === 'Return') title = "Credit Note";
            
            document.getElementById('titleText').innerText = title;
            generateInvNo();
        }

        function generateInvNo() {
            const type = document.getElementById('docType').value;
            const prefix = type.substring(0,3).toUpperCase(); 
            const rnd = Math.floor(Math.random() * 9000) + 1000;
            document.getElementById('invNo').value = `${prefix}-${new Date().getFullYear()}-${rnd}`;
        }

        function loadParties() {
            const sel = document.getElementById('partySelect');
            const debtorId = ledgers.find(l => l.name === 'Sundry Debtors')?.id; // Simplified group check
            // In real app, filter by group ID. For now showing all.
            ledgers.sort((a,b)=>a.name.localeCompare(b.name)).forEach(l => {
                let opt = document.createElement('option');
                opt.value = l.id; opt.text = l.name;
                sel.appendChild(opt);
            });
        }

        async function loadParty() {
            const pid = document.getElementById('partySelect').value;
            currentParty = ledgers.find(l => l.id == pid);
            if(currentParty) {
                document.getElementById('partyAddr').value = currentParty.address || '';
                document.getElementById('partyGst').value = currentParty.gstin || '';
                
                // Credit Check
                if(currentParty.credit_limit > 0) {
                    // Fetch current balance (Need to calc from DB in real app)
                    // Demo Logic:
                    const bal = Math.abs(currentParty.opening_balance || 0); 
                    document.getElementById('currBal').innerText = bal;
                    document.getElementById('limitBal').innerText = currentParty.credit_limit;
                    
                    if(bal > currentParty.credit_limit) {
                        document.getElementById('creditWarning').style.display = 'block';
                        alert("‚ö†Ô∏è Warning: Party Credit Limit Exceeded!");
                    } else {
                        document.getElementById('creditWarning').style.display = 'none';
                    }
                }
            }
        }

        function handleScan(e) {
            if(e.key === 'Enter') {
                const val = e.target.value.toLowerCase();
                // Find by Barcode OR Name OR SKU
                const item = items.find(i => 
                    (i.sku && i.sku.toLowerCase() === val) || 
                    i.name.toLowerCase().includes(val)
                );

                if(item) {
                    addItemRow(item);
                    e.target.value = ''; // Clear for next scan
                } else {
                    alert("Item not found!");
                }
            }
        }

        function addItemRow(item, qty=1) {
            const tbody = document.getElementById('itemRows');
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${tbody.children.length + 1}</td>
                <td>
                    <input value="${item.name}" readonly style="font-weight:600;">
                    <input type="hidden" class="itemId" value="${item.id}">
                </td>
                <td><input value="-" readonly></td>
                <td><input type="number" class="qty text-right" value="${qty}" onchange="calc(this)"></td>
                <td><input type="number" class="rate text-right" value="${item.std_price}" onchange="calc(this)"></td>
                <td><input type="number" class="tax text-right" value="${item.gst_rate}" readonly></td>
                <td class="total text-right font-bold">0.00</td>
                <td class="no-print"><button onclick="this.closest('tr').remove(); total();" style="color:red;border:none;background:none;">√ó</button></td>
            `;
            tbody.appendChild(tr);
            calc(tr.querySelector('.qty'));
        }

        function calc(el) {
            const tr = el.closest('tr');
            const qty = parseFloat(tr.querySelector('.qty').value) || 0;
            const rate = parseFloat(tr.querySelector('.rate').value) || 0;
            const tax = parseFloat(tr.querySelector('.tax').value) || 0;

            const base = qty * rate;
            const taxAmt = base * (tax / 100);
            const total = base + taxAmt;

            tr.querySelector('.total').innerText = total.toFixed(2);
            tr.dataset.taxable = base;
            tr.dataset.tax = taxAmt;
            
            total();
        }

        function total() {
            let taxable=0, tax=0;
            document.querySelectorAll('#itemRows tr').forEach(tr => {
                taxable += parseFloat(tr.dataset.taxable || 0);
                tax += parseFloat(tr.dataset.tax || 0);
            });
            
            const grand = Math.round(taxable + tax);
            const round = grand - (taxable + tax);

            document.getElementById('subTotal').innerText = taxable.toFixed(2);
            document.getElementById('cgstVal').innerText = (tax/2).toFixed(2);
            document.getElementById('sgstVal').innerText = (tax/2).toFixed(2);
            document.getElementById('roundOff').innerText = round.toFixed(2);
            document.getElementById('grandTotal').innerText = "‚Çπ " + grand.toFixed(2);
            document.getElementById('amtWords').innerText = numToWords(grand) + " Only";
        }

        async function saveBill() {
            const pid = document.getElementById('partySelect').value;
            if(!pid) return alert("Select Customer");
            if(document.getElementById('itemRows').children.length === 0) return alert("Add items");

            // Credit Check Blocker (Optional)
            if(document.getElementById('creditWarning').style.display === 'block') {
                if(!confirm("Credit Limit Exceeded. Continue anyway?")) return;
            }

            const type = document.getElementById('docType').value;
            const amt = parseFloat(document.getElementById('grandTotal').innerText.replace('‚Çπ ',''));

            const voucher = {
                voucher_no: document.getElementById('invNo').value,
                date: document.getElementById('invDate').value,
                party_id: parseInt(pid),
                type: type === 'Return' ? 'Credit Note' : 'Sales', // Mapping
                amount: amt,
                narration: type
            };

            const entries = [];
            document.querySelectorAll('#itemRows tr').forEach(tr => {
                entries.push({
                    item_id: parseInt(tr.querySelector('.itemId').value),
                    qty: parseFloat(tr.querySelector('.qty').value),
                    rate: parseFloat(tr.querySelector('.rate').value)
                });
            });

            // Account Entries (Double Entry)
            // If Quotation/Challan -> NO Accounting, NO Stock
            let acct = [];
            if(type === 'Sales' || type === 'Return') {
                acct = [
                    { ledger_id: parseInt(pid), debit: amt, credit: 0 },
                    { ledger_id: 2, debit: 0, credit: amt } // Sales A/c
                ];
            }

            try {
                // If Quotation, we might save to a different store or just print
                // For now, saving as voucher for simplicity
                await DB.saveVoucher(voucher, entries, acct);
                alert("Saved Successfully!");
                location.reload();
            } catch(e) { alert(e); }
        }

        function printBill() {
            // Check Setting
            const isThermal = false; // Retrieve from DB.settings in real app
            if(isThermal) document.body.classList.add('thermal-mode');
            window.print();
            document.body.classList.remove('thermal-mode');
        }

        function shareWA() {
            const num = document.getElementById('cmpPhone').innerText; // Customer phone ideally
            const amt = document.getElementById('grandTotal').innerText;
            const msg = `Hello, your bill of ${amt} is generated. Thanks for shopping!`;
            window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
        }

        function numToWords(n) { return n + ""; } // Simplify for now
    </script>
</body>
</html>