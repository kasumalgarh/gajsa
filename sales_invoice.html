<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tax Invoice - Money Wise Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #1e293b; --accent: #2563eb; 
            --border: #cbd5e1; --bg: #f1f5f9;
        }
        * { box-sizing: border-box; font-family: 'Inter', sans-serif; margin: 0; padding: 0; }
        body { background: var(--bg); padding: 20px; color: var(--primary); }

        /* --- SCREEN MODE (Form View) --- */
        .toolbar {
            max-width: 210mm; margin: 0 auto 20px; display: flex; justify-content: space-between; align-items: center;
        }
        .btn { padding: 10px 20px; border-radius: 6px; border: none; font-weight: 600; cursor: pointer; color: white; display: flex; align-items: center; gap: 8px; }
        .btn-save { background: #10b981; } .btn-save:hover { background: #059669; }
        .btn-close { background: #ef4444; } .btn-back { background: #64748b; }

        /* --- INVOICE PAGE (A4 Paper Look) --- */
        .invoice-box {
            background: white; width: 210mm; min-height: 297mm; margin: 0 auto;
            padding: 15mm; box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            position: relative; border: 1px solid #e2e8f0;
            display: flex; flex-direction: column;
        }

        /* HEADER */
        .header { display: flex; justify-content: space-between; border-bottom: 2px solid var(--primary); padding-bottom: 10px; margin-bottom: 20px; }
        .company-info h1 { font-size: 24px; text-transform: uppercase; margin-bottom: 5px; color: var(--accent); }
        .company-info p { font-size: 12px; line-height: 1.4; color: #475569; }
        .invoice-title { text-align: right; }
        .invoice-title h2 { font-size: 20px; text-transform: uppercase; color: #94a3b8; }
        .meta-grid { display: grid; grid-template-columns: auto auto; gap: 8px 15px; margin-top: 10px; text-align: right; font-size: 13px; }
        .meta-label { font-weight: 600; color: #64748b; }
        .meta-val input { text-align: right; font-weight: 700; width: 120px; }

        /* ADDRESS SECTION */
        .address-section { display: flex; gap: 20px; margin-bottom: 20px; font-size: 13px; }
        .addr-box { flex: 1; border: 1px solid var(--border); padding: 10px; border-radius: 4px; }
        .addr-title { font-weight: 700; background: #f8fafc; padding: 5px; border-bottom: 1px solid var(--border); margin: -10px -10px 10px -10px; border-radius: 4px 4px 0 0; }
        .addr-input { width: 100%; border: none; resize: none; font-family: inherit; font-size: 13px; outline: none; }

        /* ITEM TABLE */
        .item-table { width: 100%; border-collapse: collapse; font-size: 12px; margin-bottom: 20px; }
        .item-table th { background: #1e293b; color: white; padding: 8px; text-align: left; }
        .item-table td { border-bottom: 1px solid var(--border); padding: 8px; vertical-align: middle; }
        .item-table input, .item-table select { width: 100%; border: none; outline: none; background: transparent; font-size: 12px; }
        .item-table input:focus { background: #f1f5f9; }
        .text-right { text-align: right; }
        .text-center { text-align: center; }
        .font-bold { font-weight: 700; }

        /* FOOTER */
        .footer-section { display: flex; gap: 20px; margin-top: auto; border-top: 2px solid var(--primary); padding-top: 10px; }
        .footer-left { flex: 2; font-size: 12px; display: flex; flex-direction: column; gap: 15px; }
        .footer-right { flex: 1; font-size: 13px; }
        
        .bank-details { background: #f8fafc; padding: 10px; border-radius: 4px; border: 1px solid var(--border); }
        .amount-words { font-style: italic; font-weight: 600; margin-bottom: 10px; }
        
        .total-row { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #f1f5f9; }
        .grand-total { font-size: 16px; font-weight: 800; border-top: 2px solid var(--primary); padding-top: 10px; margin-top: 5px; }

        .auth-sign { margin-top: 40px; text-align: right; font-size: 12px; }
        .sign-line { display: inline-block; width: 150px; border-top: 1px solid black; margin-top: 40px; }

        /* INPUT STYLES FOR PRINT */
        input[type="date"]::-webkit-calendar-picker-indicator { display: none; }
        
        /* UTILS */
        .add-btn { width: 100%; padding: 8px; background: #f1f5f9; border: 1px dashed #94a3b8; color: #64748b; cursor: pointer; font-size: 12px; margin-bottom: 10px; }
        .add-btn:hover { background: #e2e8f0; }
        .del-row { color: #ef4444; cursor: pointer; font-weight: bold; font-size: 14px; }

        /* --- PRINT MEDIA QUERY (THE MAGIC) --- */
        @media print {
            body { background: white; padding: 0; }
            .toolbar, .add-btn, .del-row, .no-print { display: none !important; }
            .invoice-box { box-shadow: none; border: none; margin: 0; width: 100%; height: auto; }
            input, select, textarea { border: none !important; background: transparent !important; appearance: none; -webkit-appearance: none; }
            /* Hide placeholder in print */
            ::placeholder { color: transparent; }
            /* Expand Textareas */
            textarea { resize: none; overflow: hidden; min-height: 50px; }
        }
    </style>
</head>
<body>

    <div class="toolbar">
        <button class="btn btn-back" onclick="window.location='index.html'">‚Üê Dashboard</button>
        <div style="font-weight:700; font-size:18px;">New Sale Entry</div>
        <button class="btn btn-save" onclick="saveInvoice()">üíæ Save & Print (Alt+S)</button>
    </div>

    <div class="invoice-box" id="printArea">
        
        <div class="header">
            <div class="company-info">
                <h1 id="cmpName">YOUR COMPANY NAME</h1>
                <p id="cmpAddr">Address Line 1, City, State - Zip</p>
                <p>GSTIN: <span id="cmpGST">Not Set</span> | Contact: <span id="cmpPhone">Not Set</span></p>
            </div>
            <div class="invoice-title">
                <h2>Tax Invoice</h2>
                <div class="meta-grid">
                    <span class="meta-label">Invoice No:</span>
                    <span class="meta-val"><input type="text" id="invNo" readonly></span>
                    
                    <span class="meta-label">Date:</span>
                    <span class="meta-val"><input type="date" id="invDate"></span>
                    
                    <span class="meta-label">State Code:</span>
                    <span class="meta-val"><input type="text" value="08 (RJ)" style="width:50px"></span>
                </div>
            </div>
        </div>

        <div class="address-section">
            <div class="addr-box">
                <div class="addr-title">Billed To (Party Details)</div>
                <select id="partySelect" onchange="loadPartyDetails()" style="font-weight:700; margin-bottom:5px; width:100%;">
                    <option value="">-- Select Party --</option>
                </select>
                <textarea id="billAddr" class="addr-input" rows="3" placeholder="Billing Address..."></textarea>
                <input id="partyGst" class="addr-input" placeholder="Party GSTIN" style="margin-top:5px; font-weight:600;">
            </div>
            <div class="addr-box">
                <div class="addr-title">Shipped To <small style="font-weight:normal; float:right;"><input type="checkbox" onchange="copyAddr(this)"> Same</small></div>
                <textarea id="shipAddr" class="addr-input" rows="4" placeholder="Shipping Address (if different)..."></textarea>
            </div>
        </div>

        <table class="item-table">
            <thead>
                <tr>
                    <th width="5%">#</th>
                    <th width="35%">Item Description</th>
                    <th width="10%">HSN/SAC</th>
                    <th width="8%" class="text-right">Qty</th>
                    <th width="8%" class="text-right">Rate</th>
                    <th width="8%" class="text-right">Disc %</th>
                    <th width="8%" class="text-right">GST %</th>
                    <th width="15%" class="text-right">Total</th>
                    <th width="3%" class="no-print"></th>
                </tr>
            </thead>
            <tbody id="itemRows"></tbody>
        </table>
        
        <button class="add-btn" onclick="addItemRow()">+ Add Line Item</button>

        <div class="footer-section">
            <div class="footer-left">
                <div>
                    <div class="meta-label">Amount in Words:</div>
                    <div class="amount-words" id="amtWords">Zero Only</div>
                </div>
                
                <div class="bank-details">
                    <div class="meta-label" style="border-bottom:1px solid #e2e8f0; margin-bottom:5px;">Bank Details</div>
                    <div>Bank Name: <b id="bankName">HDFC Bank</b></div>
                    <div>A/c No: <b id="acNo">XXXXXXXXXX</b></div>
                    <div>IFSC Code: <b id="ifsc">HDFC0001234</b></div>
                </div>

                <div style="font-size:11px; color:#64748b;">
                    <b>Terms & Conditions:</b><br>
                    1. Goods once sold will not be taken back.<br>
                    2. Interest @18% p.a. will be charged if not paid within due date.<br>
                    3. Subject to local jurisdiction only.
                </div>
            </div>

            <div class="footer-right">
                <div class="total-row">
                    <span>Taxable Value</span>
                    <span id="taxableVal">0.00</span>
                </div>
                <div class="total-row">
                    <span>CGST Amount</span>
                    <span id="cgstVal">0.00</span>
                </div>
                <div class="total-row">
                    <span>SGST Amount</span>
                    <span id="sgstVal">0.00</span>
                </div>
                <div class="total-row">
                    <span>IGST Amount</span>
                    <span id="igstVal">0.00</span>
                </div>
                <div class="total-row">
                    <span>Round Off</span>
                    <span id="roundVal">0.00</span>
                </div>
                <div class="total-row grand-total">
                    <span>Grand Total</span>
                    <span id="grandVal">‚Çπ 0.00</span>
                </div>

                <div class="auth-sign">
                    <p>For, <b id="signComp">Company Name</b></p>
                    <span class="sign-line"></span>
                    <p>Authorized Signatory</p>
                </div>
            </div>
        </div>
    </div>

    <script src="db.js"></script>
    <script src="auth.js"></script>
    <script>
        let itemsList = [];
        let ledgersList = []; // Stores full ledger objects for lookup
        
        window.onload = async () => {
            await DB.init();
            
            // 1. Load Company Settings
            const set = await DB.getSettings();
            if(set) {
                document.getElementById('cmpName').innerText = set.name || "YOUR COMPANY";
                document.getElementById('signComp').innerText = set.name || "Company";
                document.getElementById('cmpAddr').innerText = set.address || "Address";
                document.getElementById('cmpGST').innerText = set.gstin || "-";
                document.getElementById('cmpPhone').innerText = set.phone || "-";
            }

            // 2. Load Parties & Items
            await loadParties();
            itemsList = await DB.getItems();
            
            // 3. Init Invoice
            document.getElementById('invDate').valueAsDate = new Date();
            generateInvNo();
            addItemRow();
        };

        async function loadParties() {
            const ledgers = await DB.getAll('ledgers');
            const groups = await DB.getAll('groups');
            ledgersList = ledgers; // Save globally for auto-fill

            // Filter Debtors & Cash
            const debtorId = groups.find(g=>g.name==='Sundry Debtors')?.id;
            const cashId = groups.find(g=>g.name==='Cash-in-Hand')?.id;
            
            const sel = document.getElementById('partySelect');
            sel.innerHTML = '<option value="">-- Select Party --</option>';

            ledgers.filter(l => l.group_id === debtorId || l.group_id === cashId)
                   .sort((a,b) => a.name.localeCompare(b.name))
                   .forEach(l => {
                       const opt = document.createElement('option');
                       opt.value = l.id;
                       opt.text = l.name;
                       sel.appendChild(opt);
                   });
        }

        function loadPartyDetails() {
            const partyId = document.getElementById('partySelect').value;
            
            // Reset fields
            document.getElementById('billAddr').value = "";
            document.getElementById('partyGst').value = "";

            if(!partyId) return;

            // Find party in memory
            const party = ledgersList.find(l => l.id == partyId);
            
            if(party) {
                // Auto-fill Address & GST
                let fullAddr = party.address || "";
                if(party.phone) fullAddr += `\n(Contact: ${party.phone})`;
                
                document.getElementById('billAddr').value = fullAddr;
                document.getElementById('partyGst').value = party.gstin || "";
            }
        }

        function copyAddr(chk) {
            if(chk.checked) document.getElementById('shipAddr').value = document.getElementById('billAddr').value;
            else document.getElementById('shipAddr').value = "";
        }

        function generateInvNo() {
            const rnd = Math.floor(Math.random() * 9000) + 1000;
            document.getElementById('invNo').value = `INV-${new Date().getFullYear()}-${rnd}`;
        }

        function addItemRow() {
            const tbody = document.getElementById('itemRows');
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="text-center">${tbody.children.length + 1}</td>
                <td>
                    <select onchange="fillItem(this)" style="font-weight:600;">
                        <option value="">Select Item</option>
                        ${itemsList.map(i => `<option value="${i.id}" data-rate="${i.std_price||0}" data-gst="${i.gst_rate||18}" data-hsn="8544">${i.name}</option>`).join('')}
                    </select>
                </td>
                <td><input class="text-center" value="8544" placeholder="HSN"></td>
                <td><input type="number" class="qty text-right" value="1" onchange="calc(this)"></td>
                <td><input type="number" class="rate text-right" value="0" onchange="calc(this)"></td>
                <td><input type="number" class="disc text-right" value="0" onchange="calc(this)"></td>
                <td><input type="number" class="gst text-right" value="18" onchange="calc(this)"></td>
                <td class="text-right font-bold amt">0.00</td>
                <td class="no-print text-center"><span class="del-row" onclick="this.closest('tr').remove(); total();">√ó</span></td>
            `;
            tbody.appendChild(tr);
        }

        function fillItem(sel) {
            const opt = sel.options[sel.selectedIndex];
            const tr = sel.closest('tr');
            tr.querySelector('.rate').value = opt.dataset.rate;
            tr.querySelector('.gst').value = opt.dataset.gst;
            calc(sel);
        }

        function calc(el) {
            const tr = el.closest('tr');
            const qty = parseFloat(tr.querySelector('.qty').value) || 0;
            const rate = parseFloat(tr.querySelector('.rate').value) || 0;
            const disc = parseFloat(tr.querySelector('.disc').value) || 0;
            const gst = parseFloat(tr.querySelector('.gst').value) || 0;

            const base = qty * rate;
            const discAmt = base * (disc/100);
            const taxable = base - discAmt;
            const taxAmt = taxable * (gst/100);
            const total = taxable + taxAmt;

            tr.querySelector('.amt').innerText = total.toFixed(2);
            tr.dataset.taxable = taxable;
            tr.dataset.tax = taxAmt;
            total();
        }

        function total() {
            let taxVal = 0, taxAmt = 0;
            document.querySelectorAll('#itemRows tr').forEach(tr => {
                taxVal += parseFloat(tr.dataset.taxable || 0);
                taxAmt += parseFloat(tr.dataset.tax || 0);
            });

            const grand = taxVal + taxAmt;
            const round = Math.round(grand) - grand;

            document.getElementById('taxableVal').innerText = taxVal.toFixed(2);
            
            // Assume Intra-State for now (CGST+SGST)
            // Logic: In future we can compare Party State vs Company State
            document.getElementById('cgstVal').innerText = (taxAmt/2).toFixed(2);
            document.getElementById('sgstVal').innerText = (taxAmt/2).toFixed(2);
            document.getElementById('igstVal').innerText = "0.00";

            document.getElementById('roundVal').innerText = round.toFixed(2);
            document.getElementById('grandVal').innerText = "‚Çπ " + Math.round(grand).toFixed(2);

            document.getElementById('amtWords').innerText = numToWords(Math.round(grand)) + " Only";
        }

        async function saveInvoice() {
            const partyId = document.getElementById('partySelect').value;
            if(!partyId) return alert("Please select a Party (Customer)");
            
            // Prepare Data for DB
            let totalAmt = 0;
            let taxableTotal = 0;
            let taxTotal = 0;
            let invEntries = [];
            
            document.querySelectorAll('#itemRows tr').forEach(tr => {
                const itemId = tr.querySelector('select').value;
                if(itemId) {
                    const qty = parseFloat(tr.querySelector('.qty').value);
                    const rate = parseFloat(tr.querySelector('.rate').value);
                    if(qty>0) {
                        invEntries.push({ item_id: parseInt(itemId), qty, rate });
                        totalAmt += (parseFloat(tr.querySelector('.amt').innerText));
                        taxableTotal += parseFloat(tr.dataset.taxable || 0);
                        taxTotal += parseFloat(tr.dataset.tax || 0);
                    }
                }
            });

            if(invEntries.length === 0) return alert("Add at least one item");

            // Voucher Header
            const vData = {
                voucher_no: document.getElementById('invNo').value,
                date: document.getElementById('invDate').value,
                party_id: parseInt(partyId),
                amount: Math.round(totalAmt),
                type: 'Sales',
                narration: "Sales Invoice Generated"
            };

            // FULL ACCOUNTING ENTRIES (Double Entry System)
            const acctEntries = [];

            // 1. DEBIT: Party (Debtor) - Full Amount
            acctEntries.push({
                ledger_id: parseInt(partyId),
                debit: Math.round(totalAmt),
                credit: 0
            });

            // 2. CREDIT: Sales Account - Taxable Amount
            // Look for 'Local Sales' ledger id
            const salesLedger = ledgersList.find(l => l.name === 'Local Sales');
            if(salesLedger) {
                acctEntries.push({
                    ledger_id: salesLedger.id,
                    debit: 0,
                    credit: taxableTotal
                });
            }

            // 3. CREDIT: Output Tax (Liability)
            // Look for CGST/SGST ledgers
            const cgstLedger = ledgersList.find(l => l.name === 'Output CGST');
            const sgstLedger = ledgersList.find(l => l.name === 'Output SGST');

            if(cgstLedger) acctEntries.push({ ledger_id: cgstLedger.id, debit: 0, credit: taxTotal/2 });
            if(sgstLedger) acctEntries.push({ ledger_id: sgstLedger.id, debit: 0, credit: taxTotal/2 });

            try {
                await DB.saveVoucher(vData, invEntries, acctEntries);
                alert("Saved! Printing...");
                window.print();
                setTimeout(() => location.reload(), 1000);
            } catch(e) { alert("Error: " + e); }
        }

        // --- UTILS ---
        function numToWords(n) {
            const a = ['','One ','Two ','Three ','Four ', 'Five ','Six ','Seven ','Eight ','Nine ','Ten ','Eleven ','Twelve ','Thirteen ','Fourteen ','Fifteen ','Sixteen ','Seventeen ','Eighteen ','Nineteen '];
            const b = ['', '', 'Twenty','Thirty','Forty','Fifty', 'Sixty','Seventy','Eighty','Ninety'];
            if ((n = n.toString()).length > 9) return 'Overflow';
            n = ('000000000' + n).substr(-9).match(/^(\d{2})(\d{2})(\d{2})(\d{1})(\d{2})$/);
            if (!n) return; var str = '';
            str += (n[1] != 0) ? (a[Number(n[1])] || b[n[1][0]] + ' ' + a[n[1][1]]) + 'Crore ' : '';
            str += (n[2] != 0) ? (a[Number(n[2])] || b[n[2][0]] + ' ' + a[n[2][1]]) + 'Lakh ' : '';
            str += (n[3] != 0) ? (a[Number(n[3])] || b[n[3][0]] + ' ' + a[n[3][1]]) + 'Thousand ' : '';
            str += (n[4] != 0) ? (a[Number(n[4])] || b[n[4][0]] + ' ' + a[n[4][1]]) + 'Hundred ' : '';
            str += (n[5] != 0) ? ((str != '') ? 'and ' : '') + (a[Number(n[5])] || b[n[5][0]] + ' ' + a[n[5][1]]) : '';
            return str || 'Zero';
        }
    </script>
</body>
</html>