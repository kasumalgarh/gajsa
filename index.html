<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Money Wise Pro - Executive Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --sidebar-bg: #0f172a; --sidebar-text: #94a3b8; --active-text: #f8fafc;
            --bg: #f8fafc; --card-bg: #ffffff;
            --accent: #6366f1; --green: #10b981; --red: #ef4444; --orange: #f59e0b;
            --text: #1e293b; --border: #e2e8f0; --muted: #64748b;
        }
        * { box-sizing: border-box; font-family: 'Inter', sans-serif; margin: 0; padding: 0; }
        body { display: flex; height: 100vh; background: var(--bg); color: var(--text); overflow: hidden; }
        /* SIDEBAR */
        .sidebar { width: 260px; background: var(--sidebar-bg); padding: 20px; display: flex; flex-direction: column; flex-shrink: 0; }
        .brand { font-size: 20px; font-weight: 800; color: #fff; margin-bottom: 40px; display: flex; align-items: center; gap: 10px; }
        .nav-link { padding: 12px 15px; margin-bottom: 5px; border-radius: 8px; color: var(--sidebar-text); text-decoration: none; font-weight: 500; display: flex; align-items: center; gap: 12px; transition: 0.2s; font-size: 14px; }
        .nav-link:hover, .nav-link.active { background: #1e293b; color: var(--active-text); }
        .nav-icon { font-size: 18px; }
        /* MAIN CONTENT */
        .main { flex: 1; overflow-y: auto; padding: 30px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .page-title { font-size: 24px; font-weight: 800; color: #0f172a; letter-spacing: -0.5px; }
        .date-badge { font-size: 13px; color: var(--muted); font-weight: 500; margin-top: 4px; }
       
        .refresh-btn { background: #fff; border: 1px solid #cbd5e1; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600; color: #475569; display: flex; align-items: center; gap: 8px; transition: 0.2s; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .refresh-btn:hover:not(:disabled) { background: #f8fafc; border-color: var(--accent); color: var(--accent); }
        .refresh-btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .spin { animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        /* METRICS GRID */
        .metrics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: var(--card-bg); padding: 24px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid var(--border); display: flex; flex-direction: column; transition: transform 0.2s; }
        .card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .card-head { font-size: 12px; font-weight: 600; text-transform: uppercase; color: var(--muted); margin-bottom: 8px; display: flex; justify-content: space-between; }
        .card-val { font-size: 26px; font-weight: 700; color: #0f172a; margin-bottom: 4px; letter-spacing: -0.5px; }
        .card-sub { font-size: 13px; font-weight: 500; display: flex; align-items: center; gap: 6px; color: var(--muted); }
       
        .trend-badge { padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; }
        .bg-green { background: #dcfce7; color: #166534; }
        .bg-red { background: #fee2e2; color: #991b1b; }
        .bg-orange { background: #ffedd5; color: #9a3412; }
        .bg-blue { background: #dbeafe; color: #1e40af; }
        /* PANELS */
        .split-view { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 30px; }
        .panel { background: #fff; border-radius: 12px; padding: 20px; border: 1px solid var(--border); box-shadow: 0 1px 3px rgba(0,0,0,0.05); height: 100%; display: flex; flex-direction: column; position: relative; }
        .panel-head { font-weight: 700; font-size: 15px; margin-bottom: 20px; color: #0f172a; display: flex; justify-content: space-between; align-items: center; }
        /* LISTS */
        .table-wrap { flex: 1; overflow-y: auto; }
        .row-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #f1f5f9; font-size: 13px; }
        .row-item:last-child { border-bottom: none; }
        .party-name { font-weight: 600; color: #334155; }
        .txn-meta { font-size: 11px; color: #94a3b8; margin-top: 2px; }
        .amt-pos { color: var(--green); font-weight: 700; }
        .amt-neg { color: var(--red); font-weight: 700; }
       
        /* ALERTS */
        .alert-item { display: flex; align-items: center; justify-content: space-between; padding: 12px; background: #fff1f2; border-radius: 8px; margin-bottom: 8px; border-left: 4px solid var(--red); cursor: pointer; transition: 0.2s; }
        .alert-item:hover { background: #ffe4e6; }
        .alert-item.warning { background: #fff7ed; border-left-color: var(--orange); }
        .alert-text { font-size: 13px; font-weight: 600; }
        .alert-sub { font-size: 11px; color: var(--muted); }
        /* EMPTY STATES */
        .empty-state { text-align: center; padding: 40px 20px; color: var(--muted); font-size: 13px; }
        .empty-icon { font-size: 24px; margin-bottom: 10px; display: block; opacity: 0.5; }
        .no-data-overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: var(--muted); font-size: 14px; text-align: center; background: rgba(255,255,255,0.9); padding: 12px 20px; border-radius: 8px; z-index: 10; }
        /* FAB */
        .fab-group { position: fixed; bottom: 30px; right: 30px; display: flex; gap: 12px; z-index: 100; }
        .fab { width: 52px; height: 52px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #fff; font-size: 24px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); cursor: pointer; text-decoration: none; transition: all 0.2s; }
        .fab:hover { transform: translateY(-4px); box-shadow: 0 6px 16px rgba(0,0,0,0.25); }
        .f-sale { background: var(--accent); }
        .f-pur { background: var(--green); }
        @media(max-width: 1024px) { .metrics-grid { grid-template-columns: repeat(2, 1fr); } .split-view { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
   <div class="sidebar">
        <div class="brand">üöÄ MoneyWise Pro</div>
        <a href="index.html" class="nav-link active"><span class="nav-icon">üìä</span> Dashboard</a>
        <a href="reports.html" class="nav-link"><span class="nav-icon">üìà</span> Reports</a>
        <a href="gst_filing.html" class="nav-link"><span class="nav-icon">üèõÔ∏è</span> GST Filing</a>
        <a href="sales_invoice.html" class="nav-link"><span class="nav-icon">üßæ</span> Sales Invoice</a>
        <a href="purchase_invoice.html" class="nav-link"><span class="nav-icon">üöö</span> Purchase Entry</a>
        <a href="vouchers.html" class="nav-link"><span class="nav-icon">üí∏</span> Vouchers (JV)</a>
        <a href="item_master.html" class="nav-link"><span class="nav-icon">üì¶</span> Inventory</a>
        <a href="moneywise.html" class="nav-link"><span class="nav-icon">üë•</span> Parties / Ledgers</a>
        <a href="coa.html" class="nav-link"><span class="nav-icon">üóÇÔ∏è</span> Chart of Accounts</a>
        <a href="settings.html" class="nav-link"><span class="nav-icon">‚öôÔ∏è</span> Settings</a>
    </div>
    <div class="main">
        <div class="header">
            <div>
                <div class="page-title">Executive Overview</div>
                <div class="date-badge" id="todayDate">...</div>
            </div>
            <button class="refresh-btn" id="refreshBtn" onclick="refreshDashboard()">
                <span id="spinIcon">üîÑ</span> <span id="refreshText">Refresh Data</span>
            </button>
        </div>
        <div class="metrics-grid">
            <div class="card">
                <div class="card-head">
                    <span>Gross Profit</span>
                    <span class="trend-badge bg-green">Performance</span>
                </div>
                <div class="card-val" id="grossProfit">‚Çπ 0</div>
                <div class="card-sub">Sales - COGS</div>
            </div>
            <div class="card">
                <div class="card-head">
                    <span>Cash In Hand</span>
                    <span class="trend-badge bg-blue">Liquid</span>
                </div>
                <div class="card-val" id="cashBal">‚Çπ 0</div>
                <div class="card-sub" id="cashStatus">Drawer Balance</div>
            </div>
            <div class="card">
                <div class="card-head">
                    <span>Receivables</span>
                    <span class="trend-badge bg-orange">Asset</span>
                </div>
                <div class="card-val" id="receivables">‚Çπ 0</div>
                <div class="card-sub" id="debtorsCount">0 Pending</div>
            </div>
            <div class="card">
                <div class="card-head">
                    <span>Payables</span>
                    <span class="trend-badge bg-red">Liability</span>
                </div>
                <div class="card-val" id="payables">‚Çπ 0</div>
                <div class="card-sub">Due to Suppliers</div>
            </div>
            <div class="card">
                <div class="card-head">
                    <span>Net GST</span>
                    <span class="trend-badge bg-blue">Tax</span>
                </div>
                <div class="card-val" id="gstNet">‚Çπ 0</div>
                <div class="card-sub" id="gstStatus">...</div>
            </div>
        </div>
        <div class="split-view">
            <div class="panel">
                <div class="panel-head">
                    <span>Sales Performance</span>
                    <span style="font-size:12px; font-weight:500; color:var(--muted);">Last 6 Months</span>
                </div>
                <div style="position: relative; height: 300px; width:100%" id="salesChartWrapper">
                    <canvas id="salesChart"></canvas>
                </div>
            </div>
            <div class="panel">
                <div class="panel-head">GST Composition</div>
                <div id="gstChartContainer" style="position: relative; height: 200px; display:flex; justify-content:center;">
                    <canvas id="gstChart"></canvas>
                </div>
                <div id="gstLegend" style="margin-top:20px; font-size:13px;">
                    <div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid #f1f5f9;">
                        <span style="color:var(--muted)">Input Credit (Asset):</span>
                        <span style="font-weight:700; color:var(--green);" id="inTax">‚Çπ 0</span>
                    </div>
                    <div style="display:flex; justify-content:space-between; padding:8px 0;">
                        <span style="color:var(--muted)">Output Liability (Pay):</span>
                        <span style="font-weight:700; color:var(--red);" id="outTax">‚Çπ 0</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="split-view">
            <div class="panel" style="height:400px;">
                <div class="panel-head">
                    <span>Recent Transactions</span>
                    <a href="sales_invoice.html" style="font-size:12px; color:var(--accent); text-decoration:none;">+ New Invoice</a>
                </div>
                <div class="table-wrap" id="recentTxn">
                    <div class="empty-state" style="padding:20px;">Loading...</div>
                </div>
            </div>
            <div class="panel" style="height:400px;">
                <div class="panel-head">
                    <span>‚ö†Ô∏è Action Needed</span>
                </div>
                <div class="table-wrap" id="alertsList">
                    <div class="empty-state" style="padding:20px;">
                        <span class="empty-icon">‚ú®</span>
                        All systems operational.
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="fab-group">
        <a href="sales_invoice.html" class="fab f-sale" title="New Sale">Ôºã</a>
        <a href="purchase_invoice.html" class="fab f-pur" title="Purchase">üöö</a>
    </div>

    <script src="db.js"></script><script src="auth.js"></script>
    <script>
        document.getElementById('todayDate').innerText = new Date().toLocaleDateString('en-IN', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

        window.onload = async () => {
            try { await DB.init(); runAnalytics(); }
            catch(e) { console.error(e); }
        };

        async function refreshDashboard() {
            const btn = document.getElementById('refreshBtn');
            const spin = document.getElementById('spinIcon');
            const txt = document.getElementById('refreshText');
            btn.disabled = true;
            spin.classList.add('spin');
            txt.innerText = 'Refreshing...';

            await runAnalytics();

            setTimeout(() => {
                spin.classList.remove('spin');
                txt.innerText = 'Refresh Data';
                btn.disabled = false;
            }, 800);
        }

        async function runAnalytics() {
            const tx = DB.db.transaction(['vouchers', 'items', 'ledgers', 'acct_entries', 'groups'], 'readonly');
            const [vouchers, items, ledgers, entries, groups] = await Promise.all([
                getAll(tx.objectStore('vouchers')),
                getAll(tx.objectStore('items')),
                getAll(tx.objectStore('ledgers')),
                getAll(tx.objectStore('acct_entries')),
                getAll(tx.objectStore('groups'))
            ]);

            // Data Prep
            const ledgerMap = {}; ledgers.forEach(l => ledgerMap[l.id] = l);
            const balances = {};
            entries.forEach(e => {
                balances[e.ledger_id] = (balances[e.ledger_id] || 0) + (e.debit || 0) - (e.credit || 0);
            });

            // Financial Metrics
            let totalSales = 0, totalPur = 0;
            vouchers.forEach(v => {
                if (v.type === 'Sales') totalSales += v.amount || 0;
                if (v.type === 'Purchase') totalPur += v.amount || 0;
            });

            // Real COGS & Gross Profit
            let openingStockVal = items.reduce((sum, i) => sum + (parseFloat(i.op_value) || (parseFloat(i.op_qty || 0) * parseFloat(i.std_cost || 0))), 0);
            let closingStockVal = items.reduce((sum, i) => sum + ((i.current_stock || 0) * (i.std_cost || 0)), 0);
            let cogs = openingStockVal + totalPur - closingStockVal;
            let profit = totalSales - cogs;
            const pEl = document.getElementById('grossProfit');
            pEl.innerText = fmt(profit);
            pEl.style.color = profit >= 0 ? 'var(--green)' : 'var(--red)';

            // Cash
            const cashGrpId = groups.find(g => g.name === "Cash-in-Hand")?.id;
            let cashTotal = 0;
            ledgers.filter(l => l.group_id === cashGrpId).forEach(l => {
                cashTotal += (l.opening_balance || 0) + (balances[l.id] || 0);
            });
            const cEl = document.getElementById('cashBal');
            cEl.innerText = fmt(cashTotal);
            if (cashTotal < 0) {
                cEl.style.color = 'var(--red)';
                document.getElementById('cashStatus').innerText = "‚ö†Ô∏è Negative Balance!";
            } else {
                document.getElementById('cashStatus').innerText = "Drawer Balance";
            }

            // Receivables
            const debtGrpId = groups.find(g => g.name === "Sundry Debtors")?.id;
            let receivables = 0, debtCount = 0;
            ledgers.filter(l => l.group_id === debtGrpId).forEach(l => {
                let bal = (l.opening_balance || 0) + (balances[l.id] || 0);
                if (bal > 0) { receivables += bal; debtCount++; }
            });
            document.getElementById('receivables').innerText = fmt(receivables);
            document.getElementById('debtorsCount').innerText = `${debtCount} Customers`;

            // Payables
            const credGrpId = groups.find(g => g.name === "Sundry Creditors")?.id;
            let payables = 0;
            ledgers.filter(l => l.group_id === credGrpId).forEach(l => {
                let bal = (l.opening_balance || 0) + (balances[l.id] || 0);
                if (bal < 0) payables += Math.abs(bal);
            });
            document.getElementById('payables').innerText = fmt(payables);

            // GST Net
            const taxGrpId = groups.find(g => g.name === "Duties & Taxes")?.id;
            let inTax = 0, outTax = 0;
            if (taxGrpId) {
                ledgers.filter(l => l.group_id === taxGrpId).forEach(l => {
                    let bal = (l.opening_balance || 0) + (balances[l.id] || 0);
                    if (bal > 0) inTax += bal;
                    else outTax += Math.abs(bal);
                });
            }
            let totalTaxVol = inTax + outTax;
            let inPct = totalTaxVol > 0 ? Math.round((inTax / totalTaxVol) * 100) : 0;
            let outPct = totalTaxVol > 0 ? Math.round((outTax / totalTaxVol) * 100) : 0;
            document.getElementById('inTax').innerText = `${fmt(inTax)} (${inPct}%)`;
            document.getElementById('outTax').innerText = `${fmt(outTax)} (${outPct}%)`;

            let netGst = outTax - inTax;
            const gstEl = document.getElementById('gstNet');
            const gstSt = document.getElementById('gstStatus');
            if (netGst > 0) {
                gstEl.innerText = fmt(netGst);
                gstEl.style.color = 'var(--red)';
                gstSt.innerText = "Liability (To Pay)";
            } else {
                gstEl.innerText = fmt(Math.abs(netGst));
                gstEl.style.color = 'var(--green)';
                gstSt.innerText = "Credit Available";
            }

            // Alerts
            let alerts = [];
            if (cashTotal < 0) alerts.push({ title: "Negative Cash", sub: "Check entries immediately", type: "critical" });
            const lowStock = items.filter(i => (i.current_stock || 0) <= (i.reorder_level || 5));
            lowStock.forEach(i => alerts.push({ title: "Low Stock: " + i.name, sub: `Only ${i.current_stock} left`, type: "warning" }));
            if (totalSales > 0 && receivables > (totalSales * 0.5)) {
                alerts.push({ title: "High Receivables", sub: "More than 50% sales on credit", type: "warning" });
            }
            const alertDiv = document.getElementById('alertsList');
            if (alerts.length > 0) {
                alertDiv.innerHTML = alerts.map(a => `
                    <div class="alert-item ${a.type === 'warning' ? 'warning' : ''}" onclick="${a.title.includes('Stock') ? 'location.href=\'item_master.html\'' : ''}">
                        <div>
                            <div class="alert-text" style="color:${a.type === 'critical' ? '#9f1239' : '#9a3412'}">${a.title}</div>
                            <div class="alert-sub">${a.sub}</div>
                        </div>
                        <span style="font-size:18px;">${a.type === 'critical' ? 'üõë' : '‚ö†Ô∏è'}</span>
                    </div>
                `).join('');
            } else {
                alertDiv.innerHTML = '<div class="empty-state"><span class="empty-icon">‚ú®</span>All systems healthy.</div>';
            }

            // Recent Transactions
            if (vouchers.length > 0) {
                const recent = vouchers.sort((a,b) => b.id - a.id).slice(0, 10);
                document.getElementById('recentTxn').innerHTML = recent.map(v => {
                    const pName = ledgerMap[v.party_id]?.name || "Cash / Unknown";
                    const isSale = v.type === 'Sales';
                    return `
                        <div class="row-item">
                            <div>
                                <div class="party-name">${pName}</div>
                                <div class="txn-meta">${v.voucher_no} ‚Ä¢ ${v.date}</div>
                            </div>
                            <div class="${isSale ? 'amt-pos' : 'amt-neg'}">
                                ${isSale ? '+' : '-'} ${fmt(v.amount)}
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                document.getElementById('recentTxn').innerHTML = '<div class="empty-state">No transactions recorded yet.</div>';
            }

            // Charts
            renderCharts(vouchers, inTax, outTax);
        }

        function renderCharts(vouchers, inTax, outTax) {
            // Sales Chart
            const months = [];
            const dataMap = {};
            const today = new Date();
            for (let i = 5; i >= 0; i--) {
                const d = new Date(today.getFullYear(), today.getMonth() - i, 1);
                const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                months.push(d.toLocaleString('default', { month: 'short', year: '2-digit' }));
                dataMap[key] = 0;
            }
            vouchers.forEach(v => {
                if (v.type === 'Sales') {
                    const vDate = new Date(v.date);
                    const key = `${vDate.getFullYear()}-${String(vDate.getMonth() + 1).padStart(2, '0')}`;
                    if (dataMap[key] !== undefined) dataMap[key] += v.amount || 0;
                }
            });
            const chartData = [];
            for (let i = 5; i >= 0; i--) {
                const d = new Date(today.getFullYear(), today.getMonth() - i, 1);
                const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                chartData.push(dataMap[key]);
            }

            const chartWrap = document.getElementById('salesChartWrapper');
            const oldOv = chartWrap.querySelector('.no-data-overlay');
            if (oldOv) oldOv.remove();
            if (chartData.every(v => v === 0)) {
                const overlay = document.createElement('div');
                overlay.className = 'no-data-overlay';
                overlay.innerHTML = '<span class="empty-icon">üìâ</span>No sales data in last 6 months';
                chartWrap.appendChild(overlay);
            }

            if (window.salesChartInstance) window.salesChartInstance.destroy();
            const ctx1 = document.getElementById('salesChart').getContext('2d');
            window.salesChartInstance = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [{
                        label: 'Revenue',
                        data: chartData,
                        borderColor: '#6366f1',
                        backgroundColor: (context) => {
                            const ctx = context.chart.ctx;
                            const gradient = ctx.createLinearGradient(0, 0, 0, 300);
                            gradient.addColorStop(0, 'rgba(99, 102, 241, 0.3)');
                            gradient.addColorStop(1, 'rgba(99, 102, 241, 0.0)');
                            return gradient;
                        },
                        fill: true,
                        tension: 0.4,
                        borderWidth: 2,
                        pointRadius: 4,
                        pointBackgroundColor: '#fff',
                        pointBorderColor: '#6366f1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => `‚Çπ ${ctx.parsed.y.toLocaleString('en-IN')}`
                            }
                        }
                    },
                    scales: {
                        y: { beginAtZero: true, grid: { borderDash: [4, 4], color: '#f1f5f9' } },
                        x: { grid: { display: false } }
                    }
                }
            });

            // GST Chart
            const gstContainer = document.getElementById('gstChartContainer');
            if (inTax === 0 && outTax === 0) {
                gstContainer.innerHTML = '<div class="empty-state" style="padding-top:80px">No Tax Data Available</div>';
            } else {
                if (window.gstChartInstance) window.gstChartInstance.destroy();
                if (!document.getElementById('gstChart')) gstContainer.innerHTML = '<canvas id="gstChart"></canvas>';
                window.gstChartInstance = new Chart(document.getElementById('gstChart'), {
                    type: 'doughnut',
                    data: {
                        labels: ['Input (Asset)', 'Output (Liab)'],
                        datasets: [{ data: [inTax, outTax], backgroundColor: ['#10b981', '#ef4444'], borderWidth: 0 }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '75%',
                        plugins: { legend: { display: false } }
                    }
                });
            }
        }

        function getAll(store) {
            return new Promise(resolve => {
                const req = store.getAll();
                req.onsuccess = () => resolve(req.result);
            });
        }

        function fmt(num) {
            return "‚Çπ " + (num || 0).toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }
    </script>
</body>
</html>