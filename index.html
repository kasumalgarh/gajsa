<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arth Book - Executive Dashboard</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="stylesheet" href="style.css"> 
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="manifest" href="manifest.json">
</head>
<body>

    <div id="loginOverlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #002171; z-index: 9999; display: flex; align-items: center; justify-content: center; color: white;">
        <div class="card" style="width: 350px; text-align: center; border-top: 5px solid var(--accent-color);">
            <div style="font-size: 50px; margin-bottom: 10px;">üõ°Ô∏è</div>
            <h2 style="color: var(--primary-color);">Arth Book</h2>
            <p style="color: #666; font-size: 12px; margin-bottom: 20px;">Secure Business Operating System</p>
            <form onsubmit="handleLogin(event)">
                <div class="form-group">
                    <input type="text" id="username" placeholder="Username (admin)" required>
                </div>
                <div class="form-group">
                    <input type="password" id="password" placeholder="Password" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Unlock Device</button>
            </form>
            <div style="margin-top: 15px; font-size: 10px; color: #999;">
                Device ID: <span id="displayMachineID">Checking...</span>
            </div>
        </div>
    </div>

    <header>
        <div class="brand-logo">
            <span class="menu-toggle" onclick="toggleSidebar()"><i class="fas fa-bars"></i></span>
            <span><i class="fas fa-book"></i> Arth Book</span>
        </div>
        <div class="user-menu">
            <span id="todayDate" style="font-size: 0.8rem; margin-right: 10px;">...</span>
            <button class="btn btn-warning" onclick="logout()" style="padding: 5px 10px; font-size: 0.8rem;">
                <i class="fas fa-power-off"></i>
            </button>
        </div>
    </header>

    <div class="sidebar" id="sidebar">
        <ul class="nav-links">
            <li><a href="index.html" class="active"><i class="fas fa-chart-pie"></i> Dashboard</a></li>
            <li><a href="sales_invoice.html"><i class="fas fa-file-invoice"></i> Sales Invoice</a></li>
            <li><a href="purchase_invoice.html"><i class="fas fa-truck"></i> Purchase Entry</a></li>
            <li><a href="vouchers.html"><i class="fas fa-receipt"></i> Vouchers (JV)</a></li>
            <li><a href="item_master.html"><i class="fas fa-boxes"></i> Inventory & Stock</a></li>
            <li><a href="moneywise.html"><i class="fas fa-users"></i> Parties (Ledgers)</a></li>
            <li><a href="reports.html"><i class="fas fa-chart-line"></i> Smart Reports</a></li>
            <hr style="margin: 10px 0; border: 0; border-top: 1px solid #ddd;">
            <li><a href="gst_filing.html"><i class="fas fa-university"></i> GST Filing</a></li>
            <li><a href="taxation.html"><i class="fas fa-calculator"></i> Global Tax / ITR</a></li>
            <li><a href="settings.html"><i class="fas fa-cogs"></i> Settings</a></li>
        </ul>
    </div>

    <main>
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 style="color: var(--primary-color);">Executive Overview</h2>
            <button class="btn btn-primary" id="refreshBtn" onclick="refreshDashboard()">
                <i class="fas fa-sync-alt" id="spinIcon"></i> Refresh
            </button>
        </div>

        <div class="card" style="margin-bottom: 20px; padding: 15px;">
            <div style="display: flex; gap: 10px;">
                <input type="text" id="univSearch" placeholder="üîç Search Bill No, Party Name, or Amount..." onkeyup="if(event.key==='Enter') searchVouchers()">
                <button class="btn btn-primary" onclick="searchVouchers()">Find</button>
            </div>
            <div class="table-container" id="searchTable" style="display: none; margin-top: 15px;">
                <table>
                    <thead><tr><th>Date</th><th>Type</th><th>Voucher #</th><th>Amount</th><th>Action</th></tr></thead>
                    <tbody id="searchBody"></tbody>
                </table>
            </div>
            <div id="noResult" style="display:none; padding:10px; text-align:center; color:#666;">No records found.</div>
        </div>

        <div class="dashboard-grid">
            <div class="card green-edge">
                <h3>Gross Profit</h3>
                <div class="value" id="grossProfit">‚Çπ 0</div>
                <div style="font-size: 0.8rem; color: #666;">Sales - Cost of Goods</div>
            </div>
            
            <div class="card gold-edge">
                <h3>Cash In Hand</h3>
                <div class="value" id="cashBal">‚Çπ 0</div>
                <div style="font-size: 0.8rem; color: #666;" id="cashStatus">Drawer Balance</div>
            </div>

            <div class="card blue-edge">
                <h3>Receivables (Lena)</h3>
                <div class="value" id="receivables">‚Çπ 0</div>
                <div style="font-size: 0.8rem; color: #666;" id="debtorsCount">0 Customers Pending</div>
            </div>

            <div class="card red-edge">
                <h3>Payables (Dena)</h3>
                <div class="value" id="payables">‚Çπ 0</div>
                <div style="font-size: 0.8rem; color: #666;">Due to Suppliers</div>
            </div>
        </div>

        <div class="dashboard-grid" style="grid-template-columns: 2fr 1fr;">
            <div class="card">
                <h3>Sales Trends (6 Months)</h3>
                <div style="position: relative; height: 250px;">
                    <canvas id="salesChart"></canvas>
                </div>
            </div>
            <div class="card">
                <h3>Tax Liability (GST)</h3>
                <div style="position: relative; height: 200px;">
                    <canvas id="gstChart"></canvas>
                </div>
                <div style="margin-top: 10px; font-size: 0.9rem;">
                    <div style="display:flex; justify-content:space-between; color: var(--success-color);">
                        <span>Input (Credit):</span> <span id="inTax" style="font-weight:bold;">‚Çπ 0</span>
                    </div>
                    <div style="display:flex; justify-content:space-between; color: var(--danger-color); margin-top: 5px;">
                        <span>Output (Pay):</span> <span id="outTax" style="font-weight:bold;">‚Çπ 0</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="dashboard-grid" style="grid-template-columns: 1fr 1fr;">
            <div class="card">
                <h3>Recent Transactions</h3>
                <div id="recentTxn" style="margin-top: 10px;">
                    <div class="text-center" style="color: #999;">Loading...</div>
                </div>
            </div>

            <div class="card">
                <h3>‚ö†Ô∏è Action Needed</h3>
                <div id="alertsList" style="margin-top: 10px;">
                    <div class="text-center" style="color: #999;">All systems healthy.</div>
                </div>
            </div>
        </div>
    </main>

    <a href="sales_invoice.html" class="fab-add" title="New Sale">
        <i class="fas fa-plus"></i>
    </a>

    <script src="security_utils.js"></script> <script src="db.js"></script> 
    <script src="ai_engine.js"></script>
    <script src="tally_bridge.js"></script>
    <script>
        // --- UI LOGIC ---
        document.getElementById('todayDate').innerText = new Date().toLocaleDateString('en-IN', { weekday: 'short', day: 'numeric', month: 'short' });

        function toggleSidebar() {
            document.querySelector('.sidebar').classList.toggle('active');
        }

        // --- AUTH & SECURITY LOGIC ---
        
        // Show Device ID on Login Screen
        window.onload = async () => {
            if(window.Security) {
                const devID = await Security.getMachineID();
                document.getElementById('displayMachineID').innerText = devID;
            }
        };

        if(sessionStorage.getItem('user_session')) {
            document.getElementById('loginOverlay').style.display = 'none';
            initDashboard();
        }

        async function handleLogin(e) {
            e.preventDefault();
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            
            // 1. Initialize DB
            await DB.init();
            
            try {
                // 2. Hash Password (If using Security Utils)
                // Note: For now, if your DB has "123", we use plain. 
                // FUTURE: Change this line to: const hashedP = await Security.hashPassword(p);
                // For this transition phase, we will try both (Legacy Support)
                
                try {
                    await DB.login(u, p); // Try Plain
                } catch (err) {
                    // Try Hashed (Future Proofing)
                    // const hashedP = await Security.hashPassword(p);
                    // await DB.login(u, hashedP);
                    throw err; // Throw if plain fails for now
                }

                document.getElementById('loginOverlay').style.display = 'none';
                initDashboard();
            } catch(err) { 
                alert("Invalid Credentials or Device Mismatch!"); 
            }
        }

        function logout() {
            if(confirm("Secure Logout?")) {
                sessionStorage.removeItem('user_session');
                location.reload();
            }
        }

        // --- DASHBOARD DATA LOGIC (PRESERVED FROM OLD CODE) ---
        let globalVouchers = []; 

        async function initDashboard() {
            try { await DB.init(); runAnalytics(); }
            catch(e) { console.error(e); }
        }

        async function runAnalytics() {
            // Using DB transactions to fetch data
            const tx = DB.db.transaction(['vouchers', 'items', 'ledgers', 'acct_entries', 'groups'], 'readonly');
            
            // Optimisation: In future use DB.getPaginated for lists, but getAll is fine for totals for now.
            const [vouchers, items, ledgers, entries, groups] = await Promise.all([
                getAll(tx.objectStore('vouchers')), 
                getAll(tx.objectStore('items')), 
                getAll(tx.objectStore('ledgers')), 
                getAll(tx.objectStore('acct_entries')), 
                getAll(tx.objectStore('groups'))
            ]);

            globalVouchers = vouchers;
            const ledgerMap = {}; ledgers.forEach(l => ledgerMap[l.id] = l);
            const balances = {};
            entries.forEach(e => { balances[e.ledger_id] = (balances[e.ledger_id] || 0) + (e.debit || 0) - (e.credit || 0); });

            // Metrics Calculation
            let totalSales = 0, totalPur = 0;
            vouchers.forEach(v => {
                if (v.type === 'Sales') totalSales += v.amount || 0;
                if (v.type === 'Purchase') totalPur += v.amount || 0;
            });

            // Gross Profit Logic
            let openingStockVal = items.reduce((sum, i) => sum + (parseFloat(i.op_value) || (parseFloat(i.op_qty || 0) * parseFloat(i.std_cost || 0))), 0);
            let closingStockVal = items.reduce((sum, i) => sum + ((i.current_stock || 0) * (i.std_cost || 0)), 0);
            let cogs = openingStockVal + totalPur - closingStockVal;
            let profit = totalSales - cogs;
            
            const pEl = document.getElementById('grossProfit');
            pEl.innerText = fmt(profit);
            pEl.style.color = profit >= 0 ? 'var(--success-color)' : 'var(--danger-color)';

            // Cash & Bank
            const cashGrpId = groups.find(g => g.name === "Cash-in-Hand")?.id;
            let cashTotal = 0;
            ledgers.filter(l => l.group_id === cashGrpId).forEach(l => { cashTotal += (l.opening_balance || 0) + (balances[l.id] || 0); });
            const cEl = document.getElementById('cashBal');
            cEl.innerText = fmt(cashTotal);
            if (cashTotal < 0) { cEl.style.color = 'var(--danger-color)'; document.getElementById('cashStatus').innerText = "‚ö†Ô∏è Negative Balance!"; }
            else { document.getElementById('cashStatus').innerText = "Drawer Balance"; }

            // Receivables & Payables
            const debtGrpId = groups.find(g => g.name === "Sundry Debtors")?.id;
            let receivables = 0, debtCount = 0;
            ledgers.filter(l => l.group_id === debtGrpId).forEach(l => {
                let bal = (l.opening_balance || 0) + (balances[l.id] || 0);
                if (bal > 0) { receivables += bal; debtCount++; }
            });
            document.getElementById('receivables').innerText = fmt(receivables);
            document.getElementById('debtorsCount').innerText = `${debtCount} Pending`;

            const credGrpId = groups.find(g => g.name === "Sundry Creditors")?.id;
            let payables = 0;
            ledgers.filter(l => l.group_id === credGrpId).forEach(l => {
                let bal = (l.opening_balance || 0) + (balances[l.id] || 0);
                if (bal < 0) payables += Math.abs(bal);
            });
            document.getElementById('payables').innerText = fmt(payables);

            // GST Calculations
            const taxGrpId = groups.find(g => g.name === "Duties & Taxes")?.id;
            let inTax = 0, outTax = 0;
            if (taxGrpId) {
                ledgers.filter(l => l.group_id === taxGrpId).forEach(l => {
                    let bal = (l.opening_balance || 0) + (balances[l.id] || 0);
                    if (bal > 0) inTax += bal; else outTax += Math.abs(bal);
                });
            }
            document.getElementById('inTax').innerText = fmt(inTax);
            document.getElementById('outTax').innerText = fmt(outTax);

            // Alerts
            let alerts = [];
            if (cashTotal < 0) alerts.push({ title: "Negative Cash", sub: "Check entries immediately", type: "critical" });
            items.filter(i => (i.current_stock || 0) <= (i.reorder_level || 5)).forEach(i => alerts.push({ title: "Low Stock: " + i.name, sub: `Only ${i.current_stock} left`, type: "warning" }));
            
            const alertDiv = document.getElementById('alertsList');
            if (alerts.length > 0) {
                alertDiv.innerHTML = alerts.map(a => `
                    <div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #eee; cursor:pointer;" onclick="${a.title.includes('Stock') ? 'location.href=\'item_master.html\'' : ''}">
                        <div>
                            <div style="font-weight:600; color:${a.type === 'critical' ? 'red' : 'orange'}">${a.title}</div>
                            <div style="font-size:0.8rem; color:#666;">${a.sub}</div>
                        </div>
                        <span>${a.type === 'critical' ? 'üõë' : '‚ö†Ô∏è'}</span>
                    </div>
                `).join('');
            } else { alertDiv.innerHTML = '<div class="text-center" style="color:#999; padding:10px;">‚ú® All systems healthy.</div>'; }

            // Recent Transactions List
            const recent = vouchers.sort((a,b) => b.id - a.id).slice(0, 8);
            if(recent.length > 0) {
                document.getElementById('recentTxn').innerHTML = recent.map(v => {
                    const pName = ledgerMap[v.party_id]?.name || "Cash / Unknown";
                    const isSale = v.type === 'Sales';
                    return `
                        <div style="display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px solid #f0f0f0;">
                            <div>
                                <div style="font-weight:600; color:#333;">${pName}</div>
                                <div style="font-size:0.8rem; color:#999;">${v.voucher_no} ‚Ä¢ ${v.date}</div>
                            </div>
                            <div style="font-weight:bold; color:${isSale ? 'var(--success-color)' : 'var(--danger-color)'}">
                                ${isSale ? '+' : '-'} ${fmt(v.amount)}
                            </div>
                        </div>`;
                }).join('');
            }

            renderCharts(vouchers, inTax, outTax);
        }

        // --- SEARCH LOGIC (PRESERVED) ---
        function searchVouchers() {
            const query = document.getElementById('univSearch').value.toLowerCase().trim();
            const table = document.getElementById('searchTable');
            const tbody = document.getElementById('searchBody');
            const noRes = document.getElementById('noResult');

            if (!query) { table.style.display = 'none'; noRes.style.display = 'none'; return; }

            const results = globalVouchers.filter(v => v.voucher_no.toLowerCase().includes(query) || v.date.includes(query) || v.amount.toString().includes(query));
            tbody.innerHTML = '';
            
            if (results.length > 0) {
                table.style.display = 'block'; // Using block because table-container handles overflow
                noRes.style.display = 'none';
                results.sort((a,b) => b.id - a.id).forEach(v => {
                    const tr = document.createElement('tr');
                    let targetPage = v.type === 'Sales' ? 'sales_invoice.html' : (v.type === 'Purchase' ? 'purchase_invoice.html' : 'vouchers.html');
                    tr.innerHTML = `<td>${v.date}</td><td><span class="badge ${v.type==='Sales'?'badge-success':'badge-pending'}">${v.type}</span></td><td>${v.voucher_no}</td><td>‚Çπ${v.amount}</td><td><button class="btn btn-primary" style="padding:2px 8px; font-size:0.8rem;" onclick="window.location.href='${targetPage}?id=${v.id}'">Open</button></td>`;
                    tbody.appendChild(tr);
                });
            } else {
                table.style.display = 'none';
                noRes.style.display = 'block';
            }
        }

        // --- HELPERS ---
        async function refreshDashboard() {
            const btn = document.getElementById('refreshBtn');
            const spin = document.getElementById('spinIcon');
            btn.disabled = true;
            spin.classList.add('fa-spin');
            await runAnalytics();
            setTimeout(() => { spin.classList.remove('fa-spin'); btn.disabled = false; }, 500);
        }

        function renderCharts(vouchers, inTax, outTax) {
             // Sales Chart Logic
             const months = [], dataMap = {}, today = new Date();
             for (let i = 5; i >= 0; i--) {
                 const d = new Date(today.getFullYear(), today.getMonth() - i, 1);
                 const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                 months.push(d.toLocaleString('default', { month: 'short' }));
                 dataMap[key] = 0;
             }
             vouchers.forEach(v => {
                 if (v.type === 'Sales') {
                     const vDate = new Date(v.date);
                     const key = `${vDate.getFullYear()}-${String(vDate.getMonth() + 1).padStart(2, '0')}`;
                     if (dataMap[key] !== undefined) dataMap[key] += v.amount || 0;
                 }
             });
             const chartData = Object.values(dataMap);
 
             if (window.salesChartInstance) window.salesChartInstance.destroy();
             const ctx1 = document.getElementById('salesChart').getContext('2d');
             window.salesChartInstance = new Chart(ctx1, {
                 type: 'line',
                 data: {
                     labels: months,
                     datasets: [{ label: 'Revenue', data: chartData, borderColor: '#0d47a1', backgroundColor: 'rgba(13, 71, 161, 0.1)', fill: true, tension: 0.4 }]
                 },
                 options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
             });
 
             // GST Chart Logic
             if (window.gstChartInstance) window.gstChartInstance.destroy();
             const gstCtx = document.getElementById('gstChart');
             if(gstCtx && (inTax > 0 || outTax > 0)) {
                 window.gstChartInstance = new Chart(gstCtx, {
                     type: 'doughnut',
                     data: { labels: ['Input Credit', 'Output Liability'], datasets: [{ data: [inTax, outTax], backgroundColor: ['#388e3c', '#d32f2f'], borderWidth: 0 }] },
                     options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { display: false } } }
                 });
             }
        }

        function getAll(store) { return new Promise(resolve => { const req = store.getAll(); req.onsuccess = () => resolve(req.result); }); }
        function fmt(num) { return "‚Çπ " + (num || 0).toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); }
    </script>
    
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('sw.js').then(reg => console.log('Arth Book PWA Active')).catch(err => console.log('PWA Failed', err));
        });
      }
    </script>
</body>
</html>