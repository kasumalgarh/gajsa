<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arth Book - Executive Dashboard</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="manifest" href="manifest.json">

    <style>
        :root {
            --primary-color: #0f172a;
            --accent-color: #2563eb;
            --bg-color: #f1f5f9;
            --card-bg: #ffffff;
            --text-color: #1e293b;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --border-color: #e2e8f0;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background-color: var(--bg-color); color: var(--text-color); display: flex; height: 100vh; overflow: hidden; }

        /* HEADER */
        header {
            display: none; /* Hidden on desktop, shown on mobile logic if needed, but handled by main layout */
        }

        /* SIDEBAR */
        .sidebar {
            width: 260px; background: var(--primary-color); color: #94a3b8;
            display: flex; flex-direction: column; height: 100vh;
            flex-shrink: 0; overflow-y: auto; transition: 0.3s; z-index: 100;
        }
        .brand-logo { 
            padding: 20px; font-size: 20px; font-weight: 800; color: white; 
            display: flex; align-items: center; gap: 10px; margin-bottom: 20px;
        }
        .nav-links { list-style: none; padding: 0 10px; }
        .nav-links li { margin-bottom: 5px; }
        .nav-links a {
            display: flex; align-items: center; gap: 12px; padding: 12px 15px;
            color: inherit; text-decoration: none; border-radius: 8px;
            font-weight: 500; transition: 0.2s;
        }
        .nav-links a:hover, .nav-links a.active { background: #1e293b; color: white; }
        .nav-links i { width: 20px; text-align: center; }

        /* MAIN CONTENT */
        main { flex: 1; padding: 25px; overflow-y: auto; display: flex; flex-direction: column; }

        /* CARDS & GRID */
        .dashboard-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px; margin-bottom: 20px;
        }
        .card {
            background: var(--card-bg); border-radius: 12px; padding: 20px;
            box-shadow: var(--shadow); border: 1px solid var(--border-color);
            position: relative;
        }
        .card h3 { font-size: 14px; color: #64748b; font-weight: 600; text-transform: uppercase; margin-bottom: 10px; }
        .value { font-size: 28px; font-weight: 800; color: var(--text-color); margin-bottom: 5px; }

        /* COLORED EDGES */
        .green-edge { border-left: 5px solid var(--success-color); }
        .gold-edge { border-left: 5px solid var(--warning-color); }
        .blue-edge { border-left: 5px solid var(--accent-color); }
        .red-edge { border-left: 5px solid var(--danger-color); }

        /* UTILS */
        .btn {
            padding: 10px 20px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer;
            display: inline-flex; align-items: center; gap: 8px; transition: 0.2s;
        }
        .btn-primary { background: var(--accent-color); color: white; }
        .btn-warning { background: var(--danger-color); color: white; } /* Logout red */
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }

        input {
            padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; outline: none;
        }
        input:focus { border-color: var(--accent-color); box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }

        /* TABLE */
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; margin-top: 10px; }
        th { text-align: left; padding: 12px; background: #f8fafc; color: #64748b; border-bottom: 2px solid var(--border-color); }
        td { padding: 12px; border-bottom: 1px solid var(--border-color); }
        
        /* FAB */
        .fab-add {
            position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px;
            background: var(--accent-color); color: white; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 24px; box-shadow: 0 10px 25px rgba(37,99,235,0.4);
            transition: 0.3s; z-index: 500; text-decoration: none;
        }
        .fab-add:hover { transform: scale(1.1) rotate(90deg); }

        /* MOBILE */
        @media (max-width: 768px) {
            .sidebar { position: fixed; left: -100%; top: 0; height: 100%; width: 260px; }
            .sidebar.active { left: 0; }
            header { display: flex; justify-content: space-between; align-items: center; padding: 15px; background: white; border-bottom: 1px solid var(--border-color); }
            main { padding: 15px; }
            .user-menu { display: none; } /* Hide user menu on mobile or move it */
            .menu-toggle { font-size: 24px; cursor: pointer; color: var(--primary-color); margin-right: 15px; }
            /* Mobile Header Fix */
            .brand-logo { display: none; } /* Hide sidebar logo on mobile, show header one */
            .sidebar.active .brand-logo { display: flex; }
        }
        
        /* Show menu button only on mobile */
        .menu-toggle { display: none; }
        @media (max-width: 768px) { .menu-toggle { display: block; } }
    </style>
</head>
<body>

    <div id="loginOverlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #0f172a; z-index: 9999; display: flex; align-items: center; justify-content: center; color: white;">
        <div class="card" style="width: 350px; max-width:90%; text-align: center; border-top: 5px solid var(--accent-color); padding:30px;">
            <div style="font-size: 50px; margin-bottom: 15px;">üõ°Ô∏è</div>
            <h2 style="color: #1e293b; margin-bottom:5px;">Arth Book</h2>
            <p style="color: #64748b; font-size: 13px; margin-bottom: 25px;">Secure Business Operating System</p>
            <form onsubmit="handleLogin(event)">
                <div style="margin-bottom: 15px;">
                    <input type="text" id="username" placeholder="Username (admin)" required style="width:100%; padding:12px;">
                </div>
                <div style="margin-bottom: 20px;">
                    <input type="password" id="password" placeholder="Password" required style="width:100%; padding:12px;">
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%; padding:12px; font-size:16px;">Unlock Device</button>
            </form>
            <div style="margin-top: 20px; font-size: 11px; color: #94a3b8;">
                Device ID: <span id="displayMachineID">Checking...</span>
            </div>
        </div>
    </div>

    <header>
        <div style="display:flex; align-items:center;">
            <span class="menu-toggle" onclick="toggleSidebar()"><i class="fas fa-bars"></i></span>
            <span style="font-weight:800; font-size:18px; color:var(--primary-color);">Arth Book</span>
        </div>
        <button class="btn btn-warning" onclick="logout()" style="padding: 6px 12px; font-size: 12px;">
            <i class="fas fa-power-off"></i>
        </button>
    </header>

    <div class="sidebar" id="sidebar">
        <div class="brand-logo">
            <i class="fas fa-book"></i> Arth Book
        </div>
        <ul class="nav-links">
            <li><a href="index.html" class="active"><i class="fas fa-chart-pie"></i> Dashboard</a></li>
            <li><a href="sales_invoice.html"><i class="fas fa-file-invoice"></i> Sales Invoice</a></li>
            <li><a href="purchase_invoice.html"><i class="fas fa-truck"></i> Purchase Entry</a></li>
            <li><a href="vouchers.html"><i class="fas fa-receipt"></i> Vouchers (JV)</a></li>
            <li><a href="item_master.html"><i class="fas fa-boxes"></i> Inventory & Stock</a></li>
            <li><a href="ArthBook.html"><i class="fas fa-users"></i> Parties (Ledgers)</a></li>
            <li><a href="reports.html"><i class="fas fa-chart-line"></i> Smart Reports</a></li>
            <hr style="margin: 15px 10px; border: 0; border-top: 1px solid #334155;">
            <li><a href="gst_filing.html"><i class="fas fa-university"></i> GST Filing</a></li>
            <li><a href="taxation.html"><i class="fas fa-calculator"></i> Global Tax / ITR</a></li>
            <li><a href="settings.html"><i class="fas fa-cogs"></i> Settings</a></li>
            <li><a href="help.html" target="_blank">‚ùì Help / ‡§Æ‡§¶‡§¶</a></li>
        </ul>
        <div class="user-menu" style="margin-top:auto; padding:20px;">
            <div id="todayDate" style="font-size: 12px; color: #94a3b8; margin-bottom: 10px;">...</div>
            <button class="btn btn-warning" onclick="logout()" style="width:100%; justify-content:center;">
                <i class="fas fa-power-off"></i> Logout
            </button>
        </div>
    </div>

    <main>
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap:wrap; gap:10px;">
            <h2 style="color: var(--primary-color);">Executive Overview</h2>
            <button class="btn btn-primary" id="refreshBtn" onclick="refreshDashboard()">
                <i class="fas fa-sync-alt" id="spinIcon"></i> Refresh Data
            </button>
        </div>

        <div class="card" style="margin-bottom: 20px; padding: 20px;">
            <div style="display: flex; gap: 10px; flex-wrap:wrap;">
                <input type="text" id="univSearch" placeholder="üîç Search Bill No, Party Name, Amount..." style="flex:1; min-width:250px;" onkeyup="if(event.key==='Enter') searchVouchers()">
                <button class="btn btn-primary" onclick="searchVouchers()">Find</button>
            </div>
            <div class="table-container" id="searchTable" style="display: none; margin-top: 20px;">
                <table>
                    <thead><tr><th>Date</th><th>Party</th><th>Type</th><th>Voucher #</th><th>Amount</th><th>Action</th></tr></thead>
                    <tbody id="searchBody"></tbody>
                </table>
            </div>
            <div id="noResult" style="display:none; padding:20px; text-align:center; color:#666; font-size:14px;">No records found.</div>
        </div>

        <div class="dashboard-grid">
            <div class="card green-edge">
                <h3>Gross Profit</h3>
                <div class="value" id="grossProfit">‚Çπ0</div>
                <div style="font-size: 0.85rem; color: #64748b;">Sales - Cost of Goods</div>
            </div>
            
            <div class="card gold-edge">
                <h3>Cash In Hand</h3>
                <div class="value" id="cashBal">‚Çπ0</div>
                <div style="font-size: 0.85rem; color: #64748b;" id="cashStatus">Drawer Balance</div>
            </div>

            <div class="card blue-edge">
                <h3>Receivables (Lena)</h3>
                <div class="value" id="receivables">‚Çπ0</div>
                <div style="font-size: 0.85rem; color: #64748b;" id="debtorsCount">0 Customers</div>
            </div>

            <div class="card red-edge">
                <h3>Payables (Dena)</h3>
                <div class="value" id="payables">‚Çπ0</div>
                <div style="font-size: 0.85rem; color: #64748b;">Due to Suppliers</div>
            </div>
        </div>

        <div class="dashboard-grid" style="grid-template-columns: 2fr 1fr;">
            <div class="card">
                <h3>Sales Trends (Last 6 Months)</h3>
                <div style="position: relative; height: 280px; margin-top:10px;">
                    <canvas id="salesChart"></canvas>
                </div>
            </div>
            <div class="card">
                <h3>GST Tax Liability</h3>
                <div style="position: relative; height: 220px; margin-top:10px;">
                    <canvas id="gstChart"></canvas>
                </div>
                <div style="margin-top: 15px; font-size: 0.9rem;">
                    <div style="display:flex; justify-content:space-between; color: var(--success-color); font-weight:600;">
                        <span>Input Credit:</span> <span id="inTax">‚Çπ0</span>
                    </div>
                    <div style="display:flex; justify-content:space-between; color: var(--danger-color); margin-top: 8px; font-weight:600;">
                        <span>Output Tax:</span> <span id="outTax">‚Çπ0</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="dashboard-grid" style="grid-template-columns: 1fr 1fr;">
            <div class="card">
                <h3>Recent Transactions</h3>
                <div id="recentTxn" style="margin-top: 15px; max-height:300px; overflow-y:auto;">
                    <div class="text-center" style="color: #999; padding:20px;">Loading recent activity...</div>
                </div>
            </div>

            <div class="card">
                <h3>‚ö†Ô∏è Action Needed</h3>
                <div id="alertsList" style="margin-top: 15px; max-height:300px; overflow-y:auto;">
                    <div class="text-center" style="color:#999; padding:20px;">All systems healthy ‚ú®</div>
                </div>
            </div>
        </div>
    </main>

    <a href="sales_invoice.html" class="fab-add" title="New Sale">
        <i class="fas fa-plus"></i>
    </a>

    <div id="toast" style="position:fixed; bottom:80px; left:50%; transform:translateX(-50%); background:var(--success-color); color:white; padding:12px 30px; border-radius:8px; display:none; font-weight:600; box-shadow:var(--shadow); z-index:1000;">Dashboard Refreshed!</div>

    <script src="db.js"></script>
    <script src="security_utils.js" onerror="console.log('Security Utils optional')"></script>
    <script src="ai_engine.js" onerror="console.log('AI Engine optional')"></script>
    <script src="tally_bridge.js" onerror="console.log('Tally Bridge optional')"></script>

    <script>
        // Global Vars
        let globalVouchers = [];
        let globalLedgerMap = {};

        // UI Init
        document.getElementById('todayDate').innerText = new Date().toLocaleDateString('en-IN', { weekday: 'short', day: 'numeric', month: 'short', year: 'numeric' });

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
        }

        // AUTH & INIT
        window.addEventListener('load', async () => {
            if (window.Security) {
                const devID = await Security.getMachineID();
                document.getElementById('displayMachineID').innerText = devID;
            }

            // Check if already logged in (db.js handles default admin)
            if (sessionStorage.getItem('user_session')) {
                await DB.init(); 
                document.getElementById('loginOverlay').style.display = 'none';
                initDashboard();
            } else {
                // Auto-login for single user experience (optional, or force login)
                // For now, show login screen.
            }
        });

        async function handleLogin(e) {
            e.preventDefault();
            const u = document.getElementById('username').value.trim();
            const p = document.getElementById('password').value;

            await DB.init();

            try {
                // Try plain first (legacy), then hashed
                try {
                    await DB.login(u, p);
                } catch {
                    if (window.Security) {
                        const hashed = await Security.hashPassword(p);
                        await DB.login(u, hashed);
                    } else {
                        throw new Error("Security module missing");
                    }
                }

                sessionStorage.setItem('user_session', JSON.stringify({ username: u, role: 'admin' })); // Force role locally if needed
                document.getElementById('loginOverlay').style.display = 'none';
                initDashboard();
            } catch (err) {
                console.error(err);
                alert('Invalid credentials!');
            }
        }

        function logout() {
            if (confirm('Secure logout?')) {
                sessionStorage.removeItem('user_session');
                location.reload();
            }
        }

        // DASHBOARD CORE
        async function initDashboard() {
            await runAnalytics();
        }

        async function runAnalytics() {
            // Using DB helper directly is cleaner
            const vouchers = await DB.getAll('vouchers');
            const items = await DB.getAll('items');
            const ledgers = await DB.getAll('ledgers');
            const entries = await DB.getAll('acct_entries');
            const groups = await DB.getAll('groups');

            globalVouchers = vouchers;
            globalLedgerMap = {};
            ledgers.forEach(l => globalLedgerMap[l.id] = l);

            const balances = {};
            entries.forEach(e => {
                balances[e.ledger_id] = (balances[e.ledger_id] || 0) + (e.debit || 0) - (e.credit || 0);
            });

            // Gross Profit
            let totalSales = 0, totalPur = 0;
            vouchers.forEach(v => {
                if (v.type === 'Sales') totalSales += v.amount || 0;
                if (v.type === 'Purchase') totalPur += v.amount || 0;
            });

            const openingStockVal = items.reduce((sum, i) => sum + ((i.op_qty || 0) * (i.std_cost || 0)), 0);
            const closingStockVal = items.reduce((sum, i) => sum + ((i.current_stock || 0) * (i.std_cost || 0)), 0);
            const cogs = openingStockVal + totalPur - closingStockVal;
            const profit = totalSales - cogs;

            const pEl = document.getElementById('grossProfit');
            pEl.innerText = fmt(profit);
            pEl.style.color = profit >= 0 ? 'var(--success-color)' : 'var(--danger-color)';

            // Cash Balance
            const cashGrp = groups.find(g => g.name === 'Cash-in-Hand');
            let cashTotal = 0;
            if (cashGrp) {
                ledgers.filter(l => l.group_id === cashGrp.id).forEach(l => {
                    cashTotal += (l.opening_balance || 0) + (balances[l.id] || 0);
                });
            }
            const cEl = document.getElementById('cashBal');
            cEl.innerText = fmt(cashTotal);
            document.getElementById('cashStatus').innerText = cashTotal < 0 ? '‚ö†Ô∏è Negative Balance!' : 'Drawer Balance';
            cEl.style.color = cashTotal < 0 ? 'var(--danger-color)' : 'inherit';

            // Receivables
            const debtorsGrp = groups.find(g => g.name === 'Sundry Debtors');
            let receivables = 0, debtorCount = 0;
            if (debtorsGrp) {
                ledgers.filter(l => l.group_id === debtorsGrp.id).forEach(l => {
                    const bal = (l.opening_balance || 0) + (balances[l.id] || 0);
                    if (bal > 0) { receivables += bal; debtorCount++; }
                });
            }
            document.getElementById('receivables').innerText = fmt(receivables);
            document.getElementById('debtorsCount').innerText = `${debtorCount} Customers Pending`;

            // Payables
            const creditorsGrp = groups.find(g => g.name === 'Sundry Creditors');
            let payables = 0;
            if (creditorsGrp) {
                ledgers.filter(l => l.group_id === creditorsGrp.id).forEach(l => {
                    const bal = (l.opening_balance || 0) + (balances[l.id] || 0);
                    if (bal < 0) payables += Math.abs(bal);
                });
            }
            document.getElementById('payables').innerText = fmt(payables);

            // GST
            const taxGrp = groups.find(g => g.name === 'Duties & Taxes');
            let inTax = 0, outTax = 0;
            if (taxGrp) {
                ledgers.filter(l => l.group_id === taxGrp.id).forEach(l => {
                    const bal = (l.opening_balance || 0) + (balances[l.id] || 0);
                    if (bal > 0) inTax += bal;
                    else outTax += Math.abs(bal);
                });
            }
            document.getElementById('inTax').innerText = fmt(inTax);
            document.getElementById('outTax').innerText = fmt(outTax);

            // Alerts
            const alerts = [];
            if (cashTotal < 0) alerts.push({ title: 'Negative Cash Balance', sub: 'Immediate attention required', type: 'critical' });
            items.filter(i => (i.current_stock || 0) <= (i.reorder_level || 5)).forEach(i => 
                alerts.push({ title: `Low Stock: ${i.name}`, sub: `Only ${i.current_stock || 0} left`, type: 'warning' })
            );

            const alertDiv = document.getElementById('alertsList');
            alertDiv.innerHTML = alerts.length ? alerts.map(a => `
                <div style="display:flex; justify-content:space-between; padding:12px; border-bottom:1px solid #eee; cursor:pointer;" onclick="${a.type==='warning' ? 'location.href=\'item_master.html\'' : ''}">
                    <div>
                        <div style="font-weight:600; color:${a.type==='critical'?'red':'orange'}">${a.title}</div>
                        <div style="font-size:0.85rem; color:#666;">${a.sub}</div>
                    </div>
                    <span>${a.type==='critical'?'üõë':'‚ö†Ô∏è'}</span>
                </div>
            `).join('') : '<div class="text-center" style="color:#999; padding:20px;">‚ú® All systems healthy</div>';

            // Recent Transactions
            const recent = vouchers.sort((a,b) => (b.id || 0) - (a.id || 0)).slice(0, 10);
            document.getElementById('recentTxn').innerHTML = recent.length ? recent.map(v => {
                const pName = globalLedgerMap[v.party_id]?.name || 'Cash/Other';
                const isCredit = v.type === 'Sales' || v.type === 'Receipt';
                return `
                    <div style="display:flex; justify-content:space-between; padding:12px 0; border-bottom:1px solid #f0f0f0;">
                        <div>
                            <div style="font-weight:600;">${pName}</div>
                            <div style="font-size:0.85rem; color:#999;">${v.voucher_no} ‚Ä¢ ${v.date}</div>
                        </div>
                        <div style="font-weight:bold; color:${isCredit ? 'var(--success-color)' : 'var(--danger-color)'}">
                            ${isCredit ? '+' : '-'} ${fmt(v.amount || 0)}
                        </div>
                    </div>`;
            }).join('') : '<div class="text-center" style="color:#999; padding:20px;">No recent transactions</div>';

            renderCharts(vouchers, inTax, outTax);
        }

        function searchVouchers() {
            const query = document.getElementById('univSearch').value.toLowerCase().trim();
            const table = document.getElementById('searchTable');
            const tbody = document.getElementById('searchBody');
            const noRes = document.getElementById('noResult');

            if (!query) {
                table.style.display = 'none';
                noRes.style.display = 'none';
                return;
            }

            const results = globalVouchers.filter(v => {
                const party = globalLedgerMap[v.party_id]?.name?.toLowerCase() || '';
                return v.voucher_no.toLowerCase().includes(query) ||
                        v.date.includes(query) ||
                        (v.amount || 0).toString().includes(query) ||
                        party.includes(query);
            }).sort((a,b) => (b.id || 0) - (a.id || 0));

            tbody.innerHTML = '';
            if (results.length) {
                table.style.display = 'block';
                noRes.style.display = 'none';
                results.forEach(v => {
                    const party = globalLedgerMap[v.party_id]?.name || 'Cash';
                    const page = v.type === 'Sales' ? 'sales_invoice.html' : 
                                 v.type === 'Purchase' ? 'purchase_invoice.html' : 'vouchers.html';
                    tbody.innerHTML += `<tr>
                        <td>${v.date}</td>
                        <td><b>${party}</b></td>
                        <td>${v.type}</td>
                        <td>${v.voucher_no}</td>
                        <td>${fmt(v.amount || 0)}</td>
                        <td><button class="btn btn-primary" style="padding:4px 10px; font-size:0.8rem;" onclick="location.href='${page}?id=${v.id}'">Open</button></td>
                    </tr>`;
                });
            } else {
                table.style.display = 'none';
                noRes.style.display = 'block';
            }
        }

        async function refreshDashboard() {
            const btn = document.getElementById('refreshBtn');
            const icon = document.getElementById('spinIcon');
            btn.disabled = true;
            icon.classList.add('fa-spin');
            await runAnalytics();
            icon.classList.remove('fa-spin');
            btn.disabled = false;
            showToast();
        }

        function renderCharts(vouchers, inTax, outTax) {
            // Sales Trend
            const months = [], salesData = {};
            const today = new Date();
            for (let i = 5; i >= 0; i--) {
                const d = new Date(today.getFullYear(), today.getMonth() - i, 1);
                const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
                months.push(d.toLocaleString('default', { month: 'short' }));
                salesData[key] = 0;
            }
            vouchers.forEach(v => {
                if (v.type === 'Sales' && v.date) {
                    const key = v.date.substring(0,7);
                    salesData[key] = (salesData[key] || 0) + (v.amount || 0);
                }
            });

            // FIXED: Safe destroy
            if (window.salesChart instanceof Chart) window.salesChart.destroy();
            
            window.salesChart = new Chart(document.getElementById('salesChart'), {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [{
                        label: 'Monthly Sales',
                        data: months.map(m => {
                            const key = today.getFullYear() + '-' + (today.getMonth() + 1 - months.indexOf(m)).toString().padStart(2,'0');
                            return salesData[key] || 0;
                        }),
                        borderColor: '#2563eb',
                        backgroundColor: 'rgba(37,99,235,0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });

            // GST Doughnut
            if (window.gstChart instanceof Chart) window.gstChart.destroy();
            
            const gstCanvas = document.getElementById('gstChart');
            if (inTax + outTax === 0) {
                // Manually draw text if empty
                const ctx = gstCanvas.getContext('2d');
                ctx.clearRect(0, 0, gstCanvas.width, gstCanvas.height);
                // Chart.js won't render if data is 0, handled by simple placeholder text
            } else {
                window.gstChart = new Chart(gstCanvas, {
                    type: 'doughnut',
                    data: {
                        labels: ['Input Credit', 'Output Liability'],
                        datasets: [{ data: [inTax, outTax], backgroundColor: ['#10b981', '#ef4444'] }]
                    },
                    options: { responsive: true, cutout: '70%', plugins: { legend: { position: 'bottom' } } }
                });
            }
        }

        function fmt(num) {
            return '‚Çπ' + (num || 0).toLocaleString('en-IN', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
        }

        function showToast() {
            const t = document.getElementById('toast');
            t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 2000);
        }

        // SW Register
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js').catch(() => {});
        }
    </script>
</body>
</html>