<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arth Book - Smart Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<style>
    /* ==========================================================================
       ARTH BOOK DASHBOARD v10.0 (MARKET STANDARD)
       ========================================================================== */
    :root {
        --primary: #0d47a1; --primary-dark: #002171; --accent: #ffca28;
        --bg: #f1f5f9; --surface: #ffffff; --text: #1e293b; --text-light: #64748b;
        --success: #10b981; --danger: #ef4444; --warning: #f59e0b;
        --sidebar-width: 260px;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', sans-serif; }
    body { display: flex; height: 100vh; background: var(--bg); color: var(--text); overflow: hidden; }

    /* SIDEBAR */
    .sidebar { width: var(--sidebar-width); background: var(--primary); color: white; display: flex; flex-direction: column; flex-shrink: 0; transition: 0.3s; z-index: 1000; }
    .brand { padding: 20px; font-size: 22px; font-weight: 800; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; gap: 10px; }
    .nav-links { padding: 15px; list-style: none; overflow-y: auto; flex: 1; }
    .nav-link { display: flex; align-items: center; gap: 12px; padding: 12px 15px; color: rgba(255,255,255,0.85); text-decoration: none; border-radius: 8px; margin-bottom: 5px; transition: 0.2s; font-size: 14px; font-weight: 500; }
    .nav-link:hover { background: rgba(255,255,255,0.15); color: white; padding-left: 20px; }
    .nav-link.active { background: var(--accent); color: var(--primary-dark); font-weight: 700; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    
    /* MAIN AREA */
    .main { flex: 1; display: flex; flex-direction: column; overflow-y: auto; position: relative; }
    .top-bar { background: var(--surface); padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e2e8f0; position: sticky; top: 0; z-index: 100; }
    .user-info { display: flex; align-items: center; gap: 10px; }
    .user-avatar { width: 35px; height: 35px; background: #e0f2fe; color: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; }

    /* DASHBOARD CONTENT */
    .content { padding: 25px; max-width: 1400px; margin: 0 auto; width: 100%; }

    /* QUICK ACTIONS */
    .quick-actions { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; margin-bottom: 25px; }
    .qa-btn { background: white; padding: 15px; border-radius: 12px; border: 1px solid #e2e8f0; text-align: center; cursor: pointer; transition: 0.2s; text-decoration: none; color: var(--text); display: flex; flex-direction: column; align-items: center; gap: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
    .qa-btn:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.08); border-color: var(--primary); }
    .qa-icon { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 18px; color: white; margin-bottom: 5px; }

    /* KPI CARDS */
    .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 25px; }
    .kpi-card { background: white; padding: 20px; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); border: 1px solid #f1f5f9; position: relative; overflow: hidden; }
    .kpi-title { font-size: 12px; font-weight: 600; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.5px; }
    .kpi-value { font-size: 26px; font-weight: 800; margin-top: 8px; color: var(--text); }
    .kpi-icon { position: absolute; right: 20px; top: 20px; font-size: 24px; opacity: 0.2; }

    /* SPLIT SECTION (Graph & Lists) */
    .split-section { display: grid; grid-template-columns: 2fr 1fr; gap: 25px; }
    
    .panel { background: white; border-radius: 16px; padding: 20px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); border: 1px solid #f1f5f9; display: flex; flex-direction: column; }
    .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #f1f5f9; }
    .panel-title { font-weight: 700; font-size: 16px; display: flex; align-items: center; gap: 8px; }

    /* Transaction List */
    .txn-list { flex: 1; overflow-y: auto; max-height: 350px; }
    .txn-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px dashed #f1f5f9; }
    .txn-item:last-child { border-bottom: none; }
    .txn-icon { width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 14px; margin-right: 12px; }
    
    /* Low Stock List */
    .stock-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #f1f5f9; font-size: 13px; }
    .stock-warn { background: #fee2e2; color: #991b1b; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold; }

    /* MOBILE */
    .menu-btn { display: none; font-size: 20px; background: none; border: none; cursor: pointer; }
    .overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 900; }
    
    @media (max-width: 1024px) {
        .split-section { grid-template-columns: 1fr; }
    }
    @media (max-width: 768px) {
        .sidebar { position: fixed; left: -100%; height: 100%; }
        .sidebar.active { left: 0; }
        .menu-btn { display: block; }
        .overlay.active { display: block; }
        .quick-actions { grid-template-columns: repeat(2, 1fr); }
    }
</style>
<body>

<div class="overlay" onclick="toggleMenu()"></div>

<div class="sidebar" id="sidebar">
    <div class="brand"><i class="fas fa-cube"></i> Arth Book</div>
    <ul class="nav-links">
        <li><a href="index.html" class="nav-link active"><i class="fas fa-home"></i> Dashboard</a></li>
        <li><a href="sales_invoice.html" class="nav-link"><i class="fas fa-file-invoice"></i> Sales (POS)</a></li>
        <li><a href="purchase_invoice.html" class="nav-link"><i class="fas fa-truck"></i> Purchase</a></li>
        <li><a href="vouchers.html" class="nav-link"><i class="fas fa-receipt"></i> Day Book</a></li>
        <li><a href="item_master.html" class="nav-link"><i class="fas fa-boxes"></i> Inventory</a></li>
        <li><a href="ArthBook.html" class="nav-link"><i class="fas fa-users"></i> Parties</a></li>
        <li><a href="coa.html" class="nav-link"><i class="fas fa-sitemap"></i> Accounts</a></li>
        <li><a href="reports.html" class="nav-link"><i class="fas fa-chart-line"></i> Reports</a></li>
        <li><a href="gst_filing.html" class="nav-link"><i class="fas fa-university"></i> GST Returns</a></li>
        <li><a href="settings.html" class="nav-link"><i class="fas fa-cog"></i> Settings</a></li>
    </ul>
    <div style="padding:20px; font-size:11px; color:rgba(255,255,255,0.4); text-align:center;">
        Arth Book v10.0 Pro
    </div>
</div>

<div class="main">
    <div class="top-bar">
        <div style="display:flex; align-items:center; gap:15px;">
            <button class="menu-btn" onclick="toggleMenu()"><i class="fas fa-bars"></i></button>
            <h2 style="margin:0; font-size:18px;">Overview</h2>
        </div>
        <div class="user-info">
            <div style="text-align:right;">
                <div style="font-weight:700; font-size:14px;">Admin</div>
                <div style="font-size:11px; color:var(--text-light);" id="currentDate">Jan 26, 2026</div>
            </div>
            <div class="user-avatar">A</div>
        </div>
    </div>

    <div class="content">
        <div class="quick-actions">
            <a href="sales_invoice.html" class="qa-btn">
                <div class="qa-icon" style="background:var(--success);"><i class="fas fa-plus"></i></div>
                <div style="font-weight:600; font-size:13px;">Sale Invoice</div>
            </a>
            <a href="purchase_invoice.html" class="qa-btn">
                <div class="qa-icon" style="background:var(--primary);"><i class="fas fa-shopping-cart"></i></div>
                <div style="font-weight:600; font-size:13px;">Purchase Bill</div>
            </a>
            <a href="item_master.html" class="qa-btn">
                <div class="qa-icon" style="background:var(--warning);"><i class="fas fa-box-open"></i></div>
                <div style="font-weight:600; font-size:13px;">Add Item</div>
            </a>
            <a href="ArthBook.html" class="qa-btn">
                <div class="qa-icon" style="background:#8b5cf6;"><i class="fas fa-user-plus"></i></div>
                <div style="font-weight:600; font-size:13px;">Add Party</div>
            </a>
        </div>

        <div class="kpi-grid">
            <div class="kpi-card">
                <div class="kpi-title">To Collect (Receivables)</div>
                <div class="kpi-value" id="totalRec" style="color:var(--success);">₹0.00</div>
                <i class="fas fa-hand-holding-usd kpi-icon" style="color:var(--success);"></i>
            </div>
            <div class="kpi-card">
                <div class="kpi-title">To Pay (Payables)</div>
                <div class="kpi-value" id="totalPay" style="color:var(--danger);">₹0.00</div>
                <i class="fas fa-file-invoice-dollar kpi-icon" style="color:var(--danger);"></i>
            </div>
            <div class="kpi-card">
                <div class="kpi-title">Cash in Hand</div>
                <div class="kpi-value" id="cashBal">₹0.00</div>
                <i class="fas fa-wallet kpi-icon" style="color:var(--primary);"></i>
            </div>
            <div class="kpi-card">
                <div class="kpi-title">Stock Value</div>
                <div class="kpi-value" id="stockVal" style="color:var(--warning);">₹0.00</div>
                <i class="fas fa-cubes kpi-icon" style="color:var(--warning);"></i>
            </div>
        </div>

        <div class="split-section">
            <div class="panel">
                <div class="panel-header">
                    <div class="panel-title"><i class="fas fa-chart-bar" style="color:var(--primary);"></i> Sales vs Purchase</div>
                </div>
                <div style="height:200px; width:100%;">
                    <canvas id="mainChart"></canvas>
                </div>

                <div class="panel-header" style="margin-top:20px; border-top:1px solid #f1f5f9; padding-top:15px;">
                    <div class="panel-title"><i class="fas fa-history" style="color:var(--text-light);"></i> Recent Transactions</div>
                    <a href="vouchers.html" style="font-size:12px; color:var(--primary); font-weight:600;">View All</a>
                </div>
                <div class="txn-list" id="txnList">
                    Loading...
                </div>
            </div>

            <div class="panel">
                <div class="panel-header">
                    <div class="panel-title"><i class="fas fa-exclamation-triangle" style="color:var(--danger);"></i> Low Stock Alert</div>
                </div>
                <div class="txn-list" id="lowStockList">
                    Loading...
                </div>
            </div>
        </div>
    </div>
</div>

<script src="db.js"></script>
<script>
    // Set Date
    document.getElementById('currentDate').innerText = new Date().toLocaleDateString('en-IN', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

    function toggleMenu() {
        document.getElementById('sidebar').classList.toggle('active');
        document.querySelector('.overlay').classList.toggle('active');
    }

    window.onload = async () => {
        await DB.init();
        loadDashboardData();
    };

    async function loadDashboardData() {
        // Fetch all necessary data
        const [items, ledgers, vouchers, entries, groups] = await Promise.all([
            DB.getAll('items'),
            DB.getAll('ledgers'),
            DB.getAll('vouchers'),
            DB.getAll('acct_entries'),
            DB.getAll('groups')
        ]);

        // 1. CALCULATE KPI (Receivables / Payables / Cash)
        let rec = 0, pay = 0, cash = 0;
        const debtorGid = groups.find(g => g.name === 'Sundry Debtors')?.id;
        const creditorGid = groups.find(g => g.name === 'Sundry Creditors')?.id;
        
        // Find Cash Ledgers
        const cashIds = ledgers.filter(l => l.name.toLowerCase().includes('cash')).map(l => l.id);

        ledgers.forEach(l => {
            // Get balance for this ledger
            const txns = entries.filter(e => e.ledger_id === l.id);
            const dr = txns.reduce((s,e)=>s+(e.debit||0),0);
            const cr = txns.reduce((s,e)=>s+(e.credit||0),0);
            const net = dr - cr; // Asset perspective

            if(l.group_id === debtorGid) rec += net;
            if(l.group_id === creditorGid) pay += (cr - dr); // Liability perspective
            if(cashIds.includes(l.id)) cash += net;
        });

        document.getElementById('totalRec').innerText = "₹" + Math.max(0, rec).toLocaleString('en-IN');
        document.getElementById('totalPay').innerText = "₹" + Math.max(0, pay).toLocaleString('en-IN');
        document.getElementById('cashBal').innerText = "₹" + cash.toLocaleString('en-IN');

        // 2. STOCK VALUE & LOW STOCK
        let stockValue = 0;
        let lowStockHtml = '';
        
        items.forEach(i => {
            const stock = i.current_stock || 0;
            stockValue += stock * (i.std_cost || 0);
            
            if(stock <= (i.reorder_level || 5)) {
                lowStockHtml += `
                    <div class="stock-item">
                        <div>
                            <div style="font-weight:600;">${i.name}</div>
                            <div style="font-size:11px; color:#64748b;">SKU: ${i.sku||'-'}</div>
                        </div>
                        <div style="text-align:right;">
                            <div class="stock-warn">${stock} ${i.unit}</div>
                        </div>
                    </div>`;
            }
        });

        document.getElementById('stockVal').innerText = "₹" + stockValue.toLocaleString('en-IN');
        document.getElementById('lowStockList').innerHTML = lowStockHtml || '<div style="padding:20px; text-align:center; font-size:13px; color:#94a3b8;">All items are well stocked!</div>';

        // 3. RECENT TRANSACTIONS (FIXED PARTY NAME)
        const recent = vouchers.sort((a,b) => b.id - a.id).slice(0, 10);
        let txnHtml = '';
        
        // Graph Data Prep
        let saleTotal = 0;
        let purchTotal = 0;
        vouchers.forEach(v => {
            if(v.type === 'Sales') saleTotal += v.amount;
            if(v.type === 'Purchase') purchTotal += v.amount;
        });

        recent.forEach(v => {
            let partyName = "Cash / Walk-in";
            // Lookup Party Name properly
            if(v.party_id && v.party_id !== 0) {
                const p = ledgers.find(l => l.id === v.party_id);
                if(p) partyName = p.name;
            }

            const isSale = v.type === 'Sales';
            const icon = isSale ? '<i class="fas fa-arrow-up"></i>' : '<i class="fas fa-arrow-down"></i>';
            const bg = isSale ? '#dcfce7' : '#fee2e2';
            const color = isSale ? '#166534' : '#991b1b';

            txnHtml += `
                <div class="txn-item">
                    <div style="display:flex; align-items:center;">
                        <div class="txn-icon" style="background:${bg}; color:${color};">${icon}</div>
                        <div>
                            <div style="font-weight:600; font-size:14px;">${partyName}</div>
                            <div style="font-size:11px; color:#64748b;">${v.type} #${v.voucher_no}</div>
                        </div>
                    </div>
                    <div style="font-weight:700; color:${color};">
                        ₹${v.amount.toLocaleString('en-IN')}
                    </div>
                </div>
            `;
        });
        document.getElementById('txnList').innerHTML = txnHtml || '<div style="padding:20px; text-align:center;">No recent activity</div>';

        // 4. RENDER GRAPH
        renderChart(saleTotal, purchTotal);
    }

    function renderChart(sales, purchase) {
        const ctx = document.getElementById('mainChart').getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Total Sales', 'Total Purchase'],
                datasets: [{
                    label: 'Amount (₹)',
                    data: [sales, purchase],
                    backgroundColor: ['#10b981', '#0d47a1'],
                    borderRadius: 5
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { y: { beginAtZero: true, grid: { display: false } }, x: { grid: { display: false } } }
            }
        });
    }
</script>
</body>
</html>