<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Purchase Entry - Arth Book</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #064e3b; --accent: #10b981; --bg: #f0fdf4; --text: #064e3b; --border: #d1fae5; }
        * { box-sizing: border-box; font-family: 'Inter', sans-serif; margin: 0; padding: 0; }
        body { display: flex; height: 100vh; background: var(--bg); color: var(--text); overflow: hidden; }

        .sidebar { width: 260px; background: #0f172a; padding: 20px; display: flex; flex-direction: column; flex-shrink: 0; }
        .nav-link { padding: 12px; margin-bottom: 5px; border-radius: 8px; color: #94a3b8; text-decoration: none; font-weight: 500; display: block; }
        .nav-link:hover, .nav-link.active { background: #1e293b; color: white; }

        .main { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; }
        .toolbar { background: white; padding: 10px; margin-bottom: 20px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .container { background: white; max-width: 1000px; margin: 0 auto; padding: 25px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 1px solid var(--border); }
        
        .grid-header { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        input, select { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; outline: none; }
        label { font-size: 12px; font-weight: 700; color: #64748b; display: block; margin-bottom: 5px; }
        
        .table-wrap { overflow-x: auto; margin-bottom: 20px; border: 1px solid var(--border); border-radius: 6px; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { background: var(--primary); color: white; padding: 10px; text-align: left; }
        td { border-bottom: 1px solid #e2e8f0; padding: 5px; }
        td input { border: none; background: transparent; padding: 5px; width: 100%; }
        
        .btn { padding: 10px 20px; border-radius: 6px; border: none; font-weight: 600; cursor: pointer; color: white; }
        .btn-add { background: #ecfdf5; color: var(--primary); border: 1px dashed var(--primary); width: 100%; margin-bottom: 20px; }
        .btn-save { background: var(--primary); }

        .totals { display: flex; justify-content: flex-end; gap: 30px; font-size: 14px; font-weight: 600; padding-top: 15px; border-top: 2px solid var(--border); }
        
        /* NEW STYLES FOR RECENT TABLE */
        .recent-box { margin-top:30px; background:white; padding:15px; border-radius:8px; border:1px solid var(--border); }
        .recent-table { width:100%; border-collapse:collapse; font-size:13px; }
        .recent-table th { background:#f1f5f9; padding:10px; text-align:left; color:#333; border-bottom: 2px solid #ddd; }
        .recent-table td { padding:10px; border-bottom:1px solid #eee; }
        .btn-del { background: #fee2e2; color: #ef4444; padding: 5px 10px; font-size: 12px; border-radius: 4px; cursor: pointer; border: 1px solid #fecaca; }
        .btn-del:hover { background: #fecaca; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div style="color:white; font-size:20px; font-weight:800; margin-bottom:30px;">üöÄ Arth Book</div>
        <a href="index.html" class="nav-link">üìä Dashboard</a>
        <a href="reports.html" class="nav-link">üìà Reports</a>
        <a href="gst_filing.html" class="nav-link">üèõÔ∏è GST Filing</a>
        <a href="sales_invoice.html" class="nav-link">üßæ Sales Invoice</a>
        <a href="purchase_invoice.html" class="nav-link active">üöö Purchase Entry</a>
        <a href="vouchers.html" class="nav-link">üí∏ Vouchers (JV)</a>
        <a href="item_master.html" class="nav-link">üì¶ Inventory</a>
        <a href="settings.html" class="nav-link">‚öôÔ∏è Settings</a>
    </div>

    <div class="main">
        <div class="toolbar">
            <h2 style="font-size:18px;">Purchase Entry</h2>
            <button class="btn btn-save" onclick="savePurchase()">üíæ Save Purchase</button>
        </div>

        <div class="container">
            <div class="grid-header">
                <div><label>Invoice No</label><input type="text" id="invNo"></div>
                <div><label>Date</label><input type="date" id="invDate"></div>
                <div><label>Supplier</label><select id="partySelect"></select></div>
            </div>

            <div class="table-wrap">
                <table id="itemTable">
                    <thead>
                        <tr>
                            <th width="40%">Item</th>
                            <th width="15%">Qty</th>
                            <th width="15%">Rate</th>
                            <th width="10%">Tax %</th>
                            <th width="15%">Total</th>
                            <th width="5%"></th>
                        </tr>
                    </thead>
                    <tbody id="rows"></tbody>
                </table>
            </div>
            <button class="btn btn-add" onclick="addRow()">+ Add Item</button>

            <div class="totals">
                <div>Taxable: <span id="lblTaxable">0.00</span></div>
                <div>Input GST: <span id="lblTax">0.00</span></div>
                <div style="font-size:18px; color:var(--primary);">Total: <span id="lblTotal">0.00</span></div>
            </div>
        </div>

        <div class="recent-box">
            <h3>Recent Purchases (Delete old entries here)</h3>
            <table class="recent-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Inv No</th>
                        <th>Supplier</th>
                        <th>Amount</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="recentList"></tbody>
            </table>
        </div>
    </div>

    <script src="db.js"></script>
    <script>
        let items = [], ledgers = [];

        window.onload = async () => {
            await DB.init();
            
            // --- SELF REPAIR: Check & Create System Ledgers ---
            await ensureLedger("Local Purchase", "Purchase Accounts");
            await ensureLedger("Input GST", "Duties & Taxes");

            await loadData();
            document.getElementById('invDate').valueAsDate = new Date();
            addRow();
        };

        async function ensureLedger(name, groupName) {
            const all = await DB.getAll('ledgers');
            if(!all.find(l => l.name === name)) {
                const groups = await DB.getAll('groups');
                const grp = groups.find(g => g.name === groupName) || groups[0];
                const tx = DB.db.transaction('ledgers', 'readwrite');
                tx.objectStore('ledgers').add({ name: name, group_id: grp.id, opening_balance: 0 });
                return new Promise(r => tx.oncomplete = r);
            }
        }

        async function loadData() {
            [items, ledgers] = await Promise.all([DB.getAll('items'), DB.getAll('ledgers')]);
            
            const sel = document.getElementById('partySelect');
            sel.innerHTML = '<option value="">Select Supplier</option>';
            ledgers.forEach(l => {
                if(!['Local Purchase', 'Input GST', 'Local Sales', 'Output GST'].includes(l.name)) {
                    sel.innerHTML += `<option value="${l.id}">${l.name}</option>`;
                }
            });

            // --- LOAD RECENT ENTRIES WITH DELETE BUTTON ---
            const vouchers = await DB.getAll('vouchers');
            const tbody = document.getElementById('recentList');
            tbody.innerHTML = '';
            
            // Sort by ID descending (newest first)
            const purchases = vouchers.filter(v => v.type === 'Purchase').sort((a,b) => b.id - a.id);

            purchases.forEach(v => {
                const partyName = ledgers.find(l => l.id == v.party_id)?.name || 'Unknown';
                tbody.innerHTML += `
                    <tr>
                        <td>${v.date}</td>
                        <td>${v.voucher_no}</td>
                        <td>${partyName}</td>
                        <td>‚Çπ${v.amount}</td>
                        <td>
                            <button class="btn-del" onclick="deleteVoucher(${v.id})">üóëÔ∏è Delete</button>
                        </td>
                    </tr>
                `;
            });
        }

        function addRow() {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>
                    <select class="item-sel" onchange="fillRow(this)" style="width:100%; border:none;">
                        <option value="">Select Item</option>
                        ${items.map(i => `<option value="${i.id}" data-rate="${i.std_cost}" data-gst="${i.gst_rate}">${i.name}</option>`).join('')}
                    </select>
                </td>
                <td><input type="number" class="qty" value="1" onchange="calc(this)"></td>
                <td><input type="number" class="rate" value="0" onchange="calc(this)"></td>
                <td><input type="number" class="gst" value="0" readonly></td>
                <td><input type="text" class="amt" value="0.00" readonly style="font-weight:bold; text-align:right;"></td>
                <td><button onclick="this.closest('tr').remove(); calcTotal()" style="color:red; background:none; border:none; cursor:pointer;">√ó</button></td>
            `;
            document.getElementById('rows').appendChild(tr);
        }

        function fillRow(el) {
            const opt = el.selectedOptions[0];
            const tr = el.closest('tr');
            tr.querySelector('.rate').value = opt.dataset.rate || 0;
            tr.querySelector('.gst').value = opt.dataset.gst || 0;
            calc(el);
        }

        function calc(el) {
            const tr = el.closest('tr');
            const qty = parseFloat(tr.querySelector('.qty').value) || 0;
            const rate = parseFloat(tr.querySelector('.rate').value) || 0;
            const gst = parseFloat(tr.querySelector('.gst').value) || 0;

            const basic = qty * rate;
            const tax = basic * (gst / 100);
            
            tr.querySelector('.amt').value = (basic + tax).toFixed(2);
            tr.dataset.basic = basic;
            tr.dataset.tax = tax;
            calcTotal();
        }

        function calcTotal() {
            let taxable = 0, tax = 0;
            document.querySelectorAll('#rows tr').forEach(tr => {
                taxable += parseFloat(tr.dataset.basic || 0);
                tax += parseFloat(tr.dataset.tax || 0);
            });
            document.getElementById('lblTaxable').innerText = taxable.toFixed(2);
            document.getElementById('lblTax').innerText = tax.toFixed(2);
            document.getElementById('lblTotal').innerText = (taxable + tax).toFixed(2);
        }

        async function savePurchase() {
            const pid = document.getElementById('partySelect').value;
            if(!pid) return alert("Select Supplier");

            const taxable = parseFloat(document.getElementById('lblTaxable').innerText);
            const tax = parseFloat(document.getElementById('lblTax').innerText);
            const total = parseFloat(document.getElementById('lblTotal').innerText);

            if(total === 0) return alert("Total is 0!");

            // --- ACCOUNTING FIX: Force System Ledgers ---
            const allLedgers = await DB.getAll('ledgers');
            const purchLedger = allLedgers.find(l => l.name === 'Local Purchase');
            const taxLedger = allLedgers.find(l => l.name === 'Input GST');

            if(!purchLedger || !taxLedger) return alert("System Ledgers Missing! Reload Page.");

            // Prepare Master
            const voucher = {
                voucher_no: document.getElementById('invNo').value || 'PUR-' + Date.now(),
                date: document.getElementById('invDate').value,
                type: 'Purchase',
                party_id: parseInt(pid),
                amount: total
            };

            const tx = DB.db.transaction(['vouchers', 'voucher_items', 'acct_entries', 'items'], 'readwrite');
            const vStore = tx.objectStore('vouchers');
            const vReq = vStore.add(voucher);

            vReq.onsuccess = (e) => {
                const vid = e.target.result;
                const acStore = tx.objectStore('acct_entries');
                
                // 1. Credit Party (Full Payable)
                acStore.add({ voucher_id: vid, ledger_id: parseInt(pid), credit: total, debit: 0 });

                // 2. Debit Purchase (Only Cost)
                acStore.add({ voucher_id: vid, ledger_id: purchLedger.id, credit: 0, debit: taxable });

                // 3. Debit Input Tax (Only Tax)
                if(tax > 0) {
                    acStore.add({ voucher_id: vid, ledger_id: taxLedger.id, credit: 0, debit: tax });
                }

                // 4. Save Items & Update Stock
                const viStore = tx.objectStore('voucher_items');
                const iStore = tx.objectStore('items');

                document.querySelectorAll('#rows tr').forEach(tr => {
                    const itemID = parseInt(tr.querySelector('.item-sel').value);
                    if(itemID) {
                        const qty = parseFloat(tr.querySelector('.qty').value);
                        const rate = parseFloat(tr.querySelector('.rate').value);
                        
                        viStore.add({ voucher_id: vid, item_id: itemID, qty, rate });

                        // Update Stock
                        const req = iStore.get(itemID);
                        req.onsuccess = (ev) => {
                            const d = ev.target.result;
                            if(d) {
                                d.current_stock = (parseFloat(d.current_stock) || 0) + qty;
                                // CRITICAL FIX: Only update cost, NOT assuming it includes tax
                                d.std_cost = rate; 
                                iStore.put(d);
                            }
                        }
                    }
                });
            };

            tx.oncomplete = () => {
                alert("Saved Correctly! Check Reports now.");
                location.reload();
            };
        }

        // --- NEW DELETE FUNCTION ---
        async function deleteVoucher(id) {
            if(!confirm("Are you sure you want to delete this purchase entry?")) return;
            
            // NOTE: In a real app we should also reverse stock, but for fixing bad data, direct delete is fine.
            const tx = DB.db.transaction(['vouchers', 'acct_entries', 'voucher_items'], 'readwrite');
            
            // Delete Master
            tx.objectStore('vouchers').delete(id);
            
            // Delete Related Accounting (This cleans the bad 0 GST entries)
            const acStore = tx.objectStore('acct_entries');
            const acIdx = acStore.index('voucher_id');
            const acReq = acIdx.getAllKeys(id);
            acReq.onsuccess = () => {
                acReq.result.forEach(key => acStore.delete(key));
            };

            // Delete Related Items
            const viStore = tx.objectStore('voucher_items');
            const viIdx = viStore.index('voucher_id');
            const viReq = viIdx.getAllKeys(id);
            viReq.onsuccess = () => {
                viReq.result.forEach(key => viStore.delete(key));
            };

            tx.oncomplete = () => {
                alert("Entry Deleted!");
                location.reload();
            };
        }
    </script>
</body>
</html>