<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="style.css">
    <title>Purchase Entry - Arth Book</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- ARTH BOOK PLATINUM THEME --- */
        :root {
            --primary: #0d47a1;     /* Royal Navy */
            --primary-dark: #002171;
            --accent: #ffca28;      /* Gold */
            --bg: #f1f5f9;
            --surface: #ffffff;
            --text-main: #1e293b;
            --text-sub: #64748b;
            --border: #e2e8f0;
            --success: #10b981;
            --danger: #ef4444;
            --sidebar-width: 260px;
            --shadow: 0 4px 6px -1px rgba(0,0,0,0.05), 0 10px 15px -3px rgba(0,0,0,0.05);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { display: flex; height: 100vh; background: var(--bg); color: var(--text-main); overflow: hidden; }

        /* --- SIDEBAR --- */
        .sidebar { 
            width: var(--sidebar-width); background: var(--primary); color: #e2e8f0; 
            display: flex; flex-direction: column; flex-shrink: 0; height: 100vh; 
            transition: all 0.3s ease-in-out; z-index: 1000; box-shadow: 4px 0 10px rgba(0,0,0,0.1);
        }
        .brand { 
            padding: 25px 20px; font-size: 22px; font-weight: 800; color: var(--accent); 
            display: flex; align-items: center; gap: 12px; border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .nav-links { list-style: none; padding: 15px 12px; flex: 1; overflow-y: auto; }
        .nav-links a { 
            display: flex; align-items: center; gap: 12px; padding: 12px 16px; 
            color: rgba(255,255,255,0.7); text-decoration: none; border-radius: 8px; 
            font-weight: 500; margin-bottom: 4px; transition: 0.2s; font-size: 14px;
        }
        .nav-links a:hover { background: rgba(255,255,255,0.1); color: white; padding-left: 20px; }
        .nav-links a.active { background: var(--accent); color: var(--primary-dark); font-weight: 800; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .nav-links i { width: 20px; text-align: center; }

        /* --- MAIN CONTENT --- */
        .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        
        /* TOOLBAR */
        .header { 
            background: var(--surface); height: 70px; padding: 0 30px; 
            border-bottom: 1px solid var(--border); display: flex; 
            justify-content: space-between; align-items: center; 
        }
        .header h2 { font-size: 1.25rem; font-weight: 700; color: var(--primary); display:flex; align-items:center; gap:10px; }
        
        /* SCROLL AREA */
        .scroll-area { padding: 30px; overflow-y: auto; flex: 1; }

        /* PURCHASE FORM CARD */
        .card { background: var(--surface); border-radius: 16px; padding: 30px; box-shadow: var(--shadow); border: 1px solid var(--border); margin-bottom: 30px; }
        
        .grid-header { display: grid; grid-template-columns: 1fr 1fr 2fr; gap: 20px; margin-bottom: 25px; }
        .form-group label { font-size: 0.85rem; font-weight: 600; color: var(--text-sub); display: block; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
        .form-group input, .form-group select { 
            width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; 
            font-size: 0.95rem; outline: none; transition: 0.2s; background: #f8fafc; font-weight: 500;
        }
        .form-group input:focus, .form-group select:focus { border-color: var(--primary); background: white; box-shadow: 0 0 0 4px rgba(13, 71, 161, 0.1); }

        /* ITEM TABLE */
        .table-container { border: 1px solid var(--border); border-radius: 12px; overflow: hidden; margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; font-size: 0.95rem; }
        th { background: var(--primary); color: white; padding: 15px; text-align: left; font-weight: 600; font-size: 0.85rem; text-transform: uppercase; }
        td { padding: 10px 15px; border-bottom: 1px solid var(--border); vertical-align: middle; background: white; }
        
        /* Table Inputs */
        td input, td select { padding: 8px; border: 1px solid var(--border); border-radius: 6px; width: 100%; outline: none; }
        td input:focus { border-color: var(--accent); }

        /* BUTTONS */
        .btn { padding: 12px 24px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; transition: 0.2s; display: inline-flex; align-items: center; gap: 8px; font-size: 0.95rem; }
        .btn-add { background: #eff6ff; color: var(--primary); border: 2px dashed #bfdbfe; width: 100%; justify-content: center; margin-bottom: 20px; }
        .btn-add:hover { background: #dbeafe; border-color: var(--primary); }
        .btn-save { background: var(--success); color: white; box-shadow: 0 4px 6px rgba(16, 185, 129, 0.2); }
        .btn-save:hover { transform: translateY(-2px); filter: brightness(105%); }

        /* TOTALS SECTION */
        .totals { display: flex; flex-direction: column; align-items: flex-end; gap: 12px; padding-top: 20px; border-top: 2px dashed var(--border); }
        .total-row { display: flex; gap: 30px; font-size: 0.95rem; color: var(--text-sub); font-weight: 500; }
        .total-row span:last-child { color: var(--text-main); font-weight: 700; min-width: 100px; text-align: right; }
        .grand-total { font-size: 1.8rem; font-weight: 800; color: var(--primary); margin-top: 10px; display: flex; gap: 20px; align-items: center; }

        /* RECENT LIST */
        .recent-section h3 { color: var(--text-main); font-size: 1.1rem; margin-bottom: 15px; font-weight: 700; }
        .recent-table th { background: #f1f5f9; color: var(--text-main); }
        .status-badge { background: #dcfce7; color: #166534; padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; }

        /* RESPONSIVE */
        .menu-btn { display: none; font-size: 20px; color: var(--primary); cursor: pointer; margin-right: 15px; }

        @media (max-width: 1024px) {
            .sidebar { position: fixed; left: -100%; }
            .sidebar.active { left: 0; }
            .menu-btn { display: block; }
            
            .header { padding: 0 15px; }
            .scroll-area { padding: 15px; }
            .card { padding: 20px; }
            
            .grid-header { grid-template-columns: 1fr; gap: 15px; } /* Stack inputs */
            .table-container { overflow-x: auto; }
            table { min-width: 600px; } /* Force scroll for table */
            
            .grand-total { font-size: 1.4rem; }
        }

        @media print {
            .sidebar, .header, .btn-add, .recent-section, .no-print { display: none !important; }
            .card { box-shadow: none; border: none; padding: 0; margin: 0; }
            body { background: white; height: auto; overflow: visible; }
            .scroll-area { overflow: visible; padding: 0; }
        }
    </style>
</head>
<body>

     <div class="sidebar" id="sidebar">
        <div class="brand-logo" style="padding: 20px; font-size: 20px; font-weight: 800; color: white; display: flex; align-items: center; gap: 10px;">
            <i class="fas fa-cube"></i> Arth Book
        </div>
        <ul class="nav-links" style="list-style: none; padding: 0 10px;">
            <li><a href="index.html"><i class="fas fa-home"></i> Dashboard</a></li>
            <li><a href="sales_invoice.html"><i class="fas fa-file-invoice"></i> Sales (POS)</a></li>
            <li><a href="purchase_invoice.html"><i class="fas fa-truck"></i> Purchase</a></li>
            <li><a href="vouchers.html"><i class="fas fa-receipt"></i> Day Book</a></li>
            
            <li style="margin-top:15px; margin-bottom:5px; font-size:11px; color:#64748b; font-weight:bold; padding-left:15px; text-transform:uppercase;">Masters</li>
            <li><a href="item_master.html"><i class="fas fa-boxes"></i> Inventory</a></li>
            <li><a href="ArthBook.html"><i class="fas fa-users"></i> Parties</a></li>
            <li><a href="coa.html"><i class="fas fa-sitemap"></i> Accounts</a></li>
            
            <li style="margin-top:15px; margin-bottom:5px; font-size:11px; color:#64748b; font-weight:bold; padding-left:15px; text-transform:uppercase;">Reports & Tax</li>
            <li><a href="reports.html"><i class="fas fa-chart-line"></i> Reports</a></li>
            <li><a href="gst_filing.html"><i class="fas fa-university"></i> GST Returns</a></li>
            <li><a href="taxation.html"><i class="fas fa-calculator"></i> Tax / ITR</a></li>
            
            <hr style="border:0; border-top:1px solid rgba(255,255,255,0.1); margin:15px 5px;">
            <li><a href="settings.html"><i class="fas fa-cog"></i> Settings</a></li>
            <li><a href="help.html"><i class="fas fa-question-circle"></i> Help</a></li>
        </ul>
        
        <div style="padding: 20px; font-size: 11px; color: #64748b; text-align: center; margin-top:auto;">
            Arth Book v4.0<br>Authorized User
        </div>
    </div>

    <div class="main-content">
        <div class="header">
            <div style="display:flex; align-items:center;">
                <i class="fas fa-bars menu-btn" onclick="document.getElementById('sidebar').classList.toggle('active')"></i>
                <h2><i class="fas fa-truck-loading" style="color:var(--accent);"></i> New Purchase</h2>
            </div>
            <button class="btn btn-save" onclick="savePurchase()">
                <i class="fas fa-save"></i> Save Entry
            </button>
        </div>

        <div class="scroll-area">
            <div class="card">
                <div class="grid-header">
                    <div class="form-group">
                        <label>Invoice No (Bill No)</label>
                        <input type="text" id="invNo" placeholder="e.g. PUR-001">
                    </div>
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" id="invDate">
                    </div>
                    <div class="form-group">
                        <label>Supplier (Party)</label>
                        <select id="partySelect"></select>
                    </div>
                </div>

                <div class="table-container">
                    <table id="itemTable">
                        <thead>
                            <tr>
                                <th width="40%">Item / Product</th>
                                <th width="15%">Qty</th>
                                <th width="15%">Rate</th>
                                <th width="10%">Tax %</th>
                                <th width="15%" style="text-align:right;">Total</th>
                                <th width="5%"></th>
                            </tr>
                        </thead>
                        <tbody id="rows"></tbody>
                    </table>
                </div>
                
                <button class="btn btn-add" onclick="addRow()">
                    <i class="fas fa-plus-circle"></i> Add Another Line
                </button>

                <div class="totals">
                    <div class="total-row"><span>Sub Total:</span> <span id="lblTaxable">0.00</span></div>
                    <div class="total-row"><span>Input GST:</span> <span id="lblTax">0.00</span></div>
                    <div class="grand-total"><span>Total:</span> ₹ <span id="lblTotal">0.00</span></div>
                </div>
            </div>

            <div class="recent-section no-print">
                <h3><i class="fas fa-history"></i> Recent Purchases</h3>
                <div class="table-container" style="background:white; margin-bottom: 50px;">
                    <table class="recent-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Inv No</th>
                                <th>Supplier</th>
                                <th>Amount</th>
                                <th style="text-align:right;">Action</th>
                            </tr>
                        </thead>
                        <tbody id="recentList">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="db.js"></script>
   <script src="db.js"></script>
    <script>let items = [], ledgers = [], settings = {}, groups = [];

        window.onload = async () => {
            await DB.init();
            
            // 1. Load All Data safely
            try {
                [items, ledgers, settings, groups] = await Promise.all([
                    DB.getAll('items'),
                    DB.getAll('ledgers'),
                    DB.getAll('settings'),
                    DB.getAll('groups')
                ]);
            } catch(e) { console.error("Data load error", e); }

            // 2. Populate Supplier Dropdown (SMART FILTER)
            const sel = document.getElementById('partySelect');
            sel.innerHTML = '<option value="">Select Supplier / Party</option>';
            
            // A. Find correct Group IDs by Name
            const targetNames = ['Sundry Creditors', 'Cash-in-Hand', 'Bank Accounts'];
            const allowedGroupIds = groups
                .filter(g => targetNames.includes(g.name))
                .map(g => g.id);

            // B. Filter Ledgers based on allowed IDs
            const validParties = ledgers.filter(l => allowedGroupIds.includes(l.group_id));

            // C. Show in Dropdown
            if(validParties.length > 0) {
                validParties.sort((a,b) => a.name.localeCompare(b.name));
                validParties.forEach(l => {
                    const gName = groups.find(g => g.id === l.group_id)?.name || '';
                    sel.innerHTML += `<option value="${l.id}">${l.name} (${gName})</option>`;
                });
            } else {
                sel.innerHTML = '<option value="">No Suppliers Found (Create in Parties)</option>';
            }

            document.getElementById('invDate').valueAsDate = new Date();
            loadRecentList();
            addRow(); // Default row
        };

        // Mobile Sidebar Logic (Keep Sidebar hidden on small screens)
        function toggleMenu() {
            document.getElementById('sidebar').classList.toggle('active');
            document.querySelector('.overlay').classList.toggle('active');
        }

        // ROW MANAGEMENT
        function addRow() {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>
                    <select class="item-sel" onchange="fillRow(this)">
                        <option value="">Select Item</option>
                        ${items.map(i => `<option value="${i.id}" data-rate="${i.std_cost}" data-gst="${i.gst_rate}">${i.name}</option>`).join('')}
                    </select>
                </td>
                <td><input type="number" class="qty" value="1" min="1" onchange="calc(this)"></td>
                <td><input type="number" class="rate" value="0" min="0" onchange="calc(this)"></td>
                <td><input type="number" class="gst" value="0" readonly style="background:#f1f5f9;"></td>
                <td><input type="text" class="amt" value="0.00" readonly style="background:#f1f5f9; text-align:right; font-weight:bold;"></td>
                <td style="text-align:center;"><i class="fas fa-trash-alt" onclick="removeRow(this)" style="color:var(--danger-color); cursor:pointer;"></i></td>
            `;
            document.getElementById('rows').appendChild(tr);
        }

        function removeRow(btn) {
            const rows = document.querySelectorAll('#rows tr');
            if(rows.length > 1) {
                btn.closest('tr').remove();
                calcTotal();
            } else {
                // If only 1 row, just clear values
                const tr = rows[0];
                tr.querySelector('.item-sel').value = "";
                tr.querySelector('.qty').value = 1;
                tr.querySelector('.rate').value = 0;
                tr.querySelector('.gst').value = 0;
                tr.querySelector('.amt').value = "0.00";
                tr.dataset.basic = 0; tr.dataset.tax = 0;
                calcTotal();
            }
        }

        function fillRow(el) {
            const opt = el.selectedOptions[0];
            const tr = el.closest('tr');
            if(opt.value) {
                tr.querySelector('.rate').value = opt.dataset.rate || 0;
                tr.querySelector('.gst').value = opt.dataset.gst || 0;
                calc(el);
            }
        }

        function calc(el) {
            const tr = el.closest('tr');
            const qty = parseFloat(tr.querySelector('.qty').value) || 0;
            const rate = parseFloat(tr.querySelector('.rate').value) || 0;
            const gst = parseFloat(tr.querySelector('.gst').value) || 0;

            const basic = qty * rate;
            const tax = basic * (gst / 100);
            
            tr.querySelector('.amt').value = (basic + tax).toFixed(2);
            tr.dataset.basic = basic;
            tr.dataset.tax = tax;
            calcTotal();
        }

        function calcTotal() {
            let taxable = 0, tax = 0;
            document.querySelectorAll('#rows tr').forEach(tr => {
                taxable += parseFloat(tr.dataset.basic || 0);
                tax += parseFloat(tr.dataset.tax || 0);
            });
            document.getElementById('lblTaxable').innerText = taxable.toFixed(2);
            document.getElementById('lblTax').innerText = tax.toFixed(2);
            document.getElementById('lblTotal').innerText = (taxable + tax).toFixed(2);
        }

        async function savePurchase() {
            const pid = document.getElementById('partySelect').value;
            const date = document.getElementById('invDate').value;
            const invNo = document.getElementById('invNo').value.trim();
            
            if(!invNo) return alert("Enter Bill Number (Invoice No)");
            if(!pid) return alert("Select Supplier");

            const taxable = parseFloat(document.getElementById('lblTaxable').innerText);
            const taxTotal = parseFloat(document.getElementById('lblTax').innerText);
            const grand = parseFloat(document.getElementById('lblTotal').innerText);

            if(grand <= 0) return alert("Total cannot be zero");

            // 1. Prepare Voucher Object
            const voucher = {
                voucher_no: invNo,
                date: date,
                type: 'Purchase',
                party_id: parseInt(pid),
                amount: grand,
                narration: `Purchase Invoice #${invNo}`
            };

            // 2. Prepare Accounting Entries
            const entries = [];
            
            // A. Credit the Supplier (We owe them money)
            entries.push({ ledger_id: parseInt(pid), credit: grand, debit: 0 });

            // B. Debit Purchase Account (Expense)
            // Logic: Find 'Local Purchase' ledger OR any ledger under 'Purchase Accounts' group
            let purL = ledgers.find(l => l.name === 'Local Purchase');
            if(!purL) {
                const purGroupId = groups.find(g => g.name === 'Purchase Accounts')?.id;
                if(purGroupId) purL = ledgers.find(l => l.group_id === purGroupId);
            }
            const purId = purL ? purL.id : 0; // 0 is fallback if setup is broken
            
            entries.push({ ledger_id: purId, debit: taxable, credit: 0 });

            // C. Debit Tax Account (Input GST)
            if(taxTotal > 0) {
                let taxL = ledgers.find(l => l.name === 'Input GST');
                if(!taxL) {
                     const taxGroupId = groups.find(g => g.name === 'Duties & Taxes')?.id;
                     if(taxGroupId) taxL = ledgers.find(l => l.group_id === taxGroupId);
                }
                if(taxL) entries.push({ ledger_id: taxL.id, debit: taxTotal, credit: 0 });
            }

            // 3. Prepare Inventory Meta Data (For Stock Update)
            // We create dummy entries to carry stock movement data for DB.js to process
            document.querySelectorAll('#rows tr').forEach(tr => {
                const itemId = tr.querySelector('.item-sel').value;
                if(itemId) {
                    const qty = parseFloat(tr.querySelector('.qty').value);
                    const rate = parseFloat(tr.querySelector('.rate').value);
                    
                    entries.push({
                        ledger_id: purId, 
                        debit: 0, credit: 0, // Zero value, just carrying info
                        meta_data: { item_id: parseInt(itemId), qty: qty, rate: rate }
                    });
                }
            });

            try {
                // DB.js handles transaction & stock update automatically
                await DB.saveVoucherTransaction(voucher, entries);
                alert("✅ Purchase Saved Successfully! Stock Updated.");
                location.reload();
            } catch(e) {
                console.error(e);
                alert("Error saving: " + e.message);
            }
        }

        async function loadRecentList() {
            const vouchers = await DB.getAll('vouchers');
            const tbody = document.getElementById('recentList');
            
            // Filter Purchases & Sort by Date Descending
            const purchases = vouchers.filter(v => v.type === 'Purchase').sort((a,b) => b.id - a.id);
            
            if(purchases.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center" style="padding:20px; color:#94a3b8;">No recent purchases</td></tr>';
                return;
            }

            tbody.innerHTML = purchases.slice(0, 5).map(v => {
                const party = ledgers.find(l => l.id == v.party_id)?.name || 'Unknown Party';
                return `
                    <tr>
                        <td>${v.date}</td>
                        <td><span style="font-weight:600; color:var(--primary-color);">${v.voucher_no}</span></td>
                        <td>${party}</td>
                        <td style="font-family:monospace; font-weight:600;">₹${v.amount.toFixed(2)}</td>
                        <td class="text-right">
                            <button class="btn" style="padding:6px 10px; background:#fee2e2; color:#ef4444; font-size:12px; border-radius:4px; border:none; cursor:pointer;" onclick="deleteBill(${v.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        async function deleteBill(id) {
            if(confirm("⚠️ Warning: Deleting this bill will REDUCE the stock that was added. Continue?")) {
                try {
                    await DB.deleteVoucher(id);
                    loadRecentList();
                } catch(e) {
                    alert("Delete Failed: " + e);
                }
            }
        } </script>
</body>
</html>