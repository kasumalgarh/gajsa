<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="icon" type="image/x-icon" href="favicon.ico">
    <title>Money Wise Pro - Ledger Master</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --sidebar-bg: #0f172a; --sidebar-text: #94a3b8; --active-text: #f8fafc;
            --bg: #f8fafc; --card-bg: #ffffff;
            --accent: #6366f1; --text: #1e293b; --border: #e2e8f0; --muted: #64748b;
            --green: #10b981; --red: #ef4444; --blue: #3b82f6;
        }
        * { box-sizing: border-box; font-family: 'Inter', sans-serif; margin: 0; padding: 0; }
        body { display: flex; height: 100vh; background: var(--bg); color: var(--text); overflow: hidden; }

        /* SIDEBAR */
        .sidebar { width: 260px; background: var(--sidebar-bg); padding: 20px; display: flex; flex-direction: column; flex-shrink: 0; }
        .nav-link { padding: 12px 15px; margin-bottom: 5px; border-radius: 8px; color: var(--sidebar-text); text-decoration: none; font-weight: 500; display: flex; align-items: center; gap: 12px; transition: 0.2s; font-size: 14px; }
        .nav-link:hover, .nav-link.active { background: #1e293b; color: var(--active-text); }
        .nav-icon { font-size: 18px; }

        /* MAIN CONTENT */
        .main { flex: 1; padding: 20px; overflow-y: auto; display: flex; gap: 20px; }
        
        /* LEFT: LIST PANEL */
        .list-panel { width: 320px; background: #fff; border-radius: 12px; border: 1px solid var(--border); display: flex; flex-direction: column; }
        .search-box { padding: 15px; border-bottom: 1px solid var(--border); background: #f8fafc; border-radius: 12px 12px 0 0; }
        .search-box input { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; outline: none; }
        
        .list-content { flex: 1; overflow-y: auto; }
        .ledger-item { padding: 12px 15px; border-bottom: 1px solid #f1f5f9; cursor: pointer; transition: 0.2s; display: flex; justify-content: space-between; align-items: center; }
        .ledger-item:hover { background: #f0f9ff; }
        .ledger-item.active { background: #e0e7ff; border-left: 4px solid var(--accent); }
        .l-name { font-weight: 600; font-size: 14px; color: #334155; }
        .l-sub { font-size: 11px; color: var(--muted); margin-top: 2px; }
        .l-bal { font-size: 12px; font-weight: 700; }
        .dr { color: var(--green); } .cr { color: var(--red); }

        /* RIGHT: FORM PANEL */
        .form-panel { flex: 1; background: #fff; border-radius: 12px; border: 1px solid var(--border); padding: 30px; display: flex; flex-direction: column; overflow-y: auto; }
        .form-header { margin-bottom: 25px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); padding-bottom: 15px; }
        .form-header h2 { font-size: 20px; font-weight: 700; color: #1e293b; }

        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .field { margin-bottom: 5px; }
        .full-width { grid-column: span 2; }
        
        label { display: block; font-size: 12px; font-weight: 600; color: var(--muted); margin-bottom: 5px; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 14px; outline: none; transition: 0.2s; background: #fff; }
        input:focus, select:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(99,102,241,0.1); }
        
        .section-title { font-size: 11px; font-weight: 700; color: var(--accent); text-transform: uppercase; letter-spacing: 0.5px; margin-top: 15px; margin-bottom: 10px; border-bottom: 1px solid #e2e8f0; padding-bottom: 5px; grid-column: span 2; }

        .btn-group { display: flex; gap: 10px; margin-top: 30px; }
        button { padding: 10px 24px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; transition: 0.2s; }
        .btn-save { background: var(--accent); color: white; }
        .btn-new { background: #e2e8f0; color: #475569; }
        .btn-del { background: #fee2e2; color: var(--red); margin-left: auto; }

        #toast { position: fixed; bottom: 30px; right: 30px; background: var(--green); color: white; padding: 12px 24px; border-radius: 8px; display: none; box-shadow: 0 4px 15px rgba(0,0,0,0.2); font-weight: 600; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div style="font-size: 20px; font-weight: 800; color: #fff; margin-bottom: 40px;">üöÄ MoneyWise Pro</div>
        <a href="index.html" class="nav-link"><span class="nav-icon">üìä</span> Dashboard</a>
        <a href="reports.html" class="nav-link"><span class="nav-icon">üìà</span> Reports</a>
        <a href="gst_filing.html" class="nav-link"><span class="nav-icon">üèõÔ∏è</span> GST Filing</a>
        <a href="sales_invoice.html" class="nav-link"><span class="nav-icon">üßæ</span> Sales Invoice</a>
        <a href="purchase_invoice.html" class="nav-link"><span class="nav-icon">üöö</span> Purchase Entry</a>
        <a href="vouchers.html" class="nav-link"><span class="nav-icon">üí∏</span> Vouchers (JV)</a>
        <a href="item_master.html" class="nav-link"><span class="nav-icon">üì¶</span> Inventory</a>
        <a href="moneywise.html" class="nav-link active"><span class="nav-icon">üë•</span> Parties</a>
        <a href="coa.html" class="nav-link"><span class="nav-icon">üóÇÔ∏è</span> Accounts</a>
        <a href="settings.html" class="nav-link"><span class="nav-icon">‚öôÔ∏è</span> Settings</a>
    </div>

    <div class="main">
        <div class="list-panel">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Search Party..." onkeyup="renderList(this.value)">
            </div>
            <div class="list-content" id="ledgerList"></div>
        </div>

        <div class="form-panel">
            <div class="form-header">
                <h2>Party / Ledger Master</h2>
                <button class="btn-new" onclick="resetForm()">+ New Party</button>
            </div>
            <input type="hidden" id="ledgerId">

            <div class="form-grid">
                <div class="section-title">Basic Information</div>
                <div class="field full-width">
                    <label>Ledger Name *</label>
                    <input type="text" id="lName" placeholder="e.g. Rahul Traders" required>
                </div>
                <div class="field">
                    <label>Under Group *</label>
                    <select id="groupSelect"><option value="">-- Select Group --</option></select>
                </div>
                <div class="field">
                    <label>Contact Person / Phone</label>
                    <input type="text" id="lPhone" placeholder="Mobile Number">
                </div>

                <div class="section-title">Tax & Registration</div>
                <div class="field">
                    <label>Registration Type</label>
                    <select id="lRegType" onchange="toggleGSTField()">
                        <option value="Regular">Regular (With GSTIN)</option>
                        <option value="Unregistered" selected>Unregistered</option>
                        <option value="Composition">Composition</option>
                        <option value="Consumer">Consumer</option>
                    </select>
                </div>
                <div class="field">
                    <label>GSTIN</label>
                    <input type="text" id="lGST" placeholder="NA" maxlength="15">
                </div>
                <div class="field">
                    <label>State</label>
                    <select id="lState"><option value="">-- Select State --</option></select>
                </div>
                <div class="field">
                    <label>Address</label>
                    <input type="text" id="lAddr" placeholder="City, Area">
                </div>

                <div class="section-title">Credit Limits & Banking</div>
                <div class="field">
                    <label>Credit Limit (‚Çπ)</label>
                    <input type="number" id="lLimit" placeholder="Max Credit Allowed">
                </div>
                <div class="field">
                    <label>Credit Period (Days)</label>
                    <input type="number" id="lDays" placeholder="e.g. 30">
                </div>

                <div class="section-title">Opening Balance</div>
                <div class="field">
                    <label>Amount</label>
                    <div style="display:flex; gap:5px;">
                        <input type="number" id="opBal" value="0">
                        <select id="opType" style="width:80px;"><option value="Dr">Dr</option><option value="Cr">Cr</option></select>
                    </div>
                </div>
                <div class="field">
                    <label>As On Date</label>
                    <input type="date" id="opDate">
                </div>
            </div>

            <div class="btn-group">
                <button class="btn-save" onclick="saveLedger()">Save Party (Alt+S)</button>
                <button class="btn-del" onclick="deleteLedger()" id="delBtn" style="display:none;">Delete</button>
            </div>
        </div>
    </div>

    <div id="toast">Saved Successfully!</div>

    <script src="db.js"></script><script src="auth.js"></script>
    <script>
        // 1. HARDCODED STATES (No DB needed)
        const INDIAN_STATES = [
            { code: "35", name: "Andaman & Nicobar Islands" }, { code: "37", name: "Andhra Pradesh" },
            { code: "12", name: "Arunachal Pradesh" }, { code: "18", name: "Assam" },
            { code: "10", name: "Bihar" }, { code: "04", name: "Chandigarh" },
            { code: "22", name: "Chhattisgarh" }, { code: "26", name: "Dadra & Nagar Haveli" },
            { code: "07", name: "Delhi" }, { code: "30", name: "Goa" },
            { code: "24", name: "Gujarat" }, { code: "06", name: "Haryana" },
            { code: "02", name: "Himachal Pradesh" }, { code: "01", name: "Jammu & Kashmir" },
            { code: "20", name: "Jharkhand" }, { code: "29", name: "Karnataka" },
            { code: "32", name: "Kerala" }, { code: "31", name: "Lakshadweep" },
            { code: "23", name: "Madhya Pradesh" }, { code: "27", name: "Maharashtra" },
            { code: "14", name: "Manipur" }, { code: "17", name: "Meghalaya" },
            { code: "15", name: "Mizoram" }, { code: "13", name: "Nagaland" },
            { code: "21", name: "Odisha" }, { code: "34", name: "Puducherry" },
            { code: "03", name: "Punjab" }, { code: "08", name: "Rajasthan" },
            { code: "11", name: "Sikkim" }, { code: "33", name: "Tamil Nadu" },
            { code: "36", name: "Telangana" }, { code: "16", name: "Tripura" },
            { code: "09", name: "Uttar Pradesh" }, { code: "05", name: "Uttarakhand" },
            { code: "19", name: "West Bengal" }
        ];

        let groups=[], ledgers=[];

        window.onload = async () => {
            await DB.init();
            
            // 2. FETCH DATA (Using Generic getAll if helper missing)
            groups = await DB.getAll('groups');
            ledgers = await DB.getAll('ledgers');

            populateDropdowns();
            renderList();
            document.getElementById('opDate').valueAsDate = new Date();
        };

        function populateDropdowns() {
            // Groups
            const gSel = document.getElementById('groupSelect');
            gSel.innerHTML = '<option value="">-- Select Group --</option>';
            groups.sort((a,b)=>a.name.localeCompare(b.name)).forEach(g => {
                let op = document.createElement('option');
                op.value = g.id; op.text = g.name;
                gSel.appendChild(op);
            });

            // States (From Local Array)
            const sSel = document.getElementById('lState');
            sSel.innerHTML = '<option value="">-- Select State --</option>';
            INDIAN_STATES.forEach(s => {
                let op = document.createElement('option');
                op.value = s.code; op.text = s.name;
                sSel.appendChild(op);
            });
        }

        function toggleGSTField() {
            const type = document.getElementById('lRegType').value;
            const gstInput = document.getElementById('lGST');
            if(type === 'Unregistered' || type === 'Consumer') {
                gstInput.placeholder = "NA";
            } else {
                gstInput.placeholder = "Enter GSTIN";
            }
        }

        function renderList(q = "") {
            const list = document.getElementById('ledgerList');
            list.innerHTML = '';
            
            const filtered = ledgers.filter(l => l.name.toLowerCase().includes(q.toLowerCase()));
            
            if(filtered.length === 0) {
                list.innerHTML = '<div style="padding:20px; text-align:center; color:#ccc;">No Parties Found</div>';
                return;
            }

            filtered.sort((a,b)=>a.name.localeCompare(b.name)).forEach(l => {
                const grp = groups.find(g => g.id == l.group_id)?.name || '-';
                let balHtml = '<span style="color:#cbd5e1">-</span>';
                if(l.opening_balance) {
                    const type = l.opening_balance > 0 ? 'Dr' : 'Cr';
                    balHtml = `<span class="l-bal ${type.toLowerCase()}">‚Çπ${Math.abs(l.opening_balance)} ${type}</span>`;
                }

                const div = document.createElement('div');
                div.className = 'ledger-item';
                div.onclick = () => loadLedger(l);
                div.innerHTML = `
                    <div>
                        <div class="l-name">${l.name}</div>
                        <div class="l-sub">${grp} ‚Ä¢ ${l.reg_type || 'Unreg'}</div>
                    </div>
                    ${balHtml}
                `;
                list.appendChild(div);
            });
        }

        function loadLedger(l) {
            document.getElementById('ledgerId').value = l.id;
            document.getElementById('lName').value = l.name;
            document.getElementById('groupSelect').value = l.group_id;
            document.getElementById('lPhone').value = l.phone || '';
            document.getElementById('lRegType').value = l.reg_type || 'Unregistered';
            document.getElementById('lGST').value = l.gstin || '';
            document.getElementById('lState').value = l.state_code || '';
            document.getElementById('lAddr').value = l.address || '';
            
            document.getElementById('lLimit').value = l.credit_limit || '';
            document.getElementById('lDays').value = l.credit_days || '';
            
            document.getElementById('opBal').value = Math.abs(l.opening_balance || 0);
            document.getElementById('opType').value = (l.opening_balance || 0) >= 0 ? 'Dr' : 'Cr';
            document.getElementById('opDate').value = l.op_date || new Date().toISOString().slice(0,10);

            document.getElementById('delBtn').style.display = 'block';
            toggleGSTField();
        }

        function resetForm() {
            document.querySelectorAll('input').forEach(i => i.value = '');
            document.getElementById('ledgerId').value = '';
            document.getElementById('groupSelect').value = '';
            document.getElementById('opBal').value = 0;
            document.getElementById('lRegType').value = 'Unregistered';
            document.getElementById('opDate').valueAsDate = new Date();
            document.getElementById('delBtn').style.display = 'none';
            document.getElementById('lName').focus();
        }

        // 3. ROBUST SAVE LOGIC (Direct Transaction)
        async function saveLedger() {
            const name = document.getElementById('lName').value;
            const grp = document.getElementById('groupSelect').value;
            if(!name || !grp) return alert("Name & Group required!");

            let bal = parseFloat(document.getElementById('opBal').value) || 0;
            if(document.getElementById('opType').value === 'Cr') bal = -bal;

            const data = {
                name: name,
                group_id: parseInt(grp),
                phone: document.getElementById('lPhone').value,
                reg_type: document.getElementById('lRegType').value,
                gstin: document.getElementById('lGST').value,
                state_code: document.getElementById('lState').value,
                address: document.getElementById('lAddr').value,
                credit_limit: parseFloat(document.getElementById('lLimit').value) || 0,
                credit_days: parseInt(document.getElementById('lDays').value) || 0,
                opening_balance: bal,
                op_date: document.getElementById('opDate').value
            };

            const id = document.getElementById('ledgerId').value;
            
            // Direct IndexedDB Transaction
            const tx = DB.db.transaction('ledgers', 'readwrite');
            const store = tx.objectStore('ledgers');
            
            if(id) {
                data.id = parseInt(id);
                store.put(data);
            } else {
                store.add(data);
            }

            tx.oncomplete = async () => {
                showToast();
                ledgers = await DB.getAll('ledgers'); // Refresh
                renderList(document.getElementById('searchInput').value);
                resetForm();
            };
            
            tx.onerror = (e) => alert("Error saving: " + e.target.error);
        }

        // 4. ROBUST DELETE LOGIC
        async function deleteLedger() {
            const id = document.getElementById('ledgerId').value;
            if(!id) return;
            if(confirm("Delete this party?")) {
                const tx = DB.db.transaction('ledgers', 'readwrite');
                tx.objectStore('ledgers').delete(parseInt(id));
                
                tx.oncomplete = async () => {
                    ledgers = await DB.getAll('ledgers');
                    renderList();
                    resetForm();
                };
                
                tx.onerror = (e) => alert("Cannot delete: " + e.target.error);
            }
        }

        function showToast() {
            const t = document.getElementById('toast');
            t.style.display='block';
            setTimeout(()=>t.style.display='none', 2000);
        }

        // Shortcut
        document.addEventListener('keydown', e => {
            if(e.altKey && e.key.toLowerCase() === 's') saveLedger();
            if(e.altKey && e.key.toLowerCase() === 'n') resetForm();
        });
    </script>
</body>
</html>