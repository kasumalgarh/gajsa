<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <title>Accounting Desk - Arth Book</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root { --bg: #f3f4f6; --text: #1e293b; --border: #e5e7eb; --green: #10b981; --red: #ef4444; --blue: #3b82f6; --purple: #8b5cf6; --sidebar-bg: #0f172a; }
        * { box-sizing: border-box; font-family: 'Inter', sans-serif; margin: 0; padding: 0; }
        
        body { 
            display: flex;       
            height: 100vh;       
            background: var(--bg); 
            color: var(--text); 
            overflow: hidden;    
        }

        /* SIDEBAR */
        .sidebar { 
            width: 260px; 
            background: var(--sidebar-bg); 
            padding: 20px; 
            display: flex; 
            flex-direction: column; 
            flex-shrink: 0;      
            height: 100vh;       
            overflow-y: auto;    
            z-index: 100;
            transition: 0.3s;
        }
        
        .nav-link { padding: 12px 15px; margin-bottom: 5px; border-radius: 8px; color: #94a3b8; text-decoration: none; font-weight: 500; display: block; font-size: 14px; transition: 0.2s; }
        .nav-link:hover, .nav-link.active { background: #1e293b; color: #f8fafc; }

        /* MAIN CONTENT */
        .main { 
            flex: 1;             
            padding: 20px; 
            overflow-y: auto;    
            height: 100vh;       
            display: flex;       
            flex-direction: column;
            gap: 20px; 
        }

        /* CARDS & UI */
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border: 1px solid var(--border); height: fit-content; }
        
        /* TABS */
        .tabs { display: flex; margin-bottom: 20px; background: #f1f5f9; padding: 4px; border-radius: 8px; overflow-x: auto; }
        .tab { flex: 1; text-align: center; padding: 10px; cursor: pointer; border-radius: 6px; font-weight: 600; font-size: 13px; transition: 0.2s; white-space: nowrap; }
        .tab.active { background: white; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .t-rcp.active { border-bottom: 3px solid var(--green); color: var(--green); }
        .t-pmt.active { border-bottom: 3px solid var(--red); color: var(--red); }
        .t-cnt.active { border-bottom: 3px solid var(--blue); color: var(--blue); }
        .t-jrn.active { border-bottom: 3px solid var(--purple); color: var(--purple); }

        /* INPUTS */
        .form-row { display: flex; gap: 15px; margin-bottom: 15px; }
        .form-group { flex: 1; position: relative; margin-bottom: 15px; }
        label { display: block; font-size: 12px; font-weight: 600; color: #64748b; margin-bottom: 5px; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 14px; outline: none; }
        input:focus, select:focus { border-color: var(--blue); box-shadow: 0 0 0 3px rgba(59,130,246,0.1); }

        .bal-display { position: absolute; right: 10px; top: 32px; font-size: 11px; font-weight: 700; background: white; padding: 2px 6px; border-radius: 4px; }
        .bal-dr { color: var(--green); } .bal-cr { color: var(--red); }

        .voice-btn { position: absolute; right: 10px; top: 32px; background: none; border: none; cursor: pointer; color: var(--blue); font-size: 16px; }

        /* ADVANCED & JOURNAL */
        .advanced-box { background: #f8fafc; padding: 15px; border-radius: 8px; border: 1px dashed var(--border); margin-bottom: 15px; display: none; }
        .checkbox-group { display: flex; align-items: center; gap: 8px; font-size: 13px; font-weight: 600; cursor: pointer; margin-bottom: 10px; }
        .journal-grid { display: none; margin-bottom: 15px; border: 1px solid var(--border); border-radius: 8px; overflow: hidden; }
        .journal-row { display: flex; border-bottom: 1px solid var(--border); background: #fff; }
        .j-type { width: 70px; padding: 8px; } 
        .j-ac { flex: 1; padding: 8px; } 
        .j-amt { width: 120px; padding: 8px; } 
        .j-act { width: 40px; text-align: center; cursor: pointer; color: red; padding: 8px; }
        .journal-row select, .journal-row input { border: none; border-radius: 0; background: transparent; height: 100%; }

        /* BILL SETTLEMENT */
        .bill-box { background: #fffbeb; border: 1px solid #fcd34d; padding: 10px; border-radius: 8px; margin-bottom: 15px; display: none; }
        .bill-item { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px dashed #e2e8f0; font-size: 13px; cursor: pointer; }
        .bill-item:hover { background: #fef3c7; }
        .bill-item label { display: flex; align-items: center; cursor: pointer; margin: 0; width: 100%; }

        /* BUTTONS */
        .btn-group { display: flex; gap: 10px; margin-top: 15px; }
        .btn-save { flex: 2; padding: 12px; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; color: white; transition: 0.2s; background: var(--green); }
        .btn-print { flex: 1; background: #64748b; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; }
        
        .txn-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #f1f5f9; font-size: 13px; }
        .tag { padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 700; background: #e2e8f0; }

        /* MOBILE RESPONSIVE */
        .menu-btn { display: none; position: absolute; top: 15px; left: 15px; font-size: 24px; cursor: pointer; background: none; border: none; z-index: 50; }
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 90; }

        @media (max-width: 900px) {
            .sidebar { position: fixed; left: -100%; top: 0; height: 100%; width: 250px; box-shadow: 5px 0 15px rgba(0,0,0,0.3); }
            .sidebar.active { left: 0; }
            .menu-btn { display: block; }
            .main { padding: 60px 15px 15px 15px; }
            .form-row { flex-direction: column; gap: 10px; }
            .btn-group { flex-direction: column; }
            .tabs { flex-wrap: wrap; }
        }
    </style>
</head>
<body>

    <button class="menu-btn" onclick="toggleMenu()">‚ò∞</button>
    <div class="overlay" onclick="toggleMenu()"></div>

    <div class="sidebar" id="mySidebar">
        <div style="font-size: 20px; font-weight: 800; color: #fff; margin-bottom: 40px;">üöÄ Arth Book</div> 
        <a href="index.html" class="nav-link">üìä Dashboard</a>
        <a href="reports.html" class="nav-link">üìà Reports</a>
        <a href="gst_filing.html" class="nav-link">üèõÔ∏è GST Filing</a>
        <a href="sales_invoice.html" class="nav-link">üßæ Sales Invoice</a>
        <a href="purchase_invoice.html" class="nav-link">üöö Purchase Entry</a>
        <a href="vouchers.html" class="nav-link active">üí∏ Vouchers (JV)</a>
        <a href="item_master.html" class="nav-link">üì¶ Inventory</a>
        <a href="ArthBook.html" class="nav-link">üë• Parties</a>
        <a href="coa.html" class="nav-link">üóÇÔ∏è Accounts</a>
        <a href="settings.html" class="nav-link">‚öôÔ∏è Settings</a>
    </div>

    <div class="main">
        <div class="card">
            <h3 style="margin-bottom: 20px;">Entry Desk</h3>
            
            <div class="tabs">
                <div class="tab t-rcp active" onclick="setMode('Receipt')">‚¨á Receipt (F6)</div>
                <div class="tab t-pmt" onclick="setMode('Payment')">‚¨Ü Payment (F5)</div>
                <div class="tab t-cnt" onclick="setMode('Contra')">‚áÑ Contra (F4)</div>
                <div class="tab t-jrn" onclick="setMode('Journal')">üìì Journal (F7)</div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Voucher No</label>
                    <input type="text" id="vchNo" readonly style="background:#f8fafc; font-weight:bold; color:#64748b;">
                </div>
                <div class="form-group">
                    <label>Date</label>
                    <input type="date" id="date">
                </div>
            </div>

            <div id="standardInputs">
                <div class="form-group">
                    <label id="lblAccount">Account (Bank/Cash)</label>
                    <select id="ac1Select" onchange="checkBank(this); updateBalance('ac1')"><option value="">-- Select --</option></select>
                    <span id="bal1" class="bal-display"></span>
                </div>
                
                <div id="bankOptions" class="advanced-box">
                    <div class="checkbox-group"><input type="checkbox" id="isPDC"> Post Dated Cheque (PDC)</div>
                    <div class="form-row" style="margin-bottom:0;">
                        <div class="form-group" style="margin-bottom:0;"><label>Cheque No</label><input type="text" id="chqNo" placeholder="Scan or type"></div>
                        <div class="form-group" style="margin-bottom:0;"><label>Cheque Date</label><input type="date" id="chqDate"></div>
                    </div>
                    <button onclick="printCheque()" style="margin-top:10px; padding:6px 12px; font-size:12px;">üñ®Ô∏è Print Cheque</button>
                </div>

                <div class="form-group">
                    <label id="lblParty">Party / Ledger</label>
                    <select id="ac2Select" onchange="updateBalance('ac2'); loadPendingBills(this.value)"><option value="">-- Select --</option></select>
                    <span id="bal2" class="bal-display"></span>
                </div>

                <div id="billSettlementBox" class="bill-box">
                    <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                        <span style="font-weight:700; color:#d97706; font-size:13px;">Pending Bills - Tick to Settle</span>
                        <span style="font-size:11px; cursor:pointer; color:#d97706;" onclick="this.parentElement.parentElement.style.display='none'">‚úï</span>
                    </div>
                    <div id="pendingBillList" style="max-height:180px; overflow-y:auto;"></div>
                    <div style="margin-top:8px; font-weight:bold; text-align:right;">Selected: ‚Çπ<span id="selectedBillAmt">0.00</span></div>
                </div>

                <div class="form-group">
                    <label>Amount (‚Çπ)</label>
                    <input type="number" id="amount" step="0.01" placeholder="0.00" style="font-size:18px; font-weight:bold;" onchange="clearBillSelectionIfMismatch()">
                </div>
            </div>

            <div id="journalInputs" style="display:none;">
                <div class="journal-grid" id="journalRows"></div>
                <button type="button" onclick="addJournalRow()" style="width:100%; padding:10px; border:1px dashed var(--border); background:#f8fafc; cursor:pointer; margin:10px 0;">+ Add Ledger Row</button>
                <div style="padding:10px; display:flex; justify-content:space-between; font-weight:bold; font-size:14px; background:#f1f5f9; border-radius:6px;">
                    <span>Total Debit: ‚Çπ<span id="totDr">0.00</span></span>
                    <span>Total Credit: ‚Çπ<span id="totCr">0.00</span></span>
                    <span id="diffDisplay" style="color:red;">Diff: ‚Çπ0.00</span>
                </div>
            </div>

            <div class="form-group">
                <label>Narration</label>
                <textarea id="narration" rows="3" placeholder="Being cash received towards..."></textarea>
                <button type="button" class="voice-btn" onclick="startVoice()" title="Voice to Text">üé§</button>
            </div>

            <div class="btn-group">
                <button class="btn-save" id="saveBtn" onclick="saveVoucher(false)">Save Voucher (Ctrl+Enter)</button>
                <button class="btn-print" onclick="saveVoucher(true)">Save & Print</button>
            </div>
        </div>

        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <span style="font-weight:700;">Recent Vouchers</span>
                <button style="font-size:12px; background:none; border:none; color:var(--blue); cursor:pointer;" onclick="loadRecent()">‚Üª Refresh</button>
            </div>
            <div id="recentList" style="max-height:300px; overflow-y:auto;"></div>
        </div>
    </div>

    <script src="db.js"></script>
    <script>
        let currentMode = 'Receipt';
        let ledgers = [], groups = [], allVouchers = [];
        let recognition;

        window.onload = async () => {
            await DB.init();
            ledgers = await DB.getLedgers();
            groups = await DB.getAll('groups') || [];
            allVouchers = await DB.getAll('vouchers');
            
            document.getElementById('date').valueAsDate = new Date();
            await generateVoucherNo();
            setMode('Receipt');
            loadRecent();

            // Keyboard Shortcuts
            document.addEventListener('keydown', e => {
                if(e.key === 'F5') { e.preventDefault(); setMode('Payment'); }
                if(e.key === 'F6') { e.preventDefault(); setMode('Receipt'); }
                if(e.key === 'F7') { e.preventDefault(); setMode('Journal'); }
                if(e.key === 'F4') { e.preventDefault(); setMode('Contra'); }
                if(e.ctrlKey && e.key === 'Enter') { e.preventDefault(); saveVoucher(false); }
            });

            // Voice Recognition
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
                recognition.continuous = false;
                recognition.lang = 'en-IN';
                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    document.getElementById('narration').value += (document.getElementById('narration').value ? " " : "") + transcript;
                };
                recognition.onend = () => { document.getElementById('narration').placeholder = "Being cash received towards..."; };
            }

            // Barcode/Cheque Scan Listener
            let scanBuffer = "";
            let scanTimer;
            document.addEventListener('keydown', (e) => {
                if (e.key.length === 1 && document.activeElement.tagName === 'BODY') {
                    scanBuffer += e.key;
                    clearTimeout(scanTimer);
                    scanTimer = setTimeout(() => {
                        if(scanBuffer.length > 4) {
                            if(document.getElementById('bankOptions').style.display === 'block') {
                                document.getElementById('chqNo').value = scanBuffer;
                            } else {
                                document.getElementById('narration').value += ` Ref: ${scanBuffer}`;
                            }
                        }
                        scanBuffer = "";
                    }, 100);
                } else if(e.key === 'Enter') {
                    scanBuffer = "";
                }
            });
        };

        function toggleMenu() {
            document.getElementById('mySidebar').classList.toggle('active');
            document.querySelector('.overlay').classList.toggle('active');
        }

        function startVoice() {
            if(recognition) {
                document.getElementById('narration').placeholder = "Listening... Speak now";
                recognition.start();
            } else {
                alert("Voice input not supported in this browser. Use Chrome/Edge.");
            }
        }

        function getLedgersByType(type) {
            const isCashBank = (l) => {
                const gName = groups.find(g => g.id === l.group_id)?.name || '';
                return gName.toLowerCase().includes('cash') || gName.toLowerCase().includes('bank');
            };
            if(type === 'CashBank') return ledgers.filter(isCashBank);
            if(type === 'Others') return ledgers.filter(l => !isCashBank(l));
            return ledgers;
        }

        function populateSelect(id, list) {
            const sel = document.getElementById(id);
            sel.innerHTML = '<option value="">-- Select Ledger --</option>';
            list.sort((a,b) => a.name.localeCompare(b.name)).forEach(l => {
                sel.innerHTML += `<option value="${l.id}">${l.name}</option>`;
            });
        }

        async function generateVoucherNo() {
            const prefixMap = { Receipt: 'REC', Payment: 'PMT', Contra: 'CNT', Journal: 'JRN' };
            const prefix = prefixMap[currentMode] || 'JRN';
            const year = new Date().getFullYear();
            
            const relevant = allVouchers.filter(v => v.type === currentMode);
            let maxNo = 0;
            relevant.forEach(v => {
                if(v.voucher_no && v.voucher_no.startsWith(prefix + '-' + year)) {
                    const num = parseInt(v.voucher_no.split('-')[2]);
                    if(num > maxNo) maxNo = num;
                }
            });
            
            const newNo = `${prefix}-${year}-${String(maxNo + 1).padStart(4, '0')}`;
            document.getElementById('vchNo').value = newNo;
        }

        async function setMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.t-${mode.toLowerCase().slice(0,3)}`).classList.add('active');

            const std = document.getElementById('standardInputs');
            const jrn = document.getElementById('journalInputs');
            const btn = document.getElementById('saveBtn');
            
            document.getElementById('billSettlementBox').style.display = 'none';
            document.getElementById('amount').value = '';
            document.getElementById('narration').value = '';
            document.getElementById('bankOptions').style.display = 'none';
            
            await generateVoucherNo();

            if(mode === 'Journal') {
                std.style.display = 'none';
                jrn.style.display = 'block';
                btn.style.background = 'var(--purple)';
                btn.innerText = 'Save Journal Entry';
                document.getElementById('journalRows').innerHTML = '';
                addJournalRow('Dr');
                addJournalRow('Cr');
                calcJ();
            } else {
                std.style.display = 'block';
                jrn.style.display = 'none';

                if(mode === 'Receipt') {
                    btn.style.background = 'var(--green)';
                    btn.innerText = 'Save Receipt';
                    document.getElementById('lblAccount').innerText = "Received In (Cash/Bank - Debit)";
                    document.getElementById('lblParty').innerText = "Received From (Party - Credit)";
                    populateSelect('ac1Select', getLedgersByType('CashBank'));
                    populateSelect('ac2Select', getLedgersByType('Others'));
                } else if(mode === 'Payment') {
                    btn.style.background = 'var(--red)';
                    btn.innerText = 'Save Payment';
                    document.getElementById('lblAccount').innerText = "Paid From (Cash/Bank - Credit)";
                    document.getElementById('lblParty').innerText = "Paid To (Party - Debit)";
                    populateSelect('ac1Select', getLedgersByType('CashBank'));
                    populateSelect('ac2Select', getLedgersByType('Others'));
                } else { // Contra
                    btn.style.background = 'var(--blue)';
                    btn.innerText = 'Save Contra';
                    document.getElementById('lblAccount').innerText = "Transfer To (Debit)";
                    document.getElementById('lblParty').innerText = "Transfer From (Credit)";
                    populateSelect('ac1Select', getLedgersByType('CashBank'));
                    populateSelect('ac2Select', getLedgersByType('CashBank'));
                }
            }
        }

        async function loadPendingBills(partyId) {
            if(!partyId || (currentMode !== 'Receipt' && currentMode !== 'Payment')) {
                document.getElementById('billSettlementBox').style.display = 'none';
                return;
            }

            const billType = currentMode === 'Receipt' ? 'Sales' : 'Purchase';
            const bills = allVouchers.filter(v => v.type === billType && v.party_id == partyId && v.amount > 0);
            
            const list = document.getElementById('pendingBillList');
            const box = document.getElementById('billSettlementBox');
            list.innerHTML = '';
            
            if(bills.length === 0) {
                box.style.display = 'none';
                return;
            }

            box.style.display = 'block';
            bills.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(b => {
                const amt = b.amount;
                list.innerHTML += `
                    <div class="bill-item">
                        <label>
                            <input type="checkbox" class="bill-chk" value="${amt}" data-ref="${b.voucher_no}" onchange="calcBillTotal()">
                            <span style="flex:1; margin-left:8px;">
                                <b>${b.voucher_no}</b> <span style="color:#64748b; font-size:11px;">${b.date}</span>
                            </span>
                            <span style="font-weight:bold;">‚Çπ${amt.toFixed(2)}</span>
                        </label>
                    </div>`;
            });
        }

        function calcBillTotal() {
            let total = 0;
            let refs = [];
            document.querySelectorAll('.bill-chk:checked').forEach(chk => {
                total += parseFloat(chk.value);
                refs.push(chk.dataset.ref);
            });
            document.getElementById('selectedBillAmt').innerText = total.toFixed(2);
            document.getElementById('amount').value = total.toFixed(2);
            
            if(refs.length) {
                let narr = document.getElementById('narration').value.trim();
                narr = narr.replace(/ \[Agst Ref:.*\]/, '');
                document.getElementById('narration').value = narr + ` [Agst Ref: ${refs.join(', ')}]`;
            }
        }

        function clearBillSelectionIfMismatch() {
            const entered = parseFloat(document.getElementById('amount').value) || 0;
            let selected = 0;
            document.querySelectorAll('.bill-chk:checked').forEach(chk => selected += parseFloat(chk.value));
            if(Math.abs(entered - selected) > 0.01) {
                document.querySelectorAll('.bill-chk').forEach(chk => chk.checked = false);
                document.getElementById('selectedBillAmt').innerText = '0.00';
            }
        }

        function checkBank(sel) {
            if(!sel.value) return;
            const ledger = ledgers.find(l => l.id == sel.value);
            const groupName = groups.find(g => g.id === ledger.group_id)?.name || '';
            document.getElementById('bankOptions').style.display = groupName.toLowerCase().includes('bank') ? 'block' : 'none';
        }

        function addJournalRow(defaultType = 'Dr') {
            const container = document.getElementById('journalRows');
            const row = document.createElement('div');
            row.className = 'journal-row';
            
            let options = '<option value="">-- Select Ledger --</option>';
            ledgers.forEach(l => options += `<option value="${l.id}">${l.name}</option>`);
            
            row.innerHTML = `
                <div class="j-type">
                    <select class="j-type-sel" onchange="calcJ()">
                        <option value="Dr" ${defaultType==='Dr'?'selected':''}>Dr</option>
                        <option value="Cr" ${defaultType==='Cr'?'selected':''}>Cr</option>
                    </select>
                </div>
                <div class="j-ac">
                    <select class="j-ledger" onchange="calcJ()">${options}</select>
                </div>
                <div class="j-amt">
                    <input type="number" class="j-amt-inp" step="0.01" placeholder="0.00" onchange="calcJ()">
                </div>
                <div class="j-act" onclick="this.parentElement.remove(); calcJ()">√ó</div>
            `;
            container.appendChild(row);
        }

        function calcJ() {
            let dr = 0, cr = 0;
            document.querySelectorAll('.journal-row').forEach(row => {
                const type = row.querySelector('.j-type-sel').value;
                const amt = parseFloat(row.querySelector('.j-amt-inp').value) || 0;
                if(type === 'Dr') dr += amt;
                else cr += amt;
            });
            document.getElementById('totDr').innerText = dr.toFixed(2);
            document.getElementById('totCr').innerText = cr.toFixed(2);
            const diff = Math.abs(dr - cr);
            document.getElementById('diffDisplay').innerText = `Diff: ‚Çπ${diff.toFixed(2)}`;
            document.getElementById('diffDisplay').style.color = diff < 0.01 ? 'green' : 'red';
            document.getElementById('saveBtn').disabled = diff >= 0.01;
        }

        async function updateBalance(prefix) {
            const selId = prefix === 'ac1' ? 'ac1Select' : 'ac2Select';
            const balId = prefix === 'ac1' ? 'bal1' : 'bal2';
            const ledgerId = parseInt(document.getElementById(selId).value);
            if(!ledgerId) {
                document.getElementById(balId).innerText = '';
                return;
            }
            
            const ledger = ledgers.find(l => l.id === ledgerId);
            const entries = await DB.getAll('acct_entries');
            let balance = (ledger.opening_balance || 0);
            entries.filter(e => e.ledger_id === ledgerId).forEach(e => {
                balance += (e.debit || 0) - (e.credit || 0);
            });
            
            const absBal = Math.abs(balance).toFixed(2);
            const type = balance >= 0 ? 'Dr' : 'Cr';
            document.getElementById(balId).innerText = `‚Çπ${absBal} ${type}`;
            document.getElementById(balId).className = `bal-display ${balance >= 0 ? 'bal-dr' : 'bal-cr'}`;
        }

        async function saveVoucher(printAfter) {
            const narration = document.getElementById('narration').value.trim();
            const date = document.getElementById('date').value || new Date().toISOString().slice(0,10);
            const vchNo = document.getElementById('vchNo').value;
            
            let acctEntries = [];
            let amount = 0;

            if(currentMode === 'Journal') {
                if(document.getElementById('saveBtn').disabled) return alert("Debit and Credit must match!");
                document.querySelectorAll('.journal-row').forEach(row => {
                    const type = row.querySelector('.j-type-sel').value;
                    const ledgerId = parseInt(row.querySelector('.j-ledger').value);
                    const amt = parseFloat(row.querySelector('.j-amt-inp').value) || 0;
                    if(ledgerId && amt > 0) {
                        acctEntries.push({
                            ledger_id: ledgerId,
                            debit: type === 'Dr' ? amt : 0,
                            credit: type === 'Cr' ? amt : 0
                        });
                        amount = Math.max(amount, amt);
                    }
                });
            } else {
                const amt = parseFloat(document.getElementById('amount').value) || 0;
                if(amt <= 0) return alert("Enter valid amount");
                amount = amt;
                
                const ac1 = parseInt(document.getElementById('ac1Select').value);
                const ac2 = parseInt(document.getElementById('ac2Select').value);
                if(!ac1 || !ac2) return alert("Select both accounts");
                
                const isPDC = document.getElementById('isPDC').checked;
                const chqNo = document.getElementById('chqNo').value.trim();
                const chqDate = document.getElementById('chqDate').value;
                
                let extraNarr = '';
                if(chqNo) extraNarr += ` [Chq: ${chqNo}${chqDate ? ' Dt: ' + chqDate : ''}]`;
                if(isPDC) extraNarr += ' [PDC]';
                
                const vData = {
                    voucher_no: vchNo,
                    date: date,
                    type: currentMode,
                    amount: amount,
                    narration: narration + extraNarr,
                    party_id: ac2
                };

                if(currentMode === 'Receipt') {
                    acctEntries.push({ ledger_id: ac1, debit: amount, credit: 0 });
                    acctEntries.push({ ledger_id: ac2, debit: 0, credit: amount });
                } else if(currentMode === 'Payment') {
                    acctEntries.push({ ledger_id: ac1, debit: 0, credit: amount });
                    acctEntries.push({ ledger_id: ac2, debit: amount, credit: 0 });
                } else { // Contra
                    acctEntries.push({ ledger_id: ac1, debit: amount, credit: 0 });
                    acctEntries.push({ ledger_id: ac2, debit: 0, credit: amount });
                }
                
                try {
                    await DB.saveVoucher(vData, [], acctEntries);
                    alert("Voucher Saved Successfully!");
                    if(printAfter) window.print();
                    location.reload();
                } catch(e) {
                    alert("Save Failed: " + e.message);
                }
                return;
            }

            // Journal save
            const vData = {
                voucher_no: vchNo,
                date: date,
                type: 'Journal',
                amount: amount,
                narration: narration || 'Journal Entry'
            };

            try {
                await DB.saveVoucher(vData, [], acctEntries);
                alert("Journal Entry Saved!");
                if(printAfter) window.print();
                location.reload();
            } catch(e) {
                alert("Save Failed: " + e.message);
            }
        }

        async function loadRecent() {
            allVouchers = await DB.getAll('vouchers');
            const container = document.getElementById('recentList');
            container.innerHTML = '';
            if(allVouchers.length === 0) {
                container.innerHTML = '<div style="text-align:center; color:#999; padding:20px;">No transactions yet</div>';
                return;
            }
            
            allVouchers.sort((a,b) => b.id - a.id).slice(0, 10).forEach(v => {
                const party = ledgers.find(l => l.id === v.party_id)?.name || '';
                container.innerHTML += `
                    <div class="txn-item">
                        <div>
                            <span class="tag">${v.type}</span> 
                            <b>${v.voucher_no}</b> 
                            <span style="color:#64748b; font-size:11px;">${v.date}</span>
                            ${party ? `<br><small>${party}</small>` : ''}
                        </div>
                        <div style="font-weight:bold;">‚Çπ${(v.amount||0).toFixed(2)}</div>
                    </div>`;
            });
        }

        function printCheque() {
            const payee = document.getElementById('ac2Select').selectedOptions[0]?.text || '__________';
            const amount = document.getElementById('amount').value;
            const chqDate = document.getElementById('chqDate').value || new Date().toISOString().slice(0,10);
            if(!amount) return alert("Enter amount first");
            
            const words = numberToWords(amount);
            const win = window.open('', '_blank', 'width=800,height=600');
            win.document.write(`
                <html><head><title>Cheque</title>
                <style>
                    body { font-family: 'Times New Roman', serif; padding: 50px; }
                    .cheque { border: 2px solid #000; padding: 30px; width: 800px; height: 350px; position: relative; }
                    .date { position: absolute; top: 30px; right: 50px; font-size: 18px; }
                    .payee { position: absolute; top: 100px; left: 100px; font-size: 22px; }
                    .amount-words { position: absolute; top: 150px; left: 80px; font-size: 18px; }
                    .amount-box { position: absolute; top: 140px; right: 50px; border: 1px solid #000; padding: 10px; font-size: 20px; }
                </style></head>
                <body onload="window.print(); window.close();">
                    <div class="cheque">
                        <div class="date">${chqDate.split('-').reverse().join('/')}</div>
                        <div class="payee">Pay: <b>${payee}</b></div>
                        <div class="amount-words">Rupees ${words} Only</div>
                        <div class="amount-box">‚Çπ ${parseFloat(amount).toFixed(2)}</div>
                    </div>
                </body></html>
            `);
        }

        // Simple number to words (Indian style)
        function numberToWords(num) {
            const ones = ['', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven', 'Eight', 'Nine', 'Ten',
                          'Eleven', 'Twelve', 'Thirteen', 'Fourteen', 'Fifteen', 'Sixteen', 'Seventeen', 'Eighteen', 'Nineteen'];
            const tens = ['', '', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];
            if(num == 0) return 'Zero';
            const crore = Math.floor(num / 10000000);
            num %= 10000000;
            const lakh = Math.floor(num / 100000);
            num %= 100000;
            const thousand = Math.floor(num / 1000);
            num %= 1000;
            const hundred = Math.floor(num / 100);
            num %= 100;
            let words = '';
            if(crore) words += numberToWords(crore) + ' Crore ';
            if(lakh) words += numberToWords(lakh) + ' Lakh ';
            if(thousand) words += numberToWords(thousand) + ' Thousand ';
            if(hundred) words += ones[hundred] + ' Hundred ';
            if(num > 0) {
                if(num < 20) words += ones[num];
                else words += tens[Math.floor(num/10)] + (num%10 ? ' ' + ones[num%10] : '');
            }
            return words.trim();
        }
    </script>
</body>
</html>