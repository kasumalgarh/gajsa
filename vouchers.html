<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Day Book - Arth Book</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <link rel="icon" type="image/x-icon" href="favicon.ico"><link rel="stylesheet" href="style.css">

 
</head>
<body>
   <div class="sidebar" id="sidebar">
        <div class="brand-logo" style="padding: 20px; display: flex; align-items: center; gap: 10px;">
            <img id="appLogo" src="favicon.ico" style="height: 35px; width: auto;" onerror="this.src='https://cdn-icons-png.flaticon.com/512/1041/1041888.png'"> 
            <span style="font-size: 20px; font-weight: 800; color: white;">Arth Book</span>
        </div>
        <ul class="nav-links" style="list-style: none; padding: 0 10px;">
            <li><a href="index.html" class="nav-link"><i class="fas fa-home"></i> Dashboard</a></li>
            <li><a href="sales_invoice.html" class="nav-link"><i class="fas fa-file-invoice"></i> Sales (Table)</a></li>
            <li><a href="purchase_invoice.html" class="nav-link"><i class="fas fa-truck"></i> Purchase</a></li>
            <li><a href="vouchers.html" class="nav-link active"><i class="fas fa-receipt"></i> Day Book</a></li>
            <li style="margin-top:15px; margin-bottom:5px; font-size:11px; color:#64748b; font-weight:bold; padding-left:15px; text-transform:uppercase;">Masters</li>
            <li><a href="item_master.html" class="nav-link"><i class="fas fa-boxes"></i> Inventory</a></li>
            <li><a href="ArthBook.html" class="nav-link"><i class="fas fa-users"></i> Parties</a></li>
            <hr style="border:0; border-top:1px solid rgba(255,255,255,0.1); margin:15px 5px;">
            <li><a href="settings.html" class="nav-link"><i class="fas fa-cog"></i> Settings</a></li>
        </ul>
        <div style="padding: 20px; font-size: 11px; color: #64748b; text-align: center; margin-top:auto;">Arth Book v4.2<br>Authorized User</div>
    </div>

    <div class="main-area">
        <div class="top-bar">
            <div class="tb-header">
                <h2>Day Book</h2>
                <a href="voucher_entry.html" class="btn-new"><i class="fas fa-plus"></i> New Entry</a>
            </div>
            <div class="filters">
                <input type="date" id="dateFrom" class="filter-input">
                <input type="date" id="dateTo" class="filter-input">
                <select id="typeFilter" class="filter-input">
                    <option value="All">All Vouchers</option>
                    <option value="Sales">Sales</option>
                    <option value="Purchase">Purchase</option>
                    <option value="Payment">Payment</option>
                    <option value="Receipt">Receipt</option>
                    <option value="Contra">Contra</option>
                    <option value="Journal">Journal</option>
                </select>
                <div class="search-grp">
                    <i class="fas fa-search"></i>
                    <input type="text" id="searchBox" class="search-box" placeholder="Search Vch No, Amount...">
                </div>
                <button class="btn-refresh" onclick="renderVouchers()"><i class="fas fa-sync-alt"></i></button>
            </div>
        </div>

        <div class="content-scroll">
            <div id="loading" style="text-align:center; padding:40px; display:none;">Loading...</div>
            <div id="noData" style="text-align:center; padding:40px; display:none; color:#64748b;">No Vouchers Found</div>
            <div class="table-container" id="tableWrap">
                <table>
                    <thead>
                        <tr>
                            <th width="15%">Date</th>
                            <th width="15%">Voucher No</th>
                            <th>Narration</th>
                            <th width="10%">Type</th>
                            <th width="15%" style="text-align:right;">Amount</th>
                            <th width="15%" style="text-align:center;">Action</th>
                        </tr>
                    </thead>
                    <tbody id="voucherTable"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="printArea"></div>

    <script src="db.js"></script>
    <script>
        let ledgers = [], items = [], settings = {};
        
        // DEFAULT LOGO (If none uploaded)
        const DEFAULT_LOGO = "https://cdn-icons-png.flaticon.com/512/1041/1041888.png"; 

        window.onload = async () => {
            try {
                await DB.init();
                [ledgers, items, settings] = await Promise.all([
                    DB.getAll('ledgers'), DB.getAll('items'), DB.getAll('settings')
                ]);
                
                if(Array.isArray(settings) && settings.length > 0) settings = settings[0];
                if(!settings) settings = {};

                // Update Sidebar Logo from Settings if available
                if(settings.logo) document.getElementById('appLogo').src = settings.logo;

                const date = new Date();
                document.getElementById('dateFrom').valueAsDate = new Date(date.getFullYear(), date.getMonth(), 1);
                document.getElementById('dateTo').valueAsDate = new Date(date.getFullYear(), date.getMonth() + 1, 0);

                renderVouchers();

                document.getElementById('typeFilter').addEventListener('change', renderVouchers);
                document.getElementById('dateFrom').addEventListener('change', renderVouchers);
                document.getElementById('dateTo').addEventListener('change', renderVouchers);
                document.getElementById('searchBox').addEventListener('keyup', (e) => setTimeout(renderVouchers, 300));
            } catch (e) { console.error(e); }
        };

        async function renderVouchers() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('tableWrap').style.display = 'none';
            document.getElementById('noData').style.display = 'none';

            try {
                const vData = await DB.getAll('vouchers');
                const from = document.getElementById('dateFrom').value;
                const to = document.getElementById('dateTo').value;
                const type = document.getElementById('typeFilter').value;
                const search = document.getElementById('searchBox').value.toLowerCase();

                const filtered = vData.filter(v => {
                    const matchDate = (!from || v.date >= from) && (!to || v.date <= to);
                    const matchType = type === 'All' || v.type === type;
                    const matchSearch = String(v.voucher_no).toLowerCase().includes(search) || 
                                        (v.narration && v.narration.toLowerCase().includes(search));
                    return matchDate && matchType && matchSearch;
                });

                filtered.sort((a,b) => b.date.localeCompare(a.date) || b.id - a.id);

                const tbody = document.getElementById('voucherTable');
                tbody.innerHTML = '';
                document.getElementById('loading').style.display = 'none';

                if (filtered.length === 0) {
                    document.getElementById('noData').style.display = 'block';
                    return;
                }

                document.getElementById('tableWrap').style.display = 'block';

                filtered.forEach(v => {
                    const isIn = ['Receipt', 'Sales', 'Credit Note'].includes(v.type);
                    const amtClass = isIn ? 'amt-in' : 'amt-out';
                    
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${v.date.split('-').reverse().join('-')}</td>
                        <td style="font-weight:600;">${v.voucher_no}</td>
                        <td style="color:#64748b; font-size:12px;">${v.narration || '-'}</td>
                        <td><span class="vtype-badge badge-${v.type.replace(/\s/g,'')}">${v.type}</span></td>
                        <td class="amount ${amtClass}">₹${parseFloat(v.amount).toFixed(2)}</td>
                        <td class="actions" style="text-align:center;">
                            <button onclick="printVoucher(${v.id})" title="Print Invoice"><i class="fas fa-print"></i></button>
                            <button onclick="deleteVoucher(${v.id})"><i class="fas fa-trash-alt"></i></button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch(e) { console.error(e); }
        }

        // --- MASTER PRINT LOGIC ---
        async function printVoucher(id) {
            try {
                const v = await DB.getOne('vouchers', id);
                if(!v) return alert("Voucher Not Found!");

                const allEntries = await DB.getAll('acct_entries');
                const entries = allEntries.filter(e => e.voucher_id === id);

                if (v.type === 'Sales' || v.type === 'Purchase') {
                    let printItems = [];
                    // Try Metadata first
                    entries.forEach(e => {
                        if (e.meta_data && e.meta_data.item_id) {
                            const item = items.find(i => i.id == e.meta_data.item_id);
                            printItems.push({
                                name: item ? item.name : "Unknown Item",
                                hsn: item ? item.hsn : '',
                                qty: e.meta_data.qty || 0,
                                rate: e.meta_data.rate || 0,
                                unit: item ? item.unit : '',
                                gst: item ? (item.gst_rate || 0) : 0
                            });
                        }
                    });

                    // Fallback to Ledger Name
                    if(printItems.length === 0) {
                        entries.forEach(e => {
                            const l = ledgers.find(x => x.id === e.ledger_id);
                            const isItemEntry = (v.type === 'Sales' && e.credit > 0) || (v.type === 'Purchase' && e.debit > 0);
                            const isTax = l && (l.group_name === 'Duties & Taxes' || l.name.includes('GST'));
                            if(l && isItemEntry && !isTax) {
                                printItems.push({
                                    name: l.name, hsn: '', unit: '', qty: 1, 
                                    rate: e.credit || e.debit, gst: 0
                                });
                            }
                        });
                    }
                    renderA4Invoice(v, printItems);
                } else {
                    renderSimpleVoucher(v, entries);
                }
            } catch(e) { console.error(e); alert("Print Error: " + e.message); }
        }

        function renderA4Invoice(v, printItems) {
            const companyName = settings.company_name || "My Company";
            const companyAddr = settings.address || "";
            const companyGST = settings.gstin || settings.gst_user || "";
            
            // USE LOGO FROM SETTINGS OR DEFAULT
            const logoSrc = settings.logo || DEFAULT_LOGO; 
            const signSrc = settings.signature || "";

            const party = ledgers.find(l => l.id == v.party_id);
            const buyerName = party ? party.name : "Cash Sale";
            const buyerAddr = (party && party.address) ? party.address : "";
            const buyerGST = (party && party.gstin) ? party.gstin : "";

            let rows = '';
            let totalTaxable = 0;
            let totalCGST = 0; 
            let totalSGST = 0;

            printItems.forEach((i, idx) => {
                const amt = i.qty * i.rate;
                const taxAmt = amt * (i.gst / 100);
                const halfTax = taxAmt / 2;
                const halfRate = i.gst / 2;

                totalTaxable += amt;
                totalCGST += halfTax;
                totalSGST += halfTax;

                rows += `
                    <tr>
                        <td style="text-align:center; padding:5px; border-right:1px solid #000;">${idx + 1}</td>
                        <td style="padding:5px; border-right:1px solid #000;">${i.name}</td>
                        <td style="text-align:center; padding:5px; border-right:1px solid #000;">${i.hsn || '-'}</td>
                        <td style="text-align:center; padding:5px; border-right:1px solid #000;">${i.qty} ${i.unit||''}</td>
                        <td style="text-align:right; padding:5px; border-right:1px solid #000;">${parseFloat(i.rate).toFixed(2)}</td>
                        <td style="text-align:right; padding:5px; border-right:1px solid #000;">${amt.toFixed(2)}</td>
                        <td style="text-align:right; padding:5px; border-right:1px solid #000;">${halfRate}%<br><small>${halfTax.toFixed(2)}</small></td>
                        <td style="text-align:right; padding:5px; border-right:1px solid #000;">${halfRate}%<br><small>${halfTax.toFixed(2)}</small></td>
                        <td style="text-align:right; padding:5px;">${(amt + taxAmt).toFixed(2)}</td>
                    </tr>
                `;
            });

            const grandTotal = Math.round(totalTaxable + totalCGST + totalSGST);
            const roundOff = grandTotal - (totalTaxable + totalCGST + totalSGST);

            const content = `
                <div style="width: 210mm; padding: 20px; font-family: 'Arial', sans-serif; color: #000; background: white; margin: auto;">
                    <div style="border: 1px solid #000;">
                        <div style="text-align: center; border-bottom: 1px solid #000; padding: 8px; background: #eee;">
                            <h2 style="margin: 0;">TAX INVOICE</h2>
                        </div>
                        <div style="display: flex; border-bottom: 1px solid #000;">
                            <div style="flex: 1; padding: 10px; border-right: 1px solid #000;">
                                <img src="${logoSrc}" style="max-height: 50px; margin-bottom: 5px;">
                                <h3 style="margin: 5px 0;">${companyName}</h3>
                                <div style="font-size: 12px;">${companyAddr}<br>GSTIN: <b>${companyGST}</b></div>
                            </div>
                            <div style="flex: 1; padding: 10px;">
                                <div style="display: flex; justify-content: space-between; font-size:12px;">
                                    <span><strong>Inv No:</strong> ${v.voucher_no}</span>
                                    <span><strong>Date:</strong> ${v.date}</span>
                                </div>
                                <div style="margin-top: 10px; font-size:12px; border-top:1px solid #ccc; padding-top:5px;">
                                    <strong>Bill To:</strong><br>
                                    <span style="font-weight:bold; font-size:14px;">${buyerName}</span><br>
                                    ${buyerAddr}<br>${buyerGST ? 'GSTIN: '+buyerGST : ''}
                                </div>
                            </div>
                        </div>
                        <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                            <thead style="background: #f0f0f0;">
                                <tr>
                                    <th style="border: 1px solid #000; padding: 5px; width:5%;">#</th>
                                    <th style="border: 1px solid #000; padding: 5px; width:35%;">Item Description</th>
                                    <th style="border: 1px solid #000; padding: 5px;">HSN</th>
                                    <th style="border: 1px solid #000; padding: 5px;">Qty</th>
                                    <th style="border: 1px solid #000; padding: 5px;">Rate</th>
                                    <th style="border: 1px solid #000; padding: 5px;">Taxable</th>
                                    <th style="border: 1px solid #000; padding: 5px;">CGST</th>
                                    <th style="border: 1px solid #000; padding: 5px;">SGST</th>
                                    <th style="border: 1px solid #000; padding: 5px;">Total</th>
                                </tr>
                            </thead>
                            <tbody>${rows}
                                <tr style="height: 50px;"><td colspan="9" style="border:1px solid #000;"></td></tr>
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="5" style="border: 1px solid #000; text-align: right; padding: 5px; font-weight: bold;">Sub Total</td>
                                    <td style="border: 1px solid #000; text-align: right; padding: 5px;">${totalTaxable.toFixed(2)}</td>
                                    <td style="border: 1px solid #000; text-align: right; padding: 5px;">${totalCGST.toFixed(2)}</td>
                                    <td style="border: 1px solid #000; text-align: right; padding: 5px;">${totalSGST.toFixed(2)}</td>
                                    <td style="border: 1px solid #000; text-align: right; padding: 5px; font-weight: bold;">${(totalTaxable+totalCGST+totalSGST).toFixed(2)}</td>
                                </tr>
                                <tr>
                                    <td colspan="8" style="border: 1px solid #000; text-align: right; padding: 5px;">Round Off</td>
                                    <td style="border: 1px solid #000; text-align: right; padding: 5px;">${roundOff.toFixed(2)}</td>
                                </tr>
                                <tr style="background:#eee;">
                                    <td colspan="8" style="border: 1px solid #000; text-align: right; padding: 5px; font-weight: 800;">GRAND TOTAL</td>
                                    <td style="border: 1px solid #000; text-align: right; padding: 5px; font-weight: 800;">₹${grandTotal.toFixed(2)}</td>
                                </tr>
                            </tfoot>
                        </table>
                        <div style="display: flex; border-top: 1px solid #000;">
                            <div style="flex: 1.5; padding: 10px; border-right: 1px solid #000;">
                                <div style="font-size: 12px;"><strong>Amount in Words:</strong></div>
                                <div style="font-style: italic; margin-top: 5px;">${numToWords(grandTotal)} Only</div>
                                <div style="margin-top: 15px; font-size: 11px; border: 1px solid #000; padding: 8px;">
                                    <strong>Bank Details:</strong><br>Bank: ${settings.bank_name||''}<br>A/c: ${settings.bank_account||''} | IFSC: ${settings.bank_ifsc||''}
                                </div>
                            </div>
                            <div style="flex: 1; padding: 10px; text-align: center;">
                                <div style="margin-top: 40px;">For ${companyName}</div>
                                <img src="${signSrc}" style="height: 40px; margin: 5px auto; display:${signSrc?'block':'none'}">
                                <div style="font-size: 12px; border-top:1px solid #000; padding-top:5px;">Authorized Signatory</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            doPrint(content);
        }

        function renderSimpleVoucher(v, entries) {
            const companyName = settings.company_name || "Arth Book";
            // Use Logo from Settings or Default
            const logoSrc = settings.logo || DEFAULT_LOGO;
            
            let drRows = '', crRows = '';
            
            entries.forEach(e => {
                const l = ledgers.find(x => x.id === e.ledger_id);
                const name = l ? l.name : "Unknown";
                if(e.debit > 0) drRows += `<div style="display:flex; justify-content:space-between; margin-bottom:5px;"><span>${name}</span><span>₹${e.debit.toFixed(2)}</span></div>`;
                if(e.credit > 0) crRows += `<div style="display:flex; justify-content:space-between; margin-bottom:5px;"><span>${name}</span><span>₹${e.credit.toFixed(2)}</span></div>`;
            });

            const content = `
                <div style="width: 100%; max-width: 700px; margin: 20px auto; border: 1px solid #000; padding: 20px; font-family: sans-serif;">
                    <div style="text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px;">
                        <img src="${logoSrc}" style="height: 40px; margin-bottom: 5px;">
                        <h2 style="margin:0;">${companyName}</h2>
                        <div style="font-size:12px;">${settings.address || ''}</div>
                        <div style="margin-top:10px; font-weight:bold; text-decoration:underline;">${v.type.toUpperCase()} VOUCHER</div>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin: 15px 0; font-size:14px;">
                        <div>No: <b>${v.voucher_no}</b></div>
                        <div>Date: <b>${v.date}</b></div>
                    </div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; border:1px solid #000;">
                        <div style="padding:10px; border-right:1px solid #000;">
                            <div style="font-weight:bold; border-bottom:1px solid #ccc; margin-bottom:5px;">DEBIT (By)</div>
                            ${drRows}
                        </div>
                        <div style="padding:10px;">
                            <div style="font-weight:bold; border-bottom:1px solid #ccc; margin-bottom:5px;">CREDIT (To)</div>
                            ${crRows}
                        </div>
                    </div>
                    <div style="margin-top: 15px; font-size:14px;"><strong>Narration:</strong> ${v.narration || '-'}</div>
                    <div style="margin-top: 15px; font-size:14px;"><strong>Amount:</strong> ₹${v.amount.toFixed(2)} <small>(${numToWords(Math.round(v.amount))} Only)</small></div>
                    <div style="display: flex; justify-content: space-between; margin-top: 60px;">
                        <div style="border-top: 1px solid #000; padding-top: 5px; width:150px; text-align:center;">Receiver's Sign</div>
                        <div style="border-top: 1px solid #000; padding-top: 5px; width:150px; text-align:center;">Authorised Sign</div>
                    </div>
                </div>
            `;
            doPrint(content);
        }

        function doPrint(html) {
            const area = document.getElementById('printArea');
            area.innerHTML = html;
            setTimeout(() => { window.print(); area.innerHTML = ''; }, 500);
        }

        function numToWords(n) { return n + ""; } // Simplify for brevity, full version in previous code if needed
        
        async function deleteVoucher(id) {
            if(confirm("Are you sure?")) {
                try { await DB.deleteVoucher(id); renderVouchers(); } catch(e) { alert(e.message); }
            }
        }

        function editVoucher(id) { window.location.href = `voucher_entry.html?id=${id}&mode=edit`; }
    </script>
</body>
</html>