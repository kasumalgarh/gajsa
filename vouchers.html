<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Money Wise Pro - Accounting Vouchers</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --sidebar-bg: #0f172a; --sidebar-text: #94a3b8; --active-text: #f8fafc;
            --bg: #f3f4f6; --card-bg: #ffffff; --text: #1e293b; --border: #e5e7eb;
            --green: #10b981; --red: #ef4444; --blue: #3b82f6; --amber: #f59e0b; --purple: #8b5cf6;
        }
        * { box-sizing: border-box; font-family: 'Inter', sans-serif; margin: 0; padding: 0; }
        body { display: flex; height: 100vh; background: var(--bg); color: var(--text); overflow: hidden; }

        .sidebar { width: 260px; background: var(--sidebar-bg); padding: 20px; display: flex; flex-direction: column; flex-shrink: 0; }
        .brand { font-size: 20px; font-weight: 800; color: #fff; margin-bottom: 40px; display: flex; align-items: center; gap: 10px; }
        .nav-link { padding: 12px 15px; margin-bottom: 5px; border-radius: 8px; color: var(--sidebar-text); text-decoration: none; font-weight: 500; display: flex; align-items: center; gap: 12px; transition: 0.2s; font-size: 14px; }
        .nav-link:hover, .nav-link.active { background: #1e293b; color: var(--active-text); }
        .nav-icon { font-size: 18px; }

        .main { flex: 1; padding: 30px; overflow-y: auto; display: grid; grid-template-columns: 1.5fr 1fr; gap: 30px; }
        
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border: 1px solid var(--border); height: fit-content; }
        
        .tabs { display: flex; margin-bottom: 20px; background: #f1f5f9; padding: 4px; border-radius: 8px; }
        .tab { flex: 1; text-align: center; padding: 10px; cursor: pointer; border-radius: 6px; font-weight: 600; font-size: 13px; transition: 0.2s; white-space: nowrap; }
        .tab.active { background: white; box-shadow: 0 1px 3px rgba(0,0,0,0.1); transform: scale(1.02); }
        
        .t-rcp.active { color: var(--green); border-bottom: 2px solid var(--green); }
        .t-pmt.active { color: var(--red); border-bottom: 2px solid var(--red); }
        .t-cnt.active { color: var(--blue); border-bottom: 2px solid var(--blue); }
        .t-jrn.active { color: var(--purple); border-bottom: 2px solid var(--purple); }

        .form-group { margin-bottom: 15px; position: relative; }
        label { display: block; font-size: 13px; font-weight: 600; color: #64748b; margin-bottom: 5px; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px; outline: none; }
        input:focus, select:focus { border-color: var(--blue); box-shadow: 0 0 0 3px rgba(59,130,246,0.1); }

        .bal-display { position: absolute; right: 0; top: 0; font-size: 12px; font-weight: 700; }
        .bal-dr { color: var(--green); } .bal-cr { color: var(--red); }

        .btn-save { width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: 700; font-size: 15px; cursor: pointer; color: white; margin-top: 10px; transition: 0.2s; }
        .btn-save:hover { opacity: 0.9; }

        /* JOURNAL TABLE STYLES */
        .journal-grid { display: none; margin-bottom: 15px; border: 1px solid var(--border); border-radius: 8px; overflow: hidden; }
        .journal-row { display: flex; border-bottom: 1px solid var(--border); background: #fff; }
        .journal-row:last-child { border-bottom: none; }
        .j-type { width: 80px; padding: 8px; border-right: 1px solid var(--border); }
        .j-ac { flex: 1; padding: 8px; border-right: 1px solid var(--border); }
        .j-amt { width: 120px; padding: 8px; }
        .j-act { width: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--red); }
        
        .journal-footer { display: flex; justify-content: space-between; padding: 10px; background: #f8fafc; font-weight: 700; font-size: 13px; border-top: 1px solid var(--border); }
        .diff-err { color: var(--red); } .diff-ok { color: var(--green); }

        /* RECENT TRANSACTIONS */
        .recent-box { background: white; padding: 20px; border-radius: 12px; border: 1px solid var(--border); height: fit-content; }
        .txn-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #f1f5f9; font-size: 13px; }
        .tag { padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 700; }
        .tag-Receipt { background: #dcfce7; color: #166534; }
        .tag-Payment { background: #fee2e2; color: #991b1b; }
        .tag-Contra { background: #dbeafe; color: #1e40af; }
        .tag-Journal { background: #f3e8ff; color: #6b21a8; }
        
        .btn-del { background: none; border: none; cursor: pointer; font-size: 16px; opacity: 0.6; padding: 5px; color:var(--red); }

        @media (max-width: 1000px) { .main { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

   <div class="sidebar">
        <div class="brand">üöÄ MoneyWise Pro</div>
        <a href="index.html" class="nav-link"><span class="nav-icon">üìä</span> Dashboard</a>
        <a href="reports.html" class="nav-link"><span class="nav-icon">üìà</span> Reports</a>
        <a href="gst_filing.html" class="nav-link"><span class="nav-icon">üèõÔ∏è</span> GST Filing</a>
        <a href="sales_invoice.html" class="nav-link"><span class="nav-icon">üßæ</span> Sales Invoice</a>
        <a href="purchase_invoice.html" class="nav-link"><span class="nav-icon">üöö</span> Purchase Entry</a>
        <a href="vouchers.html" class="nav-link active"><span class="nav-icon">üí∏</span> Vouchers (JV)</a>
        <a href="item_master.html" class="nav-link"><span class="nav-icon">üì¶</span> Inventory</a>
        <a href="moneywise.html" class="nav-link"><span class="nav-icon">üë•</span> Parties / Ledgers</a>
        <a href="coa.html" class="nav-link"><span class="nav-icon">üóÇÔ∏è</span> Chart of Accounts</a>
        <a href="settings.html" class="nav-link"><span class="nav-icon">‚öôÔ∏è</span> Settings</a>
    </div>

    <div class="main">
        <div class="card" id="formCard">
            <h3 style="margin-bottom: 20px;">Accounting Voucher</h3>
            
            <div class="tabs">
                <div class="tab t-rcp active" onclick="setMode('Receipt')">‚¨á Receipt</div>
                <div class="tab t-pmt" onclick="setMode('Payment')">‚¨Ü Payment</div>
                <div class="tab t-cnt" onclick="setMode('Contra')">‚áÑ Contra</div>
                <div class="tab t-jrn" onclick="setMode('Journal')">üìì Journal (JV)</div>
            </div>

            <div class="form-group">
                <label>Voucher No & Date</label>
                <div style="display:flex; gap:10px;">
                    <input type="text" id="vchNo" readonly style="background:#f8fafc; font-weight:bold; width:40%; color:#64748b;">
                    <input type="date" id="date" style="width:60%;">
                </div>
            </div>

            <div id="standardInputs">
                <div class="form-group">
                    <label id="lblAccount">Target Account</label>
                    <select id="ac1Select" onchange="updateBalance('ac1')"><option value="">Loading...</option></select>
                    <span id="bal1" class="bal-display"></span>
                </div>
                <div class="form-group">
                    <label id="lblParty">Source Account</label>
                    <select id="ac2Select" onchange="updateBalance('ac2')"><option value="">Loading...</option></select>
                    <span id="bal2" class="bal-display"></span>
                </div>
                <div class="form-group">
                    <label>Amount (‚Çπ)</label>
                    <input type="number" id="amount" placeholder="0.00" style="font-size:18px; font-weight:bold;">
                </div>
            </div>

            <div id="journalInputs" style="display:none;">
                <label style="margin-bottom:5px;">Journal Entries (Dr/Cr)</label>
                <div class="journal-grid" id="journalRows">
                    </div>
                <button type="button" onclick="addJournalRow()" style="width:100%; padding:8px; border:1px dashed var(--border); background:#f8fafc; cursor:pointer; margin-bottom:15px; font-size:12px;">+ Add Ledger Line</button>
                
                <div class="journal-footer">
                    <span>Total Debit: <span id="totDr">0.00</span></span>
                    <span>Total Credit: <span id="totCr">0.00</span></span>
                    <span id="diffDisplay" class="diff-ok">Diff: 0.00</span>
                </div>
            </div>

            <div class="form-group">
                <label>Narration</label>
                <textarea id="narration" rows="2" placeholder="Being interest charged / depreciation..."></textarea>
            </div>

            <button class="btn-save" id="saveBtn" onclick="saveVoucher()">Save Entry</button>
        </div>

        <div class="recent-box">
            <div class="recent-header">
                <span>üïí Recent Transactions</span>
                <span style="font-size:12px; color:var(--blue); cursor:pointer;" onclick="loadRecent()">‚Üª Refresh</span>
            </div>
            <div id="recentList">
                <div style="text-align:center; color:#94a3b8; padding:20px;">Loading...</div>
            </div>
        </div>
    </div>

    <script src="db.js"></script>
    <script>
        let currentMode = 'Receipt';
        let ledgers = [];
        let groups = [];

        window.onload = async () => {
            await DB.init();
            ledgers = await DB.getLedgers();
            groups = await DB.getGroups();
            setMode('Receipt');
            loadRecent();
        };

        // --- FILTER HELPERS ---
        function getLedgersByType(type) {
            const isCashBank = (l) => {
                const g = groups.find(grp => grp.id == l.group_id)?.name || '';
                return g.includes("Cash") || g.includes("Bank");
            };
            if (type === 'CashBank') return ledgers.filter(l => isCashBank(l));
            if (type === 'Others') return ledgers.filter(l => !isCashBank(l));
            return ledgers;
        }

        function populateSelect(elementId, ledgerList) {
            const sel = document.getElementById(elementId);
            sel.innerHTML = '<option value="">-- Select Account --</option>';
            ledgerList.sort((a,b) => a.name.localeCompare(b.name));
            ledgerList.forEach(l => {
                const gName = groups.find(g => g.id == l.group_id)?.name || '';
                let opt = document.createElement('option');
                opt.value = l.id;
                opt.text = `${l.name} [${gName}]`;
                sel.appendChild(opt);
            });
        }

        function setMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            const map = {'Receipt':'.t-rcp', 'Payment':'.t-pmt', 'Contra':'.t-cnt', 'Journal':'.t-jrn'};
            document.querySelector(map[mode]).classList.add('active');

            const btn = document.getElementById('saveBtn');
            const std = document.getElementById('standardInputs');
            const jrn = document.getElementById('journalInputs');
            
            document.getElementById('date').valueAsDate = new Date();
            document.getElementById('vchNo').value = `${mode.substring(0,3).toUpperCase()}-${Date.now().toString().slice(-6)}`;

            if(mode === 'Journal') {
                std.style.display = 'none';
                jrn.style.display = 'block';
                btn.style.background = 'var(--purple)'; btn.innerText = 'Save Journal Entry';
                document.getElementById('journalRows').innerHTML = '';
                addJournalRow('Dr');
                addJournalRow('Cr');
                calcJournalTotal();
            } else {
                std.style.display = 'block';
                jrn.style.display = 'none';
                // Standard modes Logic
                if (mode === 'Receipt') {
                    btn.style.background = 'var(--green)'; btn.innerText = 'Save Receipt';
                    document.getElementById('lblAccount').innerText = "Deposit To (Debit)";
                    populateSelect('ac1Select', getLedgersByType('CashBank'));
                    document.getElementById('lblParty').innerText = "Received From (Credit)";
                    populateSelect('ac2Select', getLedgersByType('Others'));
                } else if (mode === 'Payment') {
                    btn.style.background = 'var(--red)'; btn.innerText = 'Save Payment';
                    document.getElementById('lblAccount').innerText = "Paid From (Credit)";
                    populateSelect('ac1Select', getLedgersByType('CashBank'));
                    document.getElementById('lblParty').innerText = "Paid To (Debit)";
                    populateSelect('ac2Select', getLedgersByType('Others'));
                } else { // Contra
                    btn.style.background = 'var(--blue)'; btn.innerText = 'Save Contra';
                    document.getElementById('lblAccount').innerText = "Deposit To (Debit)";
                    populateSelect('ac1Select', getLedgersByType('CashBank'));
                    document.getElementById('lblParty').innerText = "Withdraw From (Credit)";
                    populateSelect('ac2Select', getLedgersByType('CashBank'));
                }
            }
        }

        // --- JOURNAL LOGIC ---
        function addJournalRow(defaultType = 'Dr') {
            const div = document.createElement('div');
            div.className = 'journal-row';
            
            // Ledger Options
            let opts = `<option value="">Select Ledger</option>`;
            ledgers.sort((a,b)=>a.name.localeCompare(b.name)).forEach(l => {
                 opts += `<option value="${l.id}">${l.name}</option>`;
            });

            div.innerHTML = `
                <div class="j-type">
                    <select class="row-type" onchange="calcJournalTotal()" style="padding:5px; border:none; font-weight:bold;">
                        <option value="Dr" ${defaultType==='Dr'?'selected':''}>Dr</option>
                        <option value="Cr" ${defaultType==='Cr'?'selected':''}>Cr</option>
                    </select>
                </div>
                <div class="j-ac">
                    <select class="row-ledger" style="padding:5px; border:none; width:100%;">${opts}</select>
                </div>
                <div class="j-amt">
                    <input type="number" class="row-amt" placeholder="0.00" onchange="calcJournalTotal()" style="padding:5px; border:none; text-align:right;">
                </div>
                <div class="j-act" onclick="this.parentElement.remove(); calcJournalTotal()">√ó</div>
            `;
            document.getElementById('journalRows').appendChild(div);
        }

        function calcJournalTotal() {
            let dr = 0, cr = 0;
            document.querySelectorAll('.journal-row').forEach(row => {
                const type = row.querySelector('.row-type').value;
                const amt = parseFloat(row.querySelector('.row-amt').value) || 0;
                if(type === 'Dr') dr += amt; else cr += amt;
            });
            
            document.getElementById('totDr').textContent = dr.toFixed(2);
            document.getElementById('totCr').textContent = cr.toFixed(2);
            
            const diff = dr - cr;
            const diffEl = document.getElementById('diffDisplay');
            diffEl.textContent = `Diff: ${Math.abs(diff).toFixed(2)}`;
            
            if(Math.abs(diff) < 0.01 && dr > 0) {
                diffEl.className = 'diff-ok'; diffEl.textContent = 'Balanced ‚úÖ';
                document.getElementById('saveBtn').disabled = false;
                document.getElementById('saveBtn').style.opacity = 1;
            } else {
                diffEl.className = 'diff-err'; 
                document.getElementById('saveBtn').disabled = true;
                document.getElementById('saveBtn').style.opacity = 0.5;
            }
        }

        async function saveVoucher() {
            const narration = document.getElementById('narration').value;
            const vData = {
                voucher_no: document.getElementById('vchNo').value,
                date: document.getElementById('date').value,
                type: currentMode,
                amount: 0, // Calculated below
                party_id: null,
                narration: narration
            };

            let entries = [];
            let totalAmt = 0;

            if(currentMode === 'Journal') {
                // Process Journal Rows
                document.querySelectorAll('.journal-row').forEach(row => {
                    const type = row.querySelector('.row-type').value;
                    const lid = parseInt(row.querySelector('.row-ledger').value);
                    const amt = parseFloat(row.querySelector('.row-amt').value);
                    
                    if(lid && amt) {
                        entries.push({
                            ledger_id: lid,
                            debit: type === 'Dr' ? amt : 0,
                            credit: type === 'Cr' ? amt : 0
                        });
                        if(type === 'Dr') totalAmt += amt;
                    }
                });
                // Validation handled by calcJournalTotal button state
            } else {
                // Standard Modes
                const amt = parseFloat(document.getElementById('amount').value);
                const ac1 = parseInt(document.getElementById('ac1Select').value);
                const ac2 = parseInt(document.getElementById('ac2Select').value);
                
                if(!amt || !ac1 || !ac2) return alert("Fill all fields");
                if(ac1 === ac2) return alert("Accounts must be different");

                totalAmt = amt;
                vData.party_id = ac2; // Reference

                if (currentMode === 'Receipt') {
                    entries.push({ ledger_id: ac1, debit: amt, credit: 0 }); // Cash Dr
                    entries.push({ ledger_id: ac2, debit: 0, credit: amt }); // Party Cr
                } else if (currentMode === 'Payment') {
                    entries.push({ ledger_id: ac2, debit: amt, credit: 0 }); // Party Dr
                    entries.push({ ledger_id: ac1, debit: 0, credit: amt }); // Cash Cr
                } else { // Contra
                    entries.push({ ledger_id: ac1, debit: amt, credit: 0 }); // Target Dr
                    entries.push({ ledger_id: ac2, debit: 0, credit: amt }); // Source Cr
                }
            }

            vData.amount = totalAmt;

            try {
                if(entries.length === 0) return alert("No valid entries found");
                await DB.saveVoucher(vData, [], entries);
                
                // Reset
                if(currentMode === 'Journal') {
                    document.getElementById('journalRows').innerHTML = '';
                    addJournalRow('Dr'); addJournalRow('Cr');
                    calcJournalTotal();
                } else {
                    document.getElementById('amount').value = '';
                }
                document.getElementById('narration').value = '';
                setMode(currentMode); // Regen VCH NO
                loadRecent();
                alert("Saved!");
            } catch(e) { alert("Error: " + e); }
        }

        async function updateBalance(elType) {
            const selectId = elType === 'ac1' ? 'ac1Select' : 'ac2Select';
            const spanId = elType === 'ac1' ? 'bal1' : 'bal2';
            const id = parseInt(document.getElementById(selectId).value);
            if(!id) { document.getElementById(spanId).innerText = ''; return; }
            
            const entries = await DB.getAll('acct_entries');
            const ledger = ledgers.find(l => l.id === id);
            let bal = ledger.opening_balance || 0;
            entries.filter(e => e.ledger_id === id).forEach(e => { bal += (e.debit - e.credit); });
            
            const type = bal >= 0 ? 'Dr' : 'Cr';
            const color = bal >= 0 ? 'bal-dr' : 'bal-cr';
            document.getElementById(spanId).className = `bal-display ${color}`;
            document.getElementById(spanId).innerText = `‚Çπ${Math.abs(bal).toFixed(2)} ${type}`;
        }

        async function loadRecent() {
            const list = document.getElementById('recentList');
            list.innerHTML = '';
            const all = await DB.getAll('vouchers');
            all.sort((a,b)=>b.id-a.id).slice(0,5).forEach(v => {
                const item = document.createElement('div');
                item.className = 'txn-item';
                item.innerHTML = `
                    <div><span class="tag tag-${v.type}">${v.type}</span> <b>${v.voucher_no}</b></div>
                    <div><b>‚Çπ${v.amount}</b> <button class="btn-del" onclick="del(${v.id})">üóëÔ∏è</button></div>
                `;
                list.appendChild(item);
            });
        }
        
        async function del(id) {
             if(confirm('Delete?')) {
                 const tx = DB.db.transaction(['vouchers', 'acct_entries'], 'readwrite');
                 tx.objectStore('vouchers').delete(id);
                 // Cleanup
                 const idx = tx.objectStore('acct_entries').index('voucher_id');
                 idx.getAllKeys(id).onsuccess = (e) => e.target.result.forEach(k => tx.objectStore('acct_entries').delete(k));
                 tx.oncomplete = () => loadRecent();
             }
        }
    </script>
</body>
</html>